<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectFlow - Modern Work Management</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Day.js for advanced date handling -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/isBetween.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/advancedFormat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/weekOfYear.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #323338;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            background: #f6f7fb;
            min-height: 100vh;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e6e9ef;
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .main-nav {
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            padding: 10px 20px;
            border-radius: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #323338;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #f6f7fb;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .search-container {
            position: relative;
        }

        .search-bar {
            background: #f6f7fb;
            border: 2px solid transparent;
            padding: 12px 16px 12px 44px;
            border-radius: 12px;
            width: 320px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #676879;
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: none;
            background: #f6f7fb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .logout-btn {
            background: #fee;
            color: #c33;
            padding: 8px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .logout-btn:hover {
            background: #fdd;
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #323338;
        }

        .icon-btn:hover {
            background: #e6e9ef;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #ff3d57;
            border-radius: 50%;
            border: 2px solid white;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .init-data-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 28px;
            background: linear-gradient(135deg, #00c875 0%, #00a666 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 200, 117, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .init-data-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 200, 117, 0.5);
        }

        .init-data-btn:active {
            transform: translateY(-1px);
        }

        .init-data-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .init-data-btn.success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e6e9ef;
            padding: 24px 16px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 80px;
            padding: 24px 12px;
        }

        .sidebar.collapsed .sidebar-title {
            display: none;
        }

        .sidebar.collapsed .sidebar-item span:not(.emoji) {
            display: none;
        }

        .sidebar.collapsed .add-button {
            display: none;
        }

        .sidebar.collapsed .sidebar-item {
            justify-content: center;
            padding: 12px;
        }

        .sidebar.collapsed .sidebar-section {
            margin-bottom: 20px;
        }

        .collapse-btn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #f6f7fb 0%, #e6e9ef 100%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .collapse-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .sidebar-section-header:hover {
            opacity: 0.7;
        }

        .section-arrow {
            font-size: 12px;
            color: #676879;
            transition: transform 0.3s ease;
        }

        .sidebar-section.collapsed .section-arrow {
            transform: rotate(-90deg);
        }

        .sidebar-section-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .sidebar-section.collapsed .sidebar-section-content {
            max-height: 0;
            opacity: 0;
        }

        .sidebar.collapsed .sidebar-section-header {
            justify-content: center;
        }

        .sidebar.collapsed .section-arrow {
            display: none;
        }

        .sidebar-title {
            font-size: 11px;
            color: #676879;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .sidebar-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            color: #323338;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 4px;
        }

        .sidebar-item:hover {
            background: #f6f7fb;
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .sidebar-item .emoji {
            font-size: 20px;
        }

        .add-button {
            width: 100%;
            padding: 12px;
            border: 2px dashed #c5c7d0;
            background: transparent;
            border-radius: 12px;
            color: #676879;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-button:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f6f7fb;
            transform: scale(1.02);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .page-view {
            display: none;
            animation: slideIn 0.4s ease;
        }

        .page-view.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .board-header {
            margin-bottom: 32px;
        }

        .board-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #323338;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .board-subtitle {
            color: #676879;
            font-size: 15px;
        }

        .board-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #323338;
            border: 2px solid #e6e9ef;
        }

        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .btn-secondary.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .btn-secondary.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #676879;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            border: 1px solid #e6e9ef;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #323338;
        }

        .progress-item {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .progress-name {
            color: #323338;
            font-weight: 600;
        }

        .progress-percentage {
            color: #676879;
            font-weight: 700;
        }

        .progress-bar-container {
            height: 10px;
            background: #f6f7fb;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 16px 0;
            border-bottom: 1px solid #e6e9ef;
            display: flex;
            align-items: start;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            padding-left: 8px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            color: white;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: #323338;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .activity-time {
            font-size: 12px;
            color: #676879;
            font-weight: 600;
        }

        .table-container {
            background: white;
            border-radius: 16px;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e6e9ef;
            width: 100%;
        }

        .table-wrapper {
            min-width: 100%;
            width: max-content;
        }

        .table-header {
            display: grid;
            grid-template-columns: 60px minmax(180px, 1.8fr) 160px 120px 180px 200px 130px 130px 150px;
            background: linear-gradient(135deg, #f6f7fb 0%, #e6e9ef 100%);
            border-bottom: 2px solid #e6e9ef;
            font-size: 13px;
            font-weight: 700;
            color: #676879;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: max-content;
        }

        .table-cell {
            padding: 18px 16px;
            border-right: 1px solid #e6e9ef;
            overflow: visible;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-cell:last-child {
            border-right: none;
        }

        .table-cell.sortable:hover {
            background: rgba(0, 115, 234, 0.1);
            color: #0073ea;
        }

        .sort-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            color: #c5c7d0;
        }

        .sort-icon.asc::after {
            content: '▲';
            color: #0073ea;
        }

        .sort-icon.desc::after {
            content: '▼';
            color: #0073ea;
        }

        .table-row {
            display: grid;
            grid-template-columns: 60px minmax(180px, 1.8fr) 160px 120px 180px 200px 130px 130px 150px;
            border-bottom: 1px solid #e6e9ef;
            transition: all 0.3s ease;
            min-width: max-content;
            position: relative;
            z-index: 1;
        }

        .table-row:hover {
            background: #f6f7fb;
            transform: scale(1.005);
            z-index: 10;
        }

        .table-row:has(.status-popup.active) {
            z-index: 100;
        }

        .table-row .table-cell {
            padding: 18px 16px;
            display: flex;
            align-items: center;
        }

        .table-cell .task-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f6f7fb;
            border-radius: 0 0 16px 16px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4291 100%);
        }

        .row-number {
            color: #676879;
            font-weight: 700;
        }

        .task-name {
            font-weight: 600;
            color: #323338;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        /* Status Popup Dropdown */
        .status-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            border: 1px solid #e6e9ef;
            padding: 8px;
            min-width: 180px;
            z-index: 9999;
            display: none;
            animation: fadeInDown 0.2s ease;
        }

        .status-popup.active {
            display: block;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .status-popup-option {
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-popup-option:last-child {
            margin-bottom: 0;
        }

        .status-popup-option:hover {
            transform: translateX(4px);
        }

        .status-popup-option.working {
            background: #fdab3d;
            color: white;
        }

        .status-popup-option.done {
            background: #00c875;
            color: white;
        }

        .status-popup-option.stuck {
            background: #e44258;
            color: white;
        }

        .status-popup-option.blank {
            background: #c4c4c4;
            color: white;
        }

        .status-badge-wrapper {
            position: relative;
            display: inline-block;
        }

        .status-working {
            background: #fdab3d;
            color: white;
        }

        .status-done {
            background: #00c875;
            color: white;
        }

        .status-stuck {
            background: #e44258;
            color: white;
        }

        .status-blank {
            background: #c4c4c4;
            color: white;
        }

        .priority {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .priority-high {
            background: #e44258;
        }

        .priority-medium {
            background: #fdab3d;
        }

        .priority-low {
            background: #579bfc;
        }

        .person-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
        }

        .date-cell {
            color: #676879;
            font-size: 13px;
            font-weight: 600;
        }

        .project-badge {
            padding: 6px 6px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            background: linear-gradient(135deg, #e6f4ff 0%, #d4e9ff 100%);
            color: #667eea;
            border: 1px solid #b8daff;
            display: inline-block;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f6f7fb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.edit-btn:hover {
            background: #667eea;
            color: white;
        }

        .action-btn.delete-btn:hover {
            background: #e44258;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .add-row {
            padding: 20px 16px;
            color: #676879;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-row:hover {
            color: #667eea;
            background: #f6f7fb;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .team-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
            position: relative;
        }

        .team-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .team-card:hover .team-edit-btn {
            opacity: 1;
        }

        .team-edit-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: white;
            border: 2px solid #e6e9ef;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .team-edit-btn:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .change-password-btn {
            width: 100%;
            margin-top: 16px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .change-password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .team-avatar-large {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: 700;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .team-name {
            font-size: 20px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 6px;
        }

        .team-role {
            font-size: 14px;
            color: #676879;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .team-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .team-status.active {
            background: #d4edda;
            color: #155724;
        }

        .team-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .team-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 20px;
            border-top: 2px solid #e6e9ef;
        }

        .team-stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .team-stat-label {
            font-size: 12px;
            color: #676879;
            margin-top: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-stat.clickable-stat {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }

        .team-stat.clickable-stat:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }

        .team-stat.clickable-stat:hover .team-stat-value {
            background: linear-gradient(135deg, #5568d3 0%, #6a4291 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Multi-Select Checkbox Dropdown Styles */
        .multi-select-dropdown {
            position: relative;
            width: 100%;
            z-index: 50;
        }

        .multi-select-display {
            width: 100%;
            padding: 8px 32px 8px 12px;
            border: 1px solid #e6e9ef;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
            position: relative;
        }

        .multi-select-display:hover {
            border-color: #667eea;
        }

        .multi-select-display::after {
            content: '▼';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: #676879;
            transition: transform 0.2s ease;
            pointer-events: none;
        }

        .multi-select-display.open::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .multi-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e6e9ef;
            border-radius: 6px;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 99999 !important;
            display: none;
            max-height: 250px;
            overflow-y: auto;
            pointer-events: auto;
        }

        .multi-select-options.open {
            display: block;
        }

        .multi-select-option {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .multi-select-option:hover {
            background: #f6f7fb;
        }

        .multi-select-option input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .multi-select-option label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            color: #323338;
        }

        /* Project Health 3D Circle Styles */
        .project-health-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), inset 0 -2px 4px rgba(0, 0, 0, 0.15);
            position: relative;
            background: linear-gradient(135deg, var(--health-light), var(--health-dark));
        }

        .project-health-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            border-radius: 50% 50% 0 0;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        .project-health-circle.green {
            --health-light: #65d814;
            --health-dark: #3fa015;
        }

        .project-health-circle.amber {
            --health-light: #ffb800;
            --health-dark: #d99400;
        }

        .project-health-circle.red {
            --health-light: #ff5555;
            --health-dark: #c21e1e;
        }

        .project-health-circle.none {
            --health-light: #e6e9ef;
            --health-dark: #b0b8c8;
            color: #676879;
        }

        /* Projects Grid Styles */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            padding: 24px 0;
            width: 100%;
        }

        .project-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
            position: relative;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .project-card-title {
            font-size: 20px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 8px;
        }

        .project-card-description {
            font-size: 14px;
            color: #676879;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .project-status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-status-badge.planned {
            background: #e3f2fd;
            color: #1976d2;
        }

        .project-status-badge.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        .project-status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .project-status-badge.on-hold {
            background: #f8d7da;
            color: #721c24;
        }

        /* Make status and SDLC badges clickable */
        .project-status-badge.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-status-badge.clickable:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        /* Project status/SDLC popup */
        .project-status-popup-wrapper {
            position: relative;
            display: inline-block;
        }

        .project-status-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            border: 1px solid #e6e9ef;
            padding: 8px;
            min-width: 200px;
            z-index: 9999;
            display: none;
            animation: fadeInDown 0.2s ease;
        }

        .project-status-popup.active {
            display: block;
        }

        .project-status-popup-option {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #323338;
        }

        .project-status-popup-option:last-child {
            margin-bottom: 0;
        }

        .project-status-popup-option:hover {
            background: #f6f7fb;
            transform: translateX(4px);
        }

        .project-status-popup-option.planned {
            background: #e3f2fd;
            color: #1976d2;
        }

        .project-status-popup-option.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        .project-status-popup-option.completed {
            background: #d4edda;
            color: #155724;
        }

        .project-status-popup-option.on-hold {
            background: #f8d7da;
            color: #721c24;
        }

        .project-status-popup-option.sdlc {
            background: #e6f2ff;
            color: #0073ea;
        }

        .project-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e6e9ef;
        }

        .project-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #676879;
        }

        .project-meta-icon {
            font-size: 14px;
        }

        .project-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .project-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #e6e9ef;
            background: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .project-action-btn:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .project-action-btn.delete:hover {
            background: #e44258;
            border-color: #e44258;
        }

        .project-progress {
            margin-top: 12px;
        }

        .project-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #676879;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .project-progress-bar {
            height: 8px;
            background: #e6e9ef;
            border-radius: 10px;
            overflow: hidden;
        }

        .project-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .project-tag {
            padding: 4px 10px;
            background: #f5f6f8;
            border-radius: 6px;
            font-size: 11px;
            color: #676879;
            font-weight: 600;
        }

        /* Timeline Scale Buttons */
        .timeline-scale-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #e6e9ef;
            background: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            color: #676879;
            transition: all 0.3s ease;
        }

        .timeline-scale-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .timeline-scale-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 540px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-spinner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 20px;
        }

        .modal-spinner-overlay.active {
            display: flex;
        }

        .modal-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 28px;
            border-bottom: 2px solid #e6e9ef;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #323338;
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e6e9ef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .readonly-input {
            background: #f6f7fb;
            cursor: not-allowed;
            color: #676879;
        }

        .password-error-message {
            display: none;
            background: #fee;
            color: #c33;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .password-error-message.show {
            display: block;
        }

        .password-success-message {
            display: none;
            background: #efe;
            color: #363;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #2e7d32;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .password-success-message.show {
            display: block;
        }

        .modal-footer {
            padding: 20px 28px;
            border-top: 2px solid #e6e9ef;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .delete-btn {
            background: #e44258;
            color: white;
        }

        .delete-btn:hover {
            background: #c93649;
        }

        /* Tablet responsive design (768px - 1024px) */
        @media (max-width: 1024px) {
            .table-container {
                overflow-x: auto;
            }

            .table-header,
            .table-row {
                grid-template-columns: 50px minmax(150px, 1fr) 120px 100px 140px 110px;
            }

            /* Hide date and timeline columns on tablet */
            .table-cell:nth-child(7),
            .table-cell:nth-child(8) {
                display: none;
            }

            .content {
                padding: 20px;
            }
        }

        /* Mobile responsive design (max-width: 768px) */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
                height: 60px;
            }

            .logo {
                font-size: 20px;
            }

            .main-nav {
                display: none;
            }

            .search-container {
                display: none;
            }

            .header-right {
                gap: 8px;
            }

            .icon-btn,
            .avatar {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .sidebar {
                width: 70px;
                padding: 16px 8px;
            }

            .sidebar-title,
            .sidebar-item span:not(.emoji),
            .add-button {
                display: none;
            }

            .sidebar-item {
                justify-content: center;
                padding: 10px;
            }

            .content {
                padding: 16px;
            }

            .board-title {
                font-size: 24px;
            }

            .board-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            /* Remove horizontal scroll on mobile */
            .table-container {
                overflow-x: visible;
                overflow-y: visible;
            }

            /* Hide table header on mobile */
            .table-header {
                display: none;
            }

            /* Convert table rows to card layout */
            .table-row {
                display: flex;
                flex-direction: column;
                padding: 16px;
                gap: 12px;
                border-radius: 12px;
                margin-bottom: 12px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                min-width: auto;
            }

            .table-row:hover {
                transform: scale(1);
            }

            .table-cell {
                padding: 0 !important;
                border-right: none !important;
                display: flex !important;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }

            .table-cell::before {
                content: attr(data-label);
                font-weight: 700;
                color: #676879;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Hide row number on mobile */
            .table-cell:nth-child(1) {
                display: none !important;
            }

            /* Task name - full width, no label */
            .table-cell:nth-child(2) {
                flex-direction: column;
                align-items: flex-start;
                padding-bottom: 8px !important;
                border-bottom: 1px solid #e6e9ef;
            }

            .table-cell:nth-child(2)::before {
                content: none;
            }

            .task-name {
                font-size: 16px;
                font-weight: 700;
            }

            /* Show all cells on mobile */
            .table-cell:nth-child(n) {
                display: flex !important;
            }

            .status-badge {
                font-size: 11px;
                padding: 6px 12px;
            }

            .person-cell {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .person-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .project-badge {
                font-size: 12px;
                padding: 2px 2px;
            }

            .action-buttons {
                gap: 8px;
            }

            .action-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .date-cell {
                font-size: 13px;
            }
        }

        /* Extra small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .header {
                padding: 0 12px;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                z-index: 200;
                transition: left 0.3s ease;
                height: calc(100vh - 60px);
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .main-container {
                margin-left: 0;
            }

            .content {
                padding: 12px;
                width: 100%;
            }

            .board-title {
                font-size: 20px;
            }

            .board-subtitle {
                font-size: 13px;
            }

            .table-row {
                padding: 12px;
            }

            .table-cell {
                font-size: 13px;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner-container {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 16px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-text {
            color: #323338;
            font-size: 14px;
            font-weight: 600;
        }

        /* Custom Date Input Wrapper */
        .date-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .date-input-wrapper input[type="date"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        /* Style to show dd/mm/yyyy format */
        .date-display {
            position: relative;
            padding: 12px 50px 12px 16px;
            background: white;
            border: 2px solid #e6e9ef;
            border-radius: 12px;
            display: flex;
            align-items: center;
            color: #323338;
            font-size: 14px;
            min-height: 48px;
            cursor: pointer;
        }

        .date-display.placeholder {
            color: #a0a0a0;
        }

        .date-input-wrapper input[type="date"]:focus ~ .date-display {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .date-input-wrapper .calendar-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 1;
            font-size: 16px;
        }

        /* Hide the default date picker icon */
        .date-input-wrapper input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        /* Subtask Styles */
        .subtask-row {
            background: #f8f9fb;
            border-left: 3px solid #0073ea;
            cursor: move;
        }

        .subtask-row:hover {
            background: #f0f2f5;
        }

        .subtask-row.dragging {
            opacity: 0.5;
            background: #e6f2ff;
        }

        .subtask-indent {
            color: #0073ea;
            font-weight: bold;
            margin-right: 8px;
        }

        .subtask-name {
            font-style: italic;
            color: #676879;
        }

        .subtask-btn {
            background: #e6f2ff;
            color: #0073ea;
        }

        .subtask-btn:hover {
            background: #0073ea;
            color: white;
        }

        /* Inline Add Subtask Row */
        .inline-add-subtask-row {
            background: #f8f9fb;
            border-left: 3px solid #0073ea;
            padding: 8px 0;
        }

        .inline-add-subtask-row .table-cell {
            padding: 4px 12px;
        }

        .inline-add-subtask-row input,
        .inline-add-subtask-row select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d0d4e4;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }

        .inline-add-subtask-row input:focus,
        .inline-add-subtask-row select:focus {
            outline: none;
            border-color: #0073ea;
            box-shadow: 0 0 0 2px rgba(0, 115, 234, 0.1);
        }

        .inline-add-subtask-actions {
            display: flex;
            gap: 8px;
        }

        .inline-add-subtask-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }

        .inline-add-subtask-save {
            background: #0073ea;
            color: white;
        }

        .inline-add-subtask-save:hover {
            background: #0060c0;
        }

        .inline-add-subtask-cancel {
            background: #e6e9ef;
            color: #676879;
        }

        .inline-add-subtask-cancel:hover {
            background: #d0d4e4;
        }

        /* Drag and Drop Styles */
        .table-row.drag-over {
            background: #e6f7ff;
            border: 2px dashed #0073ea;
        }

        .table-row.drop-target {
            box-shadow: 0 2px 8px rgba(0, 115, 234, 0.3);
        }

        /* Overdue Task Styles */
        .table-row.overdue {
            background: rgba(255, 0, 0, 0.08) !important;
            border-left: 4px solid #e44258;
        }

        .subtask-row.overdue {
            background: rgba(255, 0, 0, 0.08) !important;
            border-left: 4px solid #e44258;
        }

        /* Multiple Assignees Styles */
        .person-avatars-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .person-avatar-small {
            width: 24px;
            height: 24px;
            font-size: 10px;
        }

        /* Inline Editing Styles */
        .editable-field {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
            min-height: 20px;
            display: inline-block;
            min-width: 100px;
        }

        .editable-field:hover {
            background: #f0f2f5;
            outline: 1px solid #d0d4e4;
        }

        .inline-edit-input {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #0073ea;
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            outline: none;
        }

        .inline-edit-select {
            width: 100%;
            padding: 4px 8px;
            border: 2px solid #0073ea;
            border-radius: 4px;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            min-height: 100px;
        }

        .inline-edit-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            position: absolute;
            right: 4px;
            top: 4px;
            z-index: 1000;
        }

        .inline-edit-btn {
            padding: 2px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            line-height: 1;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1001;
        }

        .inline-edit-save {
            background: #00c875;
            color: white;
            display: none;
        }

        .inline-edit-save:hover {
            background: #00a164;
        }

        .inline-edit-cancel {
            background: #e6e9ef;
            color: #676879;
        }

        .inline-edit-cancel:hover {
            background: #d0d4e4;
        }

        .editing-mode {
            background: #e6f2ff !important;
            position: relative;
        }

        .inline-edit-wrapper {
            position: relative;
            width: 100%;
        }

        /* ===== GANTT CHART STYLES (from ganttchart.html) ===== */
        :root {
            --row-height: 48px;
        }

        .gantt-row {
            height: var(--row-height);
        }

        .gantt-cell {
            min-width: 40px;
        }

        .gantt-timeline-header {
            height: 60px;
        }

        /* Hide scrollbars while keeping functionality */
        .gantt-container::-webkit-scrollbar,
        .task-list-body::-webkit-scrollbar {
            display: none;
        }

        .gantt-container,
        .task-list-body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Today line styling */
        .today-line {
            position: absolute;
            width: 2px;
            height: 100%;
            background-color: #ef4444;
            z-index: 10;
            pointer-events: none;
        }

        /* Task bar styling */
        .task-bar {
            position: absolute;
            height: 28px;
            top: 10px;
            border-radius: 6px;
            cursor: grab;
            transition: box-shadow 0.1s;
            z-index: 5;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .task-bar:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .task-bar:active {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            cursor: grabbing;
        }

        /* Resize Handle Styles */
        .resize-handle {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 10px;
            z-index: 20;
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid #ffffff;
            border-radius: 4px;
            cursor: col-resize;
            transition: opacity 0.1s;
            opacity: 0.5;
        }

        .resize-handle:hover {
            opacity: 1;
        }

        .resize-handle-left {
            left: -5px;
        }

        .resize-handle-right {
            right: -5px;
        }

        .task-list-panel {
            min-width: 250px;
            border-right: 1px solid #e0e0e0;
            background: white;
        }

        .gantt-chart-panel {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: white;
        }

        @media (min-width: 1024px) {
            .task-list-panel {
                min-width: 300px;
                max-width: 350px;
            }
            .gantt-chart-panel {
                flex-grow: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="logo">ProjectFlow</div>
                <nav class="main-nav">
                    <button class="nav-tab active" onclick="switchPage('dashboard')">Dashboard</button>
                    <button class="nav-tab" onclick="switchPage('projectslist')">Projects</button>
                    <button class="nav-tab" onclick="switchPage('tasks')">Tasks</button>
                    <button class="nav-tab" onclick="switchPage('team')">Team</button>
                    <button class="nav-tab" onclick="switchPage('reports')">Reports</button>
                </nav>
            </div>
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-bar" placeholder="Search tasks, projects, people...">
            </div>
            <div class="header-right">
                <button class="icon-btn">
                    🔔
                    <span class="notification-badge"></span>
                </button>
                <button class="icon-btn">⚙️</button>
                <button class="icon-btn">❓</button>
                <div class="user-info">
                    <span class="user-name" id="currentUserName">User</span>
                    <div class="avatar" id="currentUserAvatar">JD</div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar" id="sidebar">
                <button class="collapse-btn" onclick="toggleSidebar()">
                    <span id="collapseIcon">◀</span>
                </button>
                
                <div class="sidebar-section">
                    <div class="sidebar-item active">
                        <span class="emoji">📋</span>
                        <span>Main Table</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📊</span>
                        <span>Chart View</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📅</span>
                        <span>Calendar</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📈</span>
                        <span>Timeline</span>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('myWork')">
                        <div class="sidebar-title">My Work</div>
                        <span class="section-arrow" id="myWorkArrow">▼</span>
                    </div>
                    <div class="sidebar-section-content" id="myWorkContent">
                        <div class="sidebar-item">
                            <span class="emoji">⭐</span>
                            <span>Favorites</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">📌</span>
                            <span>My Items</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">🎯</span>
                            <span>My Goals</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('workspaces')">
                        <div class="sidebar-title">Workspaces</div>
                        <span class="section-arrow" id="workspacesArrow">▼</span>
                    </div>
                    <div class="sidebar-section-content" id="workspacesContent">
                        <div class="sidebar-item">
                            <span class="emoji">🎯</span>
                            <span>Marketing</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">💻</span>
                            <span>Development</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">🎨</span>
                            <span>Design</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">📱</span>
                            <span>Mobile</span>
                        </div>
                        <button class="add-button">+ Add Workspace</button>
                    </div>
                </div>
            </aside>

            <main class="content">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page-view active">
                    <div class="board-header">
                        <h1 class="board-title">Dashboard Overview</h1>
                        <p class="board-subtitle">Track your team's progress and performance</p>
                    </div>


                    <!-- Charts Row Container -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Project Type Chart -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Projects by Type</h3>
                                <span id="typeChartFilterLabel" style="font-size: 12px; color: #0073ea; font-weight: 600; display: none;">
                                    Filtered: <span id="typeChartFilterValue"></span>
                                </span>
                            </div>
                            <div id="projectTypeChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectTypeChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectTypeChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading project type data...
                                </div>
                            </div>
                        </div>

                        <!-- Project Health Chart -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Projects by Health</h3>
                                <span id="healthChartFilterLabel" style="font-size: 12px; color: #0073ea; font-weight: 600; display: none;">
                                    Filtered: <span id="healthChartFilterValue"></span>
                                </span>
                            </div>
                            <div id="projectHealthChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectHealthChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectHealthChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading project health data...
                                </div>
                            </div>
                        </div>

                        <!-- Project Manager Chart -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Projects by Manager</h3>
                                <span id="managerChartFilterLabel" style="font-size: 12px; color: #0073ea; font-weight: 600; display: none;">
                                    Filtered: <span id="managerChartFilterValue"></span>
                                </span>
                            </div>
                            <div id="projectManagerChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectManagerChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectManagerChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading project manager data...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Filter Clear Button (shown when filters are active) -->
                    <button id="clearChartFiltersBtn" onclick="clearChartFilters()" style="display: none; padding: 8px 16px; background: #e44258; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 24px;">
                        Clear Chart Filters
                    </button>

                    <!-- Key Metrics Cards Row -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Total Projects</div>
                            <div style="font-size: 32px; font-weight: bold;" id="metricsTotal">0</div>
                            <div style="font-size: 11px; opacity: 0.8; margin-top: 8px;">Active: <span id="metricsActive">0</span></div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">On-Time</div>
                            <div style="font-size: 32px; font-weight: bold;" id="metricsOnTime">0</div>
                            <div style="font-size: 11px; opacity: 0.8; margin-top: 8px;" id="metricsOnTimePercent">0%</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">Avg Duration</div>
                            <div style="font-size: 32px; font-weight: bold;" id="metricsAvgDuration">0</div>
                            <div style="font-size: 11px; opacity: 0.8; margin-top: 8px;">days</div>
                        </div>
                        <div onclick="showAtRiskDetails()" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';">
                            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">At Risk (Click for details)</div>
                            <div style="font-size: 32px; font-weight: bold;" id="metricsAtRisk">0</div>
                            <div style="font-size: 11px; opacity: 0.8; margin-top: 8px;" id="metricsAtRiskPercent">0%</div>
                            <div style="font-size: 10px; opacity: 0.85; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.3);">
                                <div style="margin-bottom: 3px;">
                                    <span id="metricsAtRiskOverdue">⏰ Overdue: 0</span>
                                </div>
                                <div style="margin-bottom: 3px;">
                                    <span id="metricsAtRiskBehind">📉 Behind: 0</span>
                                </div>
                                <div style="margin-bottom: 3px;">
                                    <span id="metricsAtRiskNoProgress">🚫 No Progress: 0</span>
                                </div>
                                <div>
                                    <span id="metricsAtRiskSlow">⚠️ Slow: 0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Charts Row 1 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Project Status Distribution -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Projects by Status</h3>
                                <span id="statusChartFilterLabel" style="font-size: 12px; color: #0073ea; font-weight: 600; display: none;">
                                    Filtered: <span id="statusChartFilterValue"></span>
                                </span>
                            </div>
                            <div id="projectStatusChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectStatusChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectStatusChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading project status data...
                                </div>
                            </div>
                        </div>

                        <!-- Project Priority Distribution -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Projects by Priority</h3>
                                <span id="priorityChartFilterLabel" style="font-size: 12px; color: #0073ea; font-weight: 600; display: none;">
                                    Filtered: <span id="priorityChartFilterValue"></span>
                                </span>
                            </div>
                            <div id="projectPriorityChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectPriorityChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectPriorityChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading project priority data...
                                </div>
                            </div>
                        </div>

                        <!-- SDLC Phase Progress -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">SDLC Phase Progress</h3>
                                <span id="sdlcChartFilterLabel" style="font-size: 12px; color: #0073ea; font-weight: 600; display: none;">
                                    Filtered: <span id="sdlcChartFilterValue"></span>
                                </span>
                            </div>
                            <div id="projectSDLCChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectSDLCChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectSDLCChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading SDLC phase data...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Charts Row 2 -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Project Progress Distribution -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Progress Distribution</h3>
                            </div>
                            <div id="projectProgressDistChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectProgressDistChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectProgressDistChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading progress distribution data...
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Analytics -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Timeline Analytics</h3>
                            </div>
                            <div id="projectTimelineChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectTimelineChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectTimelineChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading timeline data...
                                </div>
                            </div>
                        </div>

                        <!-- Project Completion Forecast -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Completion Forecast</h3>
                            </div>
                            <div id="projectForecastChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectForecastChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectForecastChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading forecast data...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottleneck Alerts Panel -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Bottleneck Alerts -->
                        <div class="chart-container">
                            <h3 class="chart-title">⚠️ Bottleneck Alerts</h3>
                            <ul id="bottleneckAlertsList" style="list-style: none; padding: 0;">
                                <li style="text-align: center; padding: 20px; color: #999;">
                                    Loading alerts...
                                </li>
                            </ul>
                        </div>

                        <!-- Team Workload by Manager -->
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 class="chart-title" style="margin: 0;">Team Workload</h3>
                            </div>
                            <div id="projectWorkloadChartContainer" style="position: relative; height: 300px; padding: 10px;">
                                <canvas id="projectWorkloadChartCanvas" style="max-height: 300px;"></canvas>
                                <div id="projectWorkloadChart" style="text-align: center; padding: 20px; color: #999; display: none;">
                                    Loading workload data...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--<div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalItems">8</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="workingItems">4</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="doneItems">2</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stuckItems">1</div>
                            <div class="stat-label">Needs Attention</div>
                        </div>
                    </div>-->

                    <div class="chart-container">
                        <h3 class="chart-title">Project Progress</h3>
                        <div id="projectProgressList">
                            <!-- Projects will be rendered here dynamically -->
                            <div style="text-align: center; padding: 20px; color: #999;">
                                Loading projects...
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Recent Activity</h3>
                        <ul class="activity-list" id="recentActivityList">
                            <!-- Recent activity will be rendered here dynamically -->
                            <li style="text-align: center; padding: 20px; color: #999;">
                                Loading recent activity...
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Projects List Page -->
                <div id="projectslistPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Projects</h1>
                        <p class="board-subtitle">Manage all your projects in one place</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openProjectModal()">
                                <span>+</span>
                                <span>New Project</span>
                            </button>
                            <button class="btn btn-secondary" id="tableViewBtn" onclick="switchProjectView('grid')">
                                <span>📊</span>
                                <span>Project Card</span>
                            </button>
                            <button class="btn btn-secondary" id="timelineViewBtn" onclick="switchProjectView('timeline')">
                                <span>📈</span>
                                <span>Timeline</span>
                            </button>
                            <button class="btn btn-secondary" onclick="openFullScreenGantt().catch(e => console.error('Error opening timeline:', e))">
                                <span>📅</span>
                                <span>Timeline 2</span>
                            </button>
                            <button class="btn btn-secondary" onclick="toggleProjectFilter()">
                                <span>🔍</span>
                                <span>Filter</span>
                            </button>
                            <button class="btn btn-secondary" onclick="exportProjects()">
                                <span>📤</span>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <!-- Project Filter Panel -->
                    <div id="projectFilterPanel" style="display: none; background: white; padding: 20px; margin: 16px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #323338;">Filter Projects</h3>
                            <button onclick="clearProjectFilters()" style="background: transparent; border: none; color: #e44258; cursor: pointer; font-size: 14px; font-weight: 600;">
                                Clear All
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Status</label>
                                <select id="projectFilterStatus" onchange="applyProjectFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Statuses</option>
                                    <option value="planned">Planned</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Project Type</label>
                                <select id="projectFilterType" onchange="applyProjectFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Types</option>
                                    <option value="Project">Project</option>
                                    <option value="BAU">BAU</option>
                                    <option value="Parameter">Parameter</option>
                                    <option value="Support">Support</option>
                                    <option value="Incident">Incident</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">SDLC Phase</label>
                                <select id="projectFilterSDLC" onchange="applyProjectFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Phases</option>
                                    <option value="Requirement">Requirement</option>
                                    <option value="Design">Design</option>
                                    <option value="Development">Development</option>
                                    <option value="Smoke Test">Smoke Test</option>
                                    <option value="SIT">SIT</option>
                                    <option value="UAT">UAT</option>
                                    <option value="Implemented">Implemented</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Priority</label>
                                <select id="projectFilterPriority" onchange="applyProjectFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Priorities</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Project Manager</label>
                                <div class="multi-select-dropdown" id="projectManagerFilterDropdown">
                                    <div class="multi-select-display" id="projectManagerFilterDisplay" onclick="toggleProjectManagerDropdown()">
                                        <span id="projectManagerFilterText">All Managers</span>
                                    </div>
                                    <div class="multi-select-options" id="projectManagerFilterOptions">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Project Health</label>
                                <div class="multi-select-dropdown" id="projectHealthFilterDropdown">
                                    <div class="multi-select-display" id="projectHealthFilterDisplay" onclick="toggleProjectHealthDropdown()">
                                        <span id="projectHealthFilterText">All Health</span>
                                    </div>
                                    <div class="multi-select-options" id="projectHealthFilterOptions">
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="health-green" value="green" onchange="updateProjectHealthFilter()">
                                            <label for="health-green" style="display: flex; align-items: center; gap: 6px;">
                                                <span style="width: 12px; height: 12px; border-radius: 50%; background: #65d814; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                                Green
                                            </label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="health-amber" value="amber" onchange="updateProjectHealthFilter()">
                                            <label for="health-amber" style="display: flex; align-items: center; gap: 6px;">
                                                <span style="width: 12px; height: 12px; border-radius: 50%; background: #ffb800; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                                Amber
                                            </label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="health-red" value="red" onchange="updateProjectHealthFilter()">
                                            <label for="health-red" style="display: flex; align-items: center; gap: 6px;">
                                                <span style="width: 12px; height: 12px; border-radius: 50%; background: #ff5555; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                                Red
                                            </label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="health-none" value="none" onchange="updateProjectHealthFilter()">
                                            <label for="health-none" style="display: flex; align-items: center; gap: 6px;">
                                                <span style="width: 12px; height: 12px; border-radius: 50%; background: #e6e9ef; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                                None
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="projectsGrid" class="projects-grid">
                        <!-- Projects will be rendered here dynamically -->
                    </div>

                    <!-- Projects Table View -->
                    <div id="projectsTableView" style="display: none;">
                        <div class="table-container">
                            <div class="table-header">
                                <div class="table-cell" style="flex: 2;">Project Name</div>
                                <div class="table-cell">Status</div>
                                <div class="table-cell">Type</div>
                                <div class="table-cell">SDLC Phase</div>
                                <div class="table-cell">Health</div>
                                <div class="table-cell">Progress</div>
                                <div class="table-cell">Start Date</div>
                                <div class="table-cell">End Date</div>
                                <div class="table-cell">Actions</div>
                            </div>
                            <div id="projectsTableBody" class="table-body">
                                <!-- Projects table rows will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Projects Timeline View (Gantt Chart) -->
                    <div id="projectsTimelineView" style="display: none; height: 100%; display: flex; flex-direction: column;">
                        <!-- Timeline Header Bar -->
                        <div style="padding: 16px 20px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e6e9ef;">
                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #323338;">Project Timeline - Gantt Chart</h2>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 13px; color: #676879;">Scale:</span>
                                    <select id="ganttScaleSelector" onchange="setTimelineScale(this.value)" style="padding: 6px 10px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 13px; background: white; color: #323338; cursor: pointer;">
                                        <option value="day">Day</option>
                                        <option value="week">Week</option>
                                        <option value="month" selected>Month</option>
                                        <option value="6month">6 Month</option>
                                        <option value="year">Year</option>
                                    </select>
                                </div>
                                <button onclick="renderGanttChart(currentFilteredProjects)" style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.2s;">Refresh View</button>
                            </div>
                        </div>
                        <!-- Gantt Chart Container -->
                        <div style="flex: 1; overflow-y: auto; background: white;">
                            <div style="padding: 20px 0;">
                                <div id="ganttChart" style="overflow-x: auto;">
                                    <!-- Gantt chart will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Full-Screen Gantt Timeline Modal -->
                <div id="fullScreenGanttModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 1000; overflow: hidden; flex-direction: column;">
                    <!-- Close Button Bar -->
                    <div style="padding: 16px 20px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; border-bottom: 1px solid #e6e9ef;">
                        <button onclick="closeFullScreenGantt()" style="padding: 6px 12px; background: #f0f0f0; color: #323338; border: none; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.2s;">Close</button>
                    </div>
                    <!-- Gantt Content - Using iframe to load ganttchart.html -->
                    <div style="flex: 1; overflow: hidden; width: 100%;">
                        <iframe id="ganttIframe" src="ganttchart.html" style="border: none; width: 100%; height: 100%;"></iframe>
                    </div>
                </div>

                <!-- Tasks Page -->
                <div id="tasksPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Task Management</h1>
                        <p class="board-subtitle">Manage your team's tasks and deliverables</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openModal()">
                                <span>+</span>
                                <span>New Task</span>
                            </button>
                            <button class="btn btn-secondary" id="myTasksBtn" onclick="toggleMyTasks()">
                                <span>👤</span>
                                <span>My Tasks</span>
                            </button>
                            <button class="btn btn-secondary" onclick="toggleFilterPanel()">
                                <span>🔍</span>
                                <span>Filter</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📤</span>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <!-- Task Filter Panel -->
                    <div id="taskFilterPanel" style="display: none; background: white; padding: 20px; margin: 16px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: visible; position: relative; z-index: 100;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #323338;">Filter Tasks</h3>
                            <button onclick="clearAllTaskFilters()" style="background: transparent; border: none; color: #e44258; cursor: pointer; font-size: 14px; font-weight: 600;">
                                Clear All
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; overflow: visible; position: relative; align-items: start;">
                            <div style="overflow: visible;">
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Status</label>
                                <div class="multi-select-dropdown" id="statusFilterDropdown">
                                    <div class="multi-select-display" id="statusFilterDisplay" onclick="toggleStatusDropdown()">
                                        <span id="statusFilterText">All Status</span>
                                    </div>
                                    <div class="multi-select-options" id="statusFilterOptions">
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-blank" value="blank" onchange="updateStatusFilter()">
                                            <label for="status-blank">Not Started</label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-working" value="working" onchange="updateStatusFilter()">
                                            <label for="status-working">Working on it</label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-stuck" value="stuck" onchange="updateStatusFilter()">
                                            <label for="status-stuck">Stuck</label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-done" value="done" onchange="updateStatusFilter()">
                                            <label for="status-done">Done</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="overflow: visible;">
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Priority</label>
                                <select id="filterPriority" onchange="applyTaskFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Priority</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div style="overflow: visible;">
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Assigned To</label>
                                <select id="filterAssignedTo" onchange="applyTaskFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Members</option>
                                </select>
                            </div>
                            <div style="overflow: visible;">
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Project</label>
                                <div class="multi-select-dropdown" id="projectFilterDropdown">
                                    <div class="multi-select-display" id="projectFilterDisplay" onclick="toggleProjectFilterDropdown()">
                                        <span id="projectFilterText">All Projects</span>
                                    </div>
                                    <div class="multi-select-options" id="projectFilterOptions">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="activeFiltersDisplay" style="margin-top: 12px; display: none;">
                            <div style="font-size: 12px; font-weight: 600; color: #676879; margin-bottom: 6px;">Active Filters:</div>
                            <div id="activeFilterTags" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-cell">#</div>
                            <div class="table-cell sortable" onclick="sortTasks('name')" style="cursor: pointer;">
                                Task Name <span id="sort-name" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('status')" style="cursor: pointer;">
                                Status <span id="sort-status" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('priority')" style="cursor: pointer;">
                                Priority <span id="sort-priority" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('person')" style="cursor: pointer;">
                                Assigned To <span id="sort-person" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('project')" style="cursor: pointer;">
                                Project <span id="sort-project" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('startDate')" style="cursor: pointer;">
                                Start Date <span id="sort-startDate" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('date')" style="cursor: pointer;">
                                Due Date <span id="sort-date" class="sort-icon"></span>
                            </div>
                            <div class="table-cell">Actions</div>
                        </div>
                        <div id="tableBody"></div>
                        <div class="add-row" onclick="openModal()">
                            <span>+</span>
                            <span>Add new task</span>
                        </div>
                    </div>
                </div>

                <!-- Team Page -->
                <div id="teamPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Team Members</h1>
                        <p class="board-subtitle">Collaborate with your amazing team</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openMemberModal()">
                                <span>+</span>
                                <span>Add Member</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📊</span>
                                <span>Team Report</span>
                            </button>
                        </div>
                    </div>

                    <div class="team-grid">
                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #667eea, #764ba2);">SL</div>
                            <div class="team-name">Sarah Lee</div>
                            <div class="team-role">Project Manager</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">12</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">8</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #f093fb, #f5576c);">MC</div>
                            <div class="team-name">Mike Chen</div>
                            <div class="team-role">Lead Developer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">15</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">10</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">ER</div>
                            <div class="team-name">Emily Rose</div>
                            <div class="team-role">Marketing Lead</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">9</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">7</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">AK</div>
                            <div class="team-name">Alex Kim</div>
                            <div class="team-role">Database Admin</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">11</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">6</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #fa709a, #fee140);">JP</div>
                            <div class="team-name">Jordan Park</div>
                            <div class="team-role">UI/UX Designer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">10</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">8</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #ffecd2, #fcb69f);">TW</div>
                            <div class="team-name">Taylor Wong</div>
                            <div class="team-role">Backend Developer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">13</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">9</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reportsPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Reports & Analytics</h1>
                        <p class="board-subtitle">Insights into your team's performance</p>
                        <div class="board-actions">
                            <button class="btn btn-secondary">
                                <span>📊</span>
                                <span>Export Report</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📅</span>
                                <span>Date Range</span>
                            </button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Key Metrics</h3>
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">87%</div>
                                <div class="stat-label">Completion Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">Tasks Completed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">3.2</div>
                                <div class="stat-label">Avg. Days/Task</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #e44258;">4</div>
                                <div class="stat-label">Overdue Tasks</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Team Performance</h3>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Sarah Lee - Project Manager</span>
                                <span class="progress-percentage">92%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 92%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Mike Chen - Lead Developer</span>
                                <span class="progress-percentage">85%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 85%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Emily Rose - Marketing Lead</span>
                                <span class="progress-percentage">95%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 95%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Alex Kim - Database Admin</span>
                                <span class="progress-percentage">68%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 68%; background: #fdab3d;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- At Risk Details Modal -->
            <div id="atRiskModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                    <div style="padding: 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white;">
                        <h2 style="margin: 0; color: #323338;">At Risk Projects</h2>
                        <button onclick="closeAtRiskModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
                    </div>
                    <div id="atRiskDetailsContent" style="padding: 24px;">
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Initialize Data Button -->
        <button class="init-data-btn" id="initDataBtn" onclick="initializeAllSampleData()">
            <span id="initBtnIcon">📦</span>
            <span id="initBtnText">Initialize Sample Data</span>
        </button>
    </div>

    <!-- Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <!-- Modal Spinner Overlay -->
            <div class="modal-spinner-overlay" id="modalSpinner">
                <div class="modal-spinner"></div>
            </div>

            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Create New Task</h2>
            </div>
            <form id="taskForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-input" id="itemName" placeholder="Enter task name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="itemStatus">
                            <option value="blank">Not Started</option>
                            <option value="working">Working on it</option>
                            <option value="stuck">Stuck</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="itemPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign To <span style="color: #e44258;">*</span></label>
                        <select class="form-select" id="itemPerson" multiple size="5" required>
                            <option value="" disabled>Loading team members...</option>
                        </select>
                        <small style="color: #676879; font-size: 12px; margin-top: 4px; display: block;">Hold Ctrl/Cmd to select multiple members (at least one required)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project</label>
                        <select class="form-select" id="itemProject">
                            <option value="">No Project</option>
                            <option value="Website Redesign">Website Redesign</option>
                            <option value="Mobile App Development">Mobile App Development</option>
                            <option value="Marketing Campaign Q4">Marketing Campaign Q4</option>
                            <option value="Database Infrastructure">Database Infrastructure</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="itemStartDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="itemStartDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="itemDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="itemDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subtask Modal -->
    <div class="modal" id="subtaskModal">
        <div class="modal-content">
            <!-- Modal Spinner Overlay -->
            <div class="modal-spinner-overlay" id="subtaskModalSpinner">
                <div class="modal-spinner"></div>
            </div>

            <div class="modal-header">
                <h2 class="modal-title" id="subtaskModalTitle">Create New Subtask</h2>
            </div>
            <form id="subtaskForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Subtask Name</label>
                        <input type="text" class="form-input" id="subtaskName" placeholder="Enter subtask name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="subtaskStatus">
                            <option value="blank">Not Started</option>
                            <option value="working">Working on it</option>
                            <option value="stuck">Stuck</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign To <span style="color: #e44258;">*</span></label>
                        <select class="form-select" id="subtaskPerson" required>
                            <option value="">Select team member...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project</label>
                        <select class="form-select" id="subtaskProject">
                            <option value="">No Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="subtaskStartDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="subtaskStartDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="subtaskDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="subtaskDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSubtaskModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Subtask</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Member Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="memberModalTitle">Add Team Member</h2>
            </div>
            <form id="memberForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="memberName" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="memberEmail" placeholder="email@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" id="memberRole" placeholder="e.g., Project Manager" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="memberDepartment" required>
                            <option value="">Select department...</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Development">Development</option>
                            <option value="Design">Design</option>
                            <option value="Quality">Quality</option>
                            <option value="Security">Security</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Avatar (2 letters)</label>
                        <input type="text" class="form-input" id="memberAvatar" placeholder="e.g., SL" maxlength="2" pattern="[A-Za-z]{2}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="memberStatus" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Skills (comma separated)</label>
                        <input type="text" class="form-input" id="memberSkills" placeholder="e.g., javascript, react, node.js">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projectModalTitle">Create New Project</h2>
            </div>
            <form id="projectForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" id="projectName" placeholder="Enter project name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="projectDescription" placeholder="Project description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Type</label>
                        <select class="form-select" id="projectType">
                            <option value="Project">Project</option>
                            <option value="BAU">BAU</option>
                            <option value="Parameter">Parameter</option>
                            <option value="Support">Support</option>
                            <option value="Incident">Incident</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Health</label>
                        <select class="form-select" id="projectHealth">
                            <option value="none">None</option>
                            <option value="red">Red</option>
                            <option value="amber">Amber</option>
                            <option value="green">Green</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="projectStatus">
                            <option value="planned">Planned</option>
                            <option value="in-progress" selected>In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SDLC Phase</label>
                        <select class="form-select" id="projectSDLC">
                            <option value="Requirement">Requirement</option>
                            <option value="Design">Design</option>
                            <option value="Development" selected>Development</option>
                            <option value="Smoke Test">Smoke Test</option>
                            <option value="SIT">SIT</option>
                            <option value="UAT">UAT</option>
                            <option value="Implement">Implemented</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project Manager</label>
                        <select class="form-select" id="projectManager" multiple size="5">
                            <option value="" disabled>Loading team members...</option>
                        </select>
                        <small style="color: #676879; font-size: 12px; margin-top: 4px; display: block;">Hold Ctrl/Cmd to select multiple managers</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="projectPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="projectStartDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="projectStartDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="projectEndDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="projectEndDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Progress (%)</label>
                        <input type="number" class="form-input" id="projectProgress" min="0" max="100" value="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget (฿)</label>
                        <input type="number" class="form-input" id="projectBudget" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team Members <span style="color: #e44258;">*</span></label>
                        <select class="form-select" id="projectTeamMembers" multiple size="5" required>
                            <option value="" disabled>Loading team members...</option>
                        </select>
                        <small style="color: #676879; font-size: 12px; margin-top: 4px; display: block;">Hold Ctrl/Cmd to select multiple members (at least one required)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-input" id="projectTags" placeholder="e.g., frontend, urgent">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="projectSubmitBtn">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Change Password</h2>
            </div>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="modal-body">
                    <div id="passwordError" class="password-error-message"></div>
                    <div id="passwordSuccess" class="password-success-message"></div>

                    <div class="form-group">
                        <label class="form-label">Team Member</label>
                        <input type="text" id="passwordMemberName" class="form-input readonly-input" readonly>
                        <input type="hidden" id="passwordMemberId">
                        <input type="hidden" id="passwordMemberHasPassword">
                    </div>

                    <div class="form-group" id="currentPasswordGroup">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                        <small style="color: #676879; font-size: 12px; margin-top: 4px; display: block;">Required to change your existing password</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="Enter new password (min 4 characters)" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Re-confirm New Password</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Re-enter new password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA2My_zhJEfE_wfQ9wpu4W7o_cLKOI9PLQ",
            authDomain: "project-status-f7de8.firebaseapp.com",
            projectId: "project-status-f7de8",
            storageBucket: "project-status-f7de8.firebasestorage.app",
            messagingSenderId: "809576699201",
            appId: "1:809576699201:web:554f6cbf54200d08b6fdc0",
            measurementId: "G-61Z0HS88LR"
        };

        // Session timeout configuration (1 hour = 3600000 milliseconds)
        const SESSION_TIMEOUT = 60 * 60 * 1000; // 1 hour in milliseconds

        // ========================================
        // GUEST MODE CONFIGURATION
        // ========================================
        // Check if this is a guest access link
        function isGuestMode() {
            const params = new URLSearchParams(window.location.search);
            const guestToken = params.get('guest');
            const validGuestTokens = ['dashboard-guest-2025', 'guest-view'];
            return guestToken && validGuestTokens.includes(guestToken);
        }

        // Store guest mode in session
        const guestMode = isGuestMode();
        if (guestMode) {
            sessionStorage.setItem('guestMode', 'true');
            console.log('✅ Guest mode enabled - Dashboard view only');
        }

        // Check authentication and session timeout
        function checkSession() {
            // If guest mode, skip authentication check
            if (guestMode) {
                console.log('⏭️ Skipping authentication - guest mode active');
                return true;
            }

            const loggedInUser = sessionStorage.getItem('loggedInUser');

            if (!loggedInUser) {
                window.location.href = 'login.html';
                return false;
            }

            try {
                const currentUser = JSON.parse(loggedInUser);
                const now = Date.now();
                const lastActivity = currentUser.lastActivity || now;
                const timeSinceActivity = now - lastActivity;

                // Check if session has expired (no activity for 1 hour)
                if (timeSinceActivity > SESSION_TIMEOUT) {
                    console.log('Session expired due to inactivity');
                    sessionStorage.removeItem('loggedInUser');
                    alert('Your session has expired due to inactivity. Please login again.');
                    window.location.href = 'login.html';
                    return false;
                }

                return true;
            } catch (error) {
                console.error("Error checking session:", error);
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
                return false;
            }
        }

        // Update last activity time
        function updateActivity() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                try {
                    const currentUser = JSON.parse(loggedInUser);
                    currentUser.lastActivity = Date.now();
                    sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                } catch (error) {
                    console.error("Error updating activity:", error);
                }
            }
        }

        // Check session on page load
        if (!checkSession()) {
            // Will redirect to login if session is invalid
        }

        // Parse user data and display in header
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        let currentUser = null;
        try {
            currentUser = JSON.parse(loggedInUser);
            // Update user display in header
            const userNameEl = document.getElementById('currentUserName');
            const userAvatarEl = document.getElementById('currentUserAvatar');
            if (userNameEl && currentUser.name) {
                userNameEl.textContent = currentUser.name;
            }
            if (userAvatarEl && currentUser.name) {
                const initials = currentUser.name.split(' ').map(n => n[0]).join('');
                userAvatarEl.textContent = initials;
            }

            // Hide sidebar for all users except likit.sae-ngow@scb.co.th
            const authorizedEmail = 'likit.sae-ngow@scb.co.th';
            const sidebarElement = document.getElementById('sidebar');
            if (sidebarElement && currentUser.email !== authorizedEmail) {
                sidebarElement.style.display = 'none';
            }
        } catch (error) {
            console.error("Error parsing user data:", error);
        }

        // Track user activity - update timestamp on any interaction
        const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
        });

        // Check session every minute
        setInterval(() => {
            checkSession();
        }, 60000); // Check every 60 seconds

        // Logout function
        function logout() {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        }

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("✅ Firebase initialized successfully!");
        } catch (error) {
            console.error("❌ Firebase initialization error:", error);
        }

        // ========================================
        // DATE CONVERSION HELPER FUNCTIONS
        // ========================================

        // Update date display to show dd/mm/yyyy format
        function updateDateDisplay(inputElement) {
            if (!inputElement || !inputElement.value) return;

            const displayId = inputElement.id + '-display';
            const displayElement = document.getElementById(displayId);

            if (displayElement) {
                // Convert yyyy-mm-dd to dd/mm/yyyy for display
                const [year, month, day] = inputElement.value.split('-');
                displayElement.textContent = `${day}/${month}/${year}`;
                displayElement.classList.remove('placeholder');
            }
        }

        // Convert any date format to yyyy/mm/dd for display
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';

            // Handle slash format (dd/mm/yyyy or yyyy/mm/dd)
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length !== 3) return dateString;

                // Check if it's already yyyy/mm/dd (year is 4 digits and in first position)
                if (parts[0].length === 4) {
                    return dateString; // Already yyyy/mm/dd
                }

                // Convert from dd/mm/yyyy to yyyy/mm/dd
                const [day, month, year] = parts;
                return `${year}/${month.padStart(2, '0')}/${day.padStart(2, '0')}`;
            }

            // Handle dash format (yyyy-mm-dd)
            if (dateString.includes('-')) {
                const [year, month, day] = dateString.split('-');
                return `${year}/${month}/${day}`;
            }

            return dateString;
        }

        // Set date input value (input uses yyyy-mm-dd format from HTML5 date picker)
        function setDateInputValue(inputElement, dateString) {
            if (!inputElement || !dateString) return;

            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                // Check if yyyy/mm/dd format
                if (parts[0].length === 4) {
                    // Convert yyyy/mm/dd to yyyy-mm-dd for date input
                    const [year, month, day] = parts;
                    inputElement.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                } else {
                    // Convert dd/mm/yyyy to yyyy-mm-dd
                    const [day, month, year] = parts;
                    inputElement.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
            } else if (dateString.includes('-')) {
                // Already yyyy-mm-dd
                inputElement.value = dateString;
            } else {
                inputElement.value = dateString;
            }

            // Update the display element
            updateDateDisplay(inputElement);
        }

        // Get date from input (yyyy-mm-dd from date picker) and convert to yyyy/mm/dd for storage
        function getDateInputValue(inputElement) {
            if (!inputElement || !inputElement.value) return '';

            const value = inputElement.value.trim();
            if (!value) return '';

            // Date picker returns yyyy-mm-dd, convert to yyyy/mm/dd for storage
            if (value.includes('-')) {
                const [year, month, day] = value.split('-');
                return `${year}/${month}/${day}`;
            }

            return value;
        }

        // ========================================
        // LOADING SPINNER FUNCTIONS
        // ========================================
        function showSpinner(text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const spinnerText = document.getElementById('spinnerText');
            if (overlay) {
                if (spinnerText) spinnerText.textContent = text;
                overlay.classList.add('active');
            }
        }

        function hideSpinner() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // Modal spinner functions
        function showModalSpinner() {
            const modalSpinner = document.getElementById('modalSpinner');
            if (modalSpinner) {
                modalSpinner.classList.add('active');
            }
        }

        function hideModalSpinner() {
            const modalSpinner = document.getElementById('modalSpinner');
            if (modalSpinner) {
                modalSpinner.classList.remove('active');
            }
        }

        // ========================================
        // PASSWORD CHANGE FUNCTIONS
        // ========================================

        // Base64 encode function
        function encodePassword(password) {
            return btoa(password);
        }

        // Base64 decode function
        function decodePassword(encodedPassword) {
            try {
                return atob(encodedPassword);
            } catch (e) {
                return encodedPassword; // Return as-is if not base64
            }
        }

        // Open password change modal
        async function openChangePasswordModal(memberId, memberName) {
            const modal = document.getElementById('changePasswordModal');
            document.getElementById('passwordMemberId').value = memberId;
            document.getElementById('passwordMemberName').value = memberName;
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';

            // Hide messages using class
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            // Check if member has a password
            try {
                const memberDoc = await db.collection('team_members').doc(memberId).get();
                const memberData = memberDoc.data();
                const hasPassword = memberData && memberData.password && memberData.password !== '';

                document.getElementById('passwordMemberHasPassword').value = hasPassword ? 'true' : 'false';

                // Show/hide current password field based on whether they have a password
                const currentPasswordGroup = document.getElementById('currentPasswordGroup');
                if (hasPassword) {
                    currentPasswordGroup.style.display = 'block';
                } else {
                    currentPasswordGroup.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking password:', error);
                // Default to showing the field
                document.getElementById('currentPasswordGroup').style.display = 'block';
            }

            modal.classList.add('active');
        }

        // Close password change modal
        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.remove('active');
        }

        // Change password
        async function changePassword(event) {
            if (event) event.preventDefault();
            const memberId = document.getElementById('passwordMemberId').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            const btn = document.getElementById('changePasswordBtn');

            // Hide messages using classes
            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            // Disable button
            btn.disabled = true;
            btn.textContent = 'Changing...';

            try {
                // Get member document first to check if password exists
                const memberDoc = await db.collection('team_members').doc(memberId).get();

                if (!memberDoc.exists) {
                    errorDiv.textContent = 'Team member not found';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                const memberData = memberDoc.data();
                const hasPassword = memberData.password && memberData.password !== '';

                // If member has a password, current password is required
                if (hasPassword) {
                    if (!currentPassword) {
                        errorDiv.textContent = 'Current password is required';
                        errorDiv.classList.add('show');
                        btn.disabled = false;
                        btn.textContent = 'Change Password';
                        return;
                    }

                    let storedPassword = memberData.password;
                    // Decode if it's base64
                    storedPassword = decodePassword(storedPassword);

                    // Verify current password
                    if (currentPassword !== storedPassword) {
                        errorDiv.textContent = 'Current password is incorrect';
                        errorDiv.classList.add('show');
                        btn.disabled = false;
                        btn.textContent = 'Change Password';
                        return;
                    }
                }

                // Validate new password
                if (!newPassword || !confirmPassword) {
                    errorDiv.textContent = 'New password and confirmation are required';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'New password and confirmation do not match';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                if (newPassword.length < 4) {
                    errorDiv.textContent = 'Password must be at least 4 characters long';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                // Encode new password with base64
                const encodedNewPassword = encodePassword(newPassword);

                // Update password in Firestore
                await db.collection('team_members').doc(memberId).update({
                    password: encodedNewPassword,
                    passwordUpdatedAt: new Date().toISOString()
                });

                // Success
                successDiv.textContent = 'Password changed successfully!';
                successDiv.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Change Password';

                // Clear form
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                // Close modal after 2 seconds
                setTimeout(() => {
                    closeChangePasswordModal();
                }, 2000);

            } catch (error) {
                console.error('Error changing password:', error);
                errorDiv.textContent = 'Failed to change password: ' + error.message;
                errorDiv.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Change Password';
            }
        }

        // ========================================
        // FIRESTORE FUNCTIONS
        // ========================================

        // Render team members in the UI
        function renderTeamMembers(members) {
            const teamGrid = document.querySelector('.team-grid');
            if (!teamGrid) return;

            const gradients = [
                'linear-gradient(135deg, #667eea, #764ba2)',
                'linear-gradient(135deg, #f093fb, #f5576c)',
                'linear-gradient(135deg, #4facfe, #00f2fe)',
                'linear-gradient(135deg, #43e97b, #38f9d7)',
                'linear-gradient(135deg, #fa709a, #fee140)',
                'linear-gradient(135deg, #ffecd2, #fcb69f)',
                'linear-gradient(135deg, #a1c4fd, #c2e9fb)',
                'linear-gradient(135deg, #d299c2, #fef9d7)'
            ];

            // Filter out inactive members
            const activeMembers = members.filter(member => {
                const status = member.status || 'Active';
                return status.toLowerCase() !== 'inactive';
            });

            teamGrid.innerHTML = activeMembers.map((member, index) => `
                <div class="team-card" data-member-id="${member.id}">
                    <button class="team-edit-btn" data-action="edit-member" data-member-index="${index}" title="Edit member">
                        ✏️
                    </button>
                    <div class="team-avatar-large" style="background: ${gradients[index % gradients.length]};">
                        ${member.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div class="team-name">${member.name}</div>
                    <div class="team-role">${member.role}</div>
                    <div class="team-status ${member.status === 'Active' ? 'active' : 'inactive'}">
                        ${member.status || 'Active'}
                    </div>
                    <div class="team-stats">
                        <div class="team-stat clickable-stat" data-action="filter-remaining" data-member-id="${member.id}" data-member-name="${member.name}">
                            <div class="team-stat-value">${member.remainingCount || 0}</div>
                            <div class="team-stat-label">Remain</div>
                        </div>
                        <div class="team-stat">
                            <div class="team-stat-value">${member.doneCount || 0}</div>
                            <div class="team-stat-label">Done</div>
                        </div>
                        <div class="team-stat">
                            <div class="team-stat-value">${member.inProgressProjects ? member.inProgressProjects.length : 0}</div>
                            <div class="team-stat-label">Project</div>
                        </div>
                    </div>
                    <button class="change-password-btn" onclick="openChangePasswordModal('${member.id}', '${member.name}')" title="Change Password">
                        🔐 Change Password
                    </button>
                </div>
            `).join('');

            // Add event listeners to edit buttons
            document.querySelectorAll('[data-action="edit-member"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-member-index'));
                    editMember(activeMembers[index], index);
                });
            });

            // Add event listeners to "Remain" stat
            document.querySelectorAll('[data-action="filter-remaining"]').forEach(stat => {
                stat.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const memberId = this.getAttribute('data-member-id');
                    const memberName = this.getAttribute('data-member-name');
                    filterRemainingTasksByMember(memberId, memberName);
                });
            });
        }

        // Store current members for editing
        let currentTeamMembers = [];

        // Load team members with real task counts
        async function loadTeamMembersWithStats() {
            if (!db) return;

            showSpinner('Loading team members...');

            try {
                const membersSnapshot = await db.collection('team_members').get();
                const tasksSnapshot = await db.collection('tasks').get();
                const projectsSnapshot = await db.collection('projects').get();

                const teamMembers = [];

                for (const memberDoc of membersSnapshot.docs) {
                    const memberData = memberDoc.data();
                    const memberId = memberDoc.id;

                    // Count tasks for this member by ID
                    let totalTasks = 0;
                    let doneTasks = 0;

                    tasksSnapshot.forEach(taskDoc => {
                        const task = taskDoc.data();
                        // Check both assignedTo (ID) and person (name) for backwards compatibility
                        if (task.assignedTo === memberId || task.person === memberData.name) {
                            totalTasks++;
                            if (task.status === 'done') {
                                doneTasks++;
                            }
                        }
                    });

                    // Find in-progress projects this member is part of
                    const inProgressProjects = [];
                    projectsSnapshot.forEach(projectDoc => {
                        const project = projectDoc.data();
                        // Check if member is in teamMemberIds or teamMembers (name-based)
                        const isMemberInProject =
                            (project.teamMemberIds && project.teamMemberIds.includes(memberId)) ||
                            (project.teamMembers && project.teamMembers.includes(memberData.name));

                        // Only include in-progress projects
                        if (isMemberInProject && project.status === 'in-progress') {
                            inProgressProjects.push({
                                id: projectDoc.id,
                                name: project.name,
                                progress: project.progress || 0
                            });
                        }
                    });

                    teamMembers.push({
                        id: memberDoc.id,
                        ...memberData,
                        tasksCount: totalTasks,
                        doneCount: doneTasks,
                        remainingCount: totalTasks - doneTasks,  // Calculate remaining tasks
                        inProgressProjects: inProgressProjects  // Add in-progress projects
                    });
                }

                currentTeamMembers = teamMembers;
                renderTeamMembers(teamMembers);
                console.log(`✅ Loaded ${teamMembers.length} team members with real task counts and projects`);

            } catch (error) {
                console.error("❌ Error loading team members:", error);
            } finally {
                hideSpinner();
            }
        }

        // Load active team members for dropdown
        async function loadActiveTeamMembers() {
            if (!db) {
                console.error("❌ Firebase not initialized");
                return [];
            }

            try {
                // First, try to get all team members (more reliable)
                const snapshot = await db.collection('team_members').get();

                console.log(`📊 Found ${snapshot.size} total team members in database`);

                const activeMembers = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`👤 Member: ${data.name}, active: ${data.active}, status: ${data.status}`);

                    // Include member if:
                    // 1. active field is explicitly true, OR
                    // 2. status field is 'Active', OR
                    // 3. neither field exists (assume active by default)
                    const isActive = data.active === true ||
                                   data.status === 'Active' ||
                                   (data.active === undefined && data.status === undefined);

                    if (isActive && data.name) {
                        activeMembers.push({
                            id: doc.id,
                            name: data.name
                        });
                    }
                });

                // Sort alphabetically by name
                activeMembers.sort((a, b) => a.name.localeCompare(b.name));

                console.log(`✅ Loaded ${activeMembers.length} active team members for dropdown`);
                return activeMembers;

            } catch (error) {
                console.error("❌ Error loading team members:", error);
                return [];
            }
        }

        // Get member name by ID
        async function getMemberNameById(memberId) {
            if (!db || !memberId) return 'Unknown';
            
            try {
                const doc = await db.collection('team_members').doc(memberId).get();
                if (doc.exists) {
                    return doc.data().name;
                }
                return 'Unknown';
            } catch (error) {
                console.error("❌ Error getting member name:", error);
                return 'Unknown';
            }
        }

        // Populate assign to dropdown
        async function populateAssignToDropdown() {
            console.log('🔄 populateAssignToDropdown() called');

            const personSelect = document.getElementById('itemPerson');
            if (!personSelect) {
                console.error('❌ itemPerson select element not found!');
                return;
            }

            console.log('✅ Found itemPerson select element');

            // Show loading state
            personSelect.innerHTML = '<option value="" disabled>Loading active members...</option>';
            console.log('⏳ Loading state set, calling loadActiveTeamMembers()...');

            // Get active members with IDs
            const activeMembers = await loadActiveTeamMembers();
            console.log('📦 Received activeMembers array:', activeMembers);

            if (activeMembers.length === 0) {
                personSelect.innerHTML = '<option value="" disabled>No team members found</option>';
                console.warn("⚠️ No active team members found in database");

                // Provide helpful guidance
                const shouldInit = confirm(
                    '⚠️ No team members found!\n\n' +
                    'You need to add team members before creating tasks.\n\n' +
                    'Options:\n' +
                    '1. Click "OK" to initialize sample data (includes sample team members)\n' +
                    '2. Click "Cancel" to manually add team members via the Team page\n\n' +
                    'Initialize sample data now?'
                );

                if (shouldInit) {
                    // Close the task modal
                    closeModal();
                    // Initialize sample data
                    await initializeAllSampleData();
                } else {
                    // Close task modal and navigate to team page
                    closeModal();
                    navigateTo('team');
                }
                return;
            }

            // Clear current options (no placeholder needed for multi-select)
            personSelect.innerHTML = '';

            // Add active members with ID as value
            activeMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;  // Store member ID
                option.textContent = member.name;  // Show member name
                option.setAttribute('data-member-name', member.name);
                personSelect.appendChild(option);
            });

            console.log(`✅ Populated dropdown with ${activeMembers.length} active members`);
        }

        // Populate project dropdown for task form
        async function populateTaskProjectDropdown() {
            console.log('🔄 populateTaskProjectDropdown() called');
            const projectSelect = document.getElementById('itemProject');

            if (!projectSelect) {
                console.error('❌ itemProject select element not found!');
                return;
            }

            // Show loading state
            projectSelect.innerHTML = '<option value="">Loading projects...</option>';

            if (!db) {
                console.error('❌ Firebase not initialized');
                projectSelect.innerHTML = '<option value="">No Project</option>';
                return;
            }

            try {
                const snapshot = await db.collection('projects').get();
                console.log(`📦 Found ${snapshot.size} projects in database`);

                // Clear and add default option
                projectSelect.innerHTML = '<option value="">No Project</option>';

                if (snapshot.empty) {
                    console.warn('⚠️ No projects found in database');
                    return;
                }

                // Add projects to dropdown
                let addedCount = 0;
                snapshot.forEach(doc => {
                    const project = doc.data();
                    if (project.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;  // Store project ID
                        option.textContent = project.name;  // Show project name
                        option.setAttribute('data-project-name', project.name);
                        projectSelect.appendChild(option);
                        addedCount++;
                        console.log(`📁 Added project: ${project.name}`);
                    }
                });

                console.log(`✅ Populated project dropdown with ${addedCount} projects`);

            } catch (error) {
                console.error('❌ Error loading projects for dropdown:', error);
                projectSelect.innerHTML = '<option value="">No Project</option>';
            }
        }

        // Get project name by ID
        async function getProjectNameById(projectId) {
            if (!db || !projectId) return '';

            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    return doc.data().name;
                }
                return '';
            } catch (error) {
                console.error('❌ Error getting project name:', error);
                return '';
            }
        }

        // Initialize ALL sample data (tasks, team members, workspaces, projects)
        async function initializeAllSampleData() {
            if (!db) {
                alert("❌ Firebase is not connected. Please check your configuration.");
                return;
            }

            const btn = document.getElementById('initDataBtn');
            const btnIcon = document.getElementById('initBtnIcon');
            const btnText = document.getElementById('initBtnText');
            
            // Show loading state
            btn.classList.add('loading');
            btnIcon.textContent = '⏳';
            btnText.textContent = 'Initializing...';

            try {
                // Check if data already exists
                const tasksSnapshot = await db.collection('tasks').limit(1).get();
                const membersSnapshot = await db.collection('team_members').limit(1).get();
                const workspacesSnapshot = await db.collection('workspaces').limit(1).get();
                const projectsSnapshot = await db.collection('projects').limit(1).get();

                let addedCount = 0;

                // ========== TASKS ==========
                if (tasksSnapshot.empty) {
                    console.log("📦 Adding sample tasks...");
                    const sampleTasks = [
                        { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', project: 'Website Redesign', date: '2025-11-15', timeline: '3 weeks', workspace: 'Marketing', category: 'Design', tags: ['design', 'frontend', 'urgent'] },
                        { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', project: 'Mobile App Development', date: '2025-12-01', timeline: '6 weeks', workspace: 'Development', category: 'Development', tags: ['mobile', 'ios', 'android'] },
                        { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', project: 'Marketing Campaign Q4', date: '2025-10-20', timeline: '2 weeks', workspace: 'Marketing', category: 'Marketing', tags: ['campaign', 'social-media'] },
                        { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', project: 'Database Infrastructure', date: '2025-11-30', timeline: '4 weeks', workspace: 'Development', category: 'Backend', tags: ['database', 'backend', 'critical'] },
                        { name: 'Customer Portal', status: 'working', priority: 'medium', person: 'Jordan Park', project: 'Website Redesign', date: '2025-11-25', timeline: '5 weeks', workspace: 'Development', category: 'Frontend', tags: ['portal', 'customer', 'dashboard'] },
                        { name: 'API Integration', status: 'blank', priority: 'low', person: 'Taylor Wong', project: 'Mobile App Development', date: '2025-12-15', timeline: '3 weeks', workspace: 'Development', category: 'Backend', tags: ['api', 'integration'] },
                        { name: 'User Testing', status: 'working', priority: 'medium', person: 'Chris Davis', project: 'Website Redesign', date: '2025-11-10', timeline: '1 week', workspace: 'Design', category: 'QA', tags: ['testing', 'ux', 'feedback'] },
                        { name: 'Security Audit', status: 'done', priority: 'high', person: 'Morgan Lee', project: 'Database Infrastructure', date: '2025-10-15', timeline: '2 weeks', workspace: 'Development', category: 'Security', tags: ['security', 'audit', 'compliance'] }
                    ];

                    for (const task of sampleTasks) {
                        await db.collection('tasks').add({
                            ...task,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleTasks.length} tasks`);
                }

                // ========== TEAM MEMBERS ==========
                if (membersSnapshot.empty) {
                    console.log("📦 Adding team members...");
                    const sampleMembers = [
                        { name: 'Sarah Lee', email: 'sarah.lee@company.com', role: 'Project Manager', department: 'Marketing', avatar: 'SL', status: 'Active', active: true, skills: ['management', 'planning', 'coordination'] },
                        { name: 'Mike Chen', email: 'mike.chen@company.com', role: 'Lead Developer', department: 'Development', avatar: 'MC', status: 'Active', active: true, skills: ['javascript', 'react', 'node.js'] },
                        { name: 'Emily Rose', email: 'emily.rose@company.com', role: 'Marketing Lead', department: 'Marketing', avatar: 'ER', status: 'Active', active: true, skills: ['marketing', 'analytics', 'content'] },
                        { name: 'Alex Kim', email: 'alex.kim@company.com', role: 'Database Administrator', department: 'Development', avatar: 'AK', status: 'Active', active: true, skills: ['sql', 'postgresql', 'mongodb'] },
                        { name: 'Jordan Park', email: 'jordan.park@company.com', role: 'UI/UX Designer', department: 'Design', avatar: 'JP', status: 'Active', active: true, skills: ['figma', 'sketch', 'prototyping'] },
                        { name: 'Taylor Wong', email: 'taylor.wong@company.com', role: 'Backend Developer', department: 'Development', avatar: 'TW', status: 'Active', active: true, skills: ['python', 'django', 'api'] },
                        { name: 'Chris Davis', email: 'chris.davis@company.com', role: 'QA Engineer', department: 'Quality', avatar: 'CD', status: 'Active', active: true, skills: ['testing', 'automation', 'selenium'] },
                        { name: 'Morgan Lee', email: 'morgan.lee@company.com', role: 'Security Analyst', department: 'Security', avatar: 'ML', status: 'Inactive', active: false, skills: ['security', 'penetration-testing', 'compliance'] }
                    ];

                    for (const member of sampleMembers) {
                        await db.collection('team_members').add({
                            ...member,
                            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleMembers.length} team members`);
                }

                // ========== WORKSPACES ==========
                if (workspacesSnapshot.empty) {
                    console.log("📦 Adding workspaces...");
                    const sampleWorkspaces = [
                        { name: 'Marketing', icon: '🎯', color: '#667eea', description: 'Marketing team workspace', memberCount: 3, taskCount: 5, active: true },
                        { name: 'Development', icon: '💻', color: '#764ba2', description: 'Development team workspace', memberCount: 5, taskCount: 8, active: true },
                        { name: 'Design', icon: '🎨', color: '#f093fb', description: 'Design team workspace', memberCount: 2, taskCount: 4, active: true },
                        { name: 'Mobile', icon: '📱', color: '#4facfe', description: 'Mobile app development workspace', memberCount: 4, taskCount: 6, active: true }
                    ];

                    for (const workspace of sampleWorkspaces) {
                        await db.collection('workspaces').add({
                            ...workspace,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleWorkspaces.length} workspaces`);
                }

                // ========== PROJECTS ==========
                if (projectsSnapshot.empty) {
                    console.log("📦 Adding projects...");
                    const sampleProjects = [
                        { name: 'Website Redesign', description: 'Complete redesign of company website', status: 'in-progress', priority: 'high', workspace: 'Marketing', startDate: '2025-10-01', endDate: '2025-11-30', progress: 75, budget: 50000, teamMembers: ['Sarah Lee', 'Jordan Park'], tags: ['website', 'design', 'frontend'] },
                        { name: 'Mobile App Development', description: 'iOS and Android app development', status: 'in-progress', priority: 'high', workspace: 'Development', startDate: '2025-09-15', endDate: '2025-12-31', progress: 60, budget: 120000, teamMembers: ['Mike Chen', 'Taylor Wong'], tags: ['mobile', 'app', 'ios', 'android'] },
                        { name: 'Marketing Campaign Q4', description: 'Q4 2025 marketing campaign', status: 'completed', priority: 'medium', workspace: 'Marketing', startDate: '2025-09-01', endDate: '2025-10-20', progress: 100, budget: 30000, teamMembers: ['Emily Rose'], tags: ['campaign', 'marketing', 'q4'] },
                        { name: 'Database Infrastructure', description: 'Database migration and optimization', status: 'in-progress', priority: 'high', workspace: 'Development', startDate: '2025-10-15', endDate: '2025-12-15', progress: 30, budget: 80000, teamMembers: ['Alex Kim', 'Taylor Wong'], tags: ['database', 'infrastructure', 'migration'] }
                    ];

                    for (const project of sampleProjects) {
                        await db.collection('projects').add({
                            ...project,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleProjects.length} projects`);
                }

                // Success feedback
                if (addedCount > 0) {
                    btnIcon.textContent = '✅';
                    btnText.textContent = `Added ${addedCount} items!`;
                    btn.classList.remove('loading');
                    btn.classList.add('success');
                    
                    // Reload data
                    await loadTasksFromFirebase();
                    
                    alert(`✅ Successfully initialized!\n\n📊 Added ${addedCount} items to Firebase:\n- Tasks\n- Team Members\n- Workspaces\n- Projects\n\nCheck Firebase Console to see all your data!`);
                    
                    // Hide button after 3 seconds
                    setTimeout(() => {
                        btn.style.display = 'none';
                    }, 3000);
                } else {
                    btnIcon.textContent = 'ℹ️';
                    btnText.textContent = 'Data Already Exists';
                    btn.classList.remove('loading');
                    
                    alert('ℹ️ Sample data already exists in Firebase.\n\nAll collections are populated. Check Firebase Console to view your data.');
                    
                    setTimeout(() => {
                        btnIcon.textContent = '📦';
                        btnText.textContent = 'Initialize Sample Data';
                    }, 3000);
                }

            } catch (error) {
                console.error("❌ Error initializing data:", error);
                btnIcon.textContent = '❌';
                btnText.textContent = 'Error!';
                btn.classList.remove('loading');
                
                alert(`❌ Error initializing data:\n\n${error.message}\n\nCheck console for details.`);
                
                setTimeout(() => {
                    btnIcon.textContent = '📦';
                    btnText.textContent = 'Initialize Sample Data';
                    btn.classList.remove('success');
                }, 3000);
            }
        }

        // Initialize sample data in Firebase (run once) - LEGACY FUNCTION
        async function initializeSampleData() {
            if (!db) return;

            const sampleTasks = [
                { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', date: '2025-11-15', timeline: '3 weeks', workspace: 'Marketing' },
                { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', date: '2025-12-01', timeline: '6 weeks', workspace: 'Development' },
                { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', date: '2025-10-20', timeline: '2 weeks', workspace: 'Marketing' },
                { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', date: '2025-11-30', timeline: '4 weeks', workspace: 'Development' }
            ];

            try {
                // Check if tasks already exist
                const snapshot = await db.collection('tasks').limit(1).get();
                
                if (snapshot.empty) {
                    console.log("📦 Initializing sample data...");
                    
                    for (const task of sampleTasks) {
                        await db.collection('tasks').add({
                            ...task,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    console.log("✅ Sample data initialized!");
                } else {
                    console.log("ℹ️ Data already exists in Firebase");
                }
            } catch (error) {
                console.error("❌ Error initializing data:", error);
            }
        }

        // Prevent concurrent loading
        let isLoadingTasks = false;
        let isLoadingProjects = false; // Prevent concurrent project loading

        // Load all tasks from Firestore
        async function loadTasksFromFirebase() {
            if (!db) {
                console.warn("Firebase not initialized, using local data");
                return;
            }

            // Prevent concurrent loading
            if (isLoadingTasks) {
                console.log("⏭️ Task loading already in progress, skipping...");
                return;
            }

            isLoadingTasks = true;
            showSpinner('Loading tasks...');
            console.log("📥 Loading tasks from Firebase...");

            try {
                // Fetch all data in parallel for better performance
                const [tasksSnapshot, membersSnapshot, projectsSnapshot] = await Promise.all([
                    db.collection('tasks').orderBy('createdAt', 'desc').get(),
                    db.collection('team_members').get(),
                    db.collection('projects').get()
                ]);

                // Create lookup maps for fast access
                const membersMap = {};
                membersSnapshot.forEach(doc => {
                    membersMap[doc.id] = doc.data().name;
                });

                const projectsMap = {};
                projectsSnapshot.forEach(doc => {
                    projectsMap[doc.id] = doc.data().name;
                });

                // Clear tasks array to prevent duplicates
                tasks = [];

                // Process tasks with cached data (no more individual Firebase calls!)
                tasksSnapshot.forEach(doc => {
                    const taskData = doc.data();

                    // Get member name from map (much faster!)
                    let personName = taskData.person;
                    if (taskData.assignedTo && membersMap[taskData.assignedTo]) {
                        personName = membersMap[taskData.assignedTo];
                    }

                    // Get project name from map (much faster!)
                    let projectName = taskData.project || '';
                    if (taskData.projectId && projectsMap[taskData.projectId]) {
                        projectName = projectsMap[taskData.projectId];
                    }

                    tasks.push({
                        id: doc.id,
                        ...taskData,
                        personName: personName,      // Store display name
                        project: projectName         // Store real-time project name
                    });
                });

                // Check if any filters are active and re-apply them
                // Reset allTasks when loading fresh data
                allTasks = [];

                // Populate filter dropdowns now that tasks are loaded
                populateFilterDropdowns();

                const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '');

                if (hasActiveFilters || currentProjectFilter) {
                    console.log(`🔄 Re-applying active filters`);
                    applyTaskFilters();
                } else if (isMyTasksActive) {
                    console.log(`🔄 Re-applying My Tasks filter`);
                    toggleMyTasks();
                    toggleMyTasks(); // Toggle twice to refresh with new data
                } else {
                    renderTasks();
                }

                updateDashboardStats();
                console.log(`✅ Loaded ${tasks.length} tasks from Firebase (optimized batch loading)`);
            } catch (error) {
                console.error("❌ Error loading tasks:", error);
            } finally {
                isLoadingTasks = false;
                hideSpinner();
            }
        }

        // Add task to Firestore
        async function addTaskToFirebase(task) {
            if (!db) return;

            try {
                const docRef = await db.collection('tasks').add({
                    ...task,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log("✅ Task added with ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("❌ Error adding task:", error);
            }
        }

        // Update task in Firestore
        async function updateTaskInFirebase(taskId, taskData) {
            if (!db) return;

            try {
                await db.collection('tasks').doc(taskId).update({
                    ...taskData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log("✅ Task updated:", taskId);
            } catch (error) {
                console.error("❌ Error updating task:", error);
            }
        }

        // Delete task from Firestore
        async function deleteTaskFromFirebase(taskId) {
            if (!db) return;

            try {
                await db.collection('tasks').doc(taskId).delete();
                console.log("✅ Task deleted:", taskId);
            } catch (error) {
                console.error("❌ Error deleting task:", error);
            }
        }

        // Real-time listener for tasks
        let realtimeListenerUnsubscribe = null;

        // Flag to skip initial snapshot from realtime listener
        let isInitialSnapshot = true;

        function setupRealtimeListener() {
            if (!db) return;

            // Prevent setting up multiple listeners
            if (realtimeListenerUnsubscribe) {
                console.log("⏭️ Real-time listener already set up, skipping...");
                return;
            }

            console.log("📡 Setting up real-time listener...");
            realtimeListenerUnsubscribe = db.collection('tasks').onSnapshot(async (snapshot) => {
                // Skip the initial snapshot (data already loaded)
                if (isInitialSnapshot) {
                    console.log("⏭️ Skipping initial snapshot (data already loaded)");
                    isInitialSnapshot = false;
                    return;
                }

                // Skip if we're in the middle of a manual operation
                if (isManualOperation) {
                    console.log("⏭️ Skipping real-time update (manual operation in progress)");
                    return;
                }

                const changes = snapshot.docChanges();
                if (changes.length > 0) {
                    console.log("📡 Real-time update detected, reloading tasks...");
                    await loadTasksFromFirebase();
                    await loadSubtasksFromFirebase();

                    // Reload team members if on team page
                    const teamPage = document.getElementById('teamPage');
                    if (teamPage && teamPage.classList.contains('active')) {
                        await loadTeamMembersWithStats();
                    }
                }
            });
        }

        // ========================================
        // APPLICATION CODE
        // ========================================

        let tasks = [
            { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', date: '2025-11-15', timeline: '3 weeks' },
            { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', date: '2025-12-01', timeline: '6 weeks' },
            { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', date: '2025-10-20', timeline: '2 weeks' },
            { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', date: '2025-11-30', timeline: '4 weeks' },
            { name: 'Customer Portal', status: 'working', priority: 'medium', person: 'Jordan Park', date: '2025-11-25', timeline: '5 weeks' },
            { name: 'API Integration', status: 'blank', priority: 'low', person: 'Taylor Wong', date: '2025-12-15', timeline: '3 weeks' },
            { name: 'User Testing', status: 'working', priority: 'medium', person: 'Chris Davis', date: '2025-11-10', timeline: '1 week' },
            { name: 'Security Audit', status: 'done', priority: 'high', person: 'Morgan Lee', date: '2025-10-15', timeline: '2 weeks' }
        ];

        let projects = [
            {
                name: 'Website Redesign',
                description: 'Complete overhaul of company website with modern design',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-10-01',
                endDate: '2025-12-31',
                progress: 75,
                budget: 50000,
                teamMembers: ['Sarah Lee', 'Mike Chen'],
                tags: ['design', 'frontend', 'urgent']
            },
            {
                name: 'Mobile App Development',
                description: 'Build native mobile app for iOS and Android',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-09-15',
                endDate: '2025-12-15',
                progress: 60,
                budget: 120000,
                teamMembers: ['Mike Chen', 'Taylor Wong'],
                tags: ['mobile', 'development']
            },
            {
                name: 'Marketing Campaign Q4',
                description: 'Q4 marketing initiatives and social media campaigns',
                status: 'completed',
                priority: 'medium',
                startDate: '2025-10-01',
                endDate: '2025-10-31',
                progress: 100,
                budget: 30000,
                teamMembers: ['Emily Rose'],
                tags: ['marketing', 'social-media']
            },
            {
                name: 'Database Infrastructure',
                description: 'Database migration and optimization project',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-10-15',
                endDate: '2025-12-15',
                progress: 30,
                budget: 80000,
                teamMembers: ['Alex Kim', 'Taylor Wong'],
                tags: ['database', 'infrastructure', 'backend']
            }
        ];

        let editingIndex = -1;
        let editingProjectIndex = -1;
        let isManualOperation = false;  // Flag to prevent listener conflicts

        function toggleSection(sectionName) {
            const section = event.currentTarget.closest('.sidebar-section');
            const arrow = document.getElementById(sectionName + 'Arrow');
            
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                arrow.textContent = '▶';
            } else {
                arrow.textContent = '▼';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('collapseIcon');
            sidebar.classList.toggle('collapsed');
            icon.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
        }

        function switchPage(pageName, skipFilterClear = false) {
            // In guest mode, only allow dashboard page
            if (guestMode && pageName !== 'dashboard') {
                console.log('⛔ Guest mode: Cannot access ' + pageName + ' page');
                alert('Guest access is limited to Dashboard only');
                switchPage('dashboard');
                return;
            }

            const pages = ['dashboard', 'projectslist', 'tasks', 'team', 'reports'];
            pages.forEach(p => {
                const page = document.getElementById(p + 'Page');
                if (page) page.classList.remove('active');
            });

            const targetPage = document.getElementById(pageName + 'Page');
            if (targetPage) targetPage.classList.add('active');

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            // Find and activate the correct nav button based on pageName
            // This works whether switchPage() is called from a click event or programmatically
            const navButtons = Array.from(navTabs);
            const targetButton = navButtons.find(btn => {
                const btnText = btn.textContent.trim().toLowerCase();
                const targetText = pageName === 'projectslist' ? 'projects' : pageName;
                return btnText === targetText;
            });
            if (targetButton) {
                targetButton.classList.add('active');
                console.log(`✅ Activated nav button: ${targetButton.textContent.trim()}`);
            }

            // Reload data when switching to specific pages
            if (pageName === 'tasks' && db) {
                // Clear filter only if not coming from viewProjectTasks
                if (!skipFilterClear) {
                    // Hide filter panel and clear all filters when navigating directly to tasks
                    const panel = document.getElementById('taskFilterPanel');
                    if (panel) {
                        panel.style.display = 'none';
                    }
                    clearAllTaskFilters();
                }
                loadTasksFromFirebase();
            } else if (pageName === 'team' && db) {
                loadTeamMembersWithStats();
            } else if (pageName === 'dashboard') {
                updateDashboardStats();
            } else if (pageName === 'projectslist') {
                if (db) {
                    loadProjectsFromFirebase();
                } else {
                    renderProjects();
                }
            }
        }

        function updateDashboardStats() {
            console.log('📊 Updating dashboard with real-time data...');

            // Get filtered projects based on chart selections
            let filteredProjects = [...projects];

            // Apply project type filter from chart
            if (chartTypeFilter) {
                filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            }

            // Apply health filter from chart
            if (chartHealthFilter) {
                filteredProjects = filteredProjects.filter(p => {
                    const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                    return projectHealth === chartHealthFilter;
                });
            }

            // Get project names from filtered projects
            const filteredProjectNames = filteredProjects.map(p => p.name);

            // Filter tasks by selected projects (if filters are active)
            let tasksToCount = tasks;
            if (chartTypeFilter || chartHealthFilter) {
                tasksToCount = tasks.filter(t => filteredProjectNames.includes(t.project));
            }

            // Update task statistics
            const totalTasks = tasksToCount.length;
            const workingTasks = tasksToCount.filter(t => t.status === 'working').length;
            const doneTasks = tasksToCount.filter(t => t.status === 'done').length;
            const stuckTasks = tasksToCount.filter(t => t.status === 'stuck').length;

            // document.getElementById('totalItems').textContent = totalTasks;
            // document.getElementById('workingItems').textContent = workingTasks;
            // document.getElementById('doneItems').textContent = doneTasks;
            // document.getElementById('stuckItems').textContent = stuckTasks;

            console.log(`✅ Task stats: ${totalTasks} total, ${workingTasks} in progress, ${doneTasks} done, ${stuckTasks} stuck`);

            // Update project progress
            renderProjectProgress();

            // Update key metrics
            renderKeyMetrics();

            // Update project type, health, and manager charts
            renderProjectTypeChart();
            renderProjectHealthChart();
            renderProjectManagerChart();

            // Update additional dashboard charts
            renderProjectStatusChart();
            renderProjectPriorityChart();
            renderProjectSDLCChart();
            renderProjectProgressDistChart();
            renderProjectTimelineChart();
            renderProjectForecastChart();
            renderProjectWorkloadChart();

            // Update alerts
            renderBottleneckAlerts();

            // Setup click-outside detection for charts
            setupChartClickOutside();

            // Update recent activity
            renderRecentActivity();
        }

        // Render project progress on dashboard
        function renderProjectProgress() {
            const progressList = document.getElementById('projectProgressList');
            if (!progressList) return;

            if (projects.length === 0) {
                progressList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No projects found</div>';
                return;
            }

            // Apply chart filters to projects
            let filteredProjects = [...projects];

            // Apply project type filter from chart
            if (chartTypeFilter) {
                filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            }

            // Apply health filter from chart
            if (chartHealthFilter) {
                filteredProjects = filteredProjects.filter(p => {
                    const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                    return projectHealth === chartHealthFilter;
                });
            }

            // Sort by progress (incomplete first, then by priority)
            const sortedProjects = filteredProjects
                .filter(p => p.name && p.progress !== undefined)
                .sort((a, b) => {
                    // Show incomplete projects first
                    if (a.progress < 100 && b.progress >= 100) return -1;
                    if (a.progress >= 100 && b.progress < 100) return 1;
                    // Then by progress percentage
                    return b.progress - a.progress;
                })
                .slice(0, 6); // Show top 6 projects

            progressList.innerHTML = sortedProjects.map(project => {
                const progress = project.progress || 0;
                let barColor = '#0073ea'; // Default blue

                if (progress === 100) {
                    barColor = '#00c875'; // Green for complete
                } else if (progress < 30) {
                    barColor = '#e44258'; // Red for low progress
                } else if (progress < 60) {
                    barColor = '#fdab3d'; // Orange for medium
                }

                // Get project manager name (first manager if multiple)
                const managerName = (project.projectManagers && project.projectManagers.length > 0)
                    ? project.projectManagers[0]
                    : '';

                // Display project name with manager name
                const displayName = managerName
                    ? `${project.name} (${managerName})`
                    : project.name;

                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-name">${displayName}</span>
                            <span class="progress-percentage">${progress}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progress}%; background: ${barColor}"></div>
                        </div>
                    </div>
                `;
            }).join('');

            console.log(`✅ Rendered ${sortedProjects.length} projects on dashboard`);
        }

        // Global chart instances
        let projectTypeChartInstance = null;
        let projectHealthChartInstance = null;
        let projectManagerChartInstance = null;

        // Render project type grouping chart
        function renderProjectTypeChart() {
            const canvas = document.getElementById('projectTypeChartCanvas');
            if (!canvas) return;

            if (projects.length === 0) {
                document.getElementById('projectTypeChart').style.display = 'block';
                document.getElementById('projectTypeChart').innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No projects found</div>';
                return;
            }

            // Get projects filtered by current health and manager filters (if any)
            let projectsToAnalyze = projects;
            if (chartHealthFilter) {
                projectsToAnalyze = projectsToAnalyze.filter(p => {
                    const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                    return projectHealth === chartHealthFilter;
                });
            }
            if (chartManagerFilter) {
                projectsToAnalyze = projectsToAnalyze.filter(p =>
                    p.projectManagers && p.projectManagers.includes(chartManagerFilter)
                );
            }

            // Group projects by type based on filtered data
            const typeGroups = {};
            projectsToAnalyze.forEach(project => {
                const type = project.projectType || 'Unknown';
                if (!typeGroups[type]) {
                    typeGroups[type] = 0;
                }
                typeGroups[type]++;
            });

            const sortedData = Object.entries(typeGroups)
                .sort((a, b) => b[1] - a[1]);

            const labels = sortedData.map(([type, _]) => type);
            const data = sortedData.map(([_, count]) => count);

            // PowerBI-style colors
            const colors = [
                '#0073ea', '#00c875', '#fdab3d', '#ff5555',
                '#a367e8', '#00bcd4', '#ff9800', '#9c27b0',
                '#e91e63', '#009688'
            ];

            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            if (projectTypeChartInstance) {
                projectTypeChartInstance.destroy();
            }

            projectTypeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length).map((color, index) => {
                            // If a filter is active, fade out non-selected items
                            if (chartTypeFilter && labels[index] !== chartTypeFilter) {
                                return color + '40'; // Add transparency (40 = 25% opacity)
                            }
                            return color;
                        }),
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverBorderWidth: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            const clickedIndex = activeElements[0].index;
                            const selectedType = labels[clickedIndex];

                            // Toggle filter
                            if (chartTypeFilter === selectedType) {
                                // Clear filter if clicking the same element
                                chartTypeFilter = null;
                            } else {
                                chartTypeFilter = selectedType;
                            }

                            // Apply chart-based filter
                            applyChartFilters();
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 13, weight: '500' },
                                color: '#323338',
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                cursor: 'pointer'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            padding: 12,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    const selectedInfo = chartTypeFilter === context.label ? ' (FILTERED)' : '';
                                    return `${context.label}: ${context.parsed} (${percentage}%)${selectedInfo}`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest'
                    }
                }
            });

            document.getElementById('projectTypeChart').style.display = 'none';
            console.log(`✅ Rendered project type chart with ${labels.length} types`);
        }

        // Render project health grouping chart
        function renderProjectHealthChart() {
            const canvas = document.getElementById('projectHealthChartCanvas');
            if (!canvas) return;

            if (projects.length === 0) {
                document.getElementById('projectHealthChart').style.display = 'block';
                document.getElementById('projectHealthChart').innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No projects found</div>';
                return;
            }

            // Get projects filtered by current type and manager filters (if any)
            let projectsToAnalyze = projects;
            if (chartTypeFilter) {
                projectsToAnalyze = projectsToAnalyze.filter(p => p.projectType === chartTypeFilter);
            }
            if (chartManagerFilter) {
                projectsToAnalyze = projectsToAnalyze.filter(p =>
                    p.projectManagers && p.projectManagers.includes(chartManagerFilter)
                );
            }

            // Group projects by health based on filtered data
            const healthGroups = {
                'Green': 0,
                'Amber': 0,
                'Red': 0,
                'None': 0
            };

            projectsToAnalyze.forEach(project => {
                const health = project.projectHealth || 'None';
                const capitalizedHealth = health.charAt(0).toUpperCase() + health.slice(1).toLowerCase();
                if (healthGroups.hasOwnProperty(capitalizedHealth)) {
                    healthGroups[capitalizedHealth]++;
                } else {
                    healthGroups['None']++;
                }
            });

            const healthColorMap = {
                'Green': '#65d814',
                'Amber': '#ffb800',
                'Red': '#ff5555',
                'None': '#e6e9ef'
            };

            const labels = Object.keys(healthGroups).filter(health => healthGroups[health] > 0);
            const data = labels.map(health => healthGroups[health]);
            const colors = labels.map(health => healthColorMap[health]);

            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            if (projectHealthChartInstance) {
                projectHealthChartInstance.destroy();
            }

            projectHealthChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.map((color, index) => {
                            // If a filter is active, fade out non-selected items
                            if (chartHealthFilter && labels[index] !== chartHealthFilter) {
                                return color + '40'; // Add transparency (40 = 25% opacity)
                            }
                            return color;
                        }),
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        hoverBorderWidth: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            const clickedIndex = activeElements[0].index;
                            const selectedHealth = labels[clickedIndex];

                            // Toggle filter
                            if (chartHealthFilter === selectedHealth) {
                                // Clear filter if clicking the same element
                                chartHealthFilter = null;
                            } else {
                                chartHealthFilter = selectedHealth;
                            }

                            // Apply chart-based filter
                            applyChartFilters();
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 13, weight: '500' },
                                color: '#323338',
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                cursor: 'pointer'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            padding: 12,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    const selectedInfo = chartHealthFilter === context.label ? ' (FILTERED)' : '';
                                    return `${context.label}: ${context.parsed} (${percentage}%)${selectedInfo}`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest'
                    }
                }
            });

            document.getElementById('projectHealthChart').style.display = 'none';
            console.log(`✅ Rendered project health chart with ${labels.length} health statuses`);
        }

        // Render project manager grouping chart
        function renderProjectManagerChart() {
            const canvas = document.getElementById('projectManagerChartCanvas');
            if (!canvas) return;

            if (projects.length === 0) {
                document.getElementById('projectManagerChart').style.display = 'block';
                document.getElementById('projectManagerChart').innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No projects found</div>';
                return;
            }

            // Get projects filtered by current type and health filters (if any)
            let projectsToAnalyze = projects;
            if (chartTypeFilter) {
                projectsToAnalyze = projectsToAnalyze.filter(p => p.projectType === chartTypeFilter);
            }
            if (chartHealthFilter) {
                projectsToAnalyze = projectsToAnalyze.filter(p => {
                    const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                    return projectHealth === chartHealthFilter;
                });
            }

            // Group projects by manager
            const managerGroups = {};
            projectsToAnalyze.forEach(project => {
                if (project.projectManagers && project.projectManagers.length > 0) {
                    project.projectManagers.forEach(manager => {
                        if (!managerGroups[manager]) {
                            managerGroups[manager] = 0;
                        }
                        managerGroups[manager]++;
                    });
                }
            });

            // Sort by count (highest first)
            const sortedData = Object.entries(managerGroups)
                .sort((a, b) => b[1] - a[1]);

            const labels = sortedData.map(([manager, _]) => manager);
            const data = sortedData.map(([_, count]) => count);

            if (labels.length === 0) {
                document.getElementById('projectManagerChart').style.display = 'block';
                document.getElementById('projectManagerChart').innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No managers found</div>';
                return;
            }

            // PowerBI-style colors
            const colors = [
                '#0073ea', '#00c875', '#fdab3d', '#ff5555',
                '#a367e8', '#00bcd4', '#ff9800', '#9c27b0',
                '#e91e63', '#009688'
            ];

            const ctx = canvas.getContext('2d');

            // Destroy existing chart if it exists
            if (projectManagerChartInstance) {
                projectManagerChartInstance.destroy();
            }

            projectManagerChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Projects',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length).map((color, index) => {
                            // If a filter is active, fade out non-selected items
                            if (chartManagerFilter && labels[index] !== chartManagerFilter) {
                                return color + '40'; // Add transparency (40 = 25% opacity)
                            }
                            return color;
                        }),
                        borderColor: colors.slice(0, labels.length).map((color, index) => {
                            // If a filter is active, fade out non-selected items
                            if (chartManagerFilter && labels[index] !== chartManagerFilter) {
                                return color + '40';
                            }
                            return color;
                        }),
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBackgroundColor: colors.slice(0, labels.length).map((color, index) => {
                            // If a filter is active, keep faded appearance on hover for non-selected
                            if (chartManagerFilter && labels[index] !== chartManagerFilter) {
                                return color + '40';
                            }
                            return color;
                        })
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            const clickedIndex = activeElements[0].index;
                            const selectedManager = labels[clickedIndex];

                            // Toggle filter
                            if (chartManagerFilter === selectedManager) {
                                // Clear filter if clicking the same element
                                chartManagerFilter = null;
                            } else {
                                chartManagerFilter = selectedManager;
                            }

                            // Apply chart-based filter
                            applyChartFilters();
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                font: { size: 12, weight: '500' },
                                color: '#676879'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: 12, weight: '600' },
                                color: '#323338',
                                cursor: 'pointer'
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 13, weight: '500' },
                                color: '#323338',
                                padding: 15,
                                usePointStyle: true,
                                cursor: 'pointer'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            padding: 12,
                            cornerRadius: 6,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                                    const selectedInfo = chartManagerFilter === labels[context.dataIndex] ? ' (FILTERED)' : '';
                                    return `${context.parsed.x} projects (${percentage}%)${selectedInfo}`;
                                }
                            }
                        }
                    }
                }
            });

            document.getElementById('projectManagerChart').style.display = 'none';
            console.log(`✅ Rendered project manager chart with ${labels.length} managers`);
        }

        // Setup click-outside detection for chart filtering
        function setupChartClickOutside() {
            const typeChartContainer = document.getElementById('projectTypeChartContainer');
            const healthChartContainer = document.getElementById('projectHealthChartContainer');
            const managerChartContainer = document.getElementById('projectManagerChartContainer');
            const statusChartContainer = document.getElementById('projectStatusChartContainer');
            const priorityChartContainer = document.getElementById('projectPriorityChartContainer');
            const sdlcChartContainer = document.getElementById('projectSDLCChartContainer');

            if (typeChartContainer && healthChartContainer && managerChartContainer) {
                document.addEventListener('click', function(event) {
                    const isClickInsideTypeChart = typeChartContainer.contains(event.target);
                    const isClickInsideHealthChart = healthChartContainer.contains(event.target);
                    const isClickInsideManagerChart = managerChartContainer.contains(event.target);
                    const isClickInsideStatusChart = statusChartContainer && statusChartContainer.contains(event.target);
                    const isClickInsidePriorityChart = priorityChartContainer && priorityChartContainer.contains(event.target);
                    const isClickInsideSDLCChart = sdlcChartContainer && sdlcChartContainer.contains(event.target);
                    const isClickInsideDashboard = event.target.closest('.dashboard-content') !== null;

                    // If clicked outside all charts but inside dashboard, clear filters
                    if (!isClickInsideTypeChart && !isClickInsideHealthChart && !isClickInsideManagerChart &&
                        !isClickInsideStatusChart && !isClickInsidePriorityChart && !isClickInsideSDLCChart && isClickInsideDashboard) {
                        // Only clear if filters are currently active
                        if (chartTypeFilter || chartHealthFilter || chartManagerFilter || chartStatusFilter || chartPriorityFilter || chartSDLCFilter) {
                            chartTypeFilter = null;
                            chartHealthFilter = null;
                            chartManagerFilter = null;
                            chartStatusFilter = null;
                            chartPriorityFilter = null;
                            chartSDLCFilter = null;
                            applyChartFilters();
                        }
                    }
                });
            }
        }

        // Chart instances for new dashboards
        let projectStatusChartInstance = null;
        let projectPriorityChartInstance = null;
        let projectSDLCChartInstance = null;
        let projectProgressDistChartInstance = null;
        let projectTimelineChartInstance = null;
        let projectForecastChartInstance = null;
        let projectWorkloadChartInstance = null;

        // Helper function to normalize status values from Firebase format
        function normalizeStatus(status) {
            if (!status) return 'Planned';
            const lowerStatus = status.toLowerCase();
            if (lowerStatus === 'in-progress' || lowerStatus === 'inprogress') return 'In Progress';
            if (lowerStatus === 'completed') return 'Completed';
            if (lowerStatus === 'on-hold' || lowerStatus === 'onhold') return 'On Hold';
            if (lowerStatus === 'planned') return 'Planned';
            // Return title-cased version for unknown statuses
            return status.charAt(0).toUpperCase() + status.slice(1);
        }

        // Helper function to get SDLC phase (checks both p.sdlc and p.sdlcPhase)
        function getSDLCPhase(project) {
            return project.sdlc || project.sdlcPhase || 'Development';
        }

        // Helper function to normalize priority values from Firebase format
        function normalizePriority(priority) {
            if (!priority) return 'Medium';
            const lowerPriority = priority.toLowerCase();
            if (lowerPriority === 'high') return 'High';
            if (lowerPriority === 'medium') return 'Medium';
            if (lowerPriority === 'low') return 'Low';
            // Return title-cased version for unknown priorities
            return priority.charAt(0).toUpperCase() + priority.slice(1);
        }

        // Helper function to parse date strings reliably (handles both YYYY-MM-DD and YYYY/MM/DD formats)
        function parseDate(dateStr) {
            if (!dateStr) return null;
            // Handle both '2025-10-25' and '2025/10/25' formats
            const normalizedStr = dateStr.replace(/\//g, '-');
            const parts = normalizedStr.split('-');
            if (parts.length === 3) {
                const [year, month, day] = parts.map(p => parseInt(p, 10));
                // Create date at midnight to avoid timezone issues
                return new Date(year, month - 1, day, 0, 0, 0, 0);
            }
            return new Date(dateStr);
        }

        // Helper function to get today's date at midnight (for consistent date comparisons)
        function getTodayMidnight() {
            const today = new Date();
            return new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0, 0);
        }

        // Store at-risk project details for modal
        let atRiskDetails = {
            overdue: [],
            behindSchedule: [],
            noProgress: [],
            slow: []
        };

        // Show At Risk Details Modal
        function showAtRiskDetails() {
            const modal = document.getElementById('atRiskModal');
            const content = document.getElementById('atRiskDetailsContent');

            // Build the display content
            let html = '';

            // Overdue section
            if (atRiskDetails.overdue.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #d32f2f; margin: 0 0 12px 0; font-size: 16px;">
                            ⏰ Overdue (${atRiskDetails.overdue.length})
                        </h3>
                        <div style="background: #ffebee; border-left: 4px solid #d32f2f; padding: 12px; border-radius: 4px;">
                            ${atRiskDetails.overdue.map(p => `
                                <div style="margin-bottom: 8px; color: #323338;">
                                    • <strong>${p.name}</strong> (${p.daysOverdue} days overdue)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Behind Schedule section
            if (atRiskDetails.behindSchedule.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #ff7043; margin: 0 0 12px 0; font-size: 16px;">
                            📉 Behind Schedule (${atRiskDetails.behindSchedule.length})
                        </h3>
                        <div style="background: #ffe0b2; border-left: 4px solid #ff7043; padding: 12px; border-radius: 4px;">
                            ${atRiskDetails.behindSchedule.map(p => `
                                <div style="margin-bottom: 8px; color: #323338;">
                                    • <strong>${p.name}</strong> (Expected: ${p.expectedProgress}%, Actual: ${p.actualProgress}%)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // No Progress section
            if (atRiskDetails.noProgress.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #d32f2f; margin: 0 0 12px 0; font-size: 16px;">
                            🚫 No Progress (${atRiskDetails.noProgress.length})
                        </h3>
                        <div style="background: #ffcdd2; border-left: 4px solid #d32f2f; padding: 12px; border-radius: 4px;">
                            ${atRiskDetails.noProgress.map(p => `
                                <div style="margin-bottom: 8px; color: #323338;">
                                    • <strong>${p.name}</strong> (${p.daysElapsed} days, 0% progress)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Slow Progress section (for context)
            if (atRiskDetails.slow.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin: 0 0 12px 0; font-size: 16px;">
                            ⚠️ Slow Progress (${atRiskDetails.slow.length})
                        </h3>
                        <div style="background: #e8eaf6; border-left: 4px solid #667eea; padding: 12px; border-radius: 4px;">
                            ${atRiskDetails.slow.map(p => `
                                <div style="margin-bottom: 8px; color: #323338;">
                                    • <strong>${p.name}</strong> (${p.actualProgress}% progress)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (html === '') {
                html = '<div style="text-align: center; color: #999; padding: 20px;">✅ No at-risk projects</div>';
            }

            content.innerHTML = html;
            modal.style.display = 'flex';
        }

        // Close At Risk Modal
        function closeAtRiskModal() {
            const modal = document.getElementById('atRiskModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('atRiskModal');
            if (modal && event.target === modal) {
                closeAtRiskModal();
            }
        });

        // Render Key Metrics
        function renderKeyMetrics() {
            // Get filtered projects
            let filteredProjects = [...projects];
            if (chartTypeFilter) {
                filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            }
            if (chartHealthFilter) {
                filteredProjects = filteredProjects.filter(p => {
                    const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                    return projectHealth === chartHealthFilter;
                });
            }
            if (chartManagerFilter) {
                filteredProjects = filteredProjects.filter(p =>
                    p.projectManagers && p.projectManagers.includes(chartManagerFilter)
                );
            }
            if (chartStatusFilter) {
                filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            }
            if (chartPriorityFilter) {
                filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            }
            if (chartSDLCFilter) {
                filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);
            }

            const total = filteredProjects.length;
            const active = filteredProjects.filter(p => {
                const status = normalizeStatus(p.status);
                return ['In Progress', 'Planned'].includes(status);
            }).length;
            const completed = filteredProjects.filter(p => {
                const status = normalizeStatus(p.status);
                return status === 'Completed';
            }).length;

            // On-Time: Completed projects with 100% progress, OR In-Progress projects that are on schedule
            const onTime = filteredProjects.filter(p => {
                const status = normalizeStatus(p.status);

                // Completed projects: count as on-time if 100% progress
                if (status === 'Completed') {
                    return (p.progress || 0) === 100;
                }

                // In-Progress projects: count as on-time if not behind schedule
                if (status === 'In Progress' && p.startDate && p.endDate) {
                    const startDate = parseDate(p.startDate);
                    const endDate = parseDate(p.endDate);
                    const today = getTodayMidnight();

                    // If not yet past end date, check if on track
                    if (today <= endDate) {
                        const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;

                        if (daysElapsed > 0) {
                            const expectedProgress = Math.min((daysElapsed / totalDays) * 100, 100);
                            const actualProgress = p.progress || 0;

                            // On-time if actual progress >= expected progress (within 10% tolerance)
                            return actualProgress >= expectedProgress - 10;
                        }
                    }
                }

                return false;
            }).length;

            // At Risk/Delayed: Projects that are in progress with due date passed
            let overduCount = 0;
            let behindScheduleCount = 0;
            let slowProgressCount = 0;
            atRiskDetails = { overdue: [], behindSchedule: [], noProgress: [], slow: [] };

            const delayed = filteredProjects.filter(p => {
                const normalizedStatus = normalizeStatus(p.status);
                if (normalizedStatus === 'In Progress') {
                    // Case 1: Overdue - today is past the end date
                    if (p.endDate) {
                        const endDate = parseDate(p.endDate);
                        const today = getTodayMidnight();

                        if (today > endDate) {
                            overduCount++;
                            const daysOverdue = Math.floor((today - endDate) / (1000 * 60 * 60 * 24));
                            atRiskDetails.overdue.push({ name: p.name, daysOverdue });
                            return true;  // Overdue
                        }

                        // Case 3 & 4: Progress behind schedule
                        if (p.startDate) {
                            const startDate = parseDate(p.startDate);
                            const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                            const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;

                            // Only check if project has started
                            if (daysElapsed > 0) {
                                // Expected progress: (days elapsed / total days) * 100
                                const expectedProgress = Math.min((daysElapsed / totalDays) * 100, 100);
                                const actualProgress = p.progress || 0;

                                // Case 3: At risk if expected progress exceeds actual progress by more than 10%
                                if (expectedProgress > actualProgress + 10) {
                                    behindScheduleCount++;
                                    atRiskDetails.behindSchedule.push({
                                        name: p.name,
                                        expectedProgress: Math.round(expectedProgress),
                                        actualProgress: Math.round(actualProgress)
                                    });
                                    return true;  // Behind schedule
                                }

                                // Case 4: No progress yet but days have passed (0% after days started)
                                if (actualProgress === 0 && daysElapsed >= 5) {
                                    behindScheduleCount++;
                                    atRiskDetails.noProgress.push({ name: p.name, daysElapsed });
                                    return true;  // No progress made
                                }
                            }
                        }
                        return false;
                    }

                    // Case 2: No endDate - consider at risk if progress < 50% and more than 30 days old
                    if (p.startDate && (p.progress || 0) < 50) {
                        const startDate = parseDate(p.startDate);
                        const today = getTodayMidnight();
                        const daysSinceStart = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                        if (daysSinceStart > 30) {
                            slowProgressCount++;
                            atRiskDetails.slow.push({ name: p.name, actualProgress: p.progress || 0 });
                            return true;
                        }
                    }
                }
                return false;
            }).length;

            const avgDuration = filteredProjects.reduce((sum, p) => {
                if (p.startDate && p.endDate) {
                    const start = parseDate(p.startDate);
                    const end = parseDate(p.endDate);
                    return sum + Math.floor((end - start) / (1000 * 60 * 60 * 24));
                }
                return sum;
            }, 0) / Math.max(filteredProjects.filter(p => p.startDate && p.endDate).length, 1);

            // On-Time Percentage: (On-Time / Total Projects) * 100
            const onTimePercent = total > 0 ? ((onTime / total) * 100).toFixed(0) : 0;
            // At Risk Percentage: (Delayed / Total Active)
            const atRiskPercent = active > 0 ? ((delayed / active) * 100).toFixed(0) : 0;

            document.getElementById('metricsTotal').textContent = total;
            document.getElementById('metricsActive').textContent = active;
            document.getElementById('metricsOnTime').textContent = onTime;
            document.getElementById('metricsOnTimePercent').textContent = onTimePercent + '%';
            document.getElementById('metricsAvgDuration').textContent = Math.round(avgDuration);
            document.getElementById('metricsAtRisk').textContent = delayed;
            document.getElementById('metricsAtRiskPercent').textContent = atRiskPercent + '%';
            document.getElementById('metricsAtRiskOverdue').textContent = `⏰ Overdue: ${overduCount}`;
            document.getElementById('metricsAtRiskBehind').textContent = `📉 Behind: ${behindScheduleCount}`;
            document.getElementById('metricsAtRiskNoProgress').textContent = `🚫 No Progress: ${atRiskDetails.noProgress.length}`;
            document.getElementById('metricsAtRiskSlow').textContent = `⚠️ Slow: ${slowProgressCount}`;
        }

        // Render Project Status Chart
        function renderProjectStatusChart() {
            const canvas = document.getElementById('projectStatusChartCanvas');
            if (!canvas) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartPriorityFilter) filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            if (chartSDLCFilter) filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);

            const statusGroups = { 'Planned': 0, 'In Progress': 0, 'Completed': 0, 'On Hold': 0 };
            filteredProjects.forEach(p => {
                const status = normalizeStatus(p.status);
                if (statusGroups.hasOwnProperty(status)) statusGroups[status]++;
                else statusGroups['Planned']++;
            });

            const labels = Object.keys(statusGroups).filter(s => statusGroups[s] > 0);
            const data = labels.map(s => statusGroups[s]);
            const colors = ['#0073ea', '#667eea', '#00c875', '#ffb800'];

            if (projectStatusChartInstance) projectStatusChartInstance.destroy();
            projectStatusChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: data, backgroundColor: colors.slice(0, labels.length).map((color, idx) => {
                        if (chartStatusFilter && labels[idx] !== chartStatusFilter) return color + '40';
                        return color;
                    }), borderColor: '#fff', borderWidth: 3, hoverBorderWidth: 5 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            const clickedIndex = activeElements[0].index;
                            const selectedStatus = labels[clickedIndex];
                            if (chartStatusFilter === selectedStatus) {
                                chartStatusFilter = null;
                            } else {
                                chartStatusFilter = selectedStatus;
                            }
                            applyChartFilters();
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 13 }, padding: 15, cursor: 'pointer' } },
                        tooltip: { callbacks: { label: (c) => {
                            const total = data.reduce((a,b)=>a+b,0);
                            const pct = ((c.parsed / total)*100).toFixed(1);
                            const filtered = chartStatusFilter === c.label ? ' (FILTERED)' : '';
                            return `${c.label}: ${c.parsed} (${pct}%)${filtered}`;
                        }} }
                    }
                }
            });
        }

        // Render Project Priority Chart
        function renderProjectPriorityChart() {
            const canvas = document.getElementById('projectPriorityChartCanvas');
            if (!canvas) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartStatusFilter) filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            if (chartSDLCFilter) filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);

            const priorityGroups = { 'High': 0, 'Medium': 0, 'Low': 0 };
            filteredProjects.forEach(p => {
                const priority = normalizePriority(p.priority);
                if (priorityGroups.hasOwnProperty(priority)) priorityGroups[priority]++;
            });

            const labels = Object.keys(priorityGroups).filter(p => priorityGroups[p] > 0);
            const data = labels.map(p => priorityGroups[p]);
            const colors = ['#ff5555', '#ffb800', '#00c875'];

            if (projectPriorityChartInstance) projectPriorityChartInstance.destroy();
            projectPriorityChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Projects', data: data, backgroundColor: colors.slice(0, labels.length).map((color, idx) => {
                        if (chartPriorityFilter && labels[idx] !== chartPriorityFilter) return color + '40';
                        return color;
                    }), borderRadius: 6, borderWidth: 2, borderColor: colors.slice(0, labels.length) }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            const clickedIndex = activeElements[0].index;
                            const selectedPriority = labels[clickedIndex];
                            if (chartPriorityFilter === selectedPriority) {
                                chartPriorityFilter = null;
                            } else {
                                chartPriorityFilter = selectedPriority;
                            }
                            applyChartFilters();
                        }
                    },
                    scales: { x: { beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: {
                            label: (c) => {
                                const total = data.reduce((a,b)=>a+b,0);
                                const pct = ((c.parsed.x / total)*100).toFixed(1);
                                const filtered = chartPriorityFilter === c.label ? ' (FILTERED)' : '';
                                return `${c.parsed.x} projects (${pct}%)${filtered}`;
                            }
                        }}
                    }
                }
            });
        }

        // Render SDLC Phase Chart
        function renderProjectSDLCChart() {
            const canvas = document.getElementById('projectSDLCChartCanvas');
            if (!canvas) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartStatusFilter) filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            if (chartPriorityFilter) filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);

            const sdlcGroups = { 'Requirement': 0, 'Design': 0, 'Development': 0, 'Smoke Test': 0, 'SIT': 0, 'Testing': 0, 'UAT': 0, 'Implemented': 0};
            filteredProjects.forEach(p => {
                const sdlc = getSDLCPhase(p);
                if (sdlcGroups.hasOwnProperty(sdlc)) sdlcGroups[sdlc]++;
                else if (sdlc && sdlc !== 'Development') {
                    // Handle any other SDLC phases by adding them dynamically
                    sdlcGroups[sdlc] = (sdlcGroups[sdlc] || 0) + 1;
                }
            });

            const labels = Object.keys(sdlcGroups).filter(s => sdlcGroups[s] > 0);
            const data = labels.map(s => sdlcGroups[s]);
            // Colors for SDLC phases: Requirement, Design, Development, Smoke Test, SIT, Testing, UAT, Implemented, Deployment
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#00bcd4', '#ff9800', '#ff6b6b'];

            if (projectSDLCChartInstance) projectSDLCChartInstance.destroy();
            projectSDLCChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Projects', data: data, backgroundColor: colors.slice(0, labels.length).map((color, idx) => {
                        if (chartSDLCFilter && labels[idx] !== chartSDLCFilter) return color + '40';
                        return color;
                    }), borderRadius: 6, borderWidth: 2, borderColor: colors.slice(0, labels.length) }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, activeElements) {
                        if (activeElements.length > 0) {
                            const clickedIndex = activeElements[0].index;
                            const selectedSDLC = labels[clickedIndex];
                            if (chartSDLCFilter === selectedSDLC) {
                                chartSDLCFilter = null;
                            } else {
                                chartSDLCFilter = selectedSDLC;
                            }
                            applyChartFilters();
                        }
                    },
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: {
                            label: (c) => {
                                const total = data.reduce((a,b)=>a+b,0);
                                const pct = ((c.parsed.y / total)*100).toFixed(1);
                                const filtered = chartSDLCFilter === c.label ? ' (FILTERED)' : '';
                                return `${c.parsed.y} projects (${pct}%)${filtered}`;
                            }
                        }}
                    }
                }
            });
        }

        // Render Progress Distribution Chart
        function renderProjectProgressDistChart() {
            const canvas = document.getElementById('projectProgressDistChartCanvas');
            if (!canvas) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartStatusFilter) filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            if (chartPriorityFilter) filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            if (chartSDLCFilter) filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);

            const ranges = { '0-25%': 0, '25-50%': 0, '50-75%': 0, '75-100%': 0 };
            filteredProjects.forEach(p => {
                const progress = p.progress || 0;
                if (progress < 25) ranges['0-25%']++;
                else if (progress < 50) ranges['25-50%']++;
                else if (progress < 75) ranges['50-75%']++;
                else ranges['75-100%']++;
            });

            const labels = Object.keys(ranges).filter(r => ranges[r] > 0);
            const data = labels.map(r => ranges[r]);
            const colors = ['#ff5555', '#ffb800', '#667eea', '#00c875'];

            if (projectProgressDistChartInstance) projectProgressDistChartInstance.destroy();
            projectProgressDistChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Projects', data: data, backgroundColor: colors.slice(0, labels.length), borderRadius: 6 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Render Timeline Analytics Chart
        function renderProjectTimelineChart() {
            const canvas = document.getElementById('projectTimelineChartCanvas');
            if (!canvas) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartStatusFilter) filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            if (chartPriorityFilter) filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            if (chartSDLCFilter) filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);

            const monthData = {};
            filteredProjects.forEach(p => {
                if (p.startDate) {
                    const date = parseDate(p.startDate);
                    const month = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    monthData[month] = (monthData[month] || 0) + 1;
                }
            });

            const labels = Object.keys(monthData).slice(-6);
            const data = labels.map(l => monthData[l] || 0);

            if (projectTimelineChartInstance) projectTimelineChartInstance.destroy();
            projectTimelineChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Projects Started', data: data, borderColor: '#0073ea', backgroundColor: 'rgba(0,115,234,0.1)', tension: 0.4, fill: true }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: true } }
                }
            });
        }

        // Render Completion Forecast Chart
        function renderProjectForecastChart() {
            const canvas = document.getElementById('projectForecastChartCanvas');
            if (!canvas) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartStatusFilter) filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            if (chartPriorityFilter) filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            if (chartSDLCFilter) filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);

            const inProgress = filteredProjects.filter(p => normalizeStatus(p.status) === 'In Progress' && p.progress < 100);
            const avgRemainingDays = inProgress.reduce((sum, p) => sum + ((100 - (p.progress || 0)) / 100 * 30), 0) / Math.max(inProgress.length, 1);

            const forecastData = [
                inProgress.length,
                Math.round(inProgress.filter(p => (p.progress || 0) >= 75).length),
                Math.round(inProgress.filter(p => (p.progress || 0) >= 50 && (p.progress || 0) < 75).length),
                Math.round(inProgress.filter(p => (p.progress || 0) < 50).length)
            ];

            if (projectForecastChartInstance) projectForecastChartInstance.destroy();
            projectForecastChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Total In Progress', 'On Track (75%+)', 'Medium Progress (50-75%)', 'Early Stage (<50%)'],
                    datasets: [{ data: forecastData, backgroundColor: ['#0073ea', '#00c875', '#667eea', '#ffb800'], borderColor: '#fff', borderWidth: 3 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 15 } } }
                }
            });
        }

        // Render Team Workload Chart
        function renderProjectWorkloadChart() {
            const canvas = document.getElementById('projectWorkloadChartCanvas');
            if (!canvas) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartStatusFilter) filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            if (chartPriorityFilter) filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            if (chartSDLCFilter) filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);

            const managerWorkload = {};
            filteredProjects.forEach(p => {
                if (p.projectManagers && p.projectManagers.length > 0) {
                    p.projectManagers.forEach(m => {
                        managerWorkload[m] = (managerWorkload[m] || 0) + 1;
                    });
                }
            });

            const sortedManagers = Object.entries(managerWorkload).sort((a, b) => b[1] - a[1]);
            const labels = sortedManagers.map(m => m[0]);
            const data = sortedManagers.map(m => m[1]);
            const colors = ['#0073ea', '#00c875', '#fdab3d', '#ff5555', '#667eea', '#00bcd4'];

            if (projectWorkloadChartInstance) projectWorkloadChartInstance.destroy();
            projectWorkloadChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Projects', data: data, backgroundColor: colors.slice(0, labels.length), borderRadius: 6 }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Render Bottleneck Alerts
        function renderBottleneckAlerts() {
            const alertsList = document.getElementById('bottleneckAlertsList');
            if (!alertsList) return;

            let filteredProjects = [...projects];
            if (chartTypeFilter) filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            if (chartHealthFilter) filteredProjects = filteredProjects.filter(p => {
                const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                return projectHealth === chartHealthFilter;
            });
            if (chartManagerFilter) filteredProjects = filteredProjects.filter(p =>
                p.projectManagers && p.projectManagers.includes(chartManagerFilter)
            );
            if (chartStatusFilter) filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            if (chartPriorityFilter) filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            if (chartSDLCFilter) filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);

            const alerts = [];

            // High priority projects
            filteredProjects.filter(p => normalizePriority(p.priority) === 'High').forEach(p => {
                alerts.push({ type: '🔴', title: `High Priority: ${p.name}`, color: '#ff5555' });
            });

            // Overdue projects
            filteredProjects.filter(p => normalizeStatus(p.status) === 'In Progress' && p.endDate && getTodayMidnight() > parseDate(p.endDate)).forEach(p => {
                alerts.push({ type: '⏰', title: `Overdue: ${p.name}`, color: '#ffb800' });
            });

            // Behind schedule projects (expected progress > actual progress by 10%+)
            filteredProjects.filter(p => {
                if (normalizeStatus(p.status) === 'In Progress' && p.startDate && p.endDate) {
                    const startDate = parseDate(p.startDate);
                    const endDate = parseDate(p.endDate);
                    const today = getTodayMidnight();

                    // Only check if not already overdue (avoid duplicate alerts)
                    if (today <= endDate) {
                        const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        const expectedProgress = Math.min((daysElapsed / totalDays) * 100, 100);
                        const actualProgress = p.progress || 0;

                        return expectedProgress > actualProgress + 10;
                    }
                }
                return false;
            }).forEach(p => {
                const startDate = parseDate(p.startDate);
                const endDate = parseDate(p.endDate);
                const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const today = getTodayMidnight();
                const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const expectedProgress = Math.min((daysElapsed / totalDays) * 100, 100).toFixed(0);
                const actualProgress = (p.progress || 0).toFixed(0);
                alerts.push({ type: '📉', title: `Behind Schedule: ${p.name} (Expected: ${expectedProgress}%, Actual: ${actualProgress}%)`, color: '#ff7043' });
            });

            // No progress yet projects (0% after 5+ days started)
            filteredProjects.filter(p => {
                if (normalizeStatus(p.status) === 'In Progress' && p.startDate && (p.progress || 0) === 0) {
                    const startDate = parseDate(p.startDate);
                    const today = getTodayMidnight();
                    const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                    return daysElapsed >= 5;  // 5+ days with 0% progress
                }
                return false;
            }).forEach(p => {
                const startDate = parseDate(p.startDate);
                const today = getTodayMidnight();
                const daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                alerts.push({ type: '🚫', title: `No Progress: ${p.name} (${daysElapsed} days, 0%)`, color: '#d32f2f' });
            });

            // Low progress projects
            filteredProjects.filter(p => normalizeStatus(p.status) === 'In Progress' && (p.progress || 0) < 25 && (p.progress || 0) > 0).forEach(p => {
                alerts.push({ type: '⚠️', title: `Slow Progress: ${p.name} (${p.progress}%)`, color: '#667eea' });
            });

            // High health risk
            filteredProjects.filter(p => p.projectHealth === 'red').forEach(p => {
                alerts.push({ type: '🚨', title: `Health Risk: ${p.name}`, color: '#ff5555' });
            });

            if (alerts.length === 0) {
                alertsList.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">✅ No alerts</li>';
                return;
            }

            alertsList.innerHTML = alerts.map(a => `
                <li style="padding: 12px; margin: 8px 0; background: ${a.color}20; border-left: 4px solid ${a.color}; border-radius: 4px; color: #323338;">
                    <span style="font-size: 16px;">${a.type}</span> <strong>${a.title}</strong>
                </li>
            `).join('');
        }

        // Render recent activity on dashboard
        function renderRecentActivity() {
            const activityList = document.getElementById('recentActivityList');
            if (!activityList) return;

            // Get filtered projects based on chart selections
            let filteredProjects = [...projects];

            // Apply project type filter from chart
            if (chartTypeFilter) {
                filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            }

            // Apply health filter from chart
            if (chartHealthFilter) {
                filteredProjects = filteredProjects.filter(p => {
                    const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                    return projectHealth === chartHealthFilter;
                });
            }

            // Get project names from filtered projects
            const filteredProjectNames = filteredProjects.map(p => p.name);

            // Get recent tasks (sorted by updatedAt or createdAt) - filter by selected projects
            const recentTasks = [...tasks]
                .filter(t => t.name && t.personName && (!chartTypeFilter && !chartHealthFilter || filteredProjectNames.includes(t.project)))
                .sort((a, b) => {
                    const aTime = a.updatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                    const bTime = b.updatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                    return bTime - aTime;
                })
                .slice(0, 5); // Show 5 most recent

            if (recentTasks.length === 0) {
                activityList.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">No recent activity</li>';
                return;
            }

            activityList.innerHTML = recentTasks.map(task => {
                let icon = '📝';
                let action = 'updated';

                if (task.status === 'done') {
                    icon = '✅';
                    action = 'completed';
                } else if (task.status === 'stuck') {
                    icon = '🚨';
                    action = 'marked as stuck';
                } else if (task.status === 'working') {
                    icon = '⚙️';
                    action = 'is working on';
                }

                // Calculate time ago
                const timestamp = task.updatedAt?.toMillis?.() || task.createdAt?.toMillis?.() || Date.now();
                const timeAgo = getTimeAgo(timestamp);

                const projectText = task.project ? ` in ${task.project}` : '';

                return `
                    <li class="activity-item">
                        <div class="activity-icon">${icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${task.personName}</strong> ${action} <strong>${task.name}</strong>${projectText}
                            </div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </li>
                `;
            }).join('');

            console.log(`✅ Rendered ${recentTasks.length} recent activities`);
        }

        // Helper function to calculate time ago
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return days === 1 ? '1 day ago' : `${days} days ago`;
            if (hours > 0) return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
            if (minutes > 0) return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
            return 'Just now';
        }

        function getStatusText(status) {
            const statusMap = {
                'working': 'Working on it',
                'done': 'Done',
                'stuck': 'Stuck',
                'blank': 'Not Started'
            };
            return statusMap[status] || status;
        }

        // Helper function to format name as "FirstName LastInitial."
        function formatNameWithInitial(fullName) {
            if (!fullName || fullName === 'Unknown') return fullName;

            const nameParts = fullName.trim().split(' ');
            if (nameParts.length === 1) {
                // Only first name, return as is
                return nameParts[0];
            }

            // Get first name and first letter of last name
            const firstName = nameParts[0];
            const lastNameInitial = nameParts[nameParts.length - 1][0];
            return `${firstName} ${lastNameInitial}.`;
        }

        function renderTasks() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = tasks.map((task, index) => {
                // Handle multiple assignees
                let assignedToHTML = '';
                if (task.assignedToNames && task.assignedToNames.length > 0) {
                    // Multiple assignees
                    const displayNames = task.assignedToNames.map(name => formatNameWithInitial(name));
                    if (task.assignedToNames.length === 1) {
                        const fullName = task.assignedToNames[0];
                        const displayName = displayNames[0];
                        const avatarText = fullName.split(' ').map(n => n[0]).join('');
                        assignedToHTML = `
                            <div class="person-cell">
                                <div class="person-avatar">${avatarText}</div>
                                <span>${displayName}</span>
                            </div>`;
                    } else {
                        // Multiple members - show avatars stacked
                        const avatars = task.assignedToNames.map(name => {
                            const avatarText = name.split(' ').map(n => n[0]).join('');
                            return `<div class="person-avatar person-avatar-small" title="${name}">${avatarText}</div>`;
                        }).join('');
                        assignedToHTML = `
                            <div class="person-cell">
                                <div class="person-avatars-group">${avatars}</div>
                            </div>`;
                    }
                } else {
                    // Fallback to old single assignee format
                    const fullName = task.personName || task.person || 'Unknown';
                    const displayName = formatNameWithInitial(fullName);
                    const avatarText = fullName.split(' ').map(n => n[0]).join('');
                    assignedToHTML = `
                        <div class="person-cell">
                            <div class="person-avatar">${avatarText}</div>
                            <span>${displayName}</span>
                        </div>`;
                }

                // Check if task is overdue (past due date and not done)
                const isOverdue = task.date && new Date(task.date) < new Date(new Date().setHours(0, 0, 0, 0)) && task.status !== 'done';
                const overdueClass = isOverdue ? ' overdue' : '';

                return `
                <div class="table-row${overdueClass}" data-index="${index}" data-task-id="${task.id}">
                    <div class="table-cell" data-label="#">
                        <span class="row-number">${index + 1}</span>
                    </div>
                    <div class="table-cell" data-label="Task">
                        <span class="task-name editable-field" onclick="startInlineEdit(${index}, 'name', this)" title="Click to edit">${task.name}</span>
                    </div>
                    <div class="table-cell" data-label="Status">
                        <div class="status-badge-wrapper">
                            <div class="status-badge status-${task.status}" onclick="toggleStatusPopup(event, ${index})">
                                ${getStatusText(task.status)}
                            </div>
                            <div class="status-popup" id="status-popup-${index}">
                                <div class="status-popup-option blank" onclick="changeTaskStatus(${index}, 'blank')">
                                    Not Started
                                </div>
                                <div class="status-popup-option working" onclick="changeTaskStatus(${index}, 'working')">
                                    Working on it
                                </div>
                                <div class="status-popup-option stuck" onclick="changeTaskStatus(${index}, 'stuck')">
                                    Stuck
                                </div>
                                <div class="status-popup-option done" onclick="changeTaskStatus(${index}, 'done')">
                                    Done
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Priority">
                        <div class="priority">
                            <span class="priority-dot priority-${task.priority}"></span>
                            <span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Assigned To">
                        <div class="editable-field" onclick="startInlineEdit(${index}, 'assignedTo', this)" title="Click to edit">
                            ${assignedToHTML}
                        </div>
                    </div>
                    <div class="table-cell" data-label="Project">
                        ${task.project ? `<span class="project-badge" title="${task.project}">${task.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                    </div>
                    <div class="table-cell" data-label="Start Date">
                        <span class="date-cell editable-field" onclick="startInlineEdit(${index}, 'startDate', this)" title="Click to edit">${formatDateForDisplay(task.startDate)}</span>
                    </div>
                    <div class="table-cell" data-label="Due Date">
                        <span class="date-cell editable-field" onclick="startInlineEdit(${index}, 'date', this)" title="Click to edit">${formatDateForDisplay(task.date)}</span>
                    </div>
                    <div class="table-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn subtask-btn" data-action="subtask" data-index="${index}" title="Add subtask">
                                ➕
                            </button>
                            <button class="action-btn edit-btn" data-action="edit" data-index="${index}" title="Edit task">
                                ✏️
                            </button>
                            <button class="action-btn clone-btn" data-action="clone" data-index="${index}" title="Clone task">
                                📋
                            </button>
                            <button class="action-btn delete-btn" data-action="delete" data-index="${index}" title="Delete task">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Render subtasks after tasks
            renderSubtasks();

            // Setup drag and drop for tasks (as drop targets)
            setupTaskDropTargets();

            // Add event listeners to action buttons
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (action === 'subtask') {
                        showInlineAddSubtask(index);
                    } else if (action === 'edit') {
                        editTask(index);
                    } else if (action === 'clone') {
                        cloneTask(index);
                    } else if (action === 'delete') {
                        deleteTask(index);
                    }
                });
            });
        }

        // ========================================
        // INLINE EDITING FUNCTIONALITY
        // ========================================
        let currentlyEditing = null;

        async function startInlineEdit(taskIndex, field, element) {
            // Prevent multiple edits at once
            if (currentlyEditing) {
                cancelInlineEdit();
            }

            const task = tasks[taskIndex];
            const cell = element.closest('.table-cell');
            currentlyEditing = { taskIndex, field, element, cell, originalValue: element.innerHTML };

            // Mark as editing
            cell.classList.add('editing-mode');

            if (field === 'name') {
                // Edit task name
                const currentValue = task.name.replace(/"/g, '&quot;');
                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <input type="text" class="inline-edit-input" value="${currentValue}" id="inline-edit-input-${taskIndex}">
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-btn-${taskIndex}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const input = document.getElementById(`inline-edit-input-${taskIndex}`);
                const cancelBtn = document.getElementById(`cancel-btn-${taskIndex}`);

                console.log('Cancel button element:', cancelBtn);

                input.focus();
                input.select();

                // Add button handlers (use mousedown to prevent blur from firing)
                cancelBtn.addEventListener('mousedown', (e) => {
                    console.log('Cancel mousedown triggered');
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    console.log('Cancel click triggered');
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                // Auto-save on blur (focus loss)
                input.addEventListener('blur', (e) => {
                    // Check if still editing (cancel might have been clicked)
                    setTimeout(() => {
                        if (currentlyEditing && currentlyEditing.taskIndex === taskIndex) {
                            saveInlineEdit(taskIndex, field);
                        }
                    }, 100);
                });

                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveInlineEdit(taskIndex, field);
                    } else if (e.key === 'Escape') {
                        cancelInlineEdit();
                    }
                });

            } else if (field === 'date') {
                // Edit due date
                const currentValue = task.date || '';
                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <input type="date" class="inline-edit-input" value="${currentValue}" id="inline-edit-input-${taskIndex}">
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-btn-${taskIndex}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const input = document.getElementById(`inline-edit-input-${taskIndex}`);
                const cancelBtn = document.getElementById(`cancel-btn-${taskIndex}`);

                // Store original value to restore on cancel
                const originalValue = currentValue;

                // Focus and open calendar picker
                input.focus();

                // Try to open the date picker automatically
                try {
                    input.showPicker();
                } catch (e) {
                    // showPicker() not supported, fallback to click
                    input.click();
                }

                // Add button handlers (use mousedown to prevent blur from firing)
                cancelBtn.addEventListener('mousedown', (e) => {
                    console.log('Cancel mousedown triggered (date)');
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    console.log('Cancel click triggered (date)');
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                // Auto-save on blur ONLY if value changed
                input.addEventListener('blur', (e) => {
                    // Check if still editing (cancel might have been clicked)
                    setTimeout(() => {
                        if (currentlyEditing && currentlyEditing.taskIndex === taskIndex) {
                            // Only save if value actually changed
                            if (input.value !== originalValue) {
                                saveInlineEdit(taskIndex, field);
                            } else {
                                // Value didn't change, just cancel
                                cancelInlineEdit();
                            }
                        }
                    }, 100);
                });

                // Save immediately on change (date selected)
                input.addEventListener('change', (e) => {
                    // Only save if value actually changed
                    if (input.value !== originalValue) {
                        saveInlineEdit(taskIndex, field);
                    }
                });

                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveInlineEdit(taskIndex, field);
                    } else if (e.key === 'Escape') {
                        cancelInlineEdit();
                    }
                });

            } else if (field === 'startDate') {
                // Edit start date
                const currentValue = task.startDate || '';
                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <input type="date" class="inline-edit-input" value="${currentValue}" id="inline-edit-input-${taskIndex}">
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-btn-${taskIndex}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const input = document.getElementById(`inline-edit-input-${taskIndex}`);
                const cancelBtn = document.getElementById(`cancel-btn-${taskIndex}`);

                // Store original value to restore on cancel
                const originalValue = currentValue;

                // Focus and open calendar picker
                input.focus();

                // Try to open the date picker automatically
                try {
                    input.showPicker();
                } catch (e) {
                    // showPicker() not supported, fallback to click
                    input.click();
                }

                // Add button handlers (use mousedown to prevent blur from firing)
                cancelBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                // Auto-save on blur ONLY if value changed
                input.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        if (currentlyEditing && currentlyEditing.taskIndex === taskIndex) {
                            // Only save if value actually changed
                            if (input.value !== originalValue) {
                                saveInlineEdit(taskIndex, field);
                            } else {
                                // Value didn't change, just cancel
                                cancelInlineEdit();
                            }
                        }
                    }, 100);
                });

                // Save immediately on change (date selected)
                input.addEventListener('change', (e) => {
                    // Only save if value actually changed
                    if (input.value !== originalValue) {
                        saveInlineEdit(taskIndex, field);
                    }
                });

                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveInlineEdit(taskIndex, field);
                    } else if (e.key === 'Escape') {
                        cancelInlineEdit();
                    }
                });

            } else if (field === 'assignedTo') {
                // Edit assigned to (multi-select)
                const activeMembers = await loadActiveTeamMembers();
                const currentAssignedIds = task.assignedToIds || (task.assignedTo ? [task.assignedTo] : []);

                const options = activeMembers.map(member => {
                    const selected = currentAssignedIds.includes(member.id) ? 'selected' : '';
                    return `<option value="${member.id}" ${selected}>${member.name}</option>`;
                }).join('');

                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <select multiple class="inline-edit-select" id="inline-edit-input-${taskIndex}">
                            ${options}
                        </select>
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-btn-${taskIndex}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const select = document.getElementById(`inline-edit-input-${taskIndex}`);
                const cancelBtn = document.getElementById(`cancel-btn-${taskIndex}`);

                select.focus();

                // Add button handlers (use mousedown to prevent blur from firing)
                cancelBtn.addEventListener('mousedown', (e) => {
                    console.log('Cancel mousedown triggered (assignedTo)');
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    console.log('Cancel click triggered (assignedTo)');
                    e.preventDefault();
                    e.stopPropagation();
                    cancelInlineEdit();
                });

                // Auto-save on blur (focus loss)
                select.addEventListener('blur', (e) => {
                    // Check if still editing (cancel might have been clicked)
                    setTimeout(() => {
                        if (currentlyEditing && currentlyEditing.taskIndex === taskIndex) {
                            saveInlineEdit(taskIndex, field);
                        }
                    }, 100);
                });

                // Auto-save on change (selection changed)
                select.addEventListener('change', (e) => {
                    // Small delay to allow multiple selections
                    clearTimeout(select.saveTimeout);
                    select.saveTimeout = setTimeout(() => {
                        if (currentlyEditing && currentlyEditing.taskIndex === taskIndex) {
                            saveInlineEdit(taskIndex, field);
                        }
                    }, 800);
                });
            }
        }

        async function saveInlineEdit(taskIndex, field) {
            if (!currentlyEditing) return;

            const input = document.getElementById(`inline-edit-input-${taskIndex}`);
            const task = tasks[taskIndex];

            try {
                isManualOperation = true;

                if (field === 'name') {
                    const newValue = input.value.trim();
                    if (!newValue) {
                        alert('Task name cannot be empty');
                        return;
                    }

                    // Update in Firebase
                    if (task.id && db) {
                        await db.collection('tasks').doc(task.id).update({
                            name: newValue,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    task.name = newValue;

                } else if (field === 'date') {
                    const newValue = input.value;

                    // Update in Firebase
                    if (task.id && db) {
                        await db.collection('tasks').doc(task.id).update({
                            date: newValue,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    task.date = newValue;

                } else if (field === 'startDate') {
                    const newValue = input.value;

                    // Update in Firebase
                    if (task.id && db) {
                        await db.collection('tasks').doc(task.id).update({
                            startDate: newValue,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    task.startDate = newValue;

                } else if (field === 'assignedTo') {
                    const selectedOptions = Array.from(input.selectedOptions);
                    if (selectedOptions.length === 0) {
                        alert('Please select at least one team member');
                        return;
                    }

                    const assignedToIds = selectedOptions.map(opt => opt.value);
                    const assignedToNames = selectedOptions.map(opt => opt.textContent);

                    // Update in Firebase
                    if (task.id && db) {
                        await db.collection('tasks').doc(task.id).update({
                            assignedTo: assignedToIds[0],
                            assignedToIds: assignedToIds,
                            person: assignedToNames[0],
                            assignedToNames: assignedToNames,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    task.assignedTo = assignedToIds[0];
                    task.assignedToIds = assignedToIds;
                    task.person = assignedToNames[0];
                    task.assignedToNames = assignedToNames;
                }

                // Clear editing state
                currentlyEditing = null;

                // Re-render tasks
                const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '' && (Array.isArray(v) ? v.length > 0 : true));
                if (hasActiveFilters) {
                    applyTaskFilters();
                } else {
                    renderTasks();
                }

                // Re-enable real-time listener
                setTimeout(() => {
                    isManualOperation = false;
                }, 500);

            } catch (error) {
                console.error('Error saving inline edit:', error);
                alert('Error saving changes: ' + error.message);
                isManualOperation = false;
            }
        }

        function cancelInlineEdit() {
            if (!currentlyEditing) return;

            console.log('Cancelling inline edit');

            // Clear editing state first
            currentlyEditing.cell.classList.remove('editing-mode');
            currentlyEditing = null;

            // Re-render tasks to restore original view
            const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '' && (Array.isArray(v) ? v.length > 0 : true));
            if (hasActiveFilters) {
                applyTaskFilters();
            } else {
                renderTasks();
            }
        }

        // ========================================
        // SUBTASK INLINE EDITING FUNCTIONALITY
        // ========================================
        let currentlyEditingSubtask = null;

        async function startSubtaskInlineEdit(subtaskId, field, element) {
            // Prevent multiple edits at once
            if (currentlyEditingSubtask) {
                cancelSubtaskInlineEdit();
            }

            const subtask = subtasks.find(st => st.id === subtaskId);
            if (!subtask) return;

            const cell = element.closest('.table-cell');
            currentlyEditingSubtask = { subtaskId, field, element, cell, originalValue: element.innerHTML };

            // Mark as editing
            cell.classList.add('editing-mode');

            if (field === 'name') {
                // Edit subtask name
                const currentValue = subtask.name.replace(/"/g, '&quot;');
                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <input type="text" class="inline-edit-input" value="${currentValue}" id="inline-edit-subtask-input-${subtaskId}">
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-subtask-btn-${subtaskId}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const input = document.getElementById(`inline-edit-subtask-input-${subtaskId}`);
                const cancelBtn = document.getElementById(`cancel-subtask-btn-${subtaskId}`);

                input.focus();
                input.select();

                // Add button handlers
                cancelBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                // Auto-save on blur
                input.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        if (currentlyEditingSubtask && currentlyEditingSubtask.subtaskId === subtaskId) {
                            saveSubtaskInlineEdit(subtaskId, field);
                        }
                    }, 100);
                });

                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveSubtaskInlineEdit(subtaskId, field);
                    } else if (e.key === 'Escape') {
                        cancelSubtaskInlineEdit();
                    }
                });

            } else if (field === 'date') {
                // Edit due date
                const currentValue = subtask.date || '';
                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <input type="date" class="inline-edit-input" value="${currentValue}" id="inline-edit-subtask-input-${subtaskId}">
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-subtask-btn-${subtaskId}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const input = document.getElementById(`inline-edit-subtask-input-${subtaskId}`);
                const cancelBtn = document.getElementById(`cancel-subtask-btn-${subtaskId}`);
                const originalValue = currentValue;

                input.focus();

                // Try to open the date picker automatically
                try {
                    input.showPicker();
                } catch (e) {
                    input.click();
                }

                // Add button handlers
                cancelBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                // Auto-save on blur ONLY if value changed
                input.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        if (currentlyEditingSubtask && currentlyEditingSubtask.subtaskId === subtaskId) {
                            if (input.value !== originalValue) {
                                saveSubtaskInlineEdit(subtaskId, field);
                            } else {
                                cancelSubtaskInlineEdit();
                            }
                        }
                    }, 100);
                });

                // Save immediately on change
                input.addEventListener('change', (e) => {
                    if (input.value !== originalValue) {
                        saveSubtaskInlineEdit(subtaskId, field);
                    }
                });

                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveSubtaskInlineEdit(subtaskId, field);
                    } else if (e.key === 'Escape') {
                        cancelSubtaskInlineEdit();
                    }
                });

            } else if (field === 'startDate') {
                // Edit start date
                const currentValue = subtask.startDate || '';
                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <input type="date" class="inline-edit-input" value="${currentValue}" id="inline-edit-subtask-input-${subtaskId}">
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-subtask-btn-${subtaskId}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const input = document.getElementById(`inline-edit-subtask-input-${subtaskId}`);
                const cancelBtn = document.getElementById(`cancel-subtask-btn-${subtaskId}`);
                const originalValue = currentValue;

                input.focus();

                // Try to open the date picker automatically
                try {
                    input.showPicker();
                } catch (e) {
                    input.click();
                }

                // Add button handlers
                cancelBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                // Auto-save on blur ONLY if value changed
                input.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        if (currentlyEditingSubtask && currentlyEditingSubtask.subtaskId === subtaskId) {
                            if (input.value !== originalValue) {
                                saveSubtaskInlineEdit(subtaskId, field);
                            } else {
                                cancelSubtaskInlineEdit();
                            }
                        }
                    }, 100);
                });

                // Save immediately on change
                input.addEventListener('change', (e) => {
                    if (input.value !== originalValue) {
                        saveSubtaskInlineEdit(subtaskId, field);
                    }
                });

                // Save on Enter, cancel on Escape
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveSubtaskInlineEdit(subtaskId, field);
                    } else if (e.key === 'Escape') {
                        cancelSubtaskInlineEdit();
                    }
                });

            } else if (field === 'assignedTo') {
                // Edit assigned to (single select for subtask)
                const activeMembers = await loadActiveTeamMembers();
                const currentAssignedId = subtask.assignedTo || '';

                const options = activeMembers.map(member => {
                    const selected = currentAssignedId === member.id ? 'selected' : '';
                    return `<option value="${member.id}" ${selected}>${member.name}</option>`;
                }).join('');

                cell.innerHTML = `
                    <div class="inline-edit-wrapper">
                        <select class="inline-edit-select" id="inline-edit-subtask-input-${subtaskId}" style="min-height: auto;">
                            ${options}
                        </select>
                        <div class="inline-edit-actions">
                            <button class="inline-edit-btn inline-edit-cancel" id="cancel-subtask-btn-${subtaskId}" title="Cancel">✕</button>
                        </div>
                    </div>
                `;
                const select = document.getElementById(`inline-edit-subtask-input-${subtaskId}`);
                const cancelBtn = document.getElementById(`cancel-subtask-btn-${subtaskId}`);

                select.focus();

                // Add button handlers
                cancelBtn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    cancelSubtaskInlineEdit();
                });

                // Auto-save on blur
                select.addEventListener('blur', (e) => {
                    setTimeout(() => {
                        if (currentlyEditingSubtask && currentlyEditingSubtask.subtaskId === subtaskId) {
                            saveSubtaskInlineEdit(subtaskId, field);
                        }
                    }, 100);
                });

                // Auto-save on change
                select.addEventListener('change', (e) => {
                    saveSubtaskInlineEdit(subtaskId, field);
                });
            }
        }

        async function saveSubtaskInlineEdit(subtaskId, field) {
            if (!currentlyEditingSubtask) return;

            const input = document.getElementById(`inline-edit-subtask-input-${subtaskId}`);
            const subtask = subtasks.find(st => st.id === subtaskId);
            if (!subtask) return;

            try {
                if (field === 'name') {
                    const newValue = input.value.trim();
                    if (!newValue) {
                        alert('Subtask name cannot be empty');
                        return;
                    }

                    // Update in Firebase
                    if (db) {
                        await db.collection('subtasks').doc(subtaskId).update({
                            name: newValue,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    subtask.name = newValue;

                } else if (field === 'date') {
                    const newValue = input.value;

                    // Update in Firebase
                    if (db) {
                        await db.collection('subtasks').doc(subtaskId).update({
                            date: newValue,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    subtask.date = newValue;

                } else if (field === 'startDate') {
                    const newValue = input.value;

                    // Update in Firebase
                    if (db) {
                        await db.collection('subtasks').doc(subtaskId).update({
                            startDate: newValue,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    subtask.startDate = newValue;

                } else if (field === 'assignedTo') {
                    const newMemberId = input.value;
                    if (!newMemberId) {
                        alert('Please select a team member');
                        return;
                    }

                    const memberName = await getMemberNameById(newMemberId);

                    // Update in Firebase
                    if (db) {
                        await db.collection('subtasks').doc(subtaskId).update({
                            assignedTo: newMemberId,
                            personName: memberName,
                            person: memberName,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // Update local array
                    subtask.assignedTo = newMemberId;
                    subtask.personName = memberName;
                    subtask.person = memberName;
                }

                // Clear editing state
                currentlyEditingSubtask = null;

                // Re-render tasks
                const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '' && (Array.isArray(v) ? v.length > 0 : true));
                if (hasActiveFilters) {
                    applyTaskFilters();
                } else {
                    renderTasks();
                }

            } catch (error) {
                console.error('Error saving subtask inline edit:', error);
                alert('Error saving changes: ' + error.message);
            }
        }

        function cancelSubtaskInlineEdit() {
            if (!currentlyEditingSubtask) return;

            console.log('Cancelling subtask inline edit');

            // Clear editing state first
            currentlyEditingSubtask.cell.classList.remove('editing-mode');
            currentlyEditingSubtask = null;

            // Re-render tasks to restore original view
            const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '' && (Array.isArray(v) ? v.length > 0 : true));
            if (hasActiveFilters) {
                applyTaskFilters();
            } else {
                renderTasks();
            }
        }

        // ========================================
        // MY TASKS FILTER FUNCTIONALITY
        // ========================================
        let isMyTasksActive = false;
        let allTasks = []; // Store original tasks

        async function toggleMyTasks() {
            const myTasksBtn = document.getElementById('myTasksBtn');
            isMyTasksActive = !isMyTasksActive;

            if (isMyTasksActive) {
                // Activate My Tasks filter
                myTasksBtn.classList.add('active');

                // Get current logged-in user
                const loggedInUserData = sessionStorage.getItem('loggedInUser');
                if (!loggedInUserData) {
                    console.error('No logged in user found');
                    isMyTasksActive = false;
                    myTasksBtn.classList.remove('active');
                    return;
                }

                const currentUser = JSON.parse(loggedInUserData);
                const currentUserId = currentUser.id;

                console.log(`Activating My Tasks filter for user ID: ${currentUserId}`);

                // Ensure filter dropdowns are populated
                await populateFilterDropdowns();

                // Set the assignedTo filter to current user
                taskFilters.assignedTo = currentUserId;

                // Update the filter dropdown to show current user
                const assignedToSelect = document.getElementById('filterAssignedTo');
                if (assignedToSelect) {
                    assignedToSelect.value = currentUserId;
                }

                // Apply the filters using the existing filter system
                applyTaskFilters();

                // Update active filters display to show the filter tag
                updateActiveFiltersDisplay();
            } else {
                // Deactivate My Tasks filter
                myTasksBtn.classList.remove('active');

                console.log(`Deactivating My Tasks filter`);

                // Remove the assignedTo filter
                taskFilters.assignedTo = '';

                // Update the filter dropdown
                const assignedToSelect = document.getElementById('filterAssignedTo');
                if (assignedToSelect) {
                    assignedToSelect.value = '';
                }

                // Apply the filters (which will now show all tasks if no other filters are active)
                applyTaskFilters();

                // Update active filters display to remove the filter tag
                updateActiveFiltersDisplay();
            }
        }

        // ========================================
        // SUBTASK FUNCTIONALITY
        // ========================================
        let subtasks = []; // Store all subtasks
        let currentParentTaskId = null;
        let editingSubtaskIndex = -1;

        // Load subtasks from Firestore (OPTIMIZED with batch loading)
        async function loadSubtasksFromFirebase() {
            if (!db) return;

            try {
                // Fetch all data in parallel (one batch query instead of N queries)
                const [subtasksSnapshot, membersSnapshot, projectsSnapshot] = await Promise.all([
                    db.collection('subtasks').orderBy('createdAt', 'desc').get(),
                    db.collection('team_members').get(),
                    db.collection('projects').get()
                ]);

                // Create lookup maps for fast access (no more Firebase calls)
                const membersMap = {};
                membersSnapshot.forEach(doc => {
                    membersMap[doc.id] = doc.data().name;
                });

                const projectsMap = {};
                projectsSnapshot.forEach(doc => {
                    projectsMap[doc.id] = doc.data().name;
                });

                subtasks = [];

                // Process subtasks using cached data (instant lookup)
                subtasksSnapshot.forEach(doc => {
                    const subtaskData = doc.data();

                    // Get person name from map (fast!)
                    let personName = 'Unknown';
                    if (subtaskData.assignedTo && membersMap[subtaskData.assignedTo]) {
                        personName = membersMap[subtaskData.assignedTo];
                    }

                    // Get project name from map (fast!)
                    let projectName = '';
                    if (subtaskData.projectId && projectsMap[subtaskData.projectId]) {
                        projectName = projectsMap[subtaskData.projectId];
                    }

                    subtasks.push({
                        id: doc.id,
                        ...subtaskData,
                        personName: personName,
                        project: projectName
                    });
                });

                console.log(`✅ Loaded ${subtasks.length} subtasks from Firestore (optimized batch loading)`);
            } catch (error) {
                console.error('❌ Error loading subtasks:', error);
            }
        }

        // Render subtasks under their parent tasks
        function renderSubtasks() {
            const tableBody = document.getElementById('tableBody');

            tasks.forEach((task, taskIndex) => {
                // Find subtasks for this task
                const taskSubtasks = subtasks.filter(st => st.parentTaskId === task.id);

                if (taskSubtasks.length > 0) {
                    // Find the task row by task ID instead of by index
                    const taskRow = Array.from(tableBody.children).find(row => row.dataset.taskId === task.id);

                    if (!taskRow) {
                        console.warn(`Task row not found for task ID: ${task.id}`);
                        return;
                    }

                    taskSubtasks.forEach((subtask, subtaskIndex) => {
                        const fullName = subtask.personName || subtask.person || 'Unknown';
                        const displayName = formatNameWithInitial(fullName);
                        const avatarText = fullName.split(' ').map(n => n[0]).join('');

                        // Check if subtask is overdue (past due date and not done)
                        const isSubtaskOverdue = subtask.date && new Date(subtask.date) < new Date(new Date().setHours(0, 0, 0, 0)) && subtask.status !== 'done';
                        const subtaskOverdueClass = isSubtaskOverdue ? ' overdue' : '';

                        const subtaskRow = document.createElement('div');
                        subtaskRow.className = `table-row subtask-row${subtaskOverdueClass}`;
                        subtaskRow.dataset.parentIndex = taskIndex;
                        subtaskRow.dataset.subtaskId = subtask.id;
                        subtaskRow.draggable = true;

                        subtaskRow.innerHTML = `
                            <div class="table-cell" data-label="#">
                                <span class="subtask-indent">└─</span>
                            </div>
                            <div class="table-cell" data-label="Task">
                                <span class="task-name subtask-name editable-field subtask-editable-name" data-subtask-id="${subtask.id}" data-field="name" title="Click to edit">${subtask.name}</span>
                            </div>
                            <div class="table-cell" data-label="Status">
                                <div class="status-badge-wrapper">
                                    <div class="status-badge status-${subtask.status}" onclick="toggleSubtaskStatusPopup(event, '${subtask.id}')">
                                        ${getStatusText(subtask.status)}
                                    </div>
                                    <div class="status-popup" id="subtask-status-popup-${subtask.id}">
                                        <div class="status-popup-option blank" onclick="changeSubtaskStatus('${subtask.id}', 'blank')">
                                            Not Started
                                        </div>
                                        <div class="status-popup-option working" onclick="changeSubtaskStatus('${subtask.id}', 'working')">
                                            Working on it
                                        </div>
                                        <div class="status-popup-option stuck" onclick="changeSubtaskStatus('${subtask.id}', 'stuck')">
                                            Stuck
                                        </div>
                                        <div class="status-popup-option done" onclick="changeSubtaskStatus('${subtask.id}', 'done')">
                                            Done
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-cell" data-label="Priority">
                                <span style="color: #c5c7d0;">—</span>
                            </div>
                            <div class="table-cell" data-label="Assigned To">
                                <div class="editable-field subtask-editable-assigned" data-subtask-id="${subtask.id}" data-field="assignedTo" title="Click to edit">
                                    <div class="person-cell">
                                        <div class="person-avatar">${avatarText}</div>
                                        <span>${displayName}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="table-cell" data-label="Project">
                                ${subtask.project ? `<span class="project-badge" title="${subtask.project}">${subtask.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                            </div>
                            <div class="table-cell" data-label="Start Date">
                                <span class="date-cell editable-field subtask-editable-date" data-subtask-id="${subtask.id}" data-field="startDate" title="Click to edit">${formatDateForDisplay(subtask.startDate)}</span>
                            </div>
                            <div class="table-cell" data-label="Due Date">
                                <span class="date-cell editable-field subtask-editable-date" data-subtask-id="${subtask.id}" data-field="date" title="Click to edit">${formatDateForDisplay(subtask.date)}</span>
                            </div>
                            <div class="table-cell" data-label="Actions">
                                <div class="action-buttons">
                                    <button class="action-btn edit-btn" onclick="editSubtask('${subtask.id}')" title="Edit subtask">
                                        ✏️
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteSubtask('${subtask.id}')" title="Delete subtask">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        `;

                        // Add drag and drop event handlers
                        subtaskRow.addEventListener('dragstart', handleSubtaskDragStart);
                        subtaskRow.addEventListener('dragend', handleSubtaskDragEnd);

                        // Insert after parent task
                        taskRow.insertAdjacentElement('afterend', subtaskRow);
                    });
                }
            });

            // Add event delegation for subtask inline editing
            setupSubtaskInlineEditListeners();
        }

        // Setup event delegation for subtask inline editing
        function setupSubtaskInlineEditListeners() {
            const tableBody = document.getElementById('tableBody');

            // Remove old listeners first
            const oldHandler = tableBody._subtaskEditHandler;
            if (oldHandler) {
                tableBody.removeEventListener('click', oldHandler);
            }

            // Create new handler
            const handler = function(e) {
                // Check if clicked on subtask editable field
                const target = e.target.closest('.subtask-editable-name, .subtask-editable-date, .subtask-editable-assigned');

                if (target) {
                    e.stopPropagation();
                    const subtaskId = target.getAttribute('data-subtask-id');
                    const field = target.getAttribute('data-field');

                    console.log('Subtask inline edit clicked:', subtaskId, field);
                    startSubtaskInlineEdit(subtaskId, field, target);
                }
            };

            // Store handler reference and attach
            tableBody._subtaskEditHandler = handler;
            tableBody.addEventListener('click', handler);
        }

        // ========================================
        // SUBTASK DRAG AND DROP FUNCTIONALITY
        // ========================================
        let draggedSubtask = null;

        function handleSubtaskDragStart(e) {
            draggedSubtask = {
                element: e.currentTarget,
                subtaskId: e.currentTarget.dataset.subtaskId,
                oldParentIndex: e.currentTarget.dataset.parentIndex
            };

            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.currentTarget.innerHTML);

            console.log('Dragging subtask:', draggedSubtask.subtaskId);
        }

        function handleSubtaskDragEnd(e) {
            e.currentTarget.classList.remove('dragging');

            // Remove all drop target highlights
            document.querySelectorAll('.table-row').forEach(row => {
                row.classList.remove('drag-over', 'drop-target');
            });

            draggedSubtask = null;
        }

        function setupTaskDropTargets() {
            const tableBody = document.getElementById('tableBody');

            // Get all task rows (not subtask rows)
            tableBody.querySelectorAll('.table-row:not(.subtask-row)').forEach(taskRow => {
                taskRow.addEventListener('dragover', handleTaskDragOver);
                taskRow.addEventListener('dragenter', handleTaskDragEnter);
                taskRow.addEventListener('dragleave', handleTaskDragLeave);
                taskRow.addEventListener('drop', handleTaskDrop);
            });
        }

        function handleTaskDragOver(e) {
            if (!draggedSubtask) return;

            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleTaskDragEnter(e) {
            if (!draggedSubtask) return;

            e.currentTarget.classList.add('drag-over');
        }

        function handleTaskDragLeave(e) {
            if (!draggedSubtask) return;

            e.currentTarget.classList.remove('drag-over');
        }

        async function handleTaskDrop(e) {
            if (!draggedSubtask) return;

            e.stopPropagation();
            e.preventDefault();

            const dropTargetRow = e.currentTarget;
            dropTargetRow.classList.remove('drag-over');

            // Get the task ID from the row (use data-task-id instead of data-index)
            const newParentTaskId = dropTargetRow.dataset.taskId;

            if (!newParentTaskId) {
                console.error('Could not find target task ID');
                return;
            }

            // Find the actual task by ID
            const newParentTask = tasks.find(t => t.id === newParentTaskId);

            if (!newParentTask) {
                console.error('Could not find target task');
                return;
            }

            console.log('Dropping subtask on task:', newParentTask.name);

            // Show spinner while moving subtask
            showSpinner('Moving subtask...');

            // Update subtask's parent in Firebase
            try {
                await db.collection('subtasks').doc(draggedSubtask.subtaskId).update({
                    parentTaskId: newParentTask.id,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('✅ Subtask parent updated');

                // Reload subtasks and re-render
                await loadSubtasksFromFirebase();

                // Maintain active filters if any (including My Tasks toggle)
                const hasActiveFilters = (taskFilters && Object.values(taskFilters).some(v => v !== '' && (Array.isArray(v) ? v.length > 0 : true))) || isMyTasksActive;
                if (hasActiveFilters) {
                    applyTaskFilters();
                } else {
                    renderTasks();
                }

                // Hide spinner after everything is complete
                hideSpinner();

            } catch (error) {
                console.error('❌ Error updating subtask parent:', error);
                hideSpinner();
                alert('Error moving subtask: ' + error.message);
            }
        }

        // ========================================
        // INLINE ADD SUBTASK FUNCTIONALITY
        // ========================================
        let currentInlineAddSubtask = null;

        async function showInlineAddSubtask(taskIndex) {
            // Close any existing inline add row
            if (currentInlineAddSubtask) {
                cancelInlineAddSubtask();
            }

            const task = tasks[taskIndex];
            const tableBody = document.getElementById('tableBody');
            const taskRow = tableBody.children[taskIndex];

            if (!taskRow) return;

            // Load active team members for dropdown
            const activeMembers = await loadActiveTeamMembers();

            // Create member options
            const memberOptions = activeMembers.map(member =>
                `<option value="${member.id}">${member.name}</option>`
            ).join('');

            // Load projects for dropdown
            let projectOptions = '<option value="">No Project</option>';
            try {
                const projectsSnapshot = await db.collection('projects').get();
                projectOptions += projectsSnapshot.docs.map(doc => {
                    const project = doc.data();
                    return `<option value="${doc.id}" ${doc.id === task.projectId ? 'selected' : ''}>${project.name}</option>`;
                }).join('');
            } catch (error) {
                console.error('Error loading projects:', error);
            }

            // Create inline add subtask row
            const addRow = document.createElement('div');
            addRow.className = 'table-row inline-add-subtask-row';
            addRow.id = `inline-add-subtask-${taskIndex}`;

            addRow.innerHTML = `
                <div class="table-cell" data-label="#">
                    <span class="subtask-indent">└─</span>
                </div>
                <div class="table-cell" data-label="Task">
                    <input type="text" placeholder="Subtask name" id="inline-subtask-name-${taskIndex}" autocomplete="off">
                </div>
                <div class="table-cell" data-label="Status">
                    <select id="inline-subtask-status-${taskIndex}">
                        <option value="blank">Not Started</option>
                        <option value="working">Working on it</option>
                        <option value="stuck">Stuck</option>
                        <option value="done">Done</option>
                    </select>
                </div>
                <div class="table-cell" data-label="Priority">
                    <span style="color: #c5c7d0;">—</span>
                </div>
                <div class="table-cell" data-label="Assigned To">
                    <select id="inline-subtask-person-${taskIndex}">
                        <option value="">Select member...</option>
                        ${memberOptions}
                    </select>
                </div>
                <div class="table-cell" data-label="Project">
                    <select id="inline-subtask-project-${taskIndex}">
                        ${projectOptions}
                    </select>
                </div>
                <div class="table-cell" data-label="Start Date">
                    <input type="date" id="inline-subtask-startdate-${taskIndex}">
                </div>
                <div class="table-cell" data-label="Due Date">
                    <input type="date" id="inline-subtask-date-${taskIndex}">
                </div>
                <div class="table-cell" data-label="Actions">
                    <div class="inline-add-subtask-actions">
                        <button class="inline-add-subtask-save" id="inline-subtask-save-${taskIndex}">Save</button>
                        <button class="inline-add-subtask-cancel" id="inline-subtask-cancel-${taskIndex}">Cancel</button>
                    </div>
                </div>
            `;

            // Insert after task row
            taskRow.insertAdjacentElement('afterend', addRow);

            // Store reference
            currentInlineAddSubtask = {
                taskIndex,
                taskId: task.id,
                row: addRow
            };

            // Focus on name input
            const nameInput = document.getElementById(`inline-subtask-name-${taskIndex}`);
            if (nameInput) nameInput.focus();

            // Add event listeners
            const saveBtn = document.getElementById(`inline-subtask-save-${taskIndex}`);
            const cancelBtn = document.getElementById(`inline-subtask-cancel-${taskIndex}`);

            saveBtn.addEventListener('click', () => saveInlineAddSubtask(taskIndex));
            cancelBtn.addEventListener('click', cancelInlineAddSubtask);

            // Save on Enter key in name input
            nameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveInlineAddSubtask(taskIndex);
                } else if (e.key === 'Escape') {
                    cancelInlineAddSubtask();
                }
            });
        }

        async function saveInlineAddSubtask(taskIndex) {
            if (!currentInlineAddSubtask) return;

            const name = document.getElementById(`inline-subtask-name-${taskIndex}`).value.trim();
            const status = document.getElementById(`inline-subtask-status-${taskIndex}`).value;
            const assignedTo = document.getElementById(`inline-subtask-person-${taskIndex}`).value;
            const projectId = document.getElementById(`inline-subtask-project-${taskIndex}`).value;
            const startDate = document.getElementById(`inline-subtask-startdate-${taskIndex}`).value;
            const date = document.getElementById(`inline-subtask-date-${taskIndex}`).value;

            // Validate
            if (!name) {
                alert('⚠️ Please enter a subtask name');
                return;
            }

            if (!assignedTo) {
                alert('⚠️ Please select a team member');
                return;
            }

            // Show spinner
            showSpinner('Creating subtask...');

            try {
                // Get member name
                const memberName = await getMemberNameById(assignedTo);

                // Create subtask data
                const subtaskData = {
                    name: name,
                    status: status,
                    assignedTo: assignedTo,
                    personName: memberName,
                    person: memberName,
                    projectId: projectId || null,
                    startDate: startDate,
                    date: date,
                    parentTaskId: currentInlineAddSubtask.taskId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Get project name if project is selected
                if (projectId) {
                    const projectDoc = await db.collection('projects').doc(projectId).get();
                    if (projectDoc.exists) {
                        subtaskData.project = projectDoc.data().name;
                    }
                }

                // Add to Firebase
                await db.collection('subtasks').add(subtaskData);

                console.log('✅ Subtask created');

                // Reload subtasks
                await loadSubtasksFromFirebase();

                // Remove inline add row
                cancelInlineAddSubtask();

                // Re-render with filters maintained
                const hasActiveFilters = (taskFilters && Object.values(taskFilters).some(v => v !== '' && (Array.isArray(v) ? v.length > 0 : true))) || isMyTasksActive;
                if (hasActiveFilters) {
                    applyTaskFilters();
                } else {
                    renderTasks();
                }

                hideSpinner();

            } catch (error) {
                console.error('❌ Error creating subtask:', error);
                hideSpinner();
                alert('Error creating subtask: ' + error.message);
            }
        }

        function cancelInlineAddSubtask() {
            if (!currentInlineAddSubtask) return;

            // Remove the inline add row
            if (currentInlineAddSubtask.row && currentInlineAddSubtask.row.parentNode) {
                currentInlineAddSubtask.row.remove();
            }

            currentInlineAddSubtask = null;
        }

        // Open subtask modal
        async function openSubtaskModal(taskIndex) {
            const task = tasks[taskIndex];
            currentParentTaskId = task.id;
            editingSubtaskIndex = -1;

            // Update modal title
            document.getElementById('subtaskModalTitle').textContent = 'Create New Subtask';

            // Open modal first
            document.getElementById('subtaskModal').classList.add('active');

            // Populate dropdowns
            await populateSubtaskAssignToDropdown();
            await populateSubtaskProjectDropdown();

            // Reset form after populating dropdowns
            document.getElementById('subtaskName').value = '';
            document.getElementById('subtaskStatus').value = 'blank';
            document.getElementById('subtaskDate').value = '';
            document.getElementById('subtaskStartDate').value = '';

            // Reset date displays
            document.getElementById('subtaskDate-display').textContent = 'dd/mm/yyyy';
            document.getElementById('subtaskDate-display').classList.add('placeholder');
            document.getElementById('subtaskStartDate-display').textContent = 'dd/mm/yyyy';
            document.getElementById('subtaskStartDate-display').classList.add('placeholder');

            // Set default values from parent task
            document.getElementById('subtaskProject').value = task.projectId || '';
            document.getElementById('subtaskPerson').value = task.assignedTo || '';

            // Reset button text
            const submitBtn = document.querySelector('#subtaskForm button[type="submit"]');
            submitBtn.textContent = 'Create Subtask';
        }

        // Close subtask modal
        function closeSubtaskModal() {
            document.getElementById('subtaskModal').classList.remove('active');
            document.getElementById('subtaskForm').reset();
            currentParentTaskId = null;
            editingSubtaskIndex = -1;

            // Reset button text
            const submitBtn = document.querySelector('#subtaskForm button[type="submit"]');
            submitBtn.textContent = 'Create Subtask';
        }

        // Populate assign to dropdown for subtask
        async function populateSubtaskAssignToDropdown() {
            console.log('🔄 populateSubtaskAssignToDropdown() called');

            const select = document.getElementById('subtaskPerson');
            if (!select) {
                console.error('❌ subtaskPerson select element not found!');
                return;
            }

            console.log('✅ Found subtaskPerson select element');

            // Show loading state
            select.innerHTML = '<option value="" disabled selected>Loading active members...</option>';
            console.log('⏳ Loading state set, calling loadActiveTeamMembers()...');

            // Get active members with IDs (using the same function as main task modal)
            const activeMembers = await loadActiveTeamMembers();
            console.log('📦 Received activeMembers array:', activeMembers);

            if (activeMembers.length === 0) {
                select.innerHTML = '<option value="" disabled selected>No team members found</option>';
                console.warn("⚠️ No active team members found in database");
                return;
            }

            // Clear current options and add placeholder
            select.innerHTML = '<option value="" disabled selected>Select team member...</option>';

            // Add active members with ID as value
            activeMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;  // Store member ID
                option.textContent = member.name;  // Show member name
                option.setAttribute('data-member-name', member.name);
                select.appendChild(option);
            });

            console.log(`✅ Populated subtask dropdown with ${activeMembers.length} active members`);
        }

        // Populate project dropdown for subtask
        async function populateSubtaskProjectDropdown() {
            console.log('🔄 populateSubtaskProjectDropdown() called');
            const select = document.getElementById('subtaskProject');

            if (!select) {
                console.error('❌ subtaskProject select element not found!');
                return;
            }

            // Show loading state
            select.innerHTML = '<option value="">Loading projects...</option>';

            if (!db) {
                console.error('❌ Firebase not initialized');
                select.innerHTML = '<option value="">No Project</option>';
                return;
            }

            try {
                const snapshot = await db.collection('projects').get();
                console.log(`📦 Found ${snapshot.size} projects in database`);

                // Clear and add default option
                select.innerHTML = '<option value="">No Project</option>';

                if (snapshot.empty) {
                    console.warn('⚠️ No projects found in database');
                    return;
                }

                // Add projects to dropdown
                let addedCount = 0;
                snapshot.forEach(doc => {
                    const project = doc.data();
                    if (project.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;  // Store project ID
                        option.textContent = project.name;  // Show project name
                        option.setAttribute('data-project-name', project.name);
                        select.appendChild(option);
                        addedCount++;
                    }
                });

                console.log(`✅ Populated subtask project dropdown with ${addedCount} projects`);
            } catch (error) {
                console.error('❌ Error loading projects:', error);
            }
        }

        // Handle subtask form submission
        document.getElementById('subtaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const subtaskData = {
                name: document.getElementById('subtaskName').value,
                status: document.getElementById('subtaskStatus').value,
                assignedTo: document.getElementById('subtaskPerson').value,
                projectId: document.getElementById('subtaskProject').value || null,
                date: document.getElementById('subtaskDate').value,
                startDate: document.getElementById('subtaskStartDate').value,
                parentTaskId: currentParentTaskId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (editingSubtaskIndex !== -1) {
                    // Update existing subtask
                    const subtaskId = subtasks[editingSubtaskIndex].id;
                    await db.collection('subtasks').doc(subtaskId).update({
                        ...subtaskData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('✅ Subtask updated');
                } else {
                    // Create new subtask
                    await db.collection('subtasks').add(subtaskData);
                    console.log('✅ Subtask created');
                }

                closeSubtaskModal();
                await loadSubtasksFromFirebase();
                renderTasks();
            } catch (error) {
                console.error('❌ Error saving subtask:', error);
                alert('Error saving subtask: ' + error.message);
            }
        });

        // Edit subtask
        async function editSubtask(subtaskId) {
            const subtaskIndex = subtasks.findIndex(st => st.id === subtaskId);
            if (subtaskIndex === -1) return;

            const subtask = subtasks[subtaskIndex];
            editingSubtaskIndex = subtaskIndex;
            currentParentTaskId = subtask.parentTaskId;

            // Update modal title
            document.getElementById('subtaskModalTitle').textContent = 'Edit Subtask';

            // Populate dropdowns first
            await populateSubtaskAssignToDropdown();
            await populateSubtaskProjectDropdown();

            // Fill form with subtask data
            document.getElementById('subtaskName').value = subtask.name;
            document.getElementById('subtaskStatus').value = subtask.status;
            document.getElementById('subtaskPerson').value = subtask.assignedTo;
            document.getElementById('subtaskProject').value = subtask.projectId || '';
            document.getElementById('subtaskDate').value = subtask.date;
            document.getElementById('subtaskStartDate').value = subtask.startDate || '';

            // Update date displays
            updateDateDisplay(document.getElementById('subtaskDate'));
            updateDateDisplay(document.getElementById('subtaskStartDate'));

            // Open modal
            document.getElementById('subtaskModal').classList.add('active');

            // Update button text
            const submitBtn = document.querySelector('#subtaskForm button[type="submit"]');
            submitBtn.textContent = 'Update Subtask';
        }

        // Delete subtask
        async function deleteSubtask(subtaskId) {
            if (!confirm('Are you sure you want to delete this subtask?')) {
                return;
            }

            try {
                await db.collection('subtasks').doc(subtaskId).delete();
                console.log('✅ Subtask deleted');

                await loadSubtasksFromFirebase();
                renderTasks();
            } catch (error) {
                console.error('❌ Error deleting subtask:', error);
                alert('Error deleting subtask: ' + error.message);
            }
        }

        // Toggle subtask status popup
        function toggleSubtaskStatusPopup(event, subtaskId) {
            event.stopPropagation();
            const popup = document.getElementById(`subtask-status-popup-${subtaskId}`);

            // Close all other popups
            document.querySelectorAll('.status-popup').forEach(p => {
                if (p !== popup) p.classList.remove('active');
            });

            popup.classList.toggle('active');
        }

        // Change subtask status
        async function changeSubtaskStatus(subtaskId, newStatus) {
            try {
                await db.collection('subtasks').doc(subtaskId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log(`✅ Subtask status updated to ${newStatus}`);

                // Update local array
                const subtask = subtasks.find(st => st.id === subtaskId);
                if (subtask) {
                    subtask.status = newStatus;
                }

                // Re-render
                renderTasks();
            } catch (error) {
                console.error('❌ Error updating subtask status:', error);
            }
        }

        // Close subtask modal when clicking outside
        document.getElementById('subtaskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSubtaskModal();
            }
        });

        // ========================================
        // TASK SORTING FUNCTIONALITY
        // ========================================
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        function sortTasks(column) {
            // Toggle direction if clicking same column, otherwise default to ascending
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Clear all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon';
            });

            // Set active sort icon
            const sortIcon = document.getElementById(`sort-${column}`);
            if (sortIcon) {
                sortIcon.className = `sort-icon ${currentSortDirection}`;
            }

            // Sort the tasks array
            tasks.sort((a, b) => {
                let valueA, valueB;

                switch (column) {
                    case 'name':
                        valueA = (a.name || '').toLowerCase();
                        valueB = (b.name || '').toLowerCase();
                        break;

                    case 'status':
                        // Custom order: blank, working, stuck, done
                        const statusOrder = { 'blank': 0, 'working': 1, 'stuck': 2, 'done': 3 };
                        valueA = statusOrder[a.status] ?? 999;
                        valueB = statusOrder[b.status] ?? 999;
                        break;

                    case 'priority':
                        // Custom order: high, medium, low
                        const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                        valueA = priorityOrder[a.priority] ?? 999;
                        valueB = priorityOrder[b.priority] ?? 999;
                        break;

                    case 'person':
                        valueA = (a.personName || a.person || '').toLowerCase();
                        valueB = (b.personName || b.person || '').toLowerCase();
                        break;

                    case 'project':
                        valueA = (a.project || '').toLowerCase();
                        valueB = (b.project || '').toLowerCase();
                        break;

                    case 'startDate':
                        // Convert dd/mm/yyyy to comparable format
                        valueA = convertDateForSort(a.startDate);
                        valueB = convertDateForSort(b.startDate);
                        break;

                    case 'date':
                        // Convert dd/mm/yyyy to comparable format
                        valueA = convertDateForSort(a.date);
                        valueB = convertDateForSort(b.date);
                        break;

                    default:
                        return 0;
                }

                // Compare values
                if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Check if any filters are active
            const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '');

            // Re-render the sorted tasks with filters if active
            if (hasActiveFilters) {
                applyTaskFilters();
            } else {
                renderTasks();
            }
        }

        // Helper function to convert date for sorting
        function convertDateForSort(dateString) {
            if (!dateString) return '';

            // Handle yyyy/mm/dd format (display format)
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length !== 3) return dateString;

                // Check if it's yyyy/mm/dd (year is 4 digits and in first position)
                if (parts[0].length === 4) {
                    // Already yyyy/mm/dd, just remove slashes for sorting
                    return parts.join('');
                }

                // It's dd/mm/yyyy, convert for sorting
                const [day, month, year] = parts;
                return `${year}${month.padStart(2, '0')}${day.padStart(2, '0')}`;
            }

            // Handle yyyy-mm-dd format
            if (dateString.includes('-')) {
                return dateString.replace(/-/g, '');
            }

            return dateString;
        }

        async function deleteTask(index) {
            const task = tasks[index];

            // Show confirmation dialog with task name
            if (!confirm(`Are you sure you want to delete the task "${task.name}"?\n\nThis action cannot be undone.`)) {
                return; // User cancelled
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            try {
                // Delete from Firebase if task has an ID
                if (task.id && db) {
                    // First, delete all subtasks of this task
                    const taskSubtasks = subtasks.filter(st => st.parentTaskId === task.id);
                    for (const subtask of taskSubtasks) {
                        await db.collection('subtasks').doc(subtask.id).delete();
                        console.log("✅ Subtask deleted:", subtask.id);
                    }

                    await deleteTaskFromFirebase(task.id);
                    console.log("✅ Task deleted from Firebase:", task.id);
                }

                // Reload tasks and subtasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();
                await loadSubtasksFromFirebase();

                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);

            } catch (error) {
                console.error("❌ Error deleting task:", error);
                alert('❌ Error deleting task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        }

        function editTask(index) {
            editingIndex = index;
            const task = tasks[index];

            // Update modal title
            document.getElementById('modalTitle').textContent = 'Edit Task';

            // Open modal first
            document.getElementById('taskModal').classList.add('active');

            // Show modal spinner
            showModalSpinner();

            // Populate both dropdowns first, then fill in task data
            Promise.all([
                populateAssignToDropdown(),
                populateTaskProjectDropdown()
            ]).then(() => {
                // Populate form with task data
                document.getElementById('itemName').value = task.name;
                document.getElementById('itemStatus').value = task.status;
                document.getElementById('itemPriority').value = task.priority;

                // Set the assignedTo (multi-select support)
                const personSelect = document.getElementById('itemPerson');

                // Clear all selections first
                Array.from(personSelect.options).forEach(opt => opt.selected = false);

                if (task.assignedToIds && task.assignedToIds.length > 0) {
                    // Use the new assignedToIds array
                    task.assignedToIds.forEach(memberId => {
                        Array.from(personSelect.options).forEach(option => {
                            if (option.value === memberId) {
                                option.selected = true;
                            }
                        });
                    });
                } else if (task.assignedTo) {
                    // Fallback for single assignee (backwards compatibility)
                    Array.from(personSelect.options).forEach(option => {
                        if (option.value === task.assignedTo) {
                            option.selected = true;
                        }
                    });
                } else if (task.person) {
                    // Fallback for very old data - try to find by name
                    Array.from(personSelect.options).forEach(option => {
                        if (option.getAttribute('data-member-name') === task.person) {
                            option.selected = true;
                        }
                    });
                }

                // Set the project (project ID) in dropdown
                if (task.projectId) {
                    // New format: uses project ID
                    document.getElementById('itemProject').value = task.projectId;
                } else if (task.project) {
                    // Old format: try to find by name
                    const projectSelect = document.getElementById('itemProject');
                    const options = projectSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].getAttribute('data-project-name') === task.project) {
                            projectSelect.value = options[i].value;
                            break;
                        }
                    }
                }

                // Set dates using helper function (converts dd/mm/yyyy to yyyy-mm-dd for input)
                setDateInputValue(document.getElementById('itemStartDate'), task.startDate);
                setDateInputValue(document.getElementById('itemDate'), task.date);

                // Hide modal spinner after data is loaded
                hideModalSpinner();
            }).catch(error => {
                console.error('Error loading task data:', error);
                hideModalSpinner();
            });

            // Change button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Update Task';
        }

        // ========================================
        // STATUS POPUP FUNCTIONALITY
        // ========================================
        let activeStatusPopup = null;

        function toggleStatusPopup(event, index) {
            event.stopPropagation();

            const popupId = `status-popup-${index}`;
            const popup = document.getElementById(popupId);

            if (!popup) return;

            // Close any other open popup
            if (activeStatusPopup && activeStatusPopup !== popup) {
                activeStatusPopup.classList.remove('active');
            }

            // Toggle current popup
            popup.classList.toggle('active');
            activeStatusPopup = popup.classList.contains('active') ? popup : null;
        }

        async function changeTaskStatus(index, newStatus) {
            const task = tasks[index];

            if (!task || !task.id) {
                console.error('Task not found or missing ID');
                return;
            }

            // Close popup
            if (activeStatusPopup) {
                activeStatusPopup.classList.remove('active');
                activeStatusPopup = null;
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            try {
                // Update in Firebase
                await db.collection('tasks').doc(task.id).update({
                    status: newStatus
                });

                console.log(`✅ Task status updated to ${newStatus}`);

                // Update local array
                task.status = newStatus;

                // Re-render tasks (will apply filters if active)
                const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '');
                if (hasActiveFilters) {
                    applyTaskFilters();
                } else {
                    renderTasks();
                }

                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                }, 500);

            } catch (error) {
                console.error('❌ Error updating task status:', error);
                alert('Error updating task status: ' + error.message);
                isManualOperation = false;
            }
        }

        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            if (activeStatusPopup && !event.target.closest('.status-badge-wrapper')) {
                activeStatusPopup.classList.remove('active');
                activeStatusPopup = null;
            }
        });

        async function cloneTask(index) {
            const task = tasks[index];

            // Show confirmation dialog
            if (!confirm(`Are you sure you want to duplicate the task "${task.name}"?`)) {
                return; // User cancelled
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            // Create a copy of the task with a new name
            const clonedTask = {
                name: task.name + ' (Copy)',
                status: task.status,
                priority: task.priority,
                assignedTo: task.assignedTo,
                person: task.person,
                personName: task.personName,
                project: task.project || '',
                projectId: task.projectId,
                date: task.date,
                startDate: task.startDate,
                timeline: task.timeline,
                createdAt: new Date()
            };

            try {
                // Add cloned task to Firebase
                if (db) {
                    await addTaskToFirebase(clonedTask);
                    console.log("✅ Task cloned successfully");
                }

                // Reload tasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();

                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);

            } catch (error) {
                console.error("❌ Error cloning task:", error);
                alert('❌ Error cloning task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        }

        function openModal() {
            console.log('🚪 openModal() called');
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Create New Task';
            document.getElementById('taskForm').reset();

            // Populate dropdowns
            console.log('📞 Calling populateAssignToDropdown()...');
            populateAssignToDropdown();

            console.log('📞 Calling populateTaskProjectDropdown()...');
            populateTaskProjectDropdown();

            document.getElementById('taskModal').classList.add('active');
            console.log('✅ Modal opened');

            // Reset button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Create Task';
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskForm').reset();
            editingIndex = -1;
            
            // Reset button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Create Task';
        }

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get selected team members (multi-select)
            const personSelect = document.getElementById('itemPerson');
            const selectedOptions = Array.from(personSelect.selectedOptions);

            // Validate that at least one team member is selected
            if (selectedOptions.length === 0) {
                alert('⚠️ Please select at least one team member to assign this task to.');
                document.getElementById('itemPerson').focus();
                return;
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            // Get assigned member IDs and names
            const assignedToIds = selectedOptions.map(opt => opt.value).filter(v => v);
            const assignedToNames = selectedOptions.map(opt => opt.getAttribute('data-member-name') || opt.textContent).filter(n => n);

            // For backwards compatibility, store first member as primary
            const primaryMemberId = assignedToIds[0];
            const primaryMemberName = assignedToNames[0];

            // Get project ID and name
            const projectSelect = document.getElementById('itemProject');
            const projectId = projectSelect.value;
            const projectOption = projectSelect.options[projectSelect.selectedIndex];
            const projectName = projectOption.getAttribute('data-project-name') || projectOption.textContent || '';

            const newTask = {
                name: document.getElementById('itemName').value,
                status: document.getElementById('itemStatus').value,
                priority: document.getElementById('itemPriority').value,
                assignedTo: primaryMemberId,  // Store primary member ID (backwards compatibility)
                assignedToIds: assignedToIds,  // Store all assigned member IDs
                person: primaryMemberName,  // Store primary name for backwards compatibility
                assignedToNames: assignedToNames,  // Store all assigned names
                projectId: projectId,  // Store project ID
                project: projectName,  // Store project name for backwards compatibility and display
                startDate: getDateInputValue(document.getElementById('itemStartDate')),  // Convert to dd/mm/yyyy
                date: getDateInputValue(document.getElementById('itemDate'))  // Convert to dd/mm/yyyy
            };

            try {
                if (editingIndex >= 0) {
                    const task = tasks[editingIndex];
                    
                    // Update in Firebase if task has an ID
                    if (task.id && db) {
                        await updateTaskInFirebase(task.id, newTask);
                        console.log("✅ Task updated in Firebase:", task.id);
                    }
                } else {
                    // Add to Firebase
                    if (db) {
                        const taskId = await addTaskToFirebase(newTask);
                        console.log("✅ Task added to Firebase:", taskId);
                    }
                }

                closeModal();
                
                // Reload tasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();
                
                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);
                
            } catch (error) {
                console.error("❌ Error saving task:", error);
                alert('❌ Error saving task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        });

        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ========================================
        // TEAM MEMBER MODAL FUNCTIONS
        // ========================================
        
        let editingMemberId = null;

        function openMemberModal() {
            editingMemberId = null;
            document.getElementById('memberModalTitle').textContent = 'Add Team Member';
            document.getElementById('memberModal').classList.add('active');
            document.getElementById('memberForm').reset();
            
            // Set default status
            document.getElementById('memberStatus').value = 'Active';
            
            // Reset button text
            const submitBtn = document.querySelector('#memberForm button[type="submit"]');
            submitBtn.textContent = 'Add Member';
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('active');
            document.getElementById('memberForm').reset();
            editingMemberId = null;
        }

        function editMember(member, index) {
            editingMemberId = member.id;
            
            // Update modal title
            document.getElementById('memberModalTitle').textContent = 'Edit Team Member';
            
            // Populate form with member data
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberEmail').value = member.email;
            document.getElementById('memberRole').value = member.role;
            document.getElementById('memberDepartment').value = member.department;
            document.getElementById('memberAvatar').value = member.avatar;
            document.getElementById('memberStatus').value = member.status || 'Active';
            document.getElementById('memberSkills').value = member.skills ? member.skills.join(', ') : '';
            
            // Change button text
            const submitBtn = document.querySelector('#memberForm button[type="submit"]');
            submitBtn.textContent = 'Update Member';
            
            // Open modal
            document.getElementById('memberModal').classList.add('active');
        }

        // Handle member form submission
        document.getElementById('memberForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const skillsInput = document.getElementById('memberSkills').value;
            const skillsArray = skillsInput ? skillsInput.split(',').map(s => s.trim()).filter(s => s) : [];
            
            const memberData = {
                name: document.getElementById('memberName').value,
                email: document.getElementById('memberEmail').value,
                role: document.getElementById('memberRole').value,
                department: document.getElementById('memberDepartment').value,
                avatar: document.getElementById('memberAvatar').value.toUpperCase(),
                status: document.getElementById('memberStatus').value,
                active: document.getElementById('memberStatus').value === 'Active',
                skills: skillsArray
            };

            try {
                if (editingMemberId) {
                    // Get old member data to check if name changed
                    const oldMemberDoc = await db.collection('team_members').doc(editingMemberId).get();
                    const oldMemberData = oldMemberDoc.data();
                    const nameChanged = oldMemberData.name !== memberData.name;
                    
                    // Update existing member
                    if (db) {
                        await db.collection('team_members').doc(editingMemberId).update({
                            ...memberData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("✅ Member updated:", editingMemberId);
                    }
                    
                    // If name changed, update all tasks assigned to this member
                    if (nameChanged && db) {
                        console.log(`📝 Name changed from "${oldMemberData.name}" to "${memberData.name}", updating tasks...`);
                        
                        const tasksSnapshot = await db.collection('tasks')
                            .where('assignedTo', '==', editingMemberId)
                            .get();
                        
                        const batch = db.batch();
                        let updateCount = 0;
                        
                        tasksSnapshot.forEach(doc => {
                            batch.update(doc.ref, {
                                person: memberData.name,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            updateCount++;
                        });
                        
                        if (updateCount > 0) {
                            await batch.commit();
                            console.log(`✅ Updated ${updateCount} tasks with new member name`);
                        }
                    }
                } else {
                    // Add new member
                    if (db) {
                        await db.collection('team_members').add({
                            ...memberData,
                            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("✅ Member added");
                    }
                }

                // Reload team members
                await loadTeamMembersWithStats();
                
                // Reload assign to dropdown if task modal is open
                if (document.getElementById('taskModal').classList.contains('active')) {
                    await populateAssignToDropdown();
                }
                
                closeMemberModal();
                
                alert(editingMemberId ? '✅ Team member updated successfully!' : '✅ Team member added successfully!');
                
            } catch (error) {
                console.error("❌ Error saving member:", error);
                alert('❌ Error saving team member: ' + error.message);
            }
        });

        document.getElementById('memberModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMemberModal();
            }
        });

        // ========================================
        // PROJECT CRUD FUNCTIONS
        // ========================================

        function renderProjects() {
            // Reset filtered projects when rendering all projects
            currentFilteredProjects = null;

            // Render in the current view
            if (currentProjectView === 'table') {
                renderProjectsTable();
            } else if (currentProjectView === 'timeline') {
                renderGanttChart();
            } else {
                renderProjectsGridView(projects);
            }
        }

        function renderProjectsGridOld() {
            const projectsGrid = document.getElementById('projectsGrid');
            if (!projectsGrid) return;

            projectsGrid.innerHTML = projects.map((project, index) => `
                <div class="project-card" onclick="if(event.target.closest('.project-action-btn') || event.target.closest('.project-status-badge')) return; editProject(${index})">
                    <div class="project-card-header">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div class="project-health-circle ${project.projectHealth || 'none'}" title="Health: ${project.projectHealth || 'None'}">
                                   
                                </div>
                                <div class="project-card-title">${project.name}</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                <div class="project-status-popup-wrapper">
                                    <span class="project-status-badge clickable ${project.status}"
                                          onclick="toggleProjectStatusPopup(event, '${project.id}', ${index})"
                                          title="Click to change status">
                                        ${formatStatus(project.status)}
                                    </span>
                                    <div class="project-status-popup" id="project-status-popup-${project.id}">
                                        <div class="project-status-popup-option planned" onclick="changeProjectStatus('${project.id}', ${index}, 'planned')">
                                            Planned
                                        </div>
                                        <div class="project-status-popup-option in-progress" onclick="changeProjectStatus('${project.id}', ${index}, 'in-progress')">
                                            In Progress
                                        </div>
                                        <div class="project-status-popup-option completed" onclick="changeProjectStatus('${project.id}', ${index}, 'completed')">
                                            Completed
                                        </div>
                                        <div class="project-status-popup-option on-hold" onclick="changeProjectStatus('${project.id}', ${index}, 'on-hold')">
                                            On Hold
                                        </div>
                                    </div>
                                </div>
                                <div class="project-status-popup-wrapper">
                                    <span class="project-status-badge clickable"
                                          style="background: #0073ea; color: white;"
                                          onclick="toggleProjectSDLCPopup(event, '${project.id}', ${index})"
                                          title="Click to change SDLC phase">
                                        ${project.sdlc || 'No Phase'}
                                    </span>
                                    <div class="project-status-popup" id="project-sdlc-popup-${project.id}">
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Requirement')">
                                            Requirement
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Design')">
                                            Design
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Development')">
                                            Development
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Smoke Test')">
                                            Smoke Test
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'SIT')">
                                            SIT
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'UAT')">
                                            UAT
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Implemented')">
                                            Implemented
                                        </div>
                                    </div>
                                </div>
                                ${project.projectType ? `<span class="project-status-badge" style="background: #9b59b6; color: white;">${project.projectType}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="project-card-description">${project.description}</div>

                    <div class="project-progress">
                        <div class="project-progress-label">
                            <span>Progress</span>
                            <span>${project.progress}%</span>
                        </div>
                        <div class="project-progress-bar">
                            <div class="project-progress-fill" style="width: ${project.progress}%"></div>
                        </div>
                    </div>

                    <div class="project-card-meta">
                        <div class="project-meta-item">
                            <span class="project-meta-icon">📅</span>
                            <span>${formatDateForDisplay(project.startDate)} - ${formatDateForDisplay(project.endDate)}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">💰</span>
                            <span>฿${project.budget.toLocaleString()}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">👥</span>
                            <span>${project.teamMembers && project.teamMembers.length > 0 ? project.teamMembers.length + ' members' : 'No members'}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">⚡</span>
                            <span>${formatPriority(project.priority)}</span>
                        </div>
                    </div>

                    ${project.projectManagers && project.projectManagers.length > 0 ? `
                        <div class="project-team-members" style="margin-top: 12px; padding: 12px; background: #ffe6f0; border-radius: 8px;">
                            <div style="font-size: 12px; font-weight: 700; color: #c2185b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Project Managers</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${project.projectManagers.map(manager => `
                                    <span style="background: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; color: #c2185b; border: 1px solid #f48fb1; font-weight: 600;">${formatNameWithInitial(manager)}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${project.teamMembers && project.teamMembers.length > 0 ? `
                        <div class="project-team-members" style="margin-top: 12px; padding: 12px; background: #f6f7fb; border-radius: 8px;">
                            <div style="font-size: 12px; font-weight: 700; color: #676879; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Team Members</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${project.teamMembers.map(member => `
                                    <span style="background: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; color: #323338; border: 1px solid #e6e9ef;">${formatNameWithInitial(member)}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${project.tags && project.tags.length > 0 ? `
                        <div class="project-tags">
                            ${project.tags.map(tag => `<span class="project-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}

                    <div class="project-card-actions">
                        <button class="project-action-btn" onclick="viewProjectTasks('${project.id}', '${project.name}')">
                            📋 Tasks
                        </button>
                        <button class="project-action-btn" onclick="editProject(${index})">
                            ✏️ Edit
                        </button>
                        <button class="project-action-btn delete" onclick="deleteProject(${index})">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function formatStatus(status) {
            return status.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function formatPriority(priority) {
            return priority.charAt(0).toUpperCase() + priority.slice(1);
        }

        // ========================================
        // PROJECT VIEW SWITCHING FUNCTIONS
        // ========================================

        // Store current project view
        let currentProjectView = 'grid';
        let currentTimelineScale = 'month';
        let currentFilteredProjects = null; // Store filtered projects when filters are applied
        let chartTypeFilter = null; // Selected project type from chart
        let chartHealthFilter = null; // Selected health status from chart
        let chartManagerFilter = null; // Selected project manager from chart
        let chartStatusFilter = null; // Selected project status from chart
        let chartPriorityFilter = null; // Selected project priority from chart
        let chartSDLCFilter = null; // Selected SDLC phase from chart

        function switchProjectView(viewType) {
            currentProjectView = viewType;
            const gridView = document.getElementById('projectsGrid');
            const tableView = document.getElementById('projectsTableView');
            const timelineView = document.getElementById('projectsTimelineView');
            const tableBtn = document.getElementById('tableViewBtn');
            const timelineBtn = document.getElementById('timelineViewBtn');

            // Hide all views
            gridView.style.display = 'none';
            tableView.style.display = 'none';
            timelineView.style.display = 'none';

            // Reset button styles
            tableBtn.style.background = '';
            tableBtn.style.border = '';
            tableBtn.style.color = '';
            timelineBtn.style.background = '';
            timelineBtn.style.border = '';
            timelineBtn.style.color = '';

            if (viewType === 'table') {
                tableView.style.display = 'block';
                tableBtn.style.background = 'white';
                tableBtn.style.border = '2px solid #667eea';
                tableBtn.style.color = '#667eea';
                renderProjectsTable(currentFilteredProjects);
            } else if (viewType === 'timeline') {
                timelineView.style.display = 'block';
                timelineBtn.style.background = 'white';
                timelineBtn.style.border = '2px solid #667eea';
                timelineBtn.style.color = '#667eea';
                renderGanttChart(currentFilteredProjects);
            } else {
                gridView.style.display = 'grid';
                gridView.style.width = '100%';
                // Highlight the Project Card button when viewing grid
                tableBtn.style.background = 'white';
                tableBtn.style.border = '2px solid #667eea';
                tableBtn.style.color = '#667eea';
                // Reset timeline button
                timelineBtn.style.background = '';
                timelineBtn.style.border = '';
                timelineBtn.style.color = '';
                renderProjectsGridView(currentFilteredProjects);
            }
        }

        // Render projects in table format
        function renderProjectsTable(filteredProjects) {
            const tableBody = document.getElementById('projectsTableBody');

            // Use filtered projects if provided, otherwise use all projects
            const projectsToDisplay = filteredProjects || projects;

            if (projectsToDisplay.length === 0) {
                tableBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #676879;">No projects found</div>';
                return;
            }

            tableBody.innerHTML = projectsToDisplay.map((project, index) => `
                <div class="table-row">
                    <div class="table-cell" style="flex: 2; font-weight: 600;">${project.name}</div>
                    <div class="table-cell">
                        <span class="project-status-badge ${project.status}">${formatStatus(project.status)}</span>
                    </div>
                    <div class="table-cell">
                        <span style="font-size: 12px; padding: 4px 8px; background: #f0f2f5; border-radius: 4px;">${project.projectType || 'N/A'}</span>
                    </div>
                    <div class="table-cell">
                        <span style="font-size: 12px; padding: 4px 8px; background: #e8f0fe; border-radius: 4px; color: #0073ea;">${project.sdlc || 'N/A'}</span>
                    </div>
                    <div class="table-cell">
                        ${project.projectHealth && project.projectHealth !== 'none' ? `
                            <div class="project-health-circle ${project.projectHealth}">${project.projectHealth.charAt(0).toUpperCase()}</div>
                        ` : '<span style="color: #999;">—</span>'}
                    </div>
                    <div class="table-cell">
                        <div style="font-size: 12px; color: #676879;">${project.progress || 0}%</div>
                        <div style="background: #e6e9ef; border-radius: 4px; height: 4px; margin-top: 4px; overflow: hidden;">
                            <div style="background: #667eea; height: 100%; width: ${project.progress || 0}%;"></div>
                        </div>
                    </div>
                    <div class="table-cell" style="font-size: 12px;">${project.startDate || 'N/A'}</div>
                    <div class="table-cell" style="font-size: 12px;">${project.endDate || 'N/A'}</div>
                    <div class="table-cell">
                        <button class="project-action-btn" style="padding: 4px 8px; font-size: 12px;" onclick="editProject(${index})">✏️</button>
                    </div>
                </div>
            `).join('');
        }

        // Render Gantt chart
        function renderGanttChart(filteredProjects) {
            try {
                const ganttContainer = document.getElementById('ganttChart');

                if (!ganttContainer) {
                    console.error('Gantt chart container not found');
                    return;
                }

                // Use filtered projects if provided, otherwise use all projects
                const projectsToDisplay = filteredProjects || projects;

                if (projectsToDisplay.length === 0) {
                    ganttContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #676879;">No projects to display</div>';
                    return;
                }

                // Get date range for the chart
                let minDate = new Date();
                let maxDate = new Date();

                projectsToDisplay.forEach(project => {
                    if (project.startDate) {
                        const start = parseDate(project.startDate);
                        if (start < minDate) minDate = start;
                    }
                    if (project.endDate) {
                        const end = parseDate(project.endDate);
                        if (end > maxDate) maxDate = end;
                    }
                });

                // Set minDate to 1st day of the month containing earliest project start date
                minDate = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
                minDate.setHours(0, 0, 0, 0);
                // Set maxDate to end of day (23:59:59)
                maxDate.setHours(23, 59, 59, 999);

                // Calculate total days and scale based on currentTimelineScale
                const totalDays = Math.max((maxDate - minDate) / (1000 * 60 * 60 * 24), 1);
                let pixelsPerUnit = 50;
                let headerFormat = '';
                let incrementFunction = '';

                if (currentTimelineScale === 'day') {
                    // For day view: scale based on total days, minimum 30px per day
                    pixelsPerUnit = Math.max(30, 1200 / Math.max(totalDays, 1));
                    headerFormat = 'day';
                    incrementFunction = 'Day';
                } else if (currentTimelineScale === 'week') {
                    // For week view: scale based on total weeks, minimum 50px per week
                    const totalWeeks = Math.max(totalDays / 7, 1);
                    pixelsPerUnit = Math.max(50, 1200 / totalWeeks);
                    headerFormat = 'week';
                    incrementFunction = 'Week';
                } else if (currentTimelineScale === 'month') {
                    // For month view: scale based on total months, minimum 60px per month
                    const totalMonths = Math.max(totalDays / 30, 1);
                    pixelsPerUnit = Math.max(60, 1200 / totalMonths);
                    headerFormat = 'month';
                    incrementFunction = 'Month';
                } else if (currentTimelineScale === '6month') {
                    // For 6-month view: scale based on 6-month periods, minimum 65px per 6-month
                    const total6Months = Math.max(totalDays / 180, 1);
                    pixelsPerUnit = Math.max(65, 1200 / total6Months);
                    headerFormat = '6month';
                    incrementFunction = '6Month';
                } else if (currentTimelineScale === 'year') {
                    // For year view: scale based on total years, minimum 70px per year
                    const totalYears = Math.max(totalDays / 365, 1);
                    pixelsPerUnit = Math.max(70, 1200 / totalYears);
                    headerFormat = 'year';
                    incrementFunction = 'Year';
                }

                // Calculate total timeline width to ensure bars don't get clipped
                let totalTimelineWidth = 0;
                if (currentTimelineScale === 'day') {
                    const totalDaysInTimeline = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
                    totalTimelineWidth = totalDaysInTimeline * pixelsPerUnit;
                } else if (currentTimelineScale === 'week') {
                    const totalWeeksInTimeline = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 7));
                    totalTimelineWidth = totalWeeksInTimeline * pixelsPerUnit;
                } else if (currentTimelineScale === 'month') {
                    // Calculate total width using fixed 30 days per month
                    let currentDate = new Date(minDate);
                    totalTimelineWidth = 0;
                    const minorPixelWidthTemp = pixelsPerUnit / 30;
                    while (currentDate <= maxDate) {
                        totalTimelineWidth += 30 * minorPixelWidthTemp;  // Fixed 30 days per month
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                } else if (currentTimelineScale === '6month') {
                    const total6Months = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 180));
                    totalTimelineWidth = total6Months * pixelsPerUnit;
                } else if (currentTimelineScale === 'year') {
                    const totalYearsInTimeline = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 365));
                    totalTimelineWidth = totalYearsInTimeline * pixelsPerUnit;
                }

                // Render timeline header with Major and Minor scales
                let ganttHTML = `
                <div style="display: flex; margin-bottom: 0;">
                    <div style="flex: 0 0 250px; padding: 10px; font-weight: 600; border-bottom: 2px solid #e6e9ef;">Project Name</div>
                    <div style="min-width: ${totalTimelineWidth}px; padding: 0; border-bottom: 2px solid #e6e9ef;">
                        <!-- Major Scale Header -->
                        <div style="display: flex; height: 30px; margin-bottom: 0; border-bottom: 1px solid #e6e9ef;">
                `;

                // Add Major scale headers based on selected scale
                // Calculate minor pixel widths first to derive major widths
                let minorPixelWidth = 0;
                let majorUnitMultiplier = 1;
                let currentDate = new Date(minDate);

                if (currentTimelineScale === 'day') {
                    // Major: Month headers for day view
                    minorPixelWidth = pixelsPerUnit;
                    const monthGroups = new Map();
                    currentDate = new Date(minDate);

                    // First pass: collect months
                    while (currentDate <= maxDate) {
                        const monthKey = currentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        if (!monthGroups.has(monthKey)) {
                            monthGroups.set(monthKey, 0);
                        }
                        monthGroups.set(monthKey, monthGroups.get(monthKey) + 1);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }

                    // Render month headers
                    let lastMonth = '';
                    currentDate = new Date(minDate);
                    let monthDayCount = 0;
                    let currentMonth = '';

                    while (currentDate <= maxDate) {
                        const monthKey = currentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        if (monthKey !== lastMonth) {
                            // Close previous month if any
                            if (lastMonth && monthDayCount > 0) {
                                ganttHTML += `<div style="flex: 0 0 ${monthDayCount * minorPixelWidth}px; text-align: center; font-size: 13px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${lastMonth}</div>`;
                            }
                            lastMonth = monthKey;
                            monthDayCount = 0;
                        }
                        monthDayCount++;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    // Add final month
                    if (lastMonth && monthDayCount > 0) {
                        ganttHTML += `<div style="flex: 0 0 ${monthDayCount * minorPixelWidth}px; text-align: center; font-size: 13px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${lastMonth}</div>`;
                    }
                } else if (currentTimelineScale === 'week') {
                    // Major: Week (7 days), Minor: Day - Start from minDate exactly
                    minorPixelWidth = pixelsPerUnit / 7;

                    currentDate = new Date(minDate);
                    while (currentDate < maxDate) {  // Changed to < to continue until we pass maxDate
                        const majorPixelWidth = minorPixelWidth * 7;
                        const weekStart = new Date(currentDate);
                        const weekEnd = new Date(currentDate);
                        weekEnd.setDate(weekEnd.getDate() + 6);

                        const startDay = String(weekStart.getDate()).padStart(2, '0');
                        const startMonth = String(weekStart.getMonth() + 1).padStart(2, '0');
                        const endDay = String(weekEnd.getDate()).padStart(2, '0');
                        const endMonth = String(weekEnd.getMonth() + 1).padStart(2, '0');

                        const weekLabel = `${startDay}/${startMonth}-${endDay}/${endMonth}`;

                        ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${weekLabel}</div>`;
                        currentDate.setDate(currentDate.getDate() + 7);
                    }
                    // Add final week if needed
                    if (currentDate >= maxDate && currentDate > minDate) {
                        const majorPixelWidth = minorPixelWidth * 7;
                        const weekStart = currentDate;
                        weekStart.setDate(weekStart.getDate() - 7);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekEnd.getDate() + 6);

                        const startDay = String(weekStart.getDate()).padStart(2, '0');
                        const startMonth = String(weekStart.getMonth() + 1).padStart(2, '0');
                        const endDay = String(weekEnd.getDate()).padStart(2, '0');
                        const endMonth = String(weekEnd.getMonth() + 1).padStart(2, '0');

                        const weekLabel = `${startDay}/${startMonth}-${endDay}/${endMonth}`;

                        ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${weekLabel}</div>`;
                    }
                } else if (currentTimelineScale === 'month') {
                    // Major: Month, Minor: Day - Start from minDate exactly
                    // Use fixed 30 days per month for consistent alignment
                    minorPixelWidth = pixelsPerUnit / 30;

                    currentDate = new Date(minDate);
                    while (currentDate < maxDate) {  // Changed to < to continue until we pass maxDate
                        const majorPixelWidth = minorPixelWidth * 30;
                        const month = currentDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                        ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${month}</div>`;
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    // Add final month
                    const majorPixelWidth = minorPixelWidth * 30;
                    const month = currentDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${month}</div>`;
                } else if (currentTimelineScale === '6month') {
                    // Major: 6-Month periods - Use fixed 30 days per month (180 days per 6-month)
                    minorPixelWidth = pixelsPerUnit / 30; // Each month = 30 days

                    currentDate = new Date(minDate);
                    while (currentDate < maxDate) {  // Changed to < to continue until we pass maxDate
                        const halfYear = Math.floor(currentDate.getMonth() / 6) + 1;
                        const year = currentDate.getFullYear();

                        const daysIn6Month = 6 * 30;
                        const majorPixelWidth = minorPixelWidth * daysIn6Month;
                        const halfYearLabel = `H${halfYear} '${year.toString().slice(-2)}`;
                        ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${halfYearLabel}</div>`;
                        currentDate.setMonth(currentDate.getMonth() + 6);
                    }
                    // Add final 6-month period if needed
                    if (currentDate >= maxDate && currentDate > minDate) {
                        const halfYear = Math.floor(currentDate.getMonth() / 6) + 1;
                        const year = currentDate.getFullYear();
                        const daysIn6Month = 6 * 30;
                        const majorPixelWidth = minorPixelWidth * daysIn6Month;
                        const halfYearLabel = `H${halfYear} '${year.toString().slice(-2)}`;
                        ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${halfYearLabel}</div>`;
                    }
                } else if (currentTimelineScale === 'year') {
                    // Major: Year, Minor: Month - Use fixed 30 days per month (360 days per year)
                    minorPixelWidth = pixelsPerUnit / 30; // Each month = 30 days

                    currentDate = new Date(minDate);
                    while (currentDate < maxDate) {  // Changed to < to continue until we pass maxDate
                        const year = currentDate.getFullYear();
                        const daysInYear = 12 * 30;
                        const majorPixelWidth = minorPixelWidth * daysInYear;
                        ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${year}</div>`;
                        currentDate.setFullYear(currentDate.getFullYear() + 1);
                    }
                    // Add final year if needed
                    if (currentDate >= maxDate && currentDate > minDate) {
                        const year = currentDate.getFullYear();
                        const daysInYear = 12 * 30;
                        const majorPixelWidth = minorPixelWidth * daysInYear;
                        ganttHTML += `<div style="flex: 0 0 ${majorPixelWidth}px; text-align: center; font-size: 12px; font-weight: 600; color: #323338; border-right: 1px solid #e6e9ef;">${year}</div>`;
                    }
                }

                ganttHTML += `</div>
                        <!-- Minor Scale Header -->
                        <div style="display: flex; height: 50px;">
                `;

                // Add Minor scale headers - Start from minDate exactly
                currentDate = new Date(minDate);
                if (currentTimelineScale === 'day') {
                    // Minor: Day numbers with day-of-week letters for day view
                    const minorPixels = pixelsPerUnit;
                    while (currentDate <= maxDate) {
                        const dayNum = currentDate.toLocaleDateString('en-US', { day: 'numeric' });
                        const dayLetter = currentDate.toLocaleDateString('en-US', { weekday: 'narrow' });
                        ganttHTML += `<div style="flex: 0 0 ${minorPixels}px; text-align: center; font-size: 13px; display: flex; flex-direction: column; justify-content: center; color: #323338; border-right: 1px solid #e6e9ef;">
                            <div style="font-weight: 600;">${dayNum}</div>
                            <div style="font-size: 11px; color: #999999;">${dayLetter}</div>
                        </div>`;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                } else if (currentTimelineScale === 'week') {
                    // Minor: Day (7 days per week) - Start from minDate
                    const minorPixels = pixelsPerUnit / 7;
                    while (currentDate <= maxDate) {
                        const day = currentDate.toLocaleDateString('en-US', { day: 'numeric' });
                        ganttHTML += `<div style="flex: 0 0 ${minorPixels}px; text-align: center; font-size: 10px; color: #676879; border-right: 1px solid #e6e9ef;">${day}</div>`;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                } else if (currentTimelineScale === 'month') {
                    // Minor: Day (showing dates) - Each day gets equal width within month view
                    // Use same calculation as major scale: pixelsPerUnit / 30 = width per day
                    currentDate = new Date(minDate);
                    while (currentDate <= maxDate) {
                        const minorPixels = pixelsPerUnit / 30;  // Same as in major scale calculation
                        const day = String(currentDate.getDate()).padStart(2, '0');
                        ganttHTML += `<div style="flex: 0 0 ${minorPixels}px; text-align: center; font-size: 10px; color: #676879; border-right: 1px solid #e6e9ef;">${day}</div>`;
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                } else if (currentTimelineScale === '6month') {
                    // Minor: Month (6 months) - Start from minDate
                    const minorPixels = pixelsPerUnit / 6;
                    currentDate = new Date(minDate);
                    while (currentDate <= maxDate) {
                        const month = currentDate.toLocaleDateString('en-US', { month: 'short' });
                        ganttHTML += `<div style="flex: 0 0 ${minorPixels}px; text-align: center; font-size: 10px; color: #676879; border-right: 1px solid #e6e9ef;">${month}</div>`;
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                } else if (currentTimelineScale === 'year') {
                    // Minor: Month (12 months per year) - Start from minDate
                    const minorPixels = pixelsPerUnit / 12;
                    currentDate = new Date(minDate);
                    while (currentDate <= maxDate) {
                        const month = currentDate.toLocaleDateString('en-US', { month: 'short' });
                        ganttHTML += `<div style="flex: 0 0 ${minorPixels}px; text-align: center; font-size: 10px; color: #676879; border-right: 1px solid #e6e9ef;">${month}</div>`;
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                }

                ganttHTML += `</div></div></div>`;

                // Render project timeline bars
                // Helper function to calculate pixel position based on scale
                function calculatePixelPosition(dateFrom, dateTo, minDateRef, pixelsPerUnitRef, scale) {
                    let pixelPos = 0;

                    if (scale === 'day') {
                        const daysDiff = (dateFrom - minDateRef) / (1000 * 60 * 60 * 24);
                        pixelPos = daysDiff * pixelsPerUnitRef;
                    } else if (scale === 'week') {
                        const daysDiff = (dateFrom - minDateRef) / (1000 * 60 * 60 * 24);
                        pixelPos = (daysDiff / 7) * pixelsPerUnitRef;
                    } else if (scale === 'month') {
                        // For month view, calculate pixel position using fixed 30 days per month
                        let currentDate = new Date(minDateRef);
                        pixelPos = 0;
                        const minorPixelWidth = pixelsPerUnitRef / 30;

                        // Count full months
                        while (currentDate.getFullYear() < dateFrom.getFullYear() ||
                               (currentDate.getFullYear() === dateFrom.getFullYear() && currentDate.getMonth() < dateFrom.getMonth())) {
                            pixelPos += 30 * minorPixelWidth;  // Fixed 30 days per month
                            currentDate.setMonth(currentDate.getMonth() + 1);
                        }

                        // Add partial month days
                        if (currentDate.getMonth() === dateFrom.getMonth()) {
                            const daysInPartialMonth = dateFrom.getDate() - minDateRef.getDate();
                            pixelPos += daysInPartialMonth * minorPixelWidth;
                        }
                    } else if (scale === '6month') {
                        const daysDiff = (dateFrom - minDateRef) / (1000 * 60 * 60 * 24);
                        pixelPos = (daysDiff / 180) * pixelsPerUnitRef;
                    } else if (scale === 'year') {
                        const daysDiff = (dateFrom - minDateRef) / (1000 * 60 * 60 * 24);
                        pixelPos = (daysDiff / 365) * pixelsPerUnitRef;
                    }

                    return pixelPos;
                }

                // Create SVG canvas for dependency lines
                const svgCanvas = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svgCanvas.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 250px;
                    width: ${totalTimelineWidth}px;
                    height: 100%;
                    pointer-events: none;
                    z-index: 5;
                `;

                // Store task references for dependencies and interactions
                const taskBars = {};
                const taskPositions = {}; // Store task bar positions for drawing dependencies

                projectsToDisplay.forEach(project => {
                    const startDate = project.startDate ? parseDate(project.startDate) : minDate;
                    const endDate = project.endDate ? parseDate(project.endDate) : maxDate;

                    // Set start date to start of day and end date to end of day
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(23, 59, 59, 999);

                    // Calculate offset and width using accurate positioning
                    let offsetPixels = calculatePixelPosition(startDate, startDate, minDate, pixelsPerUnit, currentTimelineScale);
                    let endPixels = calculatePixelPosition(endDate, endDate, minDate, pixelsPerUnit, currentTimelineScale);
                    let barWidth = Math.max(endPixels - offsetPixels, 20);

                    // Determine bar color based on project health
                    let barColor = '#e6e9ef'; // Default color (none/gray)
                    if (project.projectHealth === 'green') barColor = '#65d814';
                    if (project.projectHealth === 'amber') barColor = '#ffb800';
                    if (project.projectHealth === 'red') barColor = '#ff5555';

                    // Check if this is a milestone (0 day duration or marked as milestone)
                    const isMilestone = barWidth <= 20 && project.isMilestone;

                    // Build tooltip with full project details
                    const tooltipText = `
                        Project: ${project.name}
                        Status: ${normalizeStatus(project.status)}
                        Progress: ${project.progress || 0}%
                        Start: ${project.startDate}
                        End: ${project.endDate}
                        Priority: ${normalizePriority(project.priority)}
                        Health: ${project.projectHealth || 'None'}
                        Manager: ${project.projectManagers?.join(', ') || 'Unassigned'}
                    `.trim();

                    // Create bar element with drag-drop support
                    const barId = `bar-${project.id || project.name.replace(/\s+/g, '-')}`;
                    const barClass = isMilestone ? 'gantt-milestone' : 'gantt-bar';

                    // Render milestone as diamond or bar as rectangle
                    let barHTML = '';
                    if (isMilestone) {
                        // Milestone diamond
                        barHTML = `<div style="position: absolute; left: ${offsetPixels - 8}px; width: 16px; height: 16px; background: #ffb800; transform: rotate(45deg); cursor: pointer; border-radius: 2px;"
                                       class="${barClass}"
                                       id="${barId}"
                                       data-project-id="${project.id}"
                                       title="${tooltipText}"></div>`;
                    } else {
                        // Regular task bar with progress indicator
                        const progressWidth = Math.max((barWidth * (project.progress || 0)) / 100, 2);
                        barHTML = `<div style="position: absolute; left: ${offsetPixels}px; width: ${barWidth}px; height: 28px; background: ${barColor}; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600; cursor: grab; border: 2px solid transparent; transition: all 0.2s ease;"
                                       class="${barClass}"
                                       id="${barId}"
                                       data-project-id="${project.id}"
                                       data-start-date="${project.startDate}"
                                       data-end-date="${project.endDate}"
                                       data-offset="${offsetPixels}"
                                       data-width="${barWidth}"
                                       title="${tooltipText}"
                                       onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)'; this.style.borderColor='#323338';"
                                       onmouseout="this.style.boxShadow='none'; this.style.borderColor='transparent';">
                                    ${project.progress || 0}%
                                    <div style="position: absolute; left: 2px; top: 0; height: 100%; width: ${progressWidth - 4}px; background: rgba(0,0,0,0.2); border-radius: 2px;"></div>
                                </div>`;
                    }

                    ganttHTML += `
                        <div style="display: flex; align-items: center; margin-bottom: 15px; padding: 10px 0; border-bottom: 1px solid #f0f0f0;" class="gantt-row" data-project-id="${project.id}">
                            <div style="flex: 0 0 250px; padding: 10px; font-weight: 500; color: #323338; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${project.name}">
                                ${project.name}
                            </div>
                            <div style="min-width: ${totalTimelineWidth}px; padding: 0; position: relative; height: 30px;">
                                ${barHTML}
                            </div>
                        </div>
                    `;

                    // Store bar reference for later manipulation
                    taskBars[barId] = {
                        projectId: project.id,
                        element: null, // Will be set after DOM creation
                        offsetPixels,
                        barWidth,
                        startDate,
                        endDate,
                        isMilestone,
                        dependencies: project.dependencies || [] // Array of project IDs this task depends on
                    };

                    // Store position info for drawing dependency lines
                    const rowIndex = projectsToDisplay.indexOf(project);
                    taskPositions[project.id] = {
                        barId,
                        rowIndex,
                        offsetPixels,
                        barWidth,
                        endPixels
                    };
                });

                // Calculate today's position and add today indicator line using accurate positioning
                const today = getTodayMidnight();
                let todayPixels = calculatePixelPosition(today, today, minDate, pixelsPerUnit, currentTimelineScale);

                ganttContainer.innerHTML = ganttHTML;

                // Function to draw dependency lines
                function drawDependencies() {
                    const rowHeight = 45;

                    // Draw lines for each dependency
                    projectsToDisplay.forEach((project) => {
                        const deps = project.dependencies || [];
                        if (!deps || deps.length === 0) return;

                        const currentPos = taskPositions[project.id];
                        if (!currentPos) return;

                        deps.forEach((depProjectId) => {
                            const depPos = taskPositions[depProjectId];
                            if (!depPos) return;

                            // Get row centers for line drawing
                            const fromY = (depPos.rowIndex * rowHeight) + 30 + 15; // Center of bar
                            const toY = (currentPos.rowIndex * rowHeight) + 30 + 15;
                            const fromX = depPos.offsetPixels + depPos.barWidth; // End of dependency bar
                            const toX = currentPos.offsetPixels; // Start of dependent bar

                            // Create SVG path for the dependency line
                            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            const controlX = (fromX + toX) / 2;

                            // Create curved connector line
                            const d = `M ${fromX} ${fromY} C ${controlX} ${fromY}, ${controlX} ${toY}, ${toX} ${toY}`;

                            path.setAttribute('d', d);
                            path.setAttribute('stroke', '#667eea');
                            path.setAttribute('stroke-width', '2');
                            path.setAttribute('fill', 'none');
                            path.setAttribute('stroke-dasharray', '5,5');
                            path.setAttribute('opacity', '0.6');

                            // Add arrowhead
                            path.setAttribute('marker-end', 'url(#arrowhead)');

                            svgCanvas.appendChild(path);
                        });
                    });
                }

                // Add arrowhead marker
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                marker.setAttribute('id', 'arrowhead');
                marker.setAttribute('markerWidth', '10');
                marker.setAttribute('markerHeight', '10');
                marker.setAttribute('refX', '9');
                marker.setAttribute('refY', '3');
                marker.setAttribute('orient', 'auto');

                const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                polygon.setAttribute('points', '0 0, 10 3, 0 6');
                polygon.setAttribute('fill', '#667eea');

                marker.appendChild(polygon);
                defs.appendChild(marker);
                svgCanvas.appendChild(defs);

                // Append SVG canvas to gantt container
                ganttContainer.style.position = 'relative';
                ganttContainer.insertBefore(svgCanvas, ganttContainer.firstChild);

                // Draw dependencies after DOM is ready
                setTimeout(() => {
                    drawDependencies();
                }, 0);

                // Attach event listeners to bars for drag-and-drop
                const bars = ganttContainer.querySelectorAll('.gantt-bar');
                bars.forEach(bar => {
                    const barId = bar.id;
                    const barData = taskBars[barId];
                    if (!barData) return;

                    let isDragging = false;
                    let startX = 0;
                    let startLeft = 0;

                    // Drag start
                    bar.addEventListener('mousedown', (e) => {
                        if (e.button !== 0) return; // Only left click
                        isDragging = true;
                        startX = e.clientX;
                        startLeft = parseInt(bar.style.left) || barData.offsetPixels;
                        bar.style.cursor = 'grabbing';
                        e.preventDefault();
                    });

                    // Drag move
                    document.addEventListener('mousemove', (e) => {
                        if (!isDragging) return;

                        const deltaX = e.clientX - startX;
                        const newLeft = Math.max(0, startLeft + deltaX);
                        bar.style.left = newLeft + 'px';
                    });

                    // Drag end
                    document.addEventListener('mouseup', () => {
                        if (!isDragging) return;
                        isDragging = false;
                        bar.style.cursor = 'grab';

                        // Convert pixel position back to date
                        const newOffset = parseInt(bar.style.left);
                        const daysDiff = (newOffset / (pixelsPerUnit / 30)); // Approximate

                        // TODO: Reschedule project in database
                        // For now, just provide visual feedback
                    });
                });

                // Add tooltip styling
                const style = document.createElement('style');
                style.textContent = `
                    .gantt-bar, .gantt-milestone {
                        transition: all 0.2s ease;
                    }
                    .gantt-bar:hover {
                        filter: brightness(1.1);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
                    }
                    .gantt-milestone:hover {
                        filter: brightness(1.1);
                    }
                    .gantt-row {
                        transition: background-color 0.2s ease;
                    }
                    .gantt-row:hover {
                        background-color: #f9f9f9;
                    }
                `;
                document.head.appendChild(style);

                // Add today indicator line after content is rendered
                if (todayPixels >= 0) {
                    const todayLine = document.createElement('div');
                    const projectNameWidth = 250;
                    const lineLeft = projectNameWidth + todayPixels;

                    // Calculate the height of the timeline body
                    // Height = (row height + 30px) × number of rows
                    const rowHeight = 45;
                    const totalBodyHeight = (rowHeight + 30) * projectsToDisplay.length;
                    const lineStartOffset = 90 - 10 - 5; // -15px from original position

                    todayLine.style.cssText = `
                        position: absolute;
                        left: ${lineLeft}px;
                        top: ${lineStartOffset}px;
                        width: 2px;
                        height: ${totalBodyHeight}px;
                        background: #e44258;
                        border-left: none;
                        z-index: 10;
                        pointer-events: none;
                        opacity: 0.8;
                    `;

                    // Add "Today" label
                    const todayLabel = document.createElement('div');
                    todayLabel.style.cssText = `
                        position: absolute;
                        left: ${lineLeft}px;
                        top: -20px;
                        transform: translateX(-50%);
                        background: #e44258;
                        color: white;
                        padding: 2px 8px;
                        border-radius: 3px;
                        font-size: 11px;
                        font-weight: 600;
                        white-space: nowrap;
                        z-index: 11;
                        pointer-events: none;
                    `;
                    todayLabel.textContent = 'Today';

                    // Make the container position relative so the line positions correctly
                    ganttContainer.style.position = 'relative';
                    ganttContainer.style.overflow = 'visible';
                    ganttContainer.appendChild(todayLine);
                    ganttContainer.appendChild(todayLabel);
                }
            } catch (error) {
                console.error('Error rendering Gantt chart:', error);
                const ganttContainer = document.getElementById('ganttChart');
                if (ganttContainer) {
                    ganttContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #e44258;">Error loading timeline. Please check the console for details.</div>';
                }
            }
        }

        // Parse date string - supports yyyy-mm-dd, yyyy/mm/dd, and dd/mm/yyyy formats
        function parseDate(dateString) {
            if (!dateString) return new Date();

            let year, month, day;

            if (dateString.includes('-')) {
                // yyyy-mm-dd format
                [year, month, day] = dateString.split('-');
            } else if (dateString.includes('/')) {
                // Could be yyyy/mm/dd or dd/mm/yyyy
                const parts = dateString.split('/');
                const firstPart = parseInt(parts[0]);

                // If first part > 31, it's yyyy/mm/dd format
                if (firstPart > 31) {
                    [year, month, day] = parts;
                } else {
                    // It's dd/mm/yyyy format
                    [day, month, year] = parts;
                }
            }

            if (!year || !month || !day) {
                return new Date();
            }

            return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        }

        // Set timeline scale and re-render chart
        function setTimelineScale(scale) {
            currentTimelineScale = scale;

            // Update dropdown selector
            const selector = document.getElementById('ganttScaleSelector');
            if (selector) {
                selector.value = scale;
            }

            // Clear the old gantt chart completely
            const ganttContainer = document.getElementById('ganttChart');
            if (ganttContainer) {
                ganttContainer.innerHTML = '';
            }

            // Re-render the gantt chart with new scale, respecting active filters
            renderGanttChart(currentFilteredProjects);
        }

        // Gantt Chart Zoom Control
        let currentZoom = 1;
        function zoomGanttChart(factor) {
            currentZoom *= factor;
            currentZoom = Math.max(0.5, Math.min(2, currentZoom)); // Constrain between 0.5x and 2x

            const ganttChart = document.getElementById('ganttChart');
            if (ganttChart) {
                const scale = currentZoom === 1 ? '' : `scale(${currentZoom})`;
                ganttChart.style.transform = scale;
                ganttChart.style.transformOrigin = 'top left';
                ganttChart.style.transition = 'transform 0.2s ease';
            }

            // Update zoom level display
            const zoomLevel = document.getElementById('zoomLevel');
            if (zoomLevel) {
                zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
            }
        }

        // Export Gantt Chart
        function exportGanttChart() {
            const ganttContainer = document.getElementById('ganttChart');
            if (!ganttContainer) {
                alert('Gantt chart not found');
                return;
            }

            // Use html2canvas library (if available) or provide simple export
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Get chart dimensions
            const chartWidth = ganttContainer.offsetWidth;
            const chartHeight = ganttContainer.offsetHeight;

            canvas.width = chartWidth;
            canvas.height = chartHeight;

            // Fill white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, chartWidth, chartHeight);

            // Add text info
            ctx.fillStyle = '#323338';
            ctx.font = '14px Arial, sans-serif';
            ctx.fillText('Project Gantt Chart - Exported ' + new Date().toLocaleDateString(), 10, 20);

            // Download as PNG
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gantt-chart-${new Date().getTime()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            alert('Gantt chart exported as PNG. Advanced export (PDF) coming soon!');
        }

        // Keyboard Shortcuts for Gantt Chart
        document.addEventListener('keydown', (e) => {
            const ganttView = document.getElementById('projectsTimelineView');
            if (!ganttView || ganttView.style.display === 'none') return;

            // Zoom with Ctrl/Cmd + Plus/Minus
            if ((e.ctrlKey || e.metaKey) && e.key === '+') {
                e.preventDefault();
                zoomGanttChart(1.1);
            } else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                e.preventDefault();
                zoomGanttChart(0.9);
            } else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                e.preventDefault();
                currentZoom = 1;
                const ganttChart = document.getElementById('ganttChart');
                if (ganttChart) {
                    ganttChart.style.transform = '';
                }
                const zoomLevel = document.getElementById('zoomLevel');
                if (zoomLevel) {
                    zoomLevel.textContent = '100%';
                }
            }
        });

        // ========================================
        // PROJECT STATUS/SDLC POPUP FUNCTIONS
        // ========================================

        function toggleProjectStatusPopup(event, projectId, projectIndex) {
            event.stopPropagation();

            // Close all other popups
            document.querySelectorAll('.project-status-popup').forEach(popup => {
                if (popup.id !== `project-status-popup-${projectId}`) {
                    popup.classList.remove('active');
                }
            });

            // Toggle this popup
            const popup = document.getElementById(`project-status-popup-${projectId}`);
            popup.classList.toggle('active');
        }

        function toggleProjectSDLCPopup(event, projectId, projectIndex) {
            event.stopPropagation();

            // Close all other popups
            document.querySelectorAll('.project-status-popup').forEach(popup => {
                if (popup.id !== `project-sdlc-popup-${projectId}`) {
                    popup.classList.remove('active');
                }
            });

            // Toggle this popup
            const popup = document.getElementById(`project-sdlc-popup-${projectId}`);
            popup.classList.toggle('active');
        }

        async function changeProjectStatus(projectId, projectIndex, newStatus) {
            // Close popup
            document.getElementById(`project-status-popup-${projectId}`).classList.remove('active');

            // Check if status changed
            if (projects[projectIndex].status === newStatus) {
                return;
            }

            // Show spinner
            showSpinner('Updating status...');

            try {
                // Update in Firebase
                await db.collection('projects').doc(projectId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('✅ Project status updated');

                // Update local array
                projects[projectIndex].status = newStatus;

                // Re-render projects
                renderProjects();

                // Hide spinner
                hideSpinner();

            } catch (error) {
                console.error('❌ Error updating project status:', error);
                hideSpinner();
                alert('Error updating status: ' + error.message);
            }
        }

        async function changeProjectSDLC(projectId, projectIndex, newSDLC) {
            // Close popup
            document.getElementById(`project-sdlc-popup-${projectId}`).classList.remove('active');

            // Check if SDLC changed
            if (projects[projectIndex].sdlc === newSDLC) {
                return;
            }

            // Show spinner
            showSpinner('Updating SDLC phase...');

            try {
                // Update in Firebase
                await db.collection('projects').doc(projectId).update({
                    sdlc: newSDLC,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('✅ Project SDLC updated');

                // Update local array
                projects[projectIndex].sdlc = newSDLC;

                // Re-render projects
                renderProjects();

                // Hide spinner
                hideSpinner();

            } catch (error) {
                console.error('❌ Error updating project SDLC:', error);
                hideSpinner();
                alert('Error updating SDLC: ' + error.message);
            }
        }

        // Close popups when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.project-status-popup-wrapper')) {
                document.querySelectorAll('.project-status-popup').forEach(popup => {
                    popup.classList.remove('active');
                });
            }
        });

        // ========================================
        // PROJECT FIREBASE FUNCTIONS
        // ========================================

        // Add project to Firebase
        async function addProjectToFirebase(projectData) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return null;
            }

            try {
                const docRef = await db.collection('projects').add({
                    ...projectData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('✅ Project added to Firebase with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('❌ Error adding project to Firebase:', error);
                throw error;
            }
        }

        // Update project in Firebase
        async function updateProjectInFirebase(projectId, projectData) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            try {
                await db.collection('projects').doc(projectId).update({
                    ...projectData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('✅ Project updated in Firebase:', projectId);
            } catch (error) {
                console.error('❌ Error updating project in Firebase:', error);
                throw error;
            }
        }

        // Delete project from Firebase
        async function deleteProjectFromFirebase(projectId) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            try {
                await db.collection('projects').doc(projectId).delete();
                console.log('✅ Project deleted from Firebase:', projectId);
            } catch (error) {
                console.error('❌ Error deleting project from Firebase:', error);
                throw error;
            }
        }

        // Load projects from Firebase
        async function loadProjectsFromFirebase() {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            // Prevent concurrent loading
            if (isLoadingProjects) {
                console.log("⏭️ Project loading already in progress, skipping...");
                return;
            }

            isLoadingProjects = true;
            showSpinner('Loading projects...');

            try {
                const snapshot = await db.collection('projects')
                    .orderBy('createdAt', 'desc')
                    .get();

                projects = [];
                snapshot.forEach(doc => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`✅ Loaded ${projects.length} projects from Firebase`);
                populateProjectManagerFilterDropdown();
                renderProjects();
            } catch (error) {
                console.error('❌ Error loading projects from Firebase:', error);
                // If orderBy fails (no index), try without ordering
                try {
                    const snapshot = await db.collection('projects').get();
                    projects = [];
                    snapshot.forEach(doc => {
                        projects.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    console.log(`✅ Loaded ${projects.length} projects from Firebase (fallback)`);
                    populateProjectManagerFilterDropdown();
                    renderProjects();
                } catch (fallbackError) {
                    console.error('❌ Fallback also failed:', fallbackError);
                }
            } finally {
                isLoadingProjects = false;
                hideSpinner();
            }
        }

        // Populate team members dropdown for project form
        async function populateProjectTeamMembersDropdown() {
            console.log('🔄 populateProjectTeamMembersDropdown() called');
            const selectElement = document.getElementById('projectTeamMembers');

            if (!db) {
                console.error('❌ Firebase not initialized');
                selectElement.innerHTML = '<option value="">Firebase not connected</option>';
                return;
            }

            try {
                // FIXED: Changed from 'teamMembers' to 'team_members' to match the actual collection name
                console.log('📊 Loading from team_members collection...');
                const membersSnapshot = await db.collection('team_members').get();

                console.log(`📦 Found ${membersSnapshot.size} team members`);

                if (membersSnapshot.empty) {
                    console.warn('⚠️ No team members found in database');
                    selectElement.innerHTML = '<option value="">No team members found</option>';

                    const shouldInit = confirm(
                        '⚠️ No team members found!\n\n' +
                        'You need to add team members before creating projects.\n\n' +
                        'Options:\n' +
                        '1. Click "OK" to initialize sample data\n' +
                        '2. Click "Cancel" to add team members manually\n\n' +
                        'Initialize sample data now?'
                    );

                    if (shouldInit) {
                        closeProjectModal();
                        await initializeAllSampleData();
                    } else {
                        closeProjectModal();
                        navigateTo('team');
                    }
                    return;
                }

                selectElement.innerHTML = '';
                let loadedCount = 0;
                membersSnapshot.forEach(doc => {
                    const member = doc.data();

                    // Only show active members
                    const isActive = member.active === true ||
                                   member.status === 'Active' ||
                                   (member.active === undefined && member.status === undefined);

                    if (isActive && member.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.setAttribute('data-member-name', member.name);
                        option.textContent = `${member.name} - ${member.role || 'Team Member'}`;
                        selectElement.appendChild(option);
                        loadedCount++;
                        console.log(`👤 Added: ${member.name} (${member.role || 'N/A'})`);
                    }
                });

                console.log(`✅ Populated project dropdown with ${loadedCount} active team members`);

                if (loadedCount === 0) {
                    selectElement.innerHTML = '<option value="">No active team members</option>';
                    console.warn('⚠️ All team members are inactive');
                }

            } catch (error) {
                console.error('❌ Error loading team members:', error);
                selectElement.innerHTML = '<option value="">Error loading members</option>';
            }
        }

        async function populateProjectManagerDropdown() {
            console.log('🔄 populateProjectManagerDropdown() called');
            const selectElement = document.getElementById('projectManager');

            if (!db) {
                console.error('❌ Firebase not initialized');
                selectElement.innerHTML = '<option value="">Firebase not connected</option>';
                return;
            }

            try {
                console.log('📊 Loading from team_members collection...');
                const membersSnapshot = await db.collection('team_members').get();

                console.log(`📦 Found ${membersSnapshot.size} team members`);

                if (membersSnapshot.empty) {
                    console.warn('⚠️ No team members found in database');
                    selectElement.innerHTML = '<option value="">No team members found</option>';
                    return;
                }

                // Clear existing options
                selectElement.innerHTML = '';

                let loadedCount = 0;
                membersSnapshot.forEach(doc => {
                    const member = doc.data();

                    // Only show active members
                    const isActive = member.active === true ||
                                   member.status === 'Active' ||
                                   (member.active === undefined && member.status === undefined);

                    if (isActive && member.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.setAttribute('data-member-name', member.name);
                        option.textContent = `${member.name} - ${member.role || 'Team Member'}`;
                        selectElement.appendChild(option);
                        loadedCount++;
                        console.log(`👤 Added: ${member.name} (${member.role || 'N/A'})`);
                    }
                });

                console.log(`✅ Populated project manager dropdown with ${loadedCount} active team members`);

                if (loadedCount === 0) {
                    selectElement.innerHTML = '<option value="">No active team members</option>';
                    console.warn('⚠️ All team members are inactive');
                }

            } catch (error) {
                console.error('❌ Error loading team members:', error);
                selectElement.innerHTML = '<option value="">Error loading members</option>';
            }
        }

        // Populate project manager filter dropdown with checkboxes
        function populateProjectManagerFilterDropdown() {
            const optionsContainer = document.getElementById('projectManagerFilterOptions');

            try {
                // Extract unique project managers from all projects
                const managerMap = new Map(); // To store manager names by ID (sorted)

                projects.forEach(project => {
                    if (project.projectManagerIds && Array.isArray(project.projectManagerIds)) {
                        project.projectManagerIds.forEach((managerId, index) => {
                            if (!managerMap.has(managerId)) {
                                const managerName = (project.projectManagers && project.projectManagers[index]) || 'Unknown Manager';
                                managerMap.set(managerId, managerName);
                            }
                        });
                    }
                });

                // Sort managers by name
                const sortedManagers = Array.from(managerMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));

                // Clear existing options
                optionsContainer.innerHTML = '';

                // Add checkboxes for each unique manager
                sortedManagers.forEach(([managerId, managerName]) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multi-select-option';
                    optionDiv.onclick = (e) => e.stopPropagation();

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `manager-${managerId}`;
                    checkbox.value = managerId;
                    checkbox.onchange = updateProjectManagerFilter;

                    const label = document.createElement('label');
                    label.htmlFor = `manager-${managerId}`;
                    label.textContent = managerName;

                    optionDiv.appendChild(checkbox);
                    optionDiv.appendChild(label);
                    optionsContainer.appendChild(optionDiv);
                });

                console.log(`✅ Populated project manager filter with ${sortedManagers.length} unique managers`);

            } catch (error) {
                console.error('❌ Error populating project manager filter:', error);
            }
        }

        function openProjectModal() {
            console.log('🚪 openProjectModal() called');
            editingProjectIndex = -1;
            document.getElementById('projectModalTitle').textContent = 'Create New Project';
            document.getElementById('projectSubmitBtn').textContent = 'Create Project';
            document.getElementById('projectForm').reset();

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectStartDate').value = today;

            // Populate team members dropdown
            console.log('📞 Calling populateProjectTeamMembersDropdown()...');
            populateProjectTeamMembersDropdown();

            // Populate project manager dropdown
            console.log('📞 Calling populateProjectManagerDropdown()...');
            populateProjectManagerDropdown();

            document.getElementById('projectModal').classList.add('active');
            console.log('✅ Project modal opened');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('active');
            document.getElementById('projectForm').reset();
            editingProjectIndex = -1;
        }

        function editProject(index) {
            editingProjectIndex = index;
            const project = projects[index];

            // Update modal title and button
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectSubmitBtn').textContent = 'Update Project';

            // Populate form with project data
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDescription').value = project.description;
            document.getElementById('projectType').value = project.projectType || 'Project';
            document.getElementById('projectHealth').value = project.projectHealth || 'none';
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectPriority').value = project.priority;
            document.getElementById('projectSDLC').value = project.sdlc || 'Development';

            // Set dates using helper function (converts dd/mm/yyyy to yyyy-mm-dd for input)
            setDateInputValue(document.getElementById('projectStartDate'), project.startDate);
            setDateInputValue(document.getElementById('projectEndDate'), project.endDate);
            document.getElementById('projectProgress').value = project.progress;
            document.getElementById('projectBudget').value = project.budget;
            document.getElementById('projectTags').value = project.tags ? project.tags.join(', ') : '';

            // Populate team members dropdown and select the correct members
            populateProjectTeamMembersDropdown().then(() => {
                const teamMembersSelect = document.getElementById('projectTeamMembers');

                // If project has teamMemberIds, use those. Otherwise try to match by name
                if (project.teamMemberIds && project.teamMemberIds.length > 0) {
                    // Select by IDs
                    Array.from(teamMembersSelect.options).forEach(option => {
                        if (project.teamMemberIds.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                } else if (project.teamMembers && project.teamMembers.length > 0) {
                    // Fallback: try to match by name for old data
                    Array.from(teamMembersSelect.options).forEach(option => {
                        const memberName = option.getAttribute('data-member-name');
                        if (project.teamMembers.includes(memberName)) {
                            option.selected = true;
                        }
                    });
                }
            });

            // Populate project manager dropdown and select the correct managers
            populateProjectManagerDropdown().then(() => {
                const projectManagerSelect = document.getElementById('projectManager');

                // If project has projectManagerIds, use those. Otherwise try to match by name
                if (project.projectManagerIds && project.projectManagerIds.length > 0) {
                    // Select by IDs
                    Array.from(projectManagerSelect.options).forEach(option => {
                        if (project.projectManagerIds.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                } else if (project.projectManagers && project.projectManagers.length > 0) {
                    // Fallback: try to match by name for old data
                    Array.from(projectManagerSelect.options).forEach(option => {
                        const memberName = option.getAttribute('data-member-name');
                        if (project.projectManagers.includes(memberName)) {
                            option.selected = true;
                        }
                    });
                }
            });

            // Open modal
            document.getElementById('projectModal').classList.add('active');
        }

        async function deleteProject(index) {
            const project = projects[index];

            if (confirm(`Are you sure you want to delete "${project.name}"?`)) {
                try {
                    // Delete from Firebase if project has an ID
                    if (project.id && db) {
                        await deleteProjectFromFirebase(project.id);
                        console.log('✅ Project deleted from Firebase:', project.id);
                        alert('✅ Project deleted successfully!');

                        // Reload projects from Firebase
                        await loadProjectsFromFirebase();
                    } else {
                        // Fallback to local deletion if no ID
                        projects.splice(index, 1);
                        renderProjects();
                        alert('✅ Project deleted successfully (locally)!');
                    }
                } catch (error) {
                    console.error('❌ Error deleting project:', error);
                    alert('❌ Error deleting project: ' + error.message);
                }
            }
        }

        // ========================================
        // PROJECT FILTER FUNCTIONS
        // ========================================

        function toggleProjectFilter() {
            const filterPanel = document.getElementById('projectFilterPanel');
            if (filterPanel.style.display === 'none' || filterPanel.style.display === '') {
                filterPanel.style.display = 'block';
            } else {
                filterPanel.style.display = 'none';
            }
        }

        // Full-Screen Gantt Functions
        async function openFullScreenGantt() {
            const modal = document.getElementById('fullScreenGanttModal');
            if (!modal) return;

            // Ensure we have Firebase data loaded (7 projects), not just mock data (4 projects)
            if (projects.length <= 4) {
                console.log('⏳ Timeline 2 - Waiting for Firebase projects to load...');
                showSpinner('Loading timeline...');

                // Wait for Firebase data to load
                await loadProjectsFromFirebase();

                hideSpinner();
            }

            // Pass filtered projects to the iframe
            // The iframe's ganttchart.html will read from window.parent.filteredProjectsForGantt
            window.filteredProjectsForGantt = currentFilteredProjects || projects;
            console.log('✅ Timeline 2 - Passing', window.filteredProjectsForGantt.length, 'projects to iframe');
            console.log('📊 Project names:', window.filteredProjectsForGantt.map(p => p.name).join(', '));

            modal.style.display = 'flex';
        }

        function closeFullScreenGantt() {
            const modal = document.getElementById('fullScreenGanttModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Apply filters from chart selections (click-to-filter)
        function applyChartFilters() {
            let filteredProjects = [...projects];

            // Apply project type filter from chart
            if (chartTypeFilter) {
                filteredProjects = filteredProjects.filter(p => p.projectType === chartTypeFilter);
            }

            // Apply health filter from chart
            if (chartHealthFilter) {
                filteredProjects = filteredProjects.filter(p => {
                    const projectHealth = p.projectHealth ? p.projectHealth.charAt(0).toUpperCase() + p.projectHealth.slice(1).toLowerCase() : 'None';
                    return projectHealth === chartHealthFilter;
                });
            }

            // Apply project manager filter from chart
            if (chartManagerFilter) {
                filteredProjects = filteredProjects.filter(p =>
                    p.projectManagers && p.projectManagers.includes(chartManagerFilter)
                );
            }

            // Apply project status filter from chart
            if (chartStatusFilter) {
                filteredProjects = filteredProjects.filter(p => normalizeStatus(p.status) === chartStatusFilter);
            }

            // Apply project priority filter from chart
            if (chartPriorityFilter) {
                filteredProjects = filteredProjects.filter(p => normalizePriority(p.priority) === chartPriorityFilter);
            }

            // Apply SDLC phase filter from chart
            if (chartSDLCFilter) {
                filteredProjects = filteredProjects.filter(p => getSDLCPhase(p) === chartSDLCFilter);
            }

            // Render filtered projects
            renderFilteredProjects(filteredProjects);

            // Re-render all charts to show selection state
            renderProjectTypeChart();
            renderProjectHealthChart();
            renderProjectManagerChart();
            renderProjectStatusChart();
            renderProjectPriorityChart();
            renderProjectSDLCChart();
            renderProjectProgressDistChart();
            renderProjectTimelineChart();
            renderProjectForecastChart();
            renderProjectWorkloadChart();
            renderBottleneckAlerts();

            // Update filter labels
            const typeFilterLabel = document.getElementById('typeChartFilterLabel');
            const typeFilterValue = document.getElementById('typeChartFilterValue');
            if (typeFilterLabel && typeFilterValue) {
                if (chartTypeFilter) {
                    typeFilterLabel.style.display = 'inline';
                    typeFilterValue.textContent = chartTypeFilter;
                } else {
                    typeFilterLabel.style.display = 'none';
                }
            }

            const healthFilterLabel = document.getElementById('healthChartFilterLabel');
            const healthFilterValue = document.getElementById('healthChartFilterValue');
            if (healthFilterLabel && healthFilterValue) {
                if (chartHealthFilter) {
                    healthFilterLabel.style.display = 'inline';
                    healthFilterValue.textContent = chartHealthFilter;
                } else {
                    healthFilterLabel.style.display = 'none';
                }
            }

            const managerFilterLabel = document.getElementById('managerChartFilterLabel');
            const managerFilterValue = document.getElementById('managerChartFilterValue');
            if (managerFilterLabel && managerFilterValue) {
                if (chartManagerFilter) {
                    managerFilterLabel.style.display = 'inline';
                    managerFilterValue.textContent = chartManagerFilter;
                } else {
                    managerFilterLabel.style.display = 'none';
                }
            }

            const statusFilterLabel = document.getElementById('statusChartFilterLabel');
            const statusFilterValue = document.getElementById('statusChartFilterValue');
            if (statusFilterLabel && statusFilterValue) {
                if (chartStatusFilter) {
                    statusFilterLabel.style.display = 'inline';
                    statusFilterValue.textContent = chartStatusFilter;
                } else {
                    statusFilterLabel.style.display = 'none';
                }
            }

            const priorityFilterLabel = document.getElementById('priorityChartFilterLabel');
            const priorityFilterValue = document.getElementById('priorityChartFilterValue');
            if (priorityFilterLabel && priorityFilterValue) {
                if (chartPriorityFilter) {
                    priorityFilterLabel.style.display = 'inline';
                    priorityFilterValue.textContent = chartPriorityFilter;
                } else {
                    priorityFilterLabel.style.display = 'none';
                }
            }

            const sdlcFilterLabel = document.getElementById('sdlcChartFilterLabel');
            const sdlcFilterValue = document.getElementById('sdlcChartFilterValue');
            if (sdlcFilterLabel && sdlcFilterValue) {
                if (chartSDLCFilter) {
                    sdlcFilterLabel.style.display = 'inline';
                    sdlcFilterValue.textContent = chartSDLCFilter;
                } else {
                    sdlcFilterLabel.style.display = 'none';
                }
            }

            // Update clear button visibility
            updateChartFilterClearButton();

            // Update metric cards to reflect filtered data
            renderKeyMetrics();
        }

        // Clear chart filters
        function clearChartFilters() {
            chartTypeFilter = null;
            chartHealthFilter = null;
            chartManagerFilter = null;
            chartStatusFilter = null;
            chartPriorityFilter = null;
            chartSDLCFilter = null;
            applyChartFilters();
        }

        // Update clear button visibility
        function updateChartFilterClearButton() {
            const clearBtn = document.getElementById('clearChartFiltersBtn');
            if (clearBtn) {
                clearBtn.style.display = (chartTypeFilter || chartHealthFilter || chartManagerFilter || chartStatusFilter || chartPriorityFilter || chartSDLCFilter) ? 'inline-block' : 'none';
            }
        }

        function applyProjectFilters() {
            const statusFilter = document.getElementById('projectFilterStatus').value;
            const typeFilter = document.getElementById('projectFilterType').value;
            const sdlcFilter = document.getElementById('projectFilterSDLC').value;
            const priorityFilter = document.getElementById('projectFilterPriority').value;

            // Get multiple selected managers from checkboxes
            const managerCheckboxes = document.querySelectorAll('#projectManagerFilterOptions input[type="checkbox"]');
            const selectedManagers = [];
            managerCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedManagers.push(checkbox.value);
                }
            });

            // Get multiple selected health statuses from checkboxes
            const healthCheckboxes = document.querySelectorAll('#projectHealthFilterOptions input[type="checkbox"]');
            const selectedHealth = [];
            healthCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedHealth.push(checkbox.value);
                }
            });

            let filteredProjects = projects;

            // Apply status filter
            if (statusFilter) {
                filteredProjects = filteredProjects.filter(p => p.status === statusFilter);
            }

            // Apply project type filter
            if (typeFilter) {
                filteredProjects = filteredProjects.filter(p => p.projectType === typeFilter);
            }

            // Apply SDLC filter
            if (sdlcFilter) {
                filteredProjects = filteredProjects.filter(p => p.sdlc === sdlcFilter);
            }

            // Apply priority filter
            if (priorityFilter) {
                filteredProjects = filteredProjects.filter(p => p.priority === priorityFilter);
            }

            // Apply project manager filter (multiple selection)
            if (selectedManagers.length > 0) {
                filteredProjects = filteredProjects.filter(p =>
                    p.projectManagerIds && p.projectManagerIds.some(managerId => selectedManagers.includes(managerId))
                );
            }

            // Apply project health filter (multiple selection)
            if (selectedHealth.length > 0) {
                filteredProjects = filteredProjects.filter(p =>
                    selectedHealth.includes(p.projectHealth || 'none')
                );
            }

            // Render filtered projects
            renderFilteredProjects(filteredProjects);
        }

        function renderFilteredProjects(filteredProjects) {
            // Store the filtered projects so they persist when switching views
            currentFilteredProjects = filteredProjects;

            // Render in the current view with filtered projects
            if (currentProjectView === 'table') {
                renderProjectsTable(filteredProjects);
            } else if (currentProjectView === 'timeline') {
                renderGanttChart(filteredProjects);
            } else {
                renderProjectsGridView(filteredProjects);
            }
        }

        function renderProjectsGridView(filteredProjects) {
            const projectsGrid = document.getElementById('projectsGrid');
            if (!projectsGrid) return;

            if (filteredProjects.length === 0) {
                projectsGrid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #676879; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No projects match your filters</div>
                        <div style="font-size: 14px;">Try adjusting your filter criteria</div>
                    </div>
                `;
                return;
            }

            // Use the original index from projects array
            projectsGrid.innerHTML = filteredProjects.map((project) => {
                const index = projects.indexOf(project);
                //editProject(${index})
                return `
                <div class="project-card" onclick="if(event.target.closest('.project-action-btn') || event.target.closest('.project-status-badge')) return; ">
                    <div class="project-card-header">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div class="project-health-circle ${project.projectHealth || 'none'}" title="Health: ${project.projectHealth || 'None'}">
                                    
                                </div>
                                <div class="project-card-title">${project.name}</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                <div class="project-status-popup-wrapper">
                                    <span class="project-status-badge clickable ${project.status}"
                                          onclick="toggleProjectStatusPopup(event, '${project.id}', ${index})"
                                          title="Click to change status">
                                        ${formatStatus(project.status)}
                                    </span>
                                    <div class="project-status-popup" id="project-status-popup-${project.id}">
                                        <div class="project-status-popup-option planned" onclick="changeProjectStatus('${project.id}', ${index}, 'planned')">
                                            Planned
                                        </div>
                                        <div class="project-status-popup-option in-progress" onclick="changeProjectStatus('${project.id}', ${index}, 'in-progress')">
                                            In Progress
                                        </div>
                                        <div class="project-status-popup-option completed" onclick="changeProjectStatus('${project.id}', ${index}, 'completed')">
                                            Completed
                                        </div>
                                        <div class="project-status-popup-option on-hold" onclick="changeProjectStatus('${project.id}', ${index}, 'on-hold')">
                                            On Hold
                                        </div>
                                    </div>
                                </div>
                                <div class="project-status-popup-wrapper">
                                    <span class="project-status-badge clickable"
                                          style="background: #0073ea; color: white;"
                                          onclick="toggleProjectSDLCPopup(event, '${project.id}', ${index})"
                                          title="Click to change SDLC phase">
                                        ${project.sdlc || 'No Phase'}
                                    </span>
                                    <div class="project-status-popup" id="project-sdlc-popup-${project.id}">
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Requirement')">
                                            Requirement
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Design')">
                                            Design
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Development')">
                                            Development
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Smoke Test')">
                                            Smoke Test
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'SIT')">
                                            SIT
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'UAT')">
                                            UAT
                                        </div>
                                        <div class="project-status-popup-option sdlc" onclick="changeProjectSDLC('${project.id}', ${index}, 'Implemented')">
                                            Implemented
                                        </div>
                                    </div>
                                </div>
                                ${project.projectType ? `<span class="project-status-badge" style="background: #9b59b6; color: white;">${project.projectType}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="project-card-description">${project.description}</div>

                    <div class="project-progress">
                        <div class="project-progress-label">
                            <span>Progress</span>
                            <span>${project.progress}%</span>
                        </div>
                        <div class="project-progress-bar">
                            <div class="project-progress-fill" style="width: ${project.progress}%"></div>
                        </div>
                    </div>

                    <div class="project-card-meta">
                        <div class="project-meta-item">
                            <span class="project-meta-icon">📅</span>
                            <span>${formatDateForDisplay(project.startDate)} - ${formatDateForDisplay(project.endDate)}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">💰</span>
                            <span>฿${project.budget.toLocaleString()}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">👥</span>
                            <span>${project.teamMembers && project.teamMembers.length > 0 ? project.teamMembers.length + ' members' : 'No members'}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">⚡</span>
                            <span>${formatPriority(project.priority)}</span>
                        </div>
                    </div>

                    ${project.projectManagers && project.projectManagers.length > 0 ? `
                        <div class="project-team-members" style="margin-top: 12px; padding: 12px; background: #ffe6f0; border-radius: 8px;">
                            <div style="font-size: 12px; font-weight: 700; color: #c2185b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Project Managers</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${project.projectManagers.map(manager => `
                                    <span style="background: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; color: #c2185b; border: 1px solid #f48fb1; font-weight: 600;">${formatNameWithInitial(manager)}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${project.teamMembers && project.teamMembers.length > 0 ? `
                        <div class="project-team-members" style="margin-top: 12px; padding: 12px; background: #f6f7fb; border-radius: 8px;">
                            <div style="font-size: 12px; font-weight: 700; color: #676879; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Team Members</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${project.teamMembers.map(member => `
                                    <span style="background: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; color: #323338; border: 1px solid #e6e9ef;">${formatNameWithInitial(member)}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${project.tags && project.tags.length > 0 ? `
                        <div class="project-tags">
                            ${project.tags.map(tag => `<span class="project-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}

                    <div class="project-card-actions">
                        <button class="project-action-btn" onclick="viewProjectTasks('${project.id}', '${project.name}')">
                            📋 Tasks
                        </button>
                        <button class="project-action-btn" onclick="editProject(${index})">
                            ✏️ Edit
                        </button>
                        <button class="project-action-btn delete" onclick="deleteProject(${index})">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function clearProjectFilters() {
            document.getElementById('projectFilterStatus').value = '';
            document.getElementById('projectFilterType').value = '';
            document.getElementById('projectFilterSDLC').value = '';
            document.getElementById('projectFilterPriority').value = '';

            // Clear all selected checkboxes in the manager filter
            const managerCheckboxes = document.querySelectorAll('#projectManagerFilterOptions input[type="checkbox"]');
            managerCheckboxes.forEach(checkbox => checkbox.checked = false);

            // Clear all selected checkboxes in the health filter
            const healthCheckboxes = document.querySelectorAll('#projectHealthFilterOptions input[type="checkbox"]');
            healthCheckboxes.forEach(checkbox => checkbox.checked = false);

            // Reset display text
            document.getElementById('projectManagerFilterText').textContent = 'All Managers';
            document.getElementById('projectHealthFilterText').textContent = 'All Health';

            renderProjects();
        }

        function toggleProjectManagerDropdown() {
            const display = document.getElementById('projectManagerFilterDisplay');
            const options = document.getElementById('projectManagerFilterOptions');

            display.classList.toggle('open');
            options.classList.toggle('open');
        }

        // Close project manager dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('projectManagerFilterDropdown');
            const display = document.getElementById('projectManagerFilterDisplay');
            const options = document.getElementById('projectManagerFilterOptions');

            if (dropdown && !dropdown.contains(event.target)) {
                display.classList.remove('open');
                options.classList.remove('open');
            }
        });

        // Update project manager filter when checkboxes change
        function updateProjectManagerFilter() {
            const checkboxes = document.querySelectorAll('#projectManagerFilterOptions input[type="checkbox"]');
            const selectedManagers = [];
            let selectedCount = 0;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedManagers.push(checkbox.value);
                    selectedCount++;
                }
            });

            // Update display text
            const displayText = document.getElementById('projectManagerFilterText');
            if (selectedCount === 0) {
                displayText.textContent = 'All Managers';
            } else if (selectedCount === 1) {
                const checkedCheckbox = document.querySelector('#projectManagerFilterOptions input[type="checkbox"]:checked');
                const label = checkedCheckbox.nextElementSibling;
                displayText.textContent = label.textContent;
            } else {
                displayText.textContent = `${selectedCount} selected`;
            }

            // Apply filters
            applyProjectFilters();
        }

        // Toggle project health filter dropdown
        function toggleProjectHealthDropdown() {
            const display = document.getElementById('projectHealthFilterDisplay');
            const options = document.getElementById('projectHealthFilterOptions');

            display.classList.toggle('open');
            options.classList.toggle('open');
        }

        // Close project health filter dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('projectHealthFilterDropdown');
            const display = document.getElementById('projectHealthFilterDisplay');
            const options = document.getElementById('projectHealthFilterOptions');

            if (dropdown && !dropdown.contains(event.target)) {
                display.classList.remove('open');
                options.classList.remove('open');
            }
        });

        // Update project health filter when checkboxes change
        function updateProjectHealthFilter() {
            const checkboxes = document.querySelectorAll('#projectHealthFilterOptions input[type="checkbox"]');
            const selectedHealth = [];
            let selectedCount = 0;

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedHealth.push(checkbox.value);
                    selectedCount++;
                }
            });

            // Update display text
            const displayText = document.getElementById('projectHealthFilterText');
            if (selectedCount === 0) {
                displayText.textContent = 'All Health';
            } else if (selectedCount === 1) {
                const healthNames = {
                    'green': '🟢 Green',
                    'amber': '🟡 Amber',
                    'red': '🔴 Red',
                    'none': '⚪ None'
                };
                const checkedCheckbox = document.querySelector('#projectHealthFilterOptions input[type="checkbox"]:checked');
                displayText.textContent = healthNames[checkedCheckbox.value] || checkedCheckbox.value;
            } else {
                displayText.textContent = `${selectedCount} selected`;
            }

            // Apply filters
            applyProjectFilters();
        }

        function exportProjects() {
            alert('Export functionality coming soon!');
        }

        // Global variable to store current project filter
        let currentProjectFilter = null;

        // View tasks for a specific project
        function viewProjectTasks(projectId, projectName) {
            console.log(`📋 Viewing tasks for project: ${projectName} (ID: ${projectId})`);

            // Switch to tasks page (skip filter clearing)
            switchPage('tasks', true);

            // Open filter panel and set project filter
            const panel = document.getElementById('taskFilterPanel');
            panel.style.display = 'block';

            // Populate dropdowns first
            populateFilterDropdowns().then(() => {
                // Set the project filter
                document.getElementById('filterProject').value = projectId;
                taskFilters.project = projectId;

                // Apply filters
                applyTaskFilters();
            });

            // Store for backwards compatibility
            currentProjectFilter = { id: projectId, name: projectName };
        }

        // Clear project filter (legacy function - now redirects to clearAllTaskFilters)
        function clearProjectFilter() {
            console.log('🔄 Clearing project filter');
            clearAllTaskFilters();
        }

        // Filter remaining tasks by team member (all non-done tasks)
        function filterRemainingTasksByMember(memberId, memberName) {
            // Switch to tasks page without clearing filters
            switchPage('tasks', true);

            // Wait for page to load and tasks to be fetched from Firebase
            setTimeout(async () => {
                console.log(`🔍 Starting filter for member: ${memberName} (${memberId})`);
                console.log(`📋 Total tasks available: ${tasks.length}`);

                // Open filter panel and populate dropdowns
                const filterPanel = document.getElementById('taskFilterPanel');
                if (filterPanel) {
                    // Make sure it's visible
                    filterPanel.style.display = 'block';

                    // Populate filter dropdowns first
                    await populateFilterDropdowns();
                    console.log(`✅ Dropdowns populated`);
                }

                // Set filter values - filter by assigned member
                const assignedToSelect = document.getElementById('filterAssignedTo');
                if (assignedToSelect) {
                    assignedToSelect.value = memberId;
                    console.log(`✅ Set assignedTo dropdown to: ${memberId}`);
                    console.log(`📋 Dropdown options count: ${assignedToSelect.options.length}`);
                }

                // Check status checkboxes for all non-done statuses (blank, working, stuck)
                const statusCheckboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
                console.log(`📦 Found ${statusCheckboxes.length} status checkboxes`);

                statusCheckboxes.forEach(checkbox => {
                    // Check all except "done"
                    if (checkbox.value !== 'done') {
                        checkbox.checked = true;
                        console.log(`✅ Checked checkbox: ${checkbox.value}`);
                    } else {
                        checkbox.checked = false;
                        console.log(`❌ Unchecked checkbox: ${checkbox.value}`);
                    }
                });

                // Clear other filters
                document.getElementById('filterPriority').value = '';
                document.getElementById('filterProject').value = '';

                // Update task filters object with the non-done statuses
                taskFilters.assignedTo = memberId;
                taskFilters.status = ['blank', 'working', 'stuck'];
                taskFilters.priority = '';
                taskFilters.project = '';

                console.log(`🎯 Filter object:`, taskFilters);

                // Update status filter display to show the selected statuses
                updateStatusFilterDisplay();

                // Manually filter tasks with proper logic
                let filteredTasks = tasks.filter(task => {
                    // Check if task is assigned to this member (by ID or name for backward compatibility)
                    const isMember = task.assignedTo === memberId || task.person === memberName;

                    // Check if task status is in the selected statuses (not done)
                    const isNotDone = taskFilters.status.includes(task.status);

                    const matches = isMember && isNotDone;

                    if (isMember) {
                        console.log(`  Task "${task.name}": isMember=true, status=${task.status}, isNotDone=${isNotDone}`);
                    }

                    return matches;
                });

                console.log(`📊 Filtered ${filteredTasks.length} remaining tasks (excluding done) for member: ${memberName}`);

                // Render filtered tasks
                renderFilteredTasks(filteredTasks);

                // Update active filters display
                updateActiveFiltersDisplay();
            }, 500);
        }

        // Filter tasks by project ID
        function filterTasksByProject(projectId) {
            const tableBody = document.getElementById('tableBody');
            const filteredTasks = tasks.filter(task => task.projectId === projectId);

            console.log(`📊 Found ${filteredTasks.length} tasks for project ID: ${projectId}`);

            if (filteredTasks.length === 0) {
                tableBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #676879;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                        <div style="font-size: 16px; font-weight: 600;">No tasks found for this project</div>
                        <div style="font-size: 14px; margin-top: 8px;">Create a new task and assign it to this project</div>
                    </div>
                `;
                return;
            }

            // Render filtered tasks
            tableBody.innerHTML = filteredTasks.map((task, displayIndex) => {
                const index = tasks.indexOf(task); // Get original index
                const fullName = task.personName || task.person || 'Unknown';
                const displayName = formatNameWithInitial(fullName);
                const avatarText = fullName.split(' ').map(n => n[0]).join('');

                // Check if task is overdue (past due date and not done)
                const isOverdue = task.date && new Date(task.date) < new Date(new Date().setHours(0, 0, 0, 0)) && task.status !== 'done';
                const overdueClass = isOverdue ? ' overdue' : '';

                return `
                <div class="table-row${overdueClass}" data-index="${index}" data-task-id="${task.id}">
                    <div class="table-cell" data-label="#">
                        <span class="row-number">${displayIndex + 1}</span>
                    </div>
                    <div class="table-cell" data-label="Task">
                        <span class="task-name">${task.name}</span>
                    </div>
                    <div class="table-cell" data-label="Status">
                        <div class="status-badge status-${task.status}">
                            ${getStatusText(task.status)}
                        </div>
                    </div>
                    <div class="table-cell" data-label="Priority">
                        <div class="priority">
                            <span class="priority-dot priority-${task.priority}"></span>
                            <span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Assigned To">
                        <div class="editable-field" onclick="startInlineEdit(${index}, 'assignedTo', this)" title="Click to edit">
                            ${assignedToHTML}
                        </div>
                    </div>
                    <div class="table-cell" data-label="Project">
                        ${task.project ? `<span class="project-badge" title="${task.project}">${task.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                    </div>
                    <div class="table-cell" data-label="Start Date">
                        <span class="date-cell editable-field" onclick="startInlineEdit(${index}, 'startDate', this)" title="Click to edit">${formatDateForDisplay(task.startDate)}</span>
                    </div>
                    <div class="table-cell" data-label="Due Date">
                        <span class="date-cell editable-field" onclick="startInlineEdit(${index}, 'date', this)" title="Click to edit">${formatDateForDisplay(task.date)}</span>
                    </div>
                    <div class="table-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn subtask-btn" data-action="subtask" data-index="${index}" title="Add subtask">
                                ➕
                            </button>
                            <button class="action-btn edit-btn" data-action="edit" data-index="${index}" title="Edit task">
                                ✏️
                            </button>
                            <button class="action-btn clone-btn" data-action="clone" data-index="${index}" title="Clone task">
                                📋
                            </button>
                            <button class="action-btn delete-btn" data-action="delete" data-index="${index}" title="Delete task">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Render subtasks after filtered tasks
            renderSubtasks();

            // Setup drag and drop for tasks (as drop targets)
            setupTaskDropTargets();

            // Re-attach event listeners
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (action === 'subtask') {
                        showInlineAddSubtask(index);
                    } else if (action === 'edit') {
                        editTask(index);
                    } else if (action === 'clone') {
                        cloneTask(index);
                    } else if (action === 'delete') {
                        deleteTask(index);
                    }
                });
            });
        }

        // ========================================
        // TASK FILTER FUNCTIONS
        // ========================================
        let taskFilters = {
            status: [],  // Changed to array for multiple selections
            priority: '',
            assignedTo: '',
            projects: []  // Changed to array for multiple project selections
        };

        // ========================================
        // MULTI-SELECT STATUS DROPDOWN FUNCTIONS
        // ========================================

        // Toggle status dropdown
        function toggleStatusDropdown() {
            const display = document.getElementById('statusFilterDisplay');
            const options = document.getElementById('statusFilterOptions');

            display.classList.toggle('open');
            options.classList.toggle('open');
        }

        // Close status dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('statusFilterDropdown');
            const display = document.getElementById('statusFilterDisplay');
            const options = document.getElementById('statusFilterOptions');

            if (dropdown && !dropdown.contains(event.target)) {
                display.classList.remove('open');
                options.classList.remove('open');
            }
        });

        // Update status filter when checkboxes change
        function updateStatusFilter() {
            const checkboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
            const selectedStatuses = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedStatuses.push(checkbox.value);
                }
            });

            // Update taskFilters object
            taskFilters.status = selectedStatuses;

            // Update display text
            updateStatusFilterDisplay();

            // Apply filters immediately
            applyTaskFilters();
        }

        // Update the display text based on selected statuses
        function updateStatusFilterDisplay() {
            const displayText = document.getElementById('statusFilterText');
            const selectedStatuses = taskFilters.status;

            if (selectedStatuses.length === 0) {
                displayText.textContent = 'All Status';
            } else if (selectedStatuses.length === 1) {
                // Show single status name
                const statusNames = {
                    'blank': 'Not Started',
                    'working': 'Working on it',
                    'stuck': 'Stuck',
                    'done': 'Done'
                };
                displayText.textContent = statusNames[selectedStatuses[0]];
            } else if (selectedStatuses.length === 4) {
                displayText.textContent = 'All Status';
            } else {
                displayText.textContent = `${selectedStatuses.length} statuses selected`;
            }
        }

        // Toggle project filter dropdown
        function toggleProjectFilterDropdown() {
            const display = document.getElementById('projectFilterDisplay');
            const options = document.getElementById('projectFilterOptions');

            display.classList.toggle('open');
            options.classList.toggle('open');

            // Calculate position if opening
            if (options.classList.contains('open')) {
                setTimeout(() => {
                    const rect = display.getBoundingClientRect();
                    options.style.position = 'fixed';
                    options.style.top = (rect.bottom + 4) + 'px';
                    options.style.left = rect.left + 'px';
                    options.style.width = rect.width + 'px';
                    options.style.right = 'auto';
                }, 0);
            } else {
                options.style.position = 'absolute';
                options.style.top = '100%';
                options.style.left = '0';
                options.style.right = '0';
            }
        }

        // Reposition project filter dropdown on scroll
        window.addEventListener('scroll', function() {
            const options = document.getElementById('projectFilterOptions');
            if (options && options.classList.contains('open')) {
                const display = document.getElementById('projectFilterDisplay');
                const rect = display.getBoundingClientRect();
                options.style.top = (rect.bottom + 4) + 'px';
                options.style.left = rect.left + 'px';
            }
        }, true);

        // Close project filter dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('projectFilterDropdown');
            const display = document.getElementById('projectFilterDisplay');
            const options = document.getElementById('projectFilterOptions');

            if (dropdown && !dropdown.contains(event.target) && options && !options.contains(event.target)) {
                display.classList.remove('open');
                options.classList.remove('open');
            }
        });

        // Update project filter when checkboxes change
        function updateProjectFilter() {
            const checkboxes = document.querySelectorAll('#projectFilterOptions input[type="checkbox"]');
            const selectedProjects = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedProjects.push(checkbox.value);
                }
            });

            // Update taskFilters object
            taskFilters.projects = selectedProjects;

            // Update display text
            updateProjectFilterDisplay();

            // Apply filters immediately
            applyTaskFilters();
        }

        // Update the display text based on selected projects
        function updateProjectFilterDisplay() {
            const displayText = document.getElementById('projectFilterText');
            const selectedProjects = taskFilters.projects;

            if (selectedProjects.length === 0) {
                displayText.textContent = 'All Projects';
            } else if (selectedProjects.length === 1) {
                // Show single project name
                const checkbox = document.querySelector(`#project-${selectedProjects[0]}`);
                if (checkbox) {
                    const label = checkbox.nextElementSibling;
                    displayText.textContent = label.textContent;
                }
            } else {
                displayText.textContent = `${selectedProjects.length} projects selected`;
            }
        }

        // Toggle filter panel visibility
        function toggleFilterPanel() {
            const panel = document.getElementById('taskFilterPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';

                // Restore all filter values from taskFilters object
                document.getElementById('filterStatus').value = taskFilters.status || '';
                document.getElementById('filterPriority').value = taskFilters.priority || '';

                // Populate dynamic dropdowns (they will restore their values internally)
                populateFilterDropdowns();
            } else {
                panel.style.display = 'none';
            }
        }

        // Populate filter dropdowns with data
        async function populateFilterDropdowns() {
            // Save current values before repopulating
            const savedAssignedTo = taskFilters.assignedTo;
            const savedProject = taskFilters.project;

            // Populate Assigned To dropdown
            const assignedToSelect = document.getElementById('filterAssignedTo');
            const uniqueMembers = [...new Set(tasks.map(t => t.assignedTo).filter(Boolean))];

            // Get member names
            const memberOptions = await Promise.all(
                uniqueMembers.map(async (memberId) => {
                    const memberName = await getMemberNameById(memberId);
                    return { id: memberId, name: memberName };
                })
            );

            assignedToSelect.innerHTML = '<option value="">All Members</option>' +
                memberOptions.map(m => `<option value="${m.id}">${m.name}</option>`).join('');

            // Restore saved value
            if (savedAssignedTo) {
                assignedToSelect.value = savedAssignedTo;
            }

            // Populate Project filter with checkboxes
            const projectOptionsContainer = document.getElementById('projectFilterOptions');
            const uniqueProjects = [...new Set(tasks.map(t => t.projectId).filter(Boolean))];

            const projectOptions = await Promise.all(
                uniqueProjects.map(async (projectId) => {
                    const projectName = await getProjectNameById(projectId);
                    return { id: projectId, name: projectName };
                })
            );

            // Sort projects by name
            projectOptions.sort((a, b) => a.name.localeCompare(b.name));

            // Clear and rebuild with checkboxes
            projectOptionsContainer.innerHTML = '';

            projectOptions.forEach(project => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'multi-select-option';
                optionDiv.onclick = (e) => e.stopPropagation();

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `project-${project.id}`;
                checkbox.value = project.id;
                checkbox.onchange = updateProjectFilter;

                // Restore saved selections
                if (taskFilters.projects && taskFilters.projects.includes(project.id)) {
                    checkbox.checked = true;
                }

                const label = document.createElement('label');
                label.htmlFor = `project-${project.id}`;
                label.textContent = project.name;

                optionDiv.appendChild(checkbox);
                optionDiv.appendChild(label);
                projectOptionsContainer.appendChild(optionDiv);
            });

            // Update display text based on saved selections
            updateProjectFilterDisplay();
        }

        // Apply task filters
        function applyTaskFilters() {
            // Get filter values (status is already in taskFilters.status as array)
            taskFilters.priority = document.getElementById('filterPriority').value;
            taskFilters.assignedTo = document.getElementById('filterAssignedTo').value;

            // Get multiple selected projects from checkboxes
            const projectCheckboxes = document.querySelectorAll('#projectFilterOptions input[type="checkbox"]');
            taskFilters.projects = [];
            projectCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    taskFilters.projects.push(checkbox.value);
                }
            });

            // Check if any filter is active
            const hasActiveFilters = taskFilters.status.length > 0 ||
                                      taskFilters.priority !== '' ||
                                      taskFilters.assignedTo !== '' ||
                                      taskFilters.projects.length > 0;

            // Filter tasks
            let filteredTasks = tasks;

            // Filter by multiple statuses (OR logic)
            if (taskFilters.status && taskFilters.status.length > 0) {
                filteredTasks = filteredTasks.filter(t => taskFilters.status.includes(t.status));
            }

            if (taskFilters.priority) {
                filteredTasks = filteredTasks.filter(t => t.priority === taskFilters.priority);
            }

            if (taskFilters.assignedTo) {
                filteredTasks = filteredTasks.filter(t => {
                    // Check assignedTo (primary ID), assignedToIds (array), and person (name) for backward compatibility
                    return t.assignedTo === taskFilters.assignedTo ||
                           (t.assignedToIds && t.assignedToIds.includes(taskFilters.assignedTo)) ||
                           (t.person && document.getElementById('filterAssignedTo').selectedOptions[0] &&
                            t.person === document.getElementById('filterAssignedTo').selectedOptions[0].text);
                });
            }

            // Filter by multiple projects (OR logic)
            if (taskFilters.projects.length > 0) {
                filteredTasks = filteredTasks.filter(t => taskFilters.projects.includes(t.projectId));
            }

            // Render filtered tasks
            renderFilteredTasks(filteredTasks);

            // Update active filters display
            updateActiveFiltersDisplay();
        }

        // Render filtered tasks
        function renderFilteredTasks(filteredTasks) {
            const tableBody = document.getElementById('tableBody');

            if (filteredTasks.length === 0) {
                tableBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #676879;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                        <div style="font-size: 16px; font-weight: 600;">No tasks match your filters</div>
                        <div style="font-size: 14px; margin-top: 8px;">Try adjusting your filter criteria</div>
                    </div>
                `;
                return;
            }

            tableBody.innerHTML = filteredTasks.map((task, displayIndex) => {
                const index = tasks.indexOf(task);

                // Handle multiple assignees
                let assignedToHTML = '';
                if (task.assignedToNames && task.assignedToNames.length > 0) {
                    // Multiple assignees
                    const displayNames = task.assignedToNames.map(name => formatNameWithInitial(name));
                    if (task.assignedToNames.length === 1) {
                        const fullName = task.assignedToNames[0];
                        const displayName = displayNames[0];
                        const avatarText = fullName.split(' ').map(n => n[0]).join('');
                        assignedToHTML = `
                            <div class="person-cell">
                                <div class="person-avatar">${avatarText}</div>
                                <span>${displayName}</span>
                            </div>`;
                    } else {
                        // Multiple members - show avatars stacked
                        const avatars = task.assignedToNames.map(name => {
                            const avatarText = name.split(' ').map(n => n[0]).join('');
                            return `<div class="person-avatar person-avatar-small" title="${name}">${avatarText}</div>`;
                        }).join('');
                        assignedToHTML = `
                            <div class="person-cell">
                                <div class="person-avatars-group">${avatars}</div>
                            </div>`;
                    }
                } else {
                    // Fallback to old single assignee format
                    const fullName = task.personName || task.person || 'Unknown';
                    const displayName = formatNameWithInitial(fullName);
                    const avatarText = fullName.split(' ').map(n => n[0]).join('');
                    assignedToHTML = `
                        <div class="person-cell">
                            <div class="person-avatar">${avatarText}</div>
                            <span>${displayName}</span>
                        </div>`;
                }

                // Check if task is overdue (past due date and not done)
                const isOverdue = task.date && new Date(task.date) < new Date(new Date().setHours(0, 0, 0, 0)) && task.status !== 'done';
                const overdueClass = isOverdue ? ' overdue' : '';

                return `
                <div class="table-row${overdueClass}" data-index="${index}" data-task-id="${task.id}">
                    <div class="table-cell" data-label="#">
                        <span class="row-number">${displayIndex + 1}</span>
                    </div>
                    <div class="table-cell" data-label="Task">
                        <span class="task-name editable-field" onclick="startInlineEdit(${index}, 'name', this)" title="Click to edit">${task.name}</span>
                    </div>
                    <div class="table-cell" data-label="Status">
                        <div class="status-badge-wrapper">
                            <div class="status-badge status-${task.status}" onclick="toggleStatusPopup(event, ${index})">
                                ${getStatusText(task.status)}
                            </div>
                            <div class="status-popup" id="status-popup-${index}">
                                <div class="status-popup-option blank" onclick="changeTaskStatus(${index}, 'blank')">
                                    Not Started
                                </div>
                                <div class="status-popup-option working" onclick="changeTaskStatus(${index}, 'working')">
                                    Working on it
                                </div>
                                <div class="status-popup-option stuck" onclick="changeTaskStatus(${index}, 'stuck')">
                                    Stuck
                                </div>
                                <div class="status-popup-option done" onclick="changeTaskStatus(${index}, 'done')">
                                    Done
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Priority">
                        <div class="priority">
                            <span class="priority-dot priority-${task.priority}"></span>
                            <span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Assigned To">
                        <div class="editable-field" onclick="startInlineEdit(${index}, 'assignedTo', this)" title="Click to edit">
                            ${assignedToHTML}
                        </div>
                    </div>
                    <div class="table-cell" data-label="Project">
                        ${task.project ? `<span class="project-badge" title="${task.project}">${task.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                    </div>
                    <div class="table-cell" data-label="Start Date">
                        <span class="date-cell editable-field" onclick="startInlineEdit(${index}, 'startDate', this)" title="Click to edit">${formatDateForDisplay(task.startDate)}</span>
                    </div>
                    <div class="table-cell" data-label="Due Date">
                        <span class="date-cell editable-field" onclick="startInlineEdit(${index}, 'date', this)" title="Click to edit">${formatDateForDisplay(task.date)}</span>
                    </div>
                    <div class="table-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn subtask-btn" data-action="subtask" data-index="${index}" title="Add subtask">
                                ➕
                            </button>
                            <button class="action-btn edit-btn" data-action="edit" data-index="${index}" title="Edit task">
                                ✏️
                            </button>
                            <button class="action-btn clone-btn" data-action="clone" data-index="${index}" title="Clone task">
                                📋
                            </button>
                            <button class="action-btn delete-btn" data-action="delete" data-index="${index}" title="Delete task">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Render subtasks after filtered tasks
            renderSubtasks();

            // Setup drag and drop for tasks (as drop targets)
            setupTaskDropTargets();

            // Re-attach event listeners
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (action === 'subtask') {
                        showInlineAddSubtask(index);
                    } else if (action === 'edit') {
                        editTask(index);
                    } else if (action === 'clone') {
                        cloneTask(index);
                    } else if (action === 'delete') {
                        deleteTask(index);
                    }
                });
            });

            console.log(`✅ Filtered to ${filteredTasks.length} tasks`);
        }

        // Update active filters display
        function updateActiveFiltersDisplay() {
            const activeFiltersDisplay = document.getElementById('activeFiltersDisplay');
            const activeFilterTags = document.getElementById('activeFilterTags');

            const activeFilters = [];

            // Handle multiple status selections
            if (taskFilters.status && taskFilters.status.length > 0) {
                const statusNames = {
                    'blank': 'Not Started',
                    'working': 'Working on it',
                    'stuck': 'Stuck',
                    'done': 'Done'
                };
                const statusValues = taskFilters.status.map(s => statusNames[s] || s).join(', ');
                activeFilters.push({ type: 'status', label: 'Status', value: statusValues });
            }
            if (taskFilters.priority) {
                activeFilters.push({ type: 'priority', label: 'Priority', value: taskFilters.priority.charAt(0).toUpperCase() + taskFilters.priority.slice(1) });
            }
            if (taskFilters.assignedTo) {
                const memberName = document.getElementById('filterAssignedTo').selectedOptions[0].text;
                activeFilters.push({ type: 'assignedTo', label: 'Member', value: memberName });
            }
            if (taskFilters.projects && taskFilters.projects.length > 0) {
                const projectNames = taskFilters.projects.map(projectId => {
                    const checkbox = document.querySelector(`#project-${projectId}`);
                    return checkbox ? checkbox.nextElementSibling.textContent : 'Unknown';
                }).join(', ');
                activeFilters.push({ type: 'projects', label: 'Project', value: projectNames });
            }

            if (activeFilters.length > 0) {
                activeFiltersDisplay.style.display = 'block';
                activeFilterTags.innerHTML = activeFilters.map(filter => `
                    <div style="background: #e6f2ff; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: #0073ea; display: flex; align-items: center; gap: 6px;">
                        <strong>${filter.label}:</strong> ${filter.value}
                        <button onclick="removeFilter('${filter.type}')" style="background: none; border: none; color: #0073ea; cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">×</button>
                    </div>
                `).join('');
            } else {
                activeFiltersDisplay.style.display = 'none';
            }
        }

        // Remove individual filter
        function removeFilter(filterType) {
            if (filterType === 'status') {
                // Uncheck all status checkboxes
                const checkboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = false);
                taskFilters.status = [];
                updateStatusFilterDisplay();
            } else if (filterType === 'projects') {
                // Uncheck all project checkboxes
                const checkboxes = document.querySelectorAll('#projectFilterOptions input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = false);
                taskFilters.projects = [];
                updateProjectFilterDisplay();
            } else {
                document.getElementById('filter' + filterType.charAt(0).toUpperCase() + filterType.slice(1)).value = '';
            }
            applyTaskFilters();
        }

        // Clear all task filters
        function clearAllTaskFilters() {
            // Clear status checkboxes
            const statusCheckboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
            statusCheckboxes.forEach(checkbox => checkbox.checked = false);

            // Clear project checkboxes
            const projectCheckboxes = document.querySelectorAll('#projectFilterOptions input[type="checkbox"]');
            projectCheckboxes.forEach(checkbox => checkbox.checked = false);

            document.getElementById('filterPriority').value = '';
            document.getElementById('filterAssignedTo').value = '';

            taskFilters = {
                status: [],  // Changed to empty array
                priority: '',
                assignedTo: '',
                projects: []  // Changed to empty array
            };

            // Update status filter display
            updateStatusFilterDisplay();

            // Update project filter display
            updateProjectFilterDisplay();

            // Clear project filter variable
            currentProjectFilter = null;

            renderTasks();
            updateActiveFiltersDisplay();

            console.log('✅ All task filters cleared');
        }

        // Handle project form submission
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get selected team member IDs and names
            const teamMembersSelect = document.getElementById('projectTeamMembers');
            const selectedOptions = Array.from(teamMembersSelect.selectedOptions);

            const teamMemberIds = selectedOptions.map(opt => opt.value).filter(v => v);
            const teamMemberNames = selectedOptions.map(opt => opt.getAttribute('data-member-name')).filter(n => n);

            // Validate that at least one team member is selected
            if (teamMemberIds.length === 0) {
                alert('⚠️ Please select at least one team member for this project.');
                teamMembersSelect.focus();
                return;
            }

            // Get selected project manager IDs and names
            const projectManagerSelect = document.getElementById('projectManager');
            const selectedManagerOptions = Array.from(projectManagerSelect.selectedOptions);

            const projectManagerIds = selectedManagerOptions.map(opt => opt.value).filter(v => v);
            const projectManagerNames = selectedManagerOptions.map(opt => opt.getAttribute('data-member-name')).filter(n => n);

            const tagsInput = document.getElementById('projectTags').value;
            const tagsArray = tagsInput ? tagsInput.split(',').map(s => s.trim()).filter(s => s) : [];

            const projectData = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                projectType: document.getElementById('projectType').value,
                projectHealth: document.getElementById('projectHealth').value,
                status: document.getElementById('projectStatus').value,
                priority: document.getElementById('projectPriority').value,
                sdlc: document.getElementById('projectSDLC').value,
                startDate: getDateInputValue(document.getElementById('projectStartDate')),  // Convert to dd/mm/yyyy
                endDate: getDateInputValue(document.getElementById('projectEndDate')),  // Convert to dd/mm/yyyy
                progress: parseInt(document.getElementById('projectProgress').value),
                budget: parseInt(document.getElementById('projectBudget').value) || 0,
                teamMemberIds: teamMemberIds,  // Store IDs
                teamMembers: teamMemberNames,   // Store names for backwards compatibility and display
                projectManagerIds: projectManagerIds,  // Store manager IDs
                projectManagers: projectManagerNames,  // Store manager names
                tags: tagsArray
            };

            try {
                if (editingProjectIndex >= 0) {
                    // Update existing project
                    const project = projects[editingProjectIndex];

                    // Update in Firebase if project has an ID
                    if (project.id && db) {
                        await updateProjectInFirebase(project.id, projectData);
                        console.log('✅ Project updated in Firebase:', project.id);
                        alert('✅ Project updated successfully!');
                    } else {
                        // Fallback to local storage if no ID
                        projects[editingProjectIndex] = projectData;
                        alert('✅ Project updated successfully (locally)!');
                    }
                } else {
                    // Add new project to Firebase
                    if (db) {
                        const projectId = await addProjectToFirebase(projectData);
                        console.log('✅ Project added to Firebase with ID:', projectId);
                        alert('✅ Project created successfully!');
                    } else {
                        // Fallback to local storage if Firebase not available
                        projects.push(projectData);
                        alert('✅ Project created successfully (locally)!');
                    }
                }

                closeProjectModal();

                // Reload projects from Firebase
                if (db) {
                    await loadProjectsFromFirebase();
                } else {
                    renderProjects();
                }

            } catch (error) {
                console.error('❌ Error saving project:', error);
                alert('❌ Error saving project: ' + error.message);
            }
        });

        // Close modal when clicking outside
        document.getElementById('projectModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProjectModal();
            }
        });

        // Initialize app
        window.addEventListener('load', async () => {
            // Show single unified spinner for all initial loads
            const overlay = document.getElementById('loadingOverlay');
            const spinnerText = document.getElementById('spinnerText');

            if (overlay && spinnerText) {
                spinnerText.textContent = 'Loading dashboard...';
                overlay.classList.add('active');
                console.log('📊 Starting unified dashboard load...');
            }

            try {
                // Load from Firebase
                if (db) {
                    // Temporarily override showSpinner to not show multiple spinners
                    const originalShowSpinner = window.showSpinner;
                    const originalHideSpinner = window.hideSpinner;
                    let showSpinnerCount = 0;

                    window.showSpinner = (text) => {
                        showSpinnerCount++;
                        // Update text but don't show/hide overlay for internal calls
                        if (spinnerText && text) {
                            spinnerText.textContent = text;
                        }
                    };

                    window.hideSpinner = () => {
                        showSpinnerCount--;
                        // Only hide if all spinners are hidden
                        if (showSpinnerCount <= 0) {
                            showSpinnerCount = 0;
                            // Keep showing the unified spinner until all loads complete
                        }
                    };

                    // Load all data
                    await loadTasksFromFirebase();
                    await loadSubtasksFromFirebase();
                    await loadTeamMembersWithStats();
                    await loadProjectsFromFirebase();
                    setupRealtimeListener();

                    // Restore original spinner functions
                    window.showSpinner = originalShowSpinner;
                    window.hideSpinner = originalHideSpinner;
                    console.log('✅ All data loaded successfully');
                } else {
                    renderTasks();
                    renderProjects();
                    updateDashboardStats();
                }
            } finally {
                // Hide the unified spinner after all loads complete
                if (overlay) {
                    overlay.classList.remove('active');
                    console.log('📊 Dashboard load complete');
                }
            }

            // Ensure dashboard page and nav button are properly activated
            switchPage('dashboard');
            console.log('📊 Dashboard page activated');

            // Setup guest mode UI
            if (guestMode) {
                console.log('🎫 Setting up guest mode UI - hiding restricted nav buttons');
                // Hide restricted nav buttons for guest users
                const restrictedButtons = ['projectsNavBtn', 'tasksNavBtn', 'teamNavBtn', 'reportsNavBtn'];
                restrictedButtons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.style.display = 'none';
                        console.log(`  ✅ Hidden button: ${btnId}`);
                    }
                });
            }

            // Initialize project view styling
            setTimeout(() => {
                const tableBtn = document.getElementById('tableViewBtn');
                if (tableBtn && currentProjectView === 'grid') {
                    tableBtn.style.background = 'white';
                    tableBtn.style.border = '2px solid #667eea';
                    tableBtn.style.color = '#667eea';
                }
            }, 100);
        });
    </script>

    <!-- Loading Spinner Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text" id="spinnerText">Loading...</div>
        </div>
    </div>

</body>
</html>