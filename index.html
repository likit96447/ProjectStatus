<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income & Expense Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom right, #dbeafe, #e0e7ff);
            min-height: 100vh;
            padding: 16px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 32px; padding-top: 24px; }
        .header h1 { font-size: 36px; font-weight: bold; color: #312e81; margin-bottom: 8px; }
        .header p { color: #6b7280; }
        .auth-box { max-width: 400px; margin: 100px auto; background: white; padding: 32px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .auth-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 24px; color: #1f2937; }
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .tab { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: #f3f4f6; color: #374151; }
        .tab.active { background: #4f46e5; color: white; }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; }
        .input-group input, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: #4f46e5; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-primary:hover { background: #4338ca; }
        .btn-logout { padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .error { background: #fee; border: 1px solid #fcc; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .stat-card.income { border-top: 4px solid #10b981; }
        .stat-card.expense { border-top: 4px solid #ef4444; }
        .stat-card.balance { border-top: 4px solid #6366f1; }
        .stat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .stat-label { color: #6b7280; font-weight: 500; }
        .stat-value { font-size: 32px; font-weight: bold; }
        .stat-value.green { color: #10b981; }
        .stat-value.red { color: #ef4444; }
        .stat-value.blue { color: #6366f1; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .card-header h2 { font-size: 24px; font-weight: bold; color: #1f2937; }
        .btn-add { display: flex; align-items: center; gap: 8px; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-add:hover { background: #4338ca; }
        .empty { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .transaction { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 12px; }
        .transaction:hover { background: #f3f4f6; }
        .trans-left { display: flex; align-items: center; gap: 16px; flex: 1; }
        .trans-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .trans-icon.income { background: #d1fae5; }
        .trans-icon.expense { background: #fee2e2; }
        .trans-info { flex: 1; }
        .trans-category { font-weight: 600; color: #1f2937; }
        .trans-date { font-size: 12px; color: #6b7280; margin-top: 2px; }
        .trans-desc { font-size: 14px; color: #6b7280; margin-top: 2px; }
        .trans-right { display: flex; align-items: center; gap: 16px; }
        .trans-amount { font-size: 20px; font-weight: bold; }
        .trans-amount.income { color: #10b981; }
        .trans-amount.expense { color: #ef4444; }
        .btn-delete { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-header h3 { font-size: 24px; font-weight: bold; color: #1f2937; }
        .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
        .radio-group { display: flex; gap: 20px; }
        .radio-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 500; }
        .radio-label.income { color: #10b981; }
        .radio-label.expense { color: #ef4444; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="modal" class="modal"></div>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCZ6Lfl2NJt8lQFYyjY5Q2rDohRmfKxP5s",
            authDomain: "expense-f50a0.firebaseapp.com",
            projectId: "expense-f50a0",
            storageBucket: "expense-f50a0.firebasestorage.app",
            messagingSenderId: "709859617407",
            appId: "1:709859617407:web:edce32057658702f9ead4a",
            measurementId: "G-39JVQJ41GN"
        };

        var app;
        var auth;
        var db;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
            
            // Test connection
            auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
                .then(function() {
                    console.log('Auth persistence set');
                })
                .catch(function(error) {
                    console.error('Persistence error:', error);
                });
                
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('app').innerHTML = '<div style="max-width:500px;margin:100px auto;padding:30px;background:white;border-radius:12px;text-align:center;"><h2 style="color:#ef4444;margin-bottom:20px;">⚠️ Firebase Connection Error</h2><p style="color:#6b7280;margin-bottom:20px;">Unable to connect to Firebase. This might be due to network restrictions in the current environment.</p><p style="color:#6b7280;"><strong>Solution:</strong> Download this HTML file and open it locally in your browser, or deploy it to a web server.</p></div>';
        }

        var user = null;
        var transactions = [];
        var mode = 'login';

        auth.onAuthStateChanged(function(u) {
            console.log('Auth state changed:', u);
            user = u;
            if (u) {
                console.log('User logged in:', u.email);
                loadData();
            } else {
                console.log('No user logged in');
                showAuth();
            }
        });

        function loadData() {
            db.collection('transactions').where('userId', '==', user.uid).orderBy('date', 'desc').onSnapshot(function(snap) {
                transactions = [];
                snap.forEach(function(doc) {
                    var d = doc.data();
                    transactions.push({
                        id: doc.id,
                        type: d.type,
                        category: d.category,
                        amount: d.amount,
                        date: d.date,
                        description: d.description
                    });
                });
                showApp();
            });
        }

        function doAuth() {
            console.log('doAuth called, mode:', mode);
            
            var email = document.getElementById('email').value;
            var pass = document.getElementById('pass').value;
            var err = document.getElementById('err');
            
            console.log('Email:', email, 'Password length:', pass.length);
            
            if (!email || !pass) {
                err.innerHTML = '<div class="error">Please fill in all fields</div>';
                return;
            }
            
            if (pass.length < 6) {
                err.innerHTML = '<div class="error">Password must be at least 6 characters</div>';
                return;
            }
            
            err.innerHTML = '<div style="text-align:center;color:#6b7280;padding:10px;">Processing...</div>';
            
            if (mode === 'login') {
                console.log('Attempting login...');
                auth.signInWithEmailAndPassword(email, pass)
                    .then(function(result) {
                        console.log('Login successful:', result);
                    })
                    .catch(function(error) {
                        console.error('Login error:', error.code, error.message);
                        err.innerHTML = '<div class="error">' + error.message + '</div>';
                    });
            } else {
                console.log('Attempting signup...');
                auth.createUserWithEmailAndPassword(email, pass)
                    .then(function(result) {
                        console.log('Account created successfully:', result);
                    })
                    .catch(function(error) {
                        console.error('Signup error:', error.code, error.message);
                        err.innerHTML = '<div class="error">' + error.message + '</div>';
                    });
            }
        }

        function logout() {
            auth.signOut();
        }

        function addTrans() {
            var radios = document.getElementsByName('type');
            var type = 'expense';
            for (var i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    type = radios[i].value;
                    break;
                }
            }
            var cat = document.getElementById('cat').value;
            var amt = parseFloat(document.getElementById('amt').value);
            var date = document.getElementById('date').value;
            var desc = document.getElementById('desc').value;

            if (!cat || !amt || !date || !desc) {
                alert('Please fill all fields');
                return;
            }

            db.collection('transactions').add({
                userId: user.uid,
                type: type,
                category: cat,
                amount: amt,
                date: date,
                description: desc,
                createdAt: new Date().toISOString()
            }).then(function() {
                hideModal();
            });
        }

        function delTrans(id) {
            if (confirm('Delete this transaction?')) {
                db.collection('transactions').doc(id).delete();
            }
        }

        function showModal() {
            document.getElementById('modal').className = 'modal show';
            var html = '<div class="modal-content">';
            html += '<div class="modal-header"><h3>Add Transaction</h3><button class="btn-close" onclick="hideModal()">✕</button></div>';
            html += '<div>';
            html += '<div class="input-group"><label>Type</label><div class="radio-group">';
            html += '<label class="radio-label income"><input type="radio" name="type" value="income"> Income</label>';
            html += '<label class="radio-label expense"><input type="radio" name="type" value="expense" checked> Expense</label>';
            html += '</div></div>';
            html += '<div class="input-group"><label>Category</label><input type="text" id="cat" required placeholder="e.g., Salary, Food"></div>';
            html += '<div class="input-group"><label>Amount</label><input type="number" id="amt" step="0.01" required placeholder="0.00"></div>';
            html += '<div class="input-group"><label>Date</label><input type="date" id="date" required></div>';
            html += '<div class="input-group"><label>Description</label><textarea id="desc" rows="3" required></textarea></div>';
            html += '<button type="button" class="btn btn-primary" onclick="addTrans()">Add Transaction</button>';
            html += '</div></div>';
            document.getElementById('modal').innerHTML = html;
        }

        function hideModal() {
            document.getElementById('modal').className = 'modal';
        }

        function setMode(m) {
            mode = m;
            showAuth();
        }

        function calc() {
            var inc = 0, exp = 0;
            for (var i = 0; i < transactions.length; i++) {
                if (transactions[i].type === 'income') {
                    inc += transactions[i].amount;
                } else {
                    exp += transactions[i].amount;
                }
            }
            return {income: inc, expense: exp, balance: inc - exp};
        }

        function showAuth() {
            var app = document.getElementById('app');
            var html = '<div class="auth-box">';
            html += '<div class="auth-title">Financial Manager</div>';
            html += '<p style="text-align:center;color:#6b7280;margin-bottom:20px;font-size:14px;">Sign up to track your finances</p>';
            html += '<div class="tabs">';
            html += '<button class="tab ' + (mode === 'login' ? 'active' : '') + '" onclick="setMode(\'login\')">Login</button>';
            html += '<button class="tab ' + (mode === 'signup' ? 'active' : '') + '" onclick="setMode(\'signup\')">Sign Up</button>';
            html += '</div>';
            html += '<div id="err"></div>';
            
            if (mode === 'signup') {
                html += '<div style="background:#fef3c7;border:1px solid #fcd34d;padding:10px;border-radius:8px;margin-bottom:16px;font-size:13px;">';
                html += '<strong>Note:</strong> Make sure Email/Password authentication is enabled in your Firebase Console (Authentication → Sign-in method)';
                html += '</div>';
            }
            
            html += '<div>';
            html += '<div class="input-group"><label>Email</label><input type="email" id="email" required placeholder="your@email.com"></div>';
            html += '<div class="input-group"><label>Password (min 6 characters)</label><input type="password" id="pass" required minlength="6" placeholder="••••••••"></div>';
            html += '<button type="button" class="btn btn-primary" onclick="doAuth()">' + (mode === 'login' ? 'Login' : 'Create Account') + '</button>';
            html += '</div>';
            
            html += '<div style="margin-top:20px;padding:12px;background:#f3f4f6;border-radius:8px;font-size:12px;color:#6b7280;">';
            html += '<strong>Test credentials:</strong><br>Email: demo@test.com<br>Password: demo123456';
            html += '</div>';
            
            html += '</div>';
            app.innerHTML = html;
        }

        function showApp() {
            var stats = calc();
            var app = document.getElementById('app');
            var html = '<div class="container">';
            html += '<div class="top-bar"><div class="header"><h1>Financial Manager</h1><p>Welcome, ' + user.email + '</p></div>';
            html += '<button class="btn-logout" onclick="logout()">Logout</button></div>';
            html += '<div class="stats">';
            html += '<div class="stat-card income"><div class="stat-header"><span class="stat-label">Total Income</span><span>📈</span></div>';
            html += '<div class="stat-value green">$' + stats.income.toFixed(2) + '</div></div>';
            html += '<div class="stat-card expense"><div class="stat-header"><span class="stat-label">Total Expenses</span><span>📉</span></div>';
            html += '<div class="stat-value red">$' + stats.expense.toFixed(2) + '</div></div>';
            html += '<div class="stat-card balance"><div class="stat-header"><span class="stat-label">Balance</span><span>💰</span></div>';
            html += '<div class="stat-value ' + (stats.balance >= 0 ? 'blue' : 'red') + '">$' + stats.balance.toFixed(2) + '</div></div>';
            html += '</div>';
            html += '<div class="card"><div class="card-header"><h2>Transactions</h2>';
            html += '<button class="btn-add" onclick="showModal()">➕ Add Transaction</button></div>';
            
            if (transactions.length === 0) {
                html += '<div class="empty"><div style="font-size:60px;margin-bottom:16px">💼</div>';
                html += '<p style="font-size:18px;margin-bottom:8px">No transactions yet</p>';
                html += '<p>Click Add Transaction to get started</p></div>';
            } else {
                for (var i = 0; i < transactions.length; i++) {
                    var t = transactions[i];
                    var icon = t.type === 'income' ? '📈' : '📉';
                    var iconClass = t.type === 'income' ? 'income' : 'expense';
                    var amtClass = t.type === 'income' ? 'income' : 'expense';
                    var sign = t.type === 'income' ? '+' : '-';
                    html += '<div class="transaction">';
                    html += '<div class="trans-left"><div class="trans-icon ' + iconClass + '">' + icon + '</div>';
                    html += '<div class="trans-info"><div class="trans-category">' + t.category + '</div>';
                    html += '<div class="trans-date">📅 ' + t.date + '</div>';
                    html += '<div class="trans-desc">' + t.description + '</div></div></div>';
                    html += '<div class="trans-right"><div class="trans-amount ' + amtClass + '">' + sign + '$' + t.amount.toFixed(2) + '</div>';
                    html += '<button class="btn-delete" onclick="delTrans(\'' + t.id + '\')">❌</button></div></div>';
                }
            }
            html += '</div></div>';
            app.innerHTML = html;
        }
    </script>
</body>
</html>