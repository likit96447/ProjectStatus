<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Team Member Passwords - ProjectFlow</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #323338;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            background: #f6f7fb;
            min-height: 100vh;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e6e9ef;
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .back-btn {
            padding: 10px 20px;
            background: #f6f7fb;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #323338;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: #e6e9ef;
            transform: translateY(-2px);
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 8px;
        }

        .page-description {
            font-size: 16px;
            color: #676879;
            line-height: 1.6;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #323338;
            margin-bottom: 16px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #1565c0;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .info-box h4 {
            color: #1565c0;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #0d47a1;
            font-size: 14px;
            line-height: 1.6;
        }

        .btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .log {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            display: none;
            border: 1px solid #e6e9ef;
        }

        .log.show {
            display: block;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .log-entry.success {
            color: #2e7d32;
        }

        .log-entry.error {
            color: #c62828;
        }

        .log-entry.info {
            color: #1565c0;
        }

        .summary {
            background: #e8f5e9;
            padding: 24px;
            border-radius: 12px;
            margin-top: 24px;
            display: none;
            border-left: 4px solid #2e7d32;
        }

        .summary.show {
            display: block;
        }

        .summary h3 {
            color: #1b5e20;
            font-size: 20px;
            margin-bottom: 16px;
        }

        .summary p {
            color: #2e7d32;
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 8px;
        }

        .summary strong {
            color: #1b5e20;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: #f6f7fb;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: #676879;
            font-weight: 500;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #f57c00;
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .warning-box h4 {
            color: #e65100;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .warning-box p {
            color: #ef6c00;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="logo">ProjectFlow</div>
                <button class="back-btn" onclick="window.location.href='index.html'">
                    ‚Üê Back to Dashboard
                </button>
            </div>
        </header>

        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title">Update Team Member Passwords</h1>
                <p class="page-description">
                    Add default password field to all team members in your database with base64 encryption.
                </p>
            </div>

            <div class="card">
                <div class="card-title">Password Update Utility</div>

                <div class="info-box">
                    <h4>What This Does</h4>
                    <p>
                        This utility will add a default password field to all team members in your database.
                        All passwords will be set to <strong>"1111"</strong> (base64 encoded as "MTExMQ==") by default.
                        Team members can use their email and this password to log in.
                    </p>
                </div>

                <div class="warning-box">
                    <h4>‚ö†Ô∏è Important</h4>
                    <p>
                        Run this utility <strong>ONCE</strong> before first use. It will skip team members who already have passwords.
                        After running this, team members can login with their email and password "1111", then change their password from the Team page.
                    </p>
                </div>

                <button id="updateBtn" class="btn" onclick="updatePasswords()">
                    <span>üîê</span>
                    Update All Passwords
                </button>

                <div id="log" class="log"></div>

                <div id="summary" class="summary"></div>
            </div>
        </div>
    </div>

    <script>
        let db;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA2My_zhJEfE_wfQ9wpu4W7o_cLKOI9PLQ",
            authDomain: "project-status-f7de8.firebaseapp.com",
            projectId: "project-status-f7de8",
            storageBucket: "project-status-f7de8.firebasestorage.app",
            messagingSenderId: "809576699201",
            appId: "1:809576699201:web:554f6cbf54200d08b6fdc0",
            measurementId: "G-61Z0HS88LR"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            log("‚úÖ Firebase initialized successfully!", "success");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            log("‚ùå Failed to initialize Firebase: " + error.message, "error");
        }

        const logContainer = document.getElementById('log');
        const summaryContainer = document.getElementById('summary');
        const updateBtn = document.getElementById('updateBtn');

        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Base64 encode function
        function encodePassword(password) {
            return btoa(password);
        }

        async function updatePasswords() {
            logContainer.innerHTML = '';
            logContainer.classList.add('show');
            summaryContainer.classList.remove('show');

            updateBtn.disabled = true;
            updateBtn.innerHTML = '<span class="spinner"></span>Updating...';

            log("üöÄ Starting password update process...", "info");

            let successCount = 0;
            let errorCount = 0;
            let skippedCount = 0;

            try {
                // Get all team members
                log("üì° Fetching all team members from Firestore...", "info");
                const snapshot = await db.collection('team_members').get();

                if (snapshot.empty) {
                    log("‚ùå No team members found in database!", "error");
                    updateBtn.disabled = false;
                    updateBtn.innerHTML = '<span>üîê</span>Update All Passwords';
                    return;
                }

                log(`‚úÖ Found ${snapshot.docs.length} team members`, "success");
                log("", "info");

                // Update each member
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    const name = data.name || doc.id;

                    try {
                        // Check if password already exists
                        if (data.password) {
                            log(`‚è≠Ô∏è  Skipped: ${name} (password already exists)`, "info");
                            skippedCount++;
                            continue;
                        }

                        // Add default password (base64 encoded)
                        const encodedPassword = encodePassword('1111');
                        await doc.ref.update({
                            password: encodedPassword,
                            passwordUpdatedAt: new Date().toISOString()
                        });

                        log(`‚úÖ Updated: ${name} - Password set to "1111" (base64: ${encodedPassword})`, "success");
                        successCount++;
                    } catch (error) {
                        log(`‚ùå Failed: ${name} - ${error.message}`, "error");
                        errorCount++;
                    }
                }

                log("", "info");
                log("üéâ Password update process completed!", "success");

                // Show summary
                summaryContainer.innerHTML = `
                    <h3>‚úÖ Update Complete!</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${snapshot.docs.length}</div>
                            <div class="stat-label">Total Members</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #2e7d32;">${successCount}</div>
                            <div class="stat-label">Successfully Updated</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #f57c00;">${skippedCount}</div>
                            <div class="stat-label">Skipped</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color: #c62828;">${errorCount}</div>
                            <div class="stat-label">Errors</div>
                        </div>
                    </div>
                    <p style="margin-top: 20px;">
                        <strong>Next Steps:</strong> Team members can now login with their email and password "1111".
                        They should change their password after first login using the "Change Password" button on their team card.
                    </p>
                `;
                summaryContainer.classList.add('show');

            } catch (error) {
                log(`üí• Fatal error: ${error.message}`, "error");
                console.error(error);
            }

            updateBtn.disabled = false;
            updateBtn.innerHTML = '<span>üîê</span>Update All Passwords';
        }
    </script>
</body>
</html>
