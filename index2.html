<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectFlow - Modern Work Management</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #323338;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            background: #f6f7fb;
            min-height: 100vh;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e6e9ef;
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .main-nav {
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            padding: 10px 20px;
            border-radius: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #323338;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #f6f7fb;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .search-container {
            position: relative;
        }

        .search-bar {
            background: #f6f7fb;
            border: 2px solid transparent;
            padding: 12px 16px 12px 44px;
            border-radius: 12px;
            width: 320px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #676879;
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: none;
            background: #f6f7fb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .icon-btn:hover {
            background: #e6e9ef;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #ff3d57;
            border-radius: 50%;
            border: 2px solid white;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .init-data-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 28px;
            background: linear-gradient(135deg, #00c875 0%, #00a666 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 200, 117, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .init-data-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 200, 117, 0.5);
        }

        .init-data-btn:active {
            transform: translateY(-1px);
        }

        .init-data-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .init-data-btn.success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e6e9ef;
            padding: 24px 16px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 80px;
            padding: 24px 12px;
        }

        .sidebar.collapsed .sidebar-title {
            display: none;
        }

        .sidebar.collapsed .sidebar-item span:not(.emoji) {
            display: none;
        }

        .sidebar.collapsed .add-button {
            display: none;
        }

        .sidebar.collapsed .sidebar-item {
            justify-content: center;
            padding: 12px;
        }

        .sidebar.collapsed .sidebar-section {
            margin-bottom: 20px;
        }

        .collapse-btn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #f6f7fb 0%, #e6e9ef 100%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .collapse-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .sidebar-section-header:hover {
            opacity: 0.7;
        }

        .section-arrow {
            font-size: 12px;
            color: #676879;
            transition: transform 0.3s ease;
        }

        .sidebar-section.collapsed .section-arrow {
            transform: rotate(-90deg);
        }

        .sidebar-section-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .sidebar-section.collapsed .sidebar-section-content {
            max-height: 0;
            opacity: 0;
        }

        .sidebar.collapsed .sidebar-section-header {
            justify-content: center;
        }

        .sidebar.collapsed .section-arrow {
            display: none;
        }

        .sidebar-title {
            font-size: 11px;
            color: #676879;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .sidebar-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            color: #323338;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 4px;
        }

        .sidebar-item:hover {
            background: #f6f7fb;
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .sidebar-item .emoji {
            font-size: 20px;
        }

        .add-button {
            width: 100%;
            padding: 12px;
            border: 2px dashed #c5c7d0;
            background: transparent;
            border-radius: 12px;
            color: #676879;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-button:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f6f7fb;
            transform: scale(1.02);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .page-view {
            display: none;
            animation: slideIn 0.4s ease;
        }

        .page-view.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .board-header {
            margin-bottom: 32px;
        }

        .board-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #323338;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .board-subtitle {
            color: #676879;
            font-size: 15px;
        }

        .board-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #323338;
            border: 2px solid #e6e9ef;
        }

        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #676879;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            border: 1px solid #e6e9ef;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #323338;
        }

        .progress-item {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .progress-name {
            color: #323338;
            font-weight: 600;
        }

        .progress-percentage {
            color: #676879;
            font-weight: 700;
        }

        .progress-bar-container {
            height: 10px;
            background: #f6f7fb;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 16px 0;
            border-bottom: 1px solid #e6e9ef;
            display: flex;
            align-items: start;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            padding-left: 8px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            color: white;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: #323338;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .activity-time {
            font-size: 12px;
            color: #676879;
            font-weight: 600;
        }

        .table-container {
            background: white;
            border-radius: 16px;
            overflow-x: auto;
            overflow-y: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e6e9ef;
            width: 100%;
        }

        .table-wrapper {
            min-width: 100%;
            width: max-content;
        }

        .table-header {
            display: grid;
            grid-template-columns: 60px minmax(180px, 1.8fr) 140px 120px 180px 150px 130px 130px 120px;
            background: linear-gradient(135deg, #f6f7fb 0%, #e6e9ef 100%);
            border-bottom: 2px solid #e6e9ef;
            font-size: 13px;
            font-weight: 700;
            color: #676879;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: max-content;
        }

        .table-cell {
            padding: 18px 16px;
            border-right: 1px solid #e6e9ef;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-cell:last-child {
            border-right: none;
        }

        .table-row {
            display: grid;
            grid-template-columns: 60px minmax(180px, 1.8fr) 140px 120px 180px 150px 130px 130px 120px;
            border-bottom: 1px solid #e6e9ef;
            transition: all 0.3s ease;
            min-width: max-content;
        }

        .table-row:hover {
            background: #f6f7fb;
            transform: scale(1.005);
        }

        .table-row .table-cell {
            padding: 18px 16px;
            display: flex;
            align-items: center;
        }

        .table-cell .task-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f6f7fb;
            border-radius: 0 0 16px 16px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4291 100%);
        }

        .row-number {
            color: #676879;
            font-weight: 700;
        }

        .task-name {
            font-weight: 600;
            color: #323338;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .status-working {
            background: #fdab3d;
            color: white;
        }

        .status-done {
            background: #00c875;
            color: white;
        }

        .status-stuck {
            background: #e44258;
            color: white;
        }

        .status-blank {
            background: #c4c4c4;
            color: white;
        }

        .priority {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .priority-high {
            background: #e44258;
        }

        .priority-medium {
            background: #fdab3d;
        }

        .priority-low {
            background: #579bfc;
        }

        .person-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
        }

        .date-cell {
            color: #676879;
            font-size: 13px;
            font-weight: 600;
        }

        .project-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            background: linear-gradient(135deg, #e6f4ff 0%, #d4e9ff 100%);
            color: #667eea;
            border: 1px solid #b8daff;
            display: inline-block;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f6f7fb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.edit-btn:hover {
            background: #667eea;
            color: white;
        }

        .action-btn.delete-btn:hover {
            background: #e44258;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .add-row {
            padding: 20px 16px;
            color: #676879;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-row:hover {
            color: #667eea;
            background: #f6f7fb;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .team-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
            position: relative;
        }

        .team-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .team-card:hover .team-edit-btn {
            opacity: 1;
        }

        .team-edit-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: white;
            border: 2px solid #e6e9ef;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .team-edit-btn:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .team-avatar-large {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: 700;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .team-name {
            font-size: 20px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 6px;
        }

        .team-role {
            font-size: 14px;
            color: #676879;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .team-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .team-status.active {
            background: #d4edda;
            color: #155724;
        }

        .team-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .team-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 20px;
            border-top: 2px solid #e6e9ef;
        }

        .team-stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .team-stat-label {
            font-size: 12px;
            color: #676879;
            margin-top: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Projects Grid Styles */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            padding: 24px 0;
        }

        .project-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
            position: relative;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .project-card-title {
            font-size: 20px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 8px;
        }

        .project-card-description {
            font-size: 14px;
            color: #676879;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .project-status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-status-badge.planned {
            background: #e3f2fd;
            color: #1976d2;
        }

        .project-status-badge.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        .project-status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .project-status-badge.on-hold {
            background: #f8d7da;
            color: #721c24;
        }

        .project-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e6e9ef;
        }

        .project-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #676879;
        }

        .project-meta-icon {
            font-size: 14px;
        }

        .project-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .project-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #e6e9ef;
            background: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .project-action-btn:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .project-action-btn.delete:hover {
            background: #e44258;
            border-color: #e44258;
        }

        .project-progress {
            margin-top: 12px;
        }

        .project-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #676879;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .project-progress-bar {
            height: 8px;
            background: #e6e9ef;
            border-radius: 10px;
            overflow: hidden;
        }

        .project-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .project-tag {
            padding: 4px 10px;
            background: #f5f6f8;
            border-radius: 6px;
            font-size: 11px;
            color: #676879;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 540px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 28px;
            border-bottom: 2px solid #e6e9ef;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #323338;
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e6e9ef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .modal-footer {
            padding: 20px 28px;
            border-top: 2px solid #e6e9ef;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .delete-btn {
            background: #e44258;
            color: white;
        }

        .delete-btn:hover {
            background: #c93649;
        }

        /* Tablet responsive design (768px - 1024px) */
        @media (max-width: 1024px) {
            .table-container {
                overflow-x: auto;
            }

            .table-header,
            .table-row {
                grid-template-columns: 50px minmax(150px, 1fr) 120px 100px 140px 110px;
            }

            /* Hide date and timeline columns on tablet */
            .table-cell:nth-child(7),
            .table-cell:nth-child(8) {
                display: none;
            }

            .content {
                padding: 20px;
            }
        }

        /* Mobile responsive design (max-width: 768px) */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
                height: 60px;
            }

            .logo {
                font-size: 20px;
            }

            .main-nav {
                display: none;
            }

            .search-container {
                display: none;
            }

            .header-right {
                gap: 8px;
            }

            .icon-btn,
            .avatar {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .sidebar {
                width: 70px;
                padding: 16px 8px;
            }

            .sidebar-title,
            .sidebar-item span:not(.emoji),
            .add-button {
                display: none;
            }

            .sidebar-item {
                justify-content: center;
                padding: 10px;
            }

            .content {
                padding: 16px;
            }

            .board-title {
                font-size: 24px;
            }

            .board-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            /* Remove horizontal scroll on mobile */
            .table-container {
                overflow-x: visible;
                overflow-y: visible;
            }

            /* Hide table header on mobile */
            .table-header {
                display: none;
            }

            /* Convert table rows to card layout */
            .table-row {
                display: flex;
                flex-direction: column;
                padding: 16px;
                gap: 12px;
                border-radius: 12px;
                margin-bottom: 12px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                min-width: auto;
            }

            .table-row:hover {
                transform: scale(1);
            }

            .table-cell {
                padding: 0 !important;
                border-right: none !important;
                display: flex !important;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }

            .table-cell::before {
                content: attr(data-label);
                font-weight: 700;
                color: #676879;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Hide row number on mobile */
            .table-cell:nth-child(1) {
                display: none !important;
            }

            /* Task name - full width, no label */
            .table-cell:nth-child(2) {
                flex-direction: column;
                align-items: flex-start;
                padding-bottom: 8px !important;
                border-bottom: 1px solid #e6e9ef;
            }

            .table-cell:nth-child(2)::before {
                content: none;
            }

            .task-name {
                font-size: 16px;
                font-weight: 700;
            }

            /* Show all cells on mobile */
            .table-cell:nth-child(n) {
                display: flex !important;
            }

            .status-badge {
                font-size: 11px;
                padding: 6px 12px;
            }

            .person-cell {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .person-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .project-badge {
                font-size: 12px;
                padding: 4px 10px;
            }

            .action-buttons {
                gap: 8px;
            }

            .action-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .date-cell {
                font-size: 13px;
            }
        }

        /* Extra small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .header {
                padding: 0 12px;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                z-index: 200;
                transition: left 0.3s ease;
                height: calc(100vh - 60px);
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .main-container {
                margin-left: 0;
            }

            .content {
                padding: 12px;
                width: 100%;
            }

            .board-title {
                font-size: 20px;
            }

            .board-subtitle {
                font-size: 13px;
            }

            .table-row {
                padding: 12px;
            }

            .table-cell {
                font-size: 13px;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="logo">ProjectFlow</div>
                <nav class="main-nav">
                    <button class="nav-tab active" onclick="switchPage('dashboard')">Dashboard</button>
                    <button class="nav-tab" onclick="switchPage('projectslist')">Projects</button>
                    <button class="nav-tab" onclick="switchPage('tasks')">Tasks</button>
                    <button class="nav-tab" onclick="switchPage('team')">Team</button>
                    <button class="nav-tab" onclick="switchPage('reports')">Reports</button>
                </nav>
            </div>
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-bar" placeholder="Search tasks, projects, people...">
            </div>
            <div class="header-right">
                <button class="icon-btn">
                    🔔
                    <span class="notification-badge"></span>
                </button>
                <button class="icon-btn">⚙️</button>
                <button class="icon-btn">❓</button>
                <div class="avatar">JD</div>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar" id="sidebar">
                <button class="collapse-btn" onclick="toggleSidebar()">
                    <span id="collapseIcon">◀</span>
                </button>
                
                <div class="sidebar-section">
                    <div class="sidebar-item active">
                        <span class="emoji">📋</span>
                        <span>Main Table</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📊</span>
                        <span>Chart View</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📅</span>
                        <span>Calendar</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📈</span>
                        <span>Timeline</span>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('myWork')">
                        <div class="sidebar-title">My Work</div>
                        <span class="section-arrow" id="myWorkArrow">▼</span>
                    </div>
                    <div class="sidebar-section-content" id="myWorkContent">
                        <div class="sidebar-item">
                            <span class="emoji">⭐</span>
                            <span>Favorites</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">📌</span>
                            <span>My Items</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">🎯</span>
                            <span>My Goals</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('workspaces')">
                        <div class="sidebar-title">Workspaces</div>
                        <span class="section-arrow" id="workspacesArrow">▼</span>
                    </div>
                    <div class="sidebar-section-content" id="workspacesContent">
                        <div class="sidebar-item">
                            <span class="emoji">🎯</span>
                            <span>Marketing</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">💻</span>
                            <span>Development</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">🎨</span>
                            <span>Design</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">📱</span>
                            <span>Mobile</span>
                        </div>
                        <button class="add-button">+ Add Workspace</button>
                    </div>
                </div>
            </aside>

            <main class="content">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page-view active">
                    <div class="board-header">
                        <h1 class="board-title">Dashboard Overview</h1>
                        <p class="board-subtitle">Track your team's progress and performance</p>
                    </div>

                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalItems">8</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="workingItems">4</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="doneItems">2</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stuckItems">1</div>
                            <div class="stat-label">Needs Attention</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Project Progress</h3>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Website Redesign</span>
                                <span class="progress-percentage">75%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 75%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Mobile App Development</span>
                                <span class="progress-percentage">60%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 60%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Marketing Campaign</span>
                                <span class="progress-percentage">100%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 100%; background: #00c875"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Database Migration</span>
                                <span class="progress-percentage">30%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 30%; background: #e44258"></div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Recent Activity</h3>
                        <ul class="activity-list">
                            <li class="activity-item">
                                <div class="activity-icon">✅</div>
                                <div class="activity-content">
                                    <div class="activity-text"><strong>Sarah Lee</strong> completed Website Redesign mockups</div>
                                    <div class="activity-time">2 hours ago</div>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon">📝</div>
                                <div class="activity-content">
                                    <div class="activity-text"><strong>Mike Chen</strong> updated Mobile App Development status</div>
                                    <div class="activity-time">4 hours ago</div>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon">💬</div>
                                <div class="activity-content">
                                    <div class="activity-text"><strong>Emily Rose</strong> commented on Marketing Campaign</div>
                                    <div class="activity-time">6 hours ago</div>
                                </div>
                            </li>
                            <li class="activity-item">
                                <div class="activity-icon">🚨</div>
                                <div class="activity-content">
                                    <div class="activity-text"><strong>Alex Kim</strong> marked Database Migration as stuck</div>
                                    <div class="activity-time">1 day ago</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Projects List Page -->
                <div id="projectslistPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Projects</h1>
                        <p class="board-subtitle">Manage all your projects in one place</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openProjectModal()">
                                <span>+</span>
                                <span>New Project</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>🔍</span>
                                <span>Filter</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📤</span>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <div id="projectsGrid" class="projects-grid">
                        <!-- Projects will be rendered here dynamically -->
                    </div>
                </div>

                <!-- Tasks Page -->
                <div id="tasksPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Task Management</h1>
                        <p class="board-subtitle">Manage your team's tasks and deliverables</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openModal()">
                                <span>+</span>
                                <span>New Task</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>🔍</span>
                                <span>Filter</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📤</span>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-cell">#</div>
                            <div class="table-cell">Task Name</div>
                            <div class="table-cell">Status</div>
                            <div class="table-cell">Priority</div>
                            <div class="table-cell">Assigned To</div>
                            <div class="table-cell">Project</div>
                            <div class="table-cell">Due Date</div>
                            <div class="table-cell">Timeline</div>
                            <div class="table-cell">Actions</div>
                        </div>
                        <div id="tableBody"></div>
                        <div class="add-row" onclick="openModal()">
                            <span>+</span>
                            <span>Add new task</span>
                        </div>
                    </div>
                </div>

                <!-- Team Page -->
                <div id="teamPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Team Members</h1>
                        <p class="board-subtitle">Collaborate with your amazing team</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openMemberModal()">
                                <span>+</span>
                                <span>Add Member</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📊</span>
                                <span>Team Report</span>
                            </button>
                        </div>
                    </div>

                    <div class="team-grid">
                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #667eea, #764ba2);">SL</div>
                            <div class="team-name">Sarah Lee</div>
                            <div class="team-role">Project Manager</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">12</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">8</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #f093fb, #f5576c);">MC</div>
                            <div class="team-name">Mike Chen</div>
                            <div class="team-role">Lead Developer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">15</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">10</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">ER</div>
                            <div class="team-name">Emily Rose</div>
                            <div class="team-role">Marketing Lead</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">9</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">7</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">AK</div>
                            <div class="team-name">Alex Kim</div>
                            <div class="team-role">Database Admin</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">11</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">6</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #fa709a, #fee140);">JP</div>
                            <div class="team-name">Jordan Park</div>
                            <div class="team-role">UI/UX Designer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">10</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">8</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #ffecd2, #fcb69f);">TW</div>
                            <div class="team-name">Taylor Wong</div>
                            <div class="team-role">Backend Developer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">13</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">9</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reportsPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Reports & Analytics</h1>
                        <p class="board-subtitle">Insights into your team's performance</p>
                        <div class="board-actions">
                            <button class="btn btn-secondary">
                                <span>📊</span>
                                <span>Export Report</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📅</span>
                                <span>Date Range</span>
                            </button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Key Metrics</h3>
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">87%</div>
                                <div class="stat-label">Completion Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">Tasks Completed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">3.2</div>
                                <div class="stat-label">Avg. Days/Task</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #e44258;">4</div>
                                <div class="stat-label">Overdue Tasks</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Team Performance</h3>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Sarah Lee - Project Manager</span>
                                <span class="progress-percentage">92%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 92%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Mike Chen - Lead Developer</span>
                                <span class="progress-percentage">85%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 85%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Emily Rose - Marketing Lead</span>
                                <span class="progress-percentage">95%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 95%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Alex Kim - Database Admin</span>
                                <span class="progress-percentage">68%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 68%; background: #fdab3d;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Initialize Data Button -->
        <button class="init-data-btn" id="initDataBtn" onclick="initializeAllSampleData()">
            <span id="initBtnIcon">📦</span>
            <span id="initBtnText">Initialize Sample Data</span>
        </button>
    </div>

    <!-- Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Create New Task</h2>
            </div>
            <form id="taskForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-input" id="itemName" placeholder="Enter task name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="itemStatus">
                            <option value="blank">Not Started</option>
                            <option value="working">Working on it</option>
                            <option value="stuck">Stuck</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="itemPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign To <span style="color: #e44258;">*</span></label>
                        <select class="form-select" id="itemPerson" required>
                            <option value="" disabled selected>Select team member...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project</label>
                        <select class="form-select" id="itemProject">
                            <option value="">No Project</option>
                            <option value="Website Redesign">Website Redesign</option>
                            <option value="Mobile App Development">Mobile App Development</option>
                            <option value="Marketing Campaign Q4">Marketing Campaign Q4</option>
                            <option value="Database Infrastructure">Database Infrastructure</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-input" id="itemDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Timeline</label>
                        <input type="text" class="form-input" id="itemTimeline" placeholder="e.g., 2 weeks" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Member Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="memberModalTitle">Add Team Member</h2>
            </div>
            <form id="memberForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="memberName" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="memberEmail" placeholder="email@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" id="memberRole" placeholder="e.g., Project Manager" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="memberDepartment" required>
                            <option value="">Select department...</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Development">Development</option>
                            <option value="Design">Design</option>
                            <option value="Quality">Quality</option>
                            <option value="Security">Security</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Avatar (2 letters)</label>
                        <input type="text" class="form-input" id="memberAvatar" placeholder="e.g., SL" maxlength="2" pattern="[A-Za-z]{2}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="memberStatus" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Skills (comma separated)</label>
                        <input type="text" class="form-input" id="memberSkills" placeholder="e.g., javascript, react, node.js">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projectModalTitle">Create New Project</h2>
            </div>
            <form id="projectForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" id="projectName" placeholder="Enter project name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="projectDescription" placeholder="Project description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="projectStatus">
                            <option value="planned">Planned</option>
                            <option value="in-progress" selected>In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="projectPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-input" id="projectStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" id="projectEndDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Progress (%)</label>
                        <input type="number" class="form-input" id="projectProgress" min="0" max="100" value="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget (฿)</label>
                        <input type="number" class="form-input" id="projectBudget" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team Members <span style="color: #e44258;">*</span></label>
                        <select class="form-select" id="projectTeamMembers" multiple size="5" required>
                            <option value="" disabled>Loading team members...</option>
                        </select>
                        <small style="color: #676879; font-size: 12px; margin-top: 4px; display: block;">Hold Ctrl/Cmd to select multiple members (at least one required)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-input" id="projectTags" placeholder="e.g., frontend, urgent">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="projectSubmitBtn">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA2My_zhJEfE_wfQ9wpu4W7o_cLKOI9PLQ",
            authDomain: "project-status-f7de8.firebaseapp.com",
            projectId: "project-status-f7de8",
            storageBucket: "project-status-f7de8.firebasestorage.app",
            messagingSenderId: "809576699201",
            appId: "1:809576699201:web:554f6cbf54200d08b6fdc0",
            measurementId: "G-61Z0HS88LR"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("✅ Firebase initialized successfully!");
        } catch (error) {
            console.error("❌ Firebase initialization error:", error);
        }

        // ========================================
        // FIRESTORE FUNCTIONS
        // ========================================

        // Render team members in the UI
        function renderTeamMembers(members) {
            const teamGrid = document.querySelector('.team-grid');
            if (!teamGrid) return;
            
            const gradients = [
                'linear-gradient(135deg, #667eea, #764ba2)',
                'linear-gradient(135deg, #f093fb, #f5576c)',
                'linear-gradient(135deg, #4facfe, #00f2fe)',
                'linear-gradient(135deg, #43e97b, #38f9d7)',
                'linear-gradient(135deg, #fa709a, #fee140)',
                'linear-gradient(135deg, #ffecd2, #fcb69f)',
                'linear-gradient(135deg, #a1c4fd, #c2e9fb)',
                'linear-gradient(135deg, #d299c2, #fef9d7)'
            ];
            
            teamGrid.innerHTML = members.map((member, index) => `
                <div class="team-card" data-member-id="${member.id}">
                    <button class="team-edit-btn" data-action="edit-member" data-member-index="${index}" title="Edit member">
                        ✏️
                    </button>
                    <div class="team-avatar-large" style="background: ${gradients[index % gradients.length]};">
                        ${member.avatar || member.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div class="team-name">${member.name}</div>
                    <div class="team-role">${member.role}</div>
                    <div class="team-status ${member.status === 'Active' ? 'active' : 'inactive'}">
                        ${member.status || 'Active'}
                    </div>
                    <div class="team-stats">
                        <div class="team-stat">
                            <div class="team-stat-value">${member.tasksCount || 0}</div>
                            <div class="team-stat-label">Tasks</div>
                        </div>
                        <div class="team-stat">
                            <div class="team-stat-value">${member.doneCount || 0}</div>
                            <div class="team-stat-label">Done</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners to edit buttons
            document.querySelectorAll('[data-action="edit-member"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-member-index'));
                    editMember(members[index], index);
                });
            });
        }

        // Store current members for editing
        let currentTeamMembers = [];

        // Load team members with real task counts
        async function loadTeamMembersWithStats() {
            if (!db) return;

            try {
                const membersSnapshot = await db.collection('team_members').get();
                const tasksSnapshot = await db.collection('tasks').get();
                
                const teamMembers = [];
                
                for (const memberDoc of membersSnapshot.docs) {
                    const memberData = memberDoc.data();
                    const memberId = memberDoc.id;
                    
                    // Count tasks for this member by ID
                    let totalTasks = 0;
                    let doneTasks = 0;
                    
                    tasksSnapshot.forEach(taskDoc => {
                        const task = taskDoc.data();
                        // Check both assignedTo (ID) and person (name) for backwards compatibility
                        if (task.assignedTo === memberId || task.person === memberData.name) {
                            totalTasks++;
                            if (task.status === 'done') {
                                doneTasks++;
                            }
                        }
                    });
                    
                    teamMembers.push({
                        id: memberDoc.id,
                        ...memberData,
                        tasksCount: totalTasks,
                        doneCount: doneTasks
                    });
                }
                
                currentTeamMembers = teamMembers;
                renderTeamMembers(teamMembers);
                console.log(`✅ Loaded ${teamMembers.length} team members with real task counts`);
                
            } catch (error) {
                console.error("❌ Error loading team members:", error);
            }
        }

        // Load active team members for dropdown
        async function loadActiveTeamMembers() {
            if (!db) {
                console.error("❌ Firebase not initialized");
                return [];
            }

            try {
                // First, try to get all team members (more reliable)
                const snapshot = await db.collection('team_members').get();

                console.log(`📊 Found ${snapshot.size} total team members in database`);

                const activeMembers = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`👤 Member: ${data.name}, active: ${data.active}, status: ${data.status}`);

                    // Include member if:
                    // 1. active field is explicitly true, OR
                    // 2. status field is 'Active', OR
                    // 3. neither field exists (assume active by default)
                    const isActive = data.active === true ||
                                   data.status === 'Active' ||
                                   (data.active === undefined && data.status === undefined);

                    if (isActive && data.name) {
                        activeMembers.push({
                            id: doc.id,
                            name: data.name
                        });
                    }
                });

                // Sort alphabetically by name
                activeMembers.sort((a, b) => a.name.localeCompare(b.name));

                console.log(`✅ Loaded ${activeMembers.length} active team members for dropdown`);
                return activeMembers;

            } catch (error) {
                console.error("❌ Error loading team members:", error);
                return [];
            }
        }

        // Get member name by ID
        async function getMemberNameById(memberId) {
            if (!db || !memberId) return 'Unknown';
            
            try {
                const doc = await db.collection('team_members').doc(memberId).get();
                if (doc.exists) {
                    return doc.data().name;
                }
                return 'Unknown';
            } catch (error) {
                console.error("❌ Error getting member name:", error);
                return 'Unknown';
            }
        }

        // Populate assign to dropdown
        async function populateAssignToDropdown() {
            console.log('🔄 populateAssignToDropdown() called');

            const personSelect = document.getElementById('itemPerson');
            if (!personSelect) {
                console.error('❌ itemPerson select element not found!');
                return;
            }

            console.log('✅ Found itemPerson select element');

            // Show loading state
            personSelect.innerHTML = '<option value="" disabled selected>Loading active members...</option>';
            console.log('⏳ Loading state set, calling loadActiveTeamMembers()...');

            // Get active members with IDs
            const activeMembers = await loadActiveTeamMembers();
            console.log('📦 Received activeMembers array:', activeMembers);

            if (activeMembers.length === 0) {
                personSelect.innerHTML = '<option value="" disabled selected>No team members found</option>';
                console.warn("⚠️ No active team members found in database");

                // Provide helpful guidance
                const shouldInit = confirm(
                    '⚠️ No team members found!\n\n' +
                    'You need to add team members before creating tasks.\n\n' +
                    'Options:\n' +
                    '1. Click "OK" to initialize sample data (includes sample team members)\n' +
                    '2. Click "Cancel" to manually add team members via the Team page\n\n' +
                    'Initialize sample data now?'
                );

                if (shouldInit) {
                    // Close the task modal
                    closeModal();
                    // Initialize sample data
                    await initializeAllSampleData();
                } else {
                    // Close task modal and navigate to team page
                    closeModal();
                    navigateTo('team');
                }
                return;
            }

            // Clear current options and add placeholder
            personSelect.innerHTML = '<option value="" disabled selected>Select team member...</option>';

            // Add active members with ID as value
            activeMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;  // Store member ID
                option.textContent = member.name;  // Show member name
                option.setAttribute('data-member-name', member.name);
                personSelect.appendChild(option);
            });

            console.log(`✅ Populated dropdown with ${activeMembers.length} active members`);
        }

        // Populate project dropdown for task form
        async function populateTaskProjectDropdown() {
            console.log('🔄 populateTaskProjectDropdown() called');
            const projectSelect = document.getElementById('itemProject');

            if (!projectSelect) {
                console.error('❌ itemProject select element not found!');
                return;
            }

            // Show loading state
            projectSelect.innerHTML = '<option value="">Loading projects...</option>';

            if (!db) {
                console.error('❌ Firebase not initialized');
                projectSelect.innerHTML = '<option value="">No Project</option>';
                return;
            }

            try {
                const snapshot = await db.collection('projects').get();
                console.log(`📦 Found ${snapshot.size} projects in database`);

                // Clear and add default option
                projectSelect.innerHTML = '<option value="">No Project</option>';

                if (snapshot.empty) {
                    console.warn('⚠️ No projects found in database');
                    return;
                }

                // Add projects to dropdown
                let addedCount = 0;
                snapshot.forEach(doc => {
                    const project = doc.data();
                    if (project.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;  // Store project ID
                        option.textContent = project.name;  // Show project name
                        option.setAttribute('data-project-name', project.name);
                        projectSelect.appendChild(option);
                        addedCount++;
                        console.log(`📁 Added project: ${project.name}`);
                    }
                });

                console.log(`✅ Populated project dropdown with ${addedCount} projects`);

            } catch (error) {
                console.error('❌ Error loading projects for dropdown:', error);
                projectSelect.innerHTML = '<option value="">No Project</option>';
            }
        }

        // Get project name by ID
        async function getProjectNameById(projectId) {
            if (!db || !projectId) return '';

            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    return doc.data().name;
                }
                return '';
            } catch (error) {
                console.error('❌ Error getting project name:', error);
                return '';
            }
        }

        // Initialize ALL sample data (tasks, team members, workspaces, projects)
        async function initializeAllSampleData() {
            if (!db) {
                alert("❌ Firebase is not connected. Please check your configuration.");
                return;
            }

            const btn = document.getElementById('initDataBtn');
            const btnIcon = document.getElementById('initBtnIcon');
            const btnText = document.getElementById('initBtnText');
            
            // Show loading state
            btn.classList.add('loading');
            btnIcon.textContent = '⏳';
            btnText.textContent = 'Initializing...';

            try {
                // Check if data already exists
                const tasksSnapshot = await db.collection('tasks').limit(1).get();
                const membersSnapshot = await db.collection('team_members').limit(1).get();
                const workspacesSnapshot = await db.collection('workspaces').limit(1).get();
                const projectsSnapshot = await db.collection('projects').limit(1).get();

                let addedCount = 0;

                // ========== TASKS ==========
                if (tasksSnapshot.empty) {
                    console.log("📦 Adding sample tasks...");
                    const sampleTasks = [
                        { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', project: 'Website Redesign', date: '2025-11-15', timeline: '3 weeks', workspace: 'Marketing', category: 'Design', tags: ['design', 'frontend', 'urgent'] },
                        { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', project: 'Mobile App Development', date: '2025-12-01', timeline: '6 weeks', workspace: 'Development', category: 'Development', tags: ['mobile', 'ios', 'android'] },
                        { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', project: 'Marketing Campaign Q4', date: '2025-10-20', timeline: '2 weeks', workspace: 'Marketing', category: 'Marketing', tags: ['campaign', 'social-media'] },
                        { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', project: 'Database Infrastructure', date: '2025-11-30', timeline: '4 weeks', workspace: 'Development', category: 'Backend', tags: ['database', 'backend', 'critical'] },
                        { name: 'Customer Portal', status: 'working', priority: 'medium', person: 'Jordan Park', project: 'Website Redesign', date: '2025-11-25', timeline: '5 weeks', workspace: 'Development', category: 'Frontend', tags: ['portal', 'customer', 'dashboard'] },
                        { name: 'API Integration', status: 'blank', priority: 'low', person: 'Taylor Wong', project: 'Mobile App Development', date: '2025-12-15', timeline: '3 weeks', workspace: 'Development', category: 'Backend', tags: ['api', 'integration'] },
                        { name: 'User Testing', status: 'working', priority: 'medium', person: 'Chris Davis', project: 'Website Redesign', date: '2025-11-10', timeline: '1 week', workspace: 'Design', category: 'QA', tags: ['testing', 'ux', 'feedback'] },
                        { name: 'Security Audit', status: 'done', priority: 'high', person: 'Morgan Lee', project: 'Database Infrastructure', date: '2025-10-15', timeline: '2 weeks', workspace: 'Development', category: 'Security', tags: ['security', 'audit', 'compliance'] }
                    ];

                    for (const task of sampleTasks) {
                        await db.collection('tasks').add({
                            ...task,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleTasks.length} tasks`);
                }

                // ========== TEAM MEMBERS ==========
                if (membersSnapshot.empty) {
                    console.log("📦 Adding team members...");
                    const sampleMembers = [
                        { name: 'Sarah Lee', email: 'sarah.lee@company.com', role: 'Project Manager', department: 'Marketing', avatar: 'SL', status: 'Active', active: true, skills: ['management', 'planning', 'coordination'] },
                        { name: 'Mike Chen', email: 'mike.chen@company.com', role: 'Lead Developer', department: 'Development', avatar: 'MC', status: 'Active', active: true, skills: ['javascript', 'react', 'node.js'] },
                        { name: 'Emily Rose', email: 'emily.rose@company.com', role: 'Marketing Lead', department: 'Marketing', avatar: 'ER', status: 'Active', active: true, skills: ['marketing', 'analytics', 'content'] },
                        { name: 'Alex Kim', email: 'alex.kim@company.com', role: 'Database Administrator', department: 'Development', avatar: 'AK', status: 'Active', active: true, skills: ['sql', 'postgresql', 'mongodb'] },
                        { name: 'Jordan Park', email: 'jordan.park@company.com', role: 'UI/UX Designer', department: 'Design', avatar: 'JP', status: 'Active', active: true, skills: ['figma', 'sketch', 'prototyping'] },
                        { name: 'Taylor Wong', email: 'taylor.wong@company.com', role: 'Backend Developer', department: 'Development', avatar: 'TW', status: 'Active', active: true, skills: ['python', 'django', 'api'] },
                        { name: 'Chris Davis', email: 'chris.davis@company.com', role: 'QA Engineer', department: 'Quality', avatar: 'CD', status: 'Active', active: true, skills: ['testing', 'automation', 'selenium'] },
                        { name: 'Morgan Lee', email: 'morgan.lee@company.com', role: 'Security Analyst', department: 'Security', avatar: 'ML', status: 'Inactive', active: false, skills: ['security', 'penetration-testing', 'compliance'] }
                    ];

                    for (const member of sampleMembers) {
                        await db.collection('team_members').add({
                            ...member,
                            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleMembers.length} team members`);
                }

                // ========== WORKSPACES ==========
                if (workspacesSnapshot.empty) {
                    console.log("📦 Adding workspaces...");
                    const sampleWorkspaces = [
                        { name: 'Marketing', icon: '🎯', color: '#667eea', description: 'Marketing team workspace', memberCount: 3, taskCount: 5, active: true },
                        { name: 'Development', icon: '💻', color: '#764ba2', description: 'Development team workspace', memberCount: 5, taskCount: 8, active: true },
                        { name: 'Design', icon: '🎨', color: '#f093fb', description: 'Design team workspace', memberCount: 2, taskCount: 4, active: true },
                        { name: 'Mobile', icon: '📱', color: '#4facfe', description: 'Mobile app development workspace', memberCount: 4, taskCount: 6, active: true }
                    ];

                    for (const workspace of sampleWorkspaces) {
                        await db.collection('workspaces').add({
                            ...workspace,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleWorkspaces.length} workspaces`);
                }

                // ========== PROJECTS ==========
                if (projectsSnapshot.empty) {
                    console.log("📦 Adding projects...");
                    const sampleProjects = [
                        { name: 'Website Redesign', description: 'Complete redesign of company website', status: 'in-progress', priority: 'high', workspace: 'Marketing', startDate: '2025-10-01', endDate: '2025-11-30', progress: 75, budget: 50000, teamMembers: ['Sarah Lee', 'Jordan Park'], tags: ['website', 'design', 'frontend'] },
                        { name: 'Mobile App Development', description: 'iOS and Android app development', status: 'in-progress', priority: 'high', workspace: 'Development', startDate: '2025-09-15', endDate: '2025-12-31', progress: 60, budget: 120000, teamMembers: ['Mike Chen', 'Taylor Wong'], tags: ['mobile', 'app', 'ios', 'android'] },
                        { name: 'Marketing Campaign Q4', description: 'Q4 2025 marketing campaign', status: 'completed', priority: 'medium', workspace: 'Marketing', startDate: '2025-09-01', endDate: '2025-10-20', progress: 100, budget: 30000, teamMembers: ['Emily Rose'], tags: ['campaign', 'marketing', 'q4'] },
                        { name: 'Database Infrastructure', description: 'Database migration and optimization', status: 'in-progress', priority: 'high', workspace: 'Development', startDate: '2025-10-15', endDate: '2025-12-15', progress: 30, budget: 80000, teamMembers: ['Alex Kim', 'Taylor Wong'], tags: ['database', 'infrastructure', 'migration'] }
                    ];

                    for (const project of sampleProjects) {
                        await db.collection('projects').add({
                            ...project,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleProjects.length} projects`);
                }

                // Success feedback
                if (addedCount > 0) {
                    btnIcon.textContent = '✅';
                    btnText.textContent = `Added ${addedCount} items!`;
                    btn.classList.remove('loading');
                    btn.classList.add('success');
                    
                    // Reload data
                    await loadTasksFromFirebase();
                    
                    alert(`✅ Successfully initialized!\n\n📊 Added ${addedCount} items to Firebase:\n- Tasks\n- Team Members\n- Workspaces\n- Projects\n\nCheck Firebase Console to see all your data!`);
                    
                    // Hide button after 3 seconds
                    setTimeout(() => {
                        btn.style.display = 'none';
                    }, 3000);
                } else {
                    btnIcon.textContent = 'ℹ️';
                    btnText.textContent = 'Data Already Exists';
                    btn.classList.remove('loading');
                    
                    alert('ℹ️ Sample data already exists in Firebase.\n\nAll collections are populated. Check Firebase Console to view your data.');
                    
                    setTimeout(() => {
                        btnIcon.textContent = '📦';
                        btnText.textContent = 'Initialize Sample Data';
                    }, 3000);
                }

            } catch (error) {
                console.error("❌ Error initializing data:", error);
                btnIcon.textContent = '❌';
                btnText.textContent = 'Error!';
                btn.classList.remove('loading');
                
                alert(`❌ Error initializing data:\n\n${error.message}\n\nCheck console for details.`);
                
                setTimeout(() => {
                    btnIcon.textContent = '📦';
                    btnText.textContent = 'Initialize Sample Data';
                    btn.classList.remove('success');
                }, 3000);
            }
        }

        // Initialize sample data in Firebase (run once) - LEGACY FUNCTION
        async function initializeSampleData() {
            if (!db) return;

            const sampleTasks = [
                { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', date: '2025-11-15', timeline: '3 weeks', workspace: 'Marketing' },
                { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', date: '2025-12-01', timeline: '6 weeks', workspace: 'Development' },
                { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', date: '2025-10-20', timeline: '2 weeks', workspace: 'Marketing' },
                { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', date: '2025-11-30', timeline: '4 weeks', workspace: 'Development' }
            ];

            try {
                // Check if tasks already exist
                const snapshot = await db.collection('tasks').limit(1).get();
                
                if (snapshot.empty) {
                    console.log("📦 Initializing sample data...");
                    
                    for (const task of sampleTasks) {
                        await db.collection('tasks').add({
                            ...task,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    console.log("✅ Sample data initialized!");
                } else {
                    console.log("ℹ️ Data already exists in Firebase");
                }
            } catch (error) {
                console.error("❌ Error initializing data:", error);
            }
        }

        // Prevent concurrent loading
        let isLoadingTasks = false;

        // Load all tasks from Firestore
        async function loadTasksFromFirebase() {
            if (!db) {
                console.warn("Firebase not initialized, using local data");
                return;
            }

            // Prevent concurrent loading
            if (isLoadingTasks) {
                console.log("⏭️ Task loading already in progress, skipping...");
                return;
            }

            isLoadingTasks = true;
            console.log("📥 Loading tasks from Firebase...");

            try {
                const snapshot = await db.collection('tasks').orderBy('createdAt', 'desc').get();

                // Clear tasks array to prevent duplicates
                tasks = [];

                for (const doc of snapshot.docs) {
                    const taskData = doc.data();

                    // Get member name if assignedTo is an ID
                    let personName = taskData.person;
                    if (taskData.assignedTo) {
                        personName = await getMemberNameById(taskData.assignedTo);
                    }

                    // Get REAL-TIME project name if projectId exists
                    let projectName = taskData.project || '';
                    if (taskData.projectId) {
                        const realtimeProjectName = await getProjectNameById(taskData.projectId);
                        if (realtimeProjectName) {
                            projectName = realtimeProjectName;
                            console.log(`🔄 Updated task "${taskData.name}" with real-time project: ${projectName}`);
                        }
                    }

                    tasks.push({
                        id: doc.id,
                        ...taskData,
                        personName: personName,      // Store display name
                        project: projectName         // Store real-time project name
                    });
                }

                renderTasks();
                updateDashboardStats();
                console.log(`✅ Loaded ${tasks.length} tasks from Firebase`);
            } catch (error) {
                console.error("❌ Error loading tasks:", error);
            } finally {
                isLoadingTasks = false;
            }
        }

        // Add task to Firestore
        async function addTaskToFirebase(task) {
            if (!db) return;

            try {
                const docRef = await db.collection('tasks').add({
                    ...task,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log("✅ Task added with ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("❌ Error adding task:", error);
            }
        }

        // Update task in Firestore
        async function updateTaskInFirebase(taskId, taskData) {
            if (!db) return;

            try {
                await db.collection('tasks').doc(taskId).update({
                    ...taskData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log("✅ Task updated:", taskId);
            } catch (error) {
                console.error("❌ Error updating task:", error);
            }
        }

        // Delete task from Firestore
        async function deleteTaskFromFirebase(taskId) {
            if (!db) return;

            try {
                await db.collection('tasks').doc(taskId).delete();
                console.log("✅ Task deleted:", taskId);
            } catch (error) {
                console.error("❌ Error deleting task:", error);
            }
        }

        // Real-time listener for tasks
        let realtimeListenerUnsubscribe = null;

        function setupRealtimeListener() {
            if (!db) return;

            // Prevent setting up multiple listeners
            if (realtimeListenerUnsubscribe) {
                console.log("⏭️ Real-time listener already set up, skipping...");
                return;
            }

            console.log("📡 Setting up real-time listener...");
            realtimeListenerUnsubscribe = db.collection('tasks').onSnapshot(async (snapshot) => {
                // Skip if we're in the middle of a manual operation
                if (isManualOperation) {
                    console.log("⏭️ Skipping real-time update (manual operation in progress)");
                    return;
                }

                const changes = snapshot.docChanges();
                if (changes.length > 0) {
                    console.log("📡 Real-time update detected, reloading tasks...");
                    await loadTasksFromFirebase();

                    // Reload team members if on team page
                    const teamPage = document.getElementById('teamPage');
                    if (teamPage && teamPage.classList.contains('active')) {
                        await loadTeamMembersWithStats();
                    }
                }
            });
        }

        // ========================================
        // APPLICATION CODE
        // ========================================

        let tasks = [
            { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', date: '2025-11-15', timeline: '3 weeks' },
            { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', date: '2025-12-01', timeline: '6 weeks' },
            { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', date: '2025-10-20', timeline: '2 weeks' },
            { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', date: '2025-11-30', timeline: '4 weeks' },
            { name: 'Customer Portal', status: 'working', priority: 'medium', person: 'Jordan Park', date: '2025-11-25', timeline: '5 weeks' },
            { name: 'API Integration', status: 'blank', priority: 'low', person: 'Taylor Wong', date: '2025-12-15', timeline: '3 weeks' },
            { name: 'User Testing', status: 'working', priority: 'medium', person: 'Chris Davis', date: '2025-11-10', timeline: '1 week' },
            { name: 'Security Audit', status: 'done', priority: 'high', person: 'Morgan Lee', date: '2025-10-15', timeline: '2 weeks' }
        ];

        let projects = [
            {
                name: 'Website Redesign',
                description: 'Complete overhaul of company website with modern design',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-10-01',
                endDate: '2025-12-31',
                progress: 75,
                budget: 50000,
                teamMembers: ['Sarah Lee', 'Mike Chen'],
                tags: ['design', 'frontend', 'urgent']
            },
            {
                name: 'Mobile App Development',
                description: 'Build native mobile app for iOS and Android',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-09-15',
                endDate: '2025-12-15',
                progress: 60,
                budget: 120000,
                teamMembers: ['Mike Chen', 'Taylor Wong'],
                tags: ['mobile', 'development']
            },
            {
                name: 'Marketing Campaign Q4',
                description: 'Q4 marketing initiatives and social media campaigns',
                status: 'completed',
                priority: 'medium',
                startDate: '2025-10-01',
                endDate: '2025-10-31',
                progress: 100,
                budget: 30000,
                teamMembers: ['Emily Rose'],
                tags: ['marketing', 'social-media']
            },
            {
                name: 'Database Infrastructure',
                description: 'Database migration and optimization project',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-10-15',
                endDate: '2025-12-15',
                progress: 30,
                budget: 80000,
                teamMembers: ['Alex Kim', 'Taylor Wong'],
                tags: ['database', 'infrastructure', 'backend']
            }
        ];

        let editingIndex = -1;
        let editingProjectIndex = -1;
        let isManualOperation = false;  // Flag to prevent listener conflicts

        function toggleSection(sectionName) {
            const section = event.currentTarget.closest('.sidebar-section');
            const arrow = document.getElementById(sectionName + 'Arrow');
            
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                arrow.textContent = '▶';
            } else {
                arrow.textContent = '▼';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('collapseIcon');
            sidebar.classList.toggle('collapsed');
            icon.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
        }

        function switchPage(pageName) {
            const pages = ['dashboard', 'projectslist', 'tasks', 'team', 'reports'];
            pages.forEach(p => {
                const page = document.getElementById(p + 'Page');
                if (page) page.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageName + 'Page');
            if (targetPage) targetPage.classList.add('active');

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Reload data when switching to specific pages
            if (pageName === 'tasks' && db) {
                loadTasksFromFirebase();
            } else if (pageName === 'team' && db) {
                loadTeamMembersWithStats();
            } else if (pageName === 'dashboard') {
                updateDashboardStats();
            } else if (pageName === 'projectslist') {
                if (db) {
                    loadProjectsFromFirebase();
                } else {
                    renderProjects();
                }
            }
        }

        function updateDashboardStats() {
            document.getElementById('totalItems').textContent = tasks.length;
            document.getElementById('workingItems').textContent = tasks.filter(t => t.status === 'working').length;
            document.getElementById('doneItems').textContent = tasks.filter(t => t.status === 'done').length;
            document.getElementById('stuckItems').textContent = tasks.filter(t => t.status === 'stuck').length;
        }

        function getStatusText(status) {
            const statusMap = {
                'working': 'Working on it',
                'done': 'Done',
                'stuck': 'Stuck',
                'blank': 'Not Started'
            };
            return statusMap[status] || status;
        }

        function renderTasks() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = tasks.map((task, index) => {
                const displayName = task.personName || task.person || 'Unknown';
                const avatarText = displayName.split(' ').map(n => n[0]).join('');

                return `
                <div class="table-row" data-index="${index}">
                    <div class="table-cell" data-label="#">
                        <span class="row-number">${index + 1}</span>
                    </div>
                    <div class="table-cell" data-label="Task">
                        <span class="task-name">${task.name}</span>
                    </div>
                    <div class="table-cell" data-label="Status">
                        <div class="status-badge status-${task.status}">
                            ${getStatusText(task.status)}
                        </div>
                    </div>
                    <div class="table-cell" data-label="Priority">
                        <div class="priority">
                            <span class="priority-dot priority-${task.priority}"></span>
                            <span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Assigned To">
                        <div class="person-cell">
                            <div class="person-avatar">${avatarText}</div>
                            <span>${displayName}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Project">
                        ${task.project ? `<span class="project-badge">${task.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                    </div>
                    <div class="table-cell" data-label="Date">
                        <span class="date-cell">${task.date}</span>
                    </div>
                    <div class="table-cell" data-label="Timeline">
                        <span class="date-cell">${task.timeline}</span>
                    </div>
                    <div class="table-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-action="edit" data-index="${index}" title="Edit task">
                                ✏️
                            </button>
                            <button class="action-btn clone-btn" data-action="clone" data-index="${index}" title="Clone task">
                                📋
                            </button>
                            <button class="action-btn delete-btn" data-action="delete" data-index="${index}" title="Delete task">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Add event listeners to action buttons
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (action === 'edit') {
                        editTask(index);
                    } else if (action === 'clone') {
                        cloneTask(index);
                    } else if (action === 'delete') {
                        deleteTask(index);
                    }
                });
            });
        }

        async function deleteTask(index) {
            if (confirm('Are you sure you want to delete this task?')) {
                // Set flag to prevent real-time listener interference
                isManualOperation = true;
                
                const task = tasks[index];
                
                try {
                    // Delete from Firebase if task has an ID
                    if (task.id && db) {
                        await deleteTaskFromFirebase(task.id);
                        console.log("✅ Task deleted from Firebase:", task.id);
                    }
                    
                    // Reload tasks from Firebase to prevent duplicates
                    await loadTasksFromFirebase();
                    
                    // Re-enable real-time listener after a short delay
                    setTimeout(() => {
                        isManualOperation = false;
                        console.log("✅ Real-time listener re-enabled");
                    }, 1000);
                    
                } catch (error) {
                    console.error("❌ Error deleting task:", error);
                    alert('❌ Error deleting task: ' + error.message);
                    isManualOperation = false;  // Reset flag on error
                }
            }
        }

        function editTask(index) {
            editingIndex = index;
            const task = tasks[index];

            // Update modal title
            document.getElementById('modalTitle').textContent = 'Edit Task';

            // Populate both dropdowns first, then fill in task data
            Promise.all([
                populateAssignToDropdown(),
                populateTaskProjectDropdown()
            ]).then(() => {
                // Populate form with task data
                document.getElementById('itemName').value = task.name;
                document.getElementById('itemStatus').value = task.status;
                document.getElementById('itemPriority').value = task.priority;

                // Set the assignedTo (member ID) in dropdown
                if (task.assignedTo) {
                    document.getElementById('itemPerson').value = task.assignedTo;
                } else if (task.person) {
                    // Fallback for old data - try to find by name
                    const personSelect = document.getElementById('itemPerson');
                    const options = personSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].getAttribute('data-member-name') === task.person) {
                            personSelect.value = options[i].value;
                            break;
                        }
                    }
                }

                // Set the project (project ID) in dropdown
                if (task.projectId) {
                    // New format: uses project ID
                    document.getElementById('itemProject').value = task.projectId;
                } else if (task.project) {
                    // Old format: try to find by name
                    const projectSelect = document.getElementById('itemProject');
                    const options = projectSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].getAttribute('data-project-name') === task.project) {
                            projectSelect.value = options[i].value;
                            break;
                        }
                    }
                }

                document.getElementById('itemDate').value = task.date;
                document.getElementById('itemTimeline').value = task.timeline;
            });

            // Change button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Update Task';

            // Open modal
            document.getElementById('taskModal').classList.add('active');
        }

        async function cloneTask(index) {
            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            const task = tasks[index];

            // Create a copy of the task with a new name
            const clonedTask = {
                name: task.name + ' (Copy)',
                status: task.status,
                priority: task.priority,
                assignedTo: task.assignedTo,
                person: task.person,
                project: task.project || '',
                date: task.date,
                timeline: task.timeline
            };

            try {
                // Add cloned task to Firebase
                if (db) {
                    await addTaskToFirebase(clonedTask);
                    console.log("✅ Task cloned successfully");
                }

                // Reload tasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();

                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);

            } catch (error) {
                console.error("❌ Error cloning task:", error);
                alert('❌ Error cloning task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        }

        function openModal() {
            console.log('🚪 openModal() called');
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Create New Task';
            document.getElementById('taskForm').reset();

            // Populate dropdowns
            console.log('📞 Calling populateAssignToDropdown()...');
            populateAssignToDropdown();

            console.log('📞 Calling populateTaskProjectDropdown()...');
            populateTaskProjectDropdown();

            document.getElementById('taskModal').classList.add('active');
            console.log('✅ Modal opened');

            // Reset button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Create Task';
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskForm').reset();
            editingIndex = -1;
            
            // Reset button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Create Task';
        }

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate that a team member is selected
            const assignedToId = document.getElementById('itemPerson').value;
            if (!assignedToId || assignedToId.trim() === '') {
                alert('⚠️ Please select a team member to assign this task to.');
                document.getElementById('itemPerson').focus();
                return;
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            const personSelect = document.getElementById('itemPerson');
            const selectedOption = personSelect.options[personSelect.selectedIndex];
            const personName = selectedOption.getAttribute('data-member-name') || selectedOption.textContent;

            // Get project ID and name
            const projectSelect = document.getElementById('itemProject');
            const projectId = projectSelect.value;
            const projectOption = projectSelect.options[projectSelect.selectedIndex];
            const projectName = projectOption.getAttribute('data-project-name') || projectOption.textContent || '';

            const newTask = {
                name: document.getElementById('itemName').value,
                status: document.getElementById('itemStatus').value,
                priority: document.getElementById('itemPriority').value,
                assignedTo: assignedToId,  // Store member ID
                person: personName,  // Store name for backwards compatibility
                projectId: projectId,  // Store project ID
                project: projectName,  // Store project name for backwards compatibility and display
                date: document.getElementById('itemDate').value,
                timeline: document.getElementById('itemTimeline').value
            };

            try {
                if (editingIndex >= 0) {
                    const task = tasks[editingIndex];
                    
                    // Update in Firebase if task has an ID
                    if (task.id && db) {
                        await updateTaskInFirebase(task.id, newTask);
                        console.log("✅ Task updated in Firebase:", task.id);
                    }
                } else {
                    // Add to Firebase
                    if (db) {
                        const taskId = await addTaskToFirebase(newTask);
                        console.log("✅ Task added to Firebase:", taskId);
                    }
                }

                closeModal();
                
                // Reload tasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();
                
                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);
                
            } catch (error) {
                console.error("❌ Error saving task:", error);
                alert('❌ Error saving task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        });

        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ========================================
        // TEAM MEMBER MODAL FUNCTIONS
        // ========================================
        
        let editingMemberId = null;

        function openMemberModal() {
            editingMemberId = null;
            document.getElementById('memberModalTitle').textContent = 'Add Team Member';
            document.getElementById('memberModal').classList.add('active');
            document.getElementById('memberForm').reset();
            
            // Set default status
            document.getElementById('memberStatus').value = 'Active';
            
            // Reset button text
            const submitBtn = document.querySelector('#memberForm button[type="submit"]');
            submitBtn.textContent = 'Add Member';
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('active');
            document.getElementById('memberForm').reset();
            editingMemberId = null;
        }

        function editMember(member, index) {
            editingMemberId = member.id;
            
            // Update modal title
            document.getElementById('memberModalTitle').textContent = 'Edit Team Member';
            
            // Populate form with member data
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberEmail').value = member.email;
            document.getElementById('memberRole').value = member.role;
            document.getElementById('memberDepartment').value = member.department;
            document.getElementById('memberAvatar').value = member.avatar;
            document.getElementById('memberStatus').value = member.status || 'Active';
            document.getElementById('memberSkills').value = member.skills ? member.skills.join(', ') : '';
            
            // Change button text
            const submitBtn = document.querySelector('#memberForm button[type="submit"]');
            submitBtn.textContent = 'Update Member';
            
            // Open modal
            document.getElementById('memberModal').classList.add('active');
        }

        // Handle member form submission
        document.getElementById('memberForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const skillsInput = document.getElementById('memberSkills').value;
            const skillsArray = skillsInput ? skillsInput.split(',').map(s => s.trim()).filter(s => s) : [];
            
            const memberData = {
                name: document.getElementById('memberName').value,
                email: document.getElementById('memberEmail').value,
                role: document.getElementById('memberRole').value,
                department: document.getElementById('memberDepartment').value,
                avatar: document.getElementById('memberAvatar').value.toUpperCase(),
                status: document.getElementById('memberStatus').value,
                active: document.getElementById('memberStatus').value === 'Active',
                skills: skillsArray
            };

            try {
                if (editingMemberId) {
                    // Get old member data to check if name changed
                    const oldMemberDoc = await db.collection('team_members').doc(editingMemberId).get();
                    const oldMemberData = oldMemberDoc.data();
                    const nameChanged = oldMemberData.name !== memberData.name;
                    
                    // Update existing member
                    if (db) {
                        await db.collection('team_members').doc(editingMemberId).update({
                            ...memberData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("✅ Member updated:", editingMemberId);
                    }
                    
                    // If name changed, update all tasks assigned to this member
                    if (nameChanged && db) {
                        console.log(`📝 Name changed from "${oldMemberData.name}" to "${memberData.name}", updating tasks...`);
                        
                        const tasksSnapshot = await db.collection('tasks')
                            .where('assignedTo', '==', editingMemberId)
                            .get();
                        
                        const batch = db.batch();
                        let updateCount = 0;
                        
                        tasksSnapshot.forEach(doc => {
                            batch.update(doc.ref, {
                                person: memberData.name,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            updateCount++;
                        });
                        
                        if (updateCount > 0) {
                            await batch.commit();
                            console.log(`✅ Updated ${updateCount} tasks with new member name`);
                        }
                    }
                } else {
                    // Add new member
                    if (db) {
                        await db.collection('team_members').add({
                            ...memberData,
                            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("✅ Member added");
                    }
                }

                // Reload team members
                await loadTeamMembersWithStats();
                
                // Reload assign to dropdown if task modal is open
                if (document.getElementById('taskModal').classList.contains('active')) {
                    await populateAssignToDropdown();
                }
                
                closeMemberModal();
                
                alert(editingMemberId ? '✅ Team member updated successfully!' : '✅ Team member added successfully!');
                
            } catch (error) {
                console.error("❌ Error saving member:", error);
                alert('❌ Error saving team member: ' + error.message);
            }
        });

        document.getElementById('memberModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMemberModal();
            }
        });

        // ========================================
        // PROJECT CRUD FUNCTIONS
        // ========================================

        function renderProjects() {
            const projectsGrid = document.getElementById('projectsGrid');
            if (!projectsGrid) return;

            projectsGrid.innerHTML = projects.map((project, index) => `
                <div class="project-card">
                    <div class="project-card-header">
                        <div>
                            <div class="project-card-title">${project.name}</div>
                            <span class="project-status-badge ${project.status}">${formatStatus(project.status)}</span>
                        </div>
                    </div>
                    <div class="project-card-description">${project.description}</div>

                    <div class="project-progress">
                        <div class="project-progress-label">
                            <span>Progress</span>
                            <span>${project.progress}%</span>
                        </div>
                        <div class="project-progress-bar">
                            <div class="project-progress-fill" style="width: ${project.progress}%"></div>
                        </div>
                    </div>

                    <div class="project-card-meta">
                        <div class="project-meta-item">
                            <span class="project-meta-icon">📅</span>
                            <span>${project.startDate} - ${project.endDate}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">💰</span>
                            <span>฿${project.budget.toLocaleString()}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">👥</span>
                            <span>${project.teamMembers && project.teamMembers.length > 0 ? project.teamMembers.length + ' members' : 'No members'}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">⚡</span>
                            <span>${formatPriority(project.priority)}</span>
                        </div>
                    </div>

                    ${project.teamMembers && project.teamMembers.length > 0 ? `
                        <div class="project-team-members" style="margin-top: 12px; padding: 12px; background: #f6f7fb; border-radius: 8px;">
                            <div style="font-size: 12px; font-weight: 700; color: #676879; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Team Members</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${project.teamMembers.map(member => `
                                    <span style="background: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; color: #323338; border: 1px solid #e6e9ef;">${member}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${project.tags && project.tags.length > 0 ? `
                        <div class="project-tags">
                            ${project.tags.map(tag => `<span class="project-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}

                    <div class="project-card-actions">
                        <button class="project-action-btn" onclick="editProject(${index})">
                            ✏️ Edit
                        </button>
                        <button class="project-action-btn delete" onclick="deleteProject(${index})">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function formatStatus(status) {
            return status.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function formatPriority(priority) {
            return priority.charAt(0).toUpperCase() + priority.slice(1);
        }

        // ========================================
        // PROJECT FIREBASE FUNCTIONS
        // ========================================

        // Add project to Firebase
        async function addProjectToFirebase(projectData) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return null;
            }

            try {
                const docRef = await db.collection('projects').add({
                    ...projectData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('✅ Project added to Firebase with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('❌ Error adding project to Firebase:', error);
                throw error;
            }
        }

        // Update project in Firebase
        async function updateProjectInFirebase(projectId, projectData) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            try {
                await db.collection('projects').doc(projectId).update({
                    ...projectData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('✅ Project updated in Firebase:', projectId);
            } catch (error) {
                console.error('❌ Error updating project in Firebase:', error);
                throw error;
            }
        }

        // Delete project from Firebase
        async function deleteProjectFromFirebase(projectId) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            try {
                await db.collection('projects').doc(projectId).delete();
                console.log('✅ Project deleted from Firebase:', projectId);
            } catch (error) {
                console.error('❌ Error deleting project from Firebase:', error);
                throw error;
            }
        }

        // Load projects from Firebase
        async function loadProjectsFromFirebase() {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            try {
                const snapshot = await db.collection('projects')
                    .orderBy('createdAt', 'desc')
                    .get();

                projects = [];
                snapshot.forEach(doc => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`✅ Loaded ${projects.length} projects from Firebase`);
                renderProjects();
            } catch (error) {
                console.error('❌ Error loading projects from Firebase:', error);
                // If orderBy fails (no index), try without ordering
                try {
                    const snapshot = await db.collection('projects').get();
                    projects = [];
                    snapshot.forEach(doc => {
                        projects.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    console.log(`✅ Loaded ${projects.length} projects from Firebase (fallback)`);
                    renderProjects();
                } catch (fallbackError) {
                    console.error('❌ Fallback also failed:', fallbackError);
                }
            }
        }

        // Populate team members dropdown for project form
        async function populateProjectTeamMembersDropdown() {
            console.log('🔄 populateProjectTeamMembersDropdown() called');
            const selectElement = document.getElementById('projectTeamMembers');

            if (!db) {
                console.error('❌ Firebase not initialized');
                selectElement.innerHTML = '<option value="">Firebase not connected</option>';
                return;
            }

            try {
                // FIXED: Changed from 'teamMembers' to 'team_members' to match the actual collection name
                console.log('📊 Loading from team_members collection...');
                const membersSnapshot = await db.collection('team_members').get();

                console.log(`📦 Found ${membersSnapshot.size} team members`);

                if (membersSnapshot.empty) {
                    console.warn('⚠️ No team members found in database');
                    selectElement.innerHTML = '<option value="">No team members found</option>';

                    const shouldInit = confirm(
                        '⚠️ No team members found!\n\n' +
                        'You need to add team members before creating projects.\n\n' +
                        'Options:\n' +
                        '1. Click "OK" to initialize sample data\n' +
                        '2. Click "Cancel" to add team members manually\n\n' +
                        'Initialize sample data now?'
                    );

                    if (shouldInit) {
                        closeProjectModal();
                        await initializeAllSampleData();
                    } else {
                        closeProjectModal();
                        navigateTo('team');
                    }
                    return;
                }

                selectElement.innerHTML = '';
                let loadedCount = 0;
                membersSnapshot.forEach(doc => {
                    const member = doc.data();

                    // Only show active members
                    const isActive = member.active === true ||
                                   member.status === 'Active' ||
                                   (member.active === undefined && member.status === undefined);

                    if (isActive && member.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.setAttribute('data-member-name', member.name);
                        option.textContent = `${member.name} - ${member.role || 'Team Member'}`;
                        selectElement.appendChild(option);
                        loadedCount++;
                        console.log(`👤 Added: ${member.name} (${member.role || 'N/A'})`);
                    }
                });

                console.log(`✅ Populated project dropdown with ${loadedCount} active team members`);

                if (loadedCount === 0) {
                    selectElement.innerHTML = '<option value="">No active team members</option>';
                    console.warn('⚠️ All team members are inactive');
                }

            } catch (error) {
                console.error('❌ Error loading team members:', error);
                selectElement.innerHTML = '<option value="">Error loading members</option>';
            }
        }

        function openProjectModal() {
            console.log('🚪 openProjectModal() called');
            editingProjectIndex = -1;
            document.getElementById('projectModalTitle').textContent = 'Create New Project';
            document.getElementById('projectSubmitBtn').textContent = 'Create Project';
            document.getElementById('projectForm').reset();

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectStartDate').value = today;

            // Populate team members dropdown
            console.log('📞 Calling populateProjectTeamMembersDropdown()...');
            populateProjectTeamMembersDropdown();

            document.getElementById('projectModal').classList.add('active');
            console.log('✅ Project modal opened');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('active');
            document.getElementById('projectForm').reset();
            editingProjectIndex = -1;
        }

        function editProject(index) {
            editingProjectIndex = index;
            const project = projects[index];

            // Update modal title and button
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectSubmitBtn').textContent = 'Update Project';

            // Populate form with project data
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDescription').value = project.description;
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectPriority').value = project.priority;
            document.getElementById('projectStartDate').value = project.startDate;
            document.getElementById('projectEndDate').value = project.endDate;
            document.getElementById('projectProgress').value = project.progress;
            document.getElementById('projectBudget').value = project.budget;
            document.getElementById('projectTags').value = project.tags ? project.tags.join(', ') : '';

            // Populate team members dropdown and select the correct members
            populateProjectTeamMembersDropdown().then(() => {
                const teamMembersSelect = document.getElementById('projectTeamMembers');

                // If project has teamMemberIds, use those. Otherwise try to match by name
                if (project.teamMemberIds && project.teamMemberIds.length > 0) {
                    // Select by IDs
                    Array.from(teamMembersSelect.options).forEach(option => {
                        if (project.teamMemberIds.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                } else if (project.teamMembers && project.teamMembers.length > 0) {
                    // Fallback: try to match by name for old data
                    Array.from(teamMembersSelect.options).forEach(option => {
                        const memberName = option.getAttribute('data-member-name');
                        if (project.teamMembers.includes(memberName)) {
                            option.selected = true;
                        }
                    });
                }
            });

            // Open modal
            document.getElementById('projectModal').classList.add('active');
        }

        async function deleteProject(index) {
            const project = projects[index];

            if (confirm(`Are you sure you want to delete "${project.name}"?`)) {
                try {
                    // Delete from Firebase if project has an ID
                    if (project.id && db) {
                        await deleteProjectFromFirebase(project.id);
                        console.log('✅ Project deleted from Firebase:', project.id);
                        alert('✅ Project deleted successfully!');

                        // Reload projects from Firebase
                        await loadProjectsFromFirebase();
                    } else {
                        // Fallback to local deletion if no ID
                        projects.splice(index, 1);
                        renderProjects();
                        alert('✅ Project deleted successfully (locally)!');
                    }
                } catch (error) {
                    console.error('❌ Error deleting project:', error);
                    alert('❌ Error deleting project: ' + error.message);
                }
            }
        }

        // Handle project form submission
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get selected team member IDs and names
            const teamMembersSelect = document.getElementById('projectTeamMembers');
            const selectedOptions = Array.from(teamMembersSelect.selectedOptions);

            const teamMemberIds = selectedOptions.map(opt => opt.value).filter(v => v);
            const teamMemberNames = selectedOptions.map(opt => opt.getAttribute('data-member-name')).filter(n => n);

            // Validate that at least one team member is selected
            if (teamMemberIds.length === 0) {
                alert('⚠️ Please select at least one team member for this project.');
                teamMembersSelect.focus();
                return;
            }

            const tagsInput = document.getElementById('projectTags').value;
            const tagsArray = tagsInput ? tagsInput.split(',').map(s => s.trim()).filter(s => s) : [];

            const projectData = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                status: document.getElementById('projectStatus').value,
                priority: document.getElementById('projectPriority').value,
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                progress: parseInt(document.getElementById('projectProgress').value),
                budget: parseInt(document.getElementById('projectBudget').value) || 0,
                teamMemberIds: teamMemberIds,  // Store IDs
                teamMembers: teamMemberNames,   // Store names for backwards compatibility and display
                tags: tagsArray
            };

            try {
                if (editingProjectIndex >= 0) {
                    // Update existing project
                    const project = projects[editingProjectIndex];

                    // Update in Firebase if project has an ID
                    if (project.id && db) {
                        await updateProjectInFirebase(project.id, projectData);
                        console.log('✅ Project updated in Firebase:', project.id);
                        alert('✅ Project updated successfully!');
                    } else {
                        // Fallback to local storage if no ID
                        projects[editingProjectIndex] = projectData;
                        alert('✅ Project updated successfully (locally)!');
                    }
                } else {
                    // Add new project to Firebase
                    if (db) {
                        const projectId = await addProjectToFirebase(projectData);
                        console.log('✅ Project added to Firebase with ID:', projectId);
                        alert('✅ Project created successfully!');
                    } else {
                        // Fallback to local storage if Firebase not available
                        projects.push(projectData);
                        alert('✅ Project created successfully (locally)!');
                    }
                }

                closeProjectModal();

                // Reload projects from Firebase
                if (db) {
                    await loadProjectsFromFirebase();
                } else {
                    renderProjects();
                }

            } catch (error) {
                console.error('❌ Error saving project:', error);
                alert('❌ Error saving project: ' + error.message);
            }
        });

        // Close modal when clicking outside
        document.getElementById('projectModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProjectModal();
            }
        });

        // Initialize app
        window.addEventListener('load', async () => {
            // Load from Firebase
            if (db) {
                await loadTasksFromFirebase();
                await loadTeamMembersWithStats();
                await loadProjectsFromFirebase();
                setupRealtimeListener();
            } else {
                renderTasks();
                renderProjects();
                updateDashboardStats();
            }
        });
    </script>
</body>
</html>