<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectFlow - Modern Work Management</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #323338;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            background: #f6f7fb;
            min-height: 100vh;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e6e9ef;
            padding: 0 24px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .main-nav {
            display: flex;
            gap: 4px;
        }

        .nav-tab {
            padding: 10px 20px;
            border-radius: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #323338;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #f6f7fb;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .search-container {
            position: relative;
        }

        .search-bar {
            background: #f6f7fb;
            border: 2px solid transparent;
            padding: 12px 16px 12px 44px;
            border-radius: 12px;
            width: 320px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-bar:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #676879;
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: none;
            background: #f6f7fb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .logout-btn {
            background: #fee;
            color: #c33;
            padding: 8px 16px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .logout-btn:hover {
            background: #fdd;
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 10px;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #323338;
        }

        .icon-btn:hover {
            background: #e6e9ef;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #ff3d57;
            border-radius: 50%;
            border: 2px solid white;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .avatar:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .init-data-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 28px;
            background: linear-gradient(135deg, #00c875 0%, #00a666 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 200, 117, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .init-data-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(0, 200, 117, 0.5);
        }

        .init-data-btn:active {
            transform: translateY(-1px);
        }

        .init-data-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .init-data-btn.success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .main-container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e6e9ef;
            padding: 24px 16px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 80px;
            padding: 24px 12px;
        }

        .sidebar.collapsed .sidebar-title {
            display: none;
        }

        .sidebar.collapsed .sidebar-item span:not(.emoji) {
            display: none;
        }

        .sidebar.collapsed .add-button {
            display: none;
        }

        .sidebar.collapsed .sidebar-item {
            justify-content: center;
            padding: 12px;
        }

        .sidebar.collapsed .sidebar-section {
            margin-bottom: 20px;
        }

        .collapse-btn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #f6f7fb 0%, #e6e9ef 100%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .collapse-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .sidebar-section-header:hover {
            opacity: 0.7;
        }

        .section-arrow {
            font-size: 12px;
            color: #676879;
            transition: transform 0.3s ease;
        }

        .sidebar-section.collapsed .section-arrow {
            transform: rotate(-90deg);
        }

        .sidebar-section-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .sidebar-section.collapsed .sidebar-section-content {
            max-height: 0;
            opacity: 0;
        }

        .sidebar.collapsed .sidebar-section-header {
            justify-content: center;
        }

        .sidebar.collapsed .section-arrow {
            display: none;
        }

        .sidebar-title {
            font-size: 11px;
            color: #676879;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .sidebar-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            color: #323338;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 4px;
        }

        .sidebar-item:hover {
            background: #f6f7fb;
            transform: translateX(4px);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .sidebar-item .emoji {
            font-size: 20px;
        }

        .add-button {
            width: 100%;
            padding: 12px;
            border: 2px dashed #c5c7d0;
            background: transparent;
            border-radius: 12px;
            color: #676879;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-button:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f6f7fb;
            transform: scale(1.02);
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        .page-view {
            display: none;
            animation: slideIn 0.4s ease;
        }

        .page-view.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .board-header {
            margin-bottom: 32px;
        }

        .board-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #323338;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .board-subtitle {
            color: #676879;
            font-size: 15px;
        }

        .board-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #323338;
            border: 2px solid #e6e9ef;
        }

        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
        }

        .btn-secondary.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .btn-secondary.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #676879;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            border: 1px solid #e6e9ef;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #323338;
        }

        .progress-item {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .progress-name {
            color: #323338;
            font-weight: 600;
        }

        .progress-percentage {
            color: #676879;
            font-weight: 700;
        }

        .progress-bar-container {
            height: 10px;
            background: #f6f7fb;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 16px 0;
            border-bottom: 1px solid #e6e9ef;
            display: flex;
            align-items: start;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            padding-left: 8px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            color: white;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: #323338;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .activity-time {
            font-size: 12px;
            color: #676879;
            font-weight: 600;
        }

        .table-container {
            background: white;
            border-radius: 16px;
            overflow-x: auto;
            overflow-y: visible;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e6e9ef;
            width: 100%;
        }

        .table-wrapper {
            min-width: 100%;
            width: max-content;
        }

        .table-header {
            display: grid;
            grid-template-columns: 60px minmax(180px, 1.8fr) 160px 120px 180px 200px 130px 130px 150px;
            background: linear-gradient(135deg, #f6f7fb 0%, #e6e9ef 100%);
            border-bottom: 2px solid #e6e9ef;
            font-size: 13px;
            font-weight: 700;
            color: #676879;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: max-content;
        }

        .table-cell {
            padding: 18px 16px;
            border-right: 1px solid #e6e9ef;
            overflow: visible;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-cell:last-child {
            border-right: none;
        }

        .table-cell.sortable:hover {
            background: rgba(0, 115, 234, 0.1);
            color: #0073ea;
        }

        .sort-icon {
            display: inline-block;
            margin-left: 4px;
            font-size: 10px;
            color: #c5c7d0;
        }

        .sort-icon.asc::after {
            content: '▲';
            color: #0073ea;
        }

        .sort-icon.desc::after {
            content: '▼';
            color: #0073ea;
        }

        .table-row {
            display: grid;
            grid-template-columns: 60px minmax(180px, 1.8fr) 160px 120px 180px 200px 130px 130px 150px;
            border-bottom: 1px solid #e6e9ef;
            transition: all 0.3s ease;
            min-width: max-content;
            position: relative;
            z-index: 1;
        }

        .table-row:hover {
            background: #f6f7fb;
            transform: scale(1.005);
            z-index: 10;
        }

        .table-row:has(.status-popup.active) {
            z-index: 100;
        }

        .table-row .table-cell {
            padding: 18px 16px;
            display: flex;
            align-items: center;
        }

        .table-cell .task-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        /* Custom scrollbar for table container */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f6f7fb;
            border-radius: 0 0 16px 16px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a4291 100%);
        }

        .row-number {
            color: #676879;
            font-weight: 700;
        }

        .task-name {
            font-weight: 600;
            color: #323338;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        /* Status Popup Dropdown */
        .status-popup {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            border: 1px solid #e6e9ef;
            padding: 8px;
            min-width: 180px;
            z-index: 9999;
            display: none;
            animation: fadeInDown 0.2s ease;
        }

        .status-popup.active {
            display: block;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .status-popup-option {
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .status-popup-option:last-child {
            margin-bottom: 0;
        }

        .status-popup-option:hover {
            transform: translateX(4px);
        }

        .status-popup-option.working {
            background: #fdab3d;
            color: white;
        }

        .status-popup-option.done {
            background: #00c875;
            color: white;
        }

        .status-popup-option.stuck {
            background: #e44258;
            color: white;
        }

        .status-popup-option.blank {
            background: #c4c4c4;
            color: white;
        }

        .status-badge-wrapper {
            position: relative;
            display: inline-block;
        }

        .status-working {
            background: #fdab3d;
            color: white;
        }

        .status-done {
            background: #00c875;
            color: white;
        }

        .status-stuck {
            background: #e44258;
            color: white;
        }

        .status-blank {
            background: #c4c4c4;
            color: white;
        }

        .priority {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .priority-high {
            background: #e44258;
        }

        .priority-medium {
            background: #fdab3d;
        }

        .priority-low {
            background: #579bfc;
        }

        .person-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .person-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
        }

        .date-cell {
            color: #676879;
            font-size: 13px;
            font-weight: 600;
        }

        .project-badge {
            padding: 6px 6px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            background: linear-gradient(135deg, #e6f4ff 0%, #d4e9ff 100%);
            color: #667eea;
            border: 1px solid #b8daff;
            display: inline-block;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #f6f7fb;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .action-btn:hover {
            transform: scale(1.1);
        }

        .action-btn.edit-btn:hover {
            background: #667eea;
            color: white;
        }

        .action-btn.delete-btn:hover {
            background: #e44258;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .add-row {
            padding: 20px 16px;
            color: #676879;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-row:hover {
            color: #667eea;
            background: #f6f7fb;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .team-card {
            background: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
            position: relative;
        }

        .team-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .team-card:hover .team-edit-btn {
            opacity: 1;
        }

        .team-edit-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: white;
            border: 2px solid #e6e9ef;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
            opacity: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .team-edit-btn:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .change-password-btn {
            width: 100%;
            margin-top: 16px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .change-password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .team-avatar-large {
            width: 90px;
            height: 90px;
            border-radius: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: 700;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .team-name {
            font-size: 20px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 6px;
        }

        .team-role {
            font-size: 14px;
            color: #676879;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .team-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .team-status.active {
            background: #d4edda;
            color: #155724;
        }

        .team-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .team-stats {
            display: flex;
            justify-content: space-around;
            padding-top: 20px;
            border-top: 2px solid #e6e9ef;
        }

        .team-stat-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .team-stat-label {
            font-size: 12px;
            color: #676879;
            margin-top: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .team-stat.clickable-stat {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            padding: 8px;
            margin: -8px;
        }

        .team-stat.clickable-stat:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.05);
        }

        .team-stat.clickable-stat:hover .team-stat-value {
            background: linear-gradient(135deg, #5568d3 0%, #6a4291 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Multi-Select Checkbox Dropdown Styles */
        .multi-select-dropdown {
            position: relative;
            width: 100%;
        }

        .multi-select-display {
            width: 100%;
            padding: 8px 32px 8px 12px;
            border: 1px solid #e6e9ef;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .multi-select-display:hover {
            border-color: #667eea;
        }

        .multi-select-display::after {
            content: '▼';
            position: absolute;
            right: 12px;
            font-size: 10px;
            color: #676879;
            transition: transform 0.2s ease;
        }

        .multi-select-display.open::after {
            transform: rotate(180deg);
        }

        .multi-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e6e9ef;
            border-radius: 6px;
            margin-top: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .multi-select-options.open {
            display: block;
        }

        .multi-select-option {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .multi-select-option:hover {
            background: #f6f7fb;
        }

        .multi-select-option input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .multi-select-option label {
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            color: #323338;
        }

        /* Projects Grid Styles */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            padding: 24px 0;
        }

        .project-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e6e9ef;
            position: relative;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.15);
        }

        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .project-card-title {
            font-size: 20px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 8px;
        }

        .project-card-description {
            font-size: 14px;
            color: #676879;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .project-status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .project-status-badge.planned {
            background: #e3f2fd;
            color: #1976d2;
        }

        .project-status-badge.in-progress {
            background: #fff3e0;
            color: #f57c00;
        }

        .project-status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .project-status-badge.on-hold {
            background: #f8d7da;
            color: #721c24;
        }

        .project-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e6e9ef;
        }

        .project-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #676879;
        }

        .project-meta-icon {
            font-size: 14px;
        }

        .project-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .project-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #e6e9ef;
            background: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .project-action-btn:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .project-action-btn.delete:hover {
            background: #e44258;
            border-color: #e44258;
        }

        .project-progress {
            margin-top: 12px;
        }

        .project-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #676879;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .project-progress-bar {
            height: 8px;
            background: #e6e9ef;
            border-radius: 10px;
            overflow: hidden;
        }

        .project-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .project-tag {
            padding: 4px 10px;
            background: #f5f6f8;
            border-radius: 6px;
            font-size: 11px;
            color: #676879;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 540px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-spinner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 20px;
        }

        .modal-spinner-overlay.active {
            display: flex;
        }

        .modal-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 28px;
            border-bottom: 2px solid #e6e9ef;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #323338;
        }

        .modal-body {
            padding: 28px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: #323338;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e6e9ef;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .readonly-input {
            background: #f6f7fb;
            cursor: not-allowed;
            color: #676879;
        }

        .password-error-message {
            display: none;
            background: #fee;
            color: #c33;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .password-error-message.show {
            display: block;
        }

        .password-success-message {
            display: none;
            background: #efe;
            color: #363;
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #2e7d32;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .password-success-message.show {
            display: block;
        }

        .modal-footer {
            padding: 20px 28px;
            border-top: 2px solid #e6e9ef;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .delete-btn {
            background: #e44258;
            color: white;
        }

        .delete-btn:hover {
            background: #c93649;
        }

        /* Tablet responsive design (768px - 1024px) */
        @media (max-width: 1024px) {
            .table-container {
                overflow-x: auto;
            }

            .table-header,
            .table-row {
                grid-template-columns: 50px minmax(150px, 1fr) 120px 100px 140px 110px;
            }

            /* Hide date and timeline columns on tablet */
            .table-cell:nth-child(7),
            .table-cell:nth-child(8) {
                display: none;
            }

            .content {
                padding: 20px;
            }
        }

        /* Mobile responsive design (max-width: 768px) */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
                height: 60px;
            }

            .logo {
                font-size: 20px;
            }

            .main-nav {
                display: none;
            }

            .search-container {
                display: none;
            }

            .header-right {
                gap: 8px;
            }

            .icon-btn,
            .avatar {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .sidebar {
                width: 70px;
                padding: 16px 8px;
            }

            .sidebar-title,
            .sidebar-item span:not(.emoji),
            .add-button {
                display: none;
            }

            .sidebar-item {
                justify-content: center;
                padding: 10px;
            }

            .content {
                padding: 16px;
            }

            .board-title {
                font-size: 24px;
            }

            .board-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            /* Remove horizontal scroll on mobile */
            .table-container {
                overflow-x: visible;
                overflow-y: visible;
            }

            /* Hide table header on mobile */
            .table-header {
                display: none;
            }

            /* Convert table rows to card layout */
            .table-row {
                display: flex;
                flex-direction: column;
                padding: 16px;
                gap: 12px;
                border-radius: 12px;
                margin-bottom: 12px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                min-width: auto;
            }

            .table-row:hover {
                transform: scale(1);
            }

            .table-cell {
                padding: 0 !important;
                border-right: none !important;
                display: flex !important;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }

            .table-cell::before {
                content: attr(data-label);
                font-weight: 700;
                color: #676879;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Hide row number on mobile */
            .table-cell:nth-child(1) {
                display: none !important;
            }

            /* Task name - full width, no label */
            .table-cell:nth-child(2) {
                flex-direction: column;
                align-items: flex-start;
                padding-bottom: 8px !important;
                border-bottom: 1px solid #e6e9ef;
            }

            .table-cell:nth-child(2)::before {
                content: none;
            }

            .task-name {
                font-size: 16px;
                font-weight: 700;
            }

            /* Show all cells on mobile */
            .table-cell:nth-child(n) {
                display: flex !important;
            }

            .status-badge {
                font-size: 11px;
                padding: 6px 12px;
            }

            .person-cell {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .person-avatar {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .project-badge {
                font-size: 12px;
                padding: 2px 2px;
            }

            .action-buttons {
                gap: 8px;
            }

            .action-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .date-cell {
                font-size: 13px;
            }
        }

        /* Extra small mobile (max-width: 480px) */
        @media (max-width: 480px) {
            .header {
                padding: 0 12px;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                z-index: 200;
                transition: left 0.3s ease;
                height: calc(100vh - 60px);
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .main-container {
                margin-left: 0;
            }

            .content {
                padding: 12px;
                width: 100%;
            }

            .board-title {
                font-size: 20px;
            }

            .board-subtitle {
                font-size: 13px;
            }

            .table-row {
                padding: 12px;
            }

            .table-cell {
                font-size: 13px;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner-container {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 16px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-text {
            color: #323338;
            font-size: 14px;
            font-weight: 600;
        }

        /* Custom Date Input Wrapper */
        .date-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
        }

        .date-input-wrapper input[type="date"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        /* Style to show dd/mm/yyyy format */
        .date-display {
            position: relative;
            padding: 12px 50px 12px 16px;
            background: white;
            border: 2px solid #e6e9ef;
            border-radius: 12px;
            display: flex;
            align-items: center;
            color: #323338;
            font-size: 14px;
            min-height: 48px;
            cursor: pointer;
        }

        .date-display.placeholder {
            color: #a0a0a0;
        }

        .date-input-wrapper input[type="date"]:focus ~ .date-display {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .date-input-wrapper .calendar-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 1;
            font-size: 16px;
        }

        /* Hide the default date picker icon */
        .date-input-wrapper input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="logo">ProjectFlow</div>
                <nav class="main-nav">
                    <button class="nav-tab active" onclick="switchPage('dashboard')">Dashboard</button>
                    <button class="nav-tab" onclick="switchPage('projectslist')">Projects</button>
                    <button class="nav-tab" onclick="switchPage('tasks')">Tasks</button>
                    <button class="nav-tab" onclick="switchPage('team')">Team</button>
                    <button class="nav-tab" onclick="switchPage('reports')">Reports</button>
                </nav>
            </div>
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-bar" placeholder="Search tasks, projects, people...">
            </div>
            <div class="header-right">
                <button class="icon-btn">
                    🔔
                    <span class="notification-badge"></span>
                </button>
                <button class="icon-btn">⚙️</button>
                <button class="icon-btn">❓</button>
                <div class="user-info">
                    <span class="user-name" id="currentUserName">User</span>
                    <div class="avatar" id="currentUserAvatar">JD</div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar" id="sidebar">
                <button class="collapse-btn" onclick="toggleSidebar()">
                    <span id="collapseIcon">◀</span>
                </button>
                
                <div class="sidebar-section">
                    <div class="sidebar-item active">
                        <span class="emoji">📋</span>
                        <span>Main Table</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📊</span>
                        <span>Chart View</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📅</span>
                        <span>Calendar</span>
                    </div>
                    <div class="sidebar-item">
                        <span class="emoji">📈</span>
                        <span>Timeline</span>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('myWork')">
                        <div class="sidebar-title">My Work</div>
                        <span class="section-arrow" id="myWorkArrow">▼</span>
                    </div>
                    <div class="sidebar-section-content" id="myWorkContent">
                        <div class="sidebar-item">
                            <span class="emoji">⭐</span>
                            <span>Favorites</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">📌</span>
                            <span>My Items</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">🎯</span>
                            <span>My Goals</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-header" onclick="toggleSection('workspaces')">
                        <div class="sidebar-title">Workspaces</div>
                        <span class="section-arrow" id="workspacesArrow">▼</span>
                    </div>
                    <div class="sidebar-section-content" id="workspacesContent">
                        <div class="sidebar-item">
                            <span class="emoji">🎯</span>
                            <span>Marketing</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">💻</span>
                            <span>Development</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">🎨</span>
                            <span>Design</span>
                        </div>
                        <div class="sidebar-item">
                            <span class="emoji">📱</span>
                            <span>Mobile</span>
                        </div>
                        <button class="add-button">+ Add Workspace</button>
                    </div>
                </div>
            </aside>

            <main class="content">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page-view active">
                    <div class="board-header">
                        <h1 class="board-title">Dashboard Overview</h1>
                        <p class="board-subtitle">Track your team's progress and performance</p>
                    </div>

                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalItems">8</div>
                            <div class="stat-label">Total Items</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="workingItems">4</div>
                            <div class="stat-label">In Progress</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="doneItems">2</div>
                            <div class="stat-label">Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stuckItems">1</div>
                            <div class="stat-label">Needs Attention</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Project Progress</h3>
                        <div id="projectProgressList">
                            <!-- Projects will be rendered here dynamically -->
                            <div style="text-align: center; padding: 20px; color: #999;">
                                Loading projects...
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Recent Activity</h3>
                        <ul class="activity-list" id="recentActivityList">
                            <!-- Recent activity will be rendered here dynamically -->
                            <li style="text-align: center; padding: 20px; color: #999;">
                                Loading recent activity...
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Projects List Page -->
                <div id="projectslistPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Projects</h1>
                        <p class="board-subtitle">Manage all your projects in one place</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openProjectModal()">
                                <span>+</span>
                                <span>New Project</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>🔍</span>
                                <span>Filter</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📤</span>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <div id="projectsGrid" class="projects-grid">
                        <!-- Projects will be rendered here dynamically -->
                    </div>
                </div>

                <!-- Tasks Page -->
                <div id="tasksPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Task Management</h1>
                        <p class="board-subtitle">Manage your team's tasks and deliverables</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openModal()">
                                <span>+</span>
                                <span>New Task</span>
                            </button>
                            <button class="btn btn-secondary" id="myTasksBtn" onclick="toggleMyTasks()">
                                <span>👤</span>
                                <span>My Tasks</span>
                            </button>
                            <button class="btn btn-secondary" onclick="toggleFilterPanel()">
                                <span>🔍</span>
                                <span>Filter</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📤</span>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <!-- Task Filter Panel -->
                    <div id="taskFilterPanel" style="display: none; background: white; padding: 20px; margin: 16px 0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #323338;">Filter Tasks</h3>
                            <button onclick="clearAllTaskFilters()" style="background: transparent; border: none; color: #e44258; cursor: pointer; font-size: 14px; font-weight: 600;">
                                Clear All
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Status</label>
                                <div class="multi-select-dropdown" id="statusFilterDropdown">
                                    <div class="multi-select-display" id="statusFilterDisplay" onclick="toggleStatusDropdown()">
                                        <span id="statusFilterText">All Status</span>
                                    </div>
                                    <div class="multi-select-options" id="statusFilterOptions">
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-blank" value="blank" onchange="updateStatusFilter()">
                                            <label for="status-blank">Not Started</label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-working" value="working" onchange="updateStatusFilter()">
                                            <label for="status-working">Working on it</label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-stuck" value="stuck" onchange="updateStatusFilter()">
                                            <label for="status-stuck">Stuck</label>
                                        </div>
                                        <div class="multi-select-option" onclick="event.stopPropagation()">
                                            <input type="checkbox" id="status-done" value="done" onchange="updateStatusFilter()">
                                            <label for="status-done">Done</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Priority</label>
                                <select id="filterPriority" onchange="applyTaskFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Priority</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Assigned To</label>
                                <select id="filterAssignedTo" onchange="applyTaskFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Members</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: #676879; margin-bottom: 6px;">Project</label>
                                <select id="filterProject" onchange="applyTaskFilters()" style="width: 100%; padding: 8px; border: 1px solid #e6e9ef; border-radius: 6px; font-size: 14px;">
                                    <option value="">All Projects</option>
                                </select>
                            </div>
                        </div>
                        <div id="activeFiltersDisplay" style="margin-top: 12px; display: none;">
                            <div style="font-size: 12px; font-weight: 600; color: #676879; margin-bottom: 6px;">Active Filters:</div>
                            <div id="activeFilterTags" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-cell">#</div>
                            <div class="table-cell sortable" onclick="sortTasks('name')" style="cursor: pointer;">
                                Task Name <span id="sort-name" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('status')" style="cursor: pointer;">
                                Status <span id="sort-status" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('priority')" style="cursor: pointer;">
                                Priority <span id="sort-priority" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('person')" style="cursor: pointer;">
                                Assigned To <span id="sort-person" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('project')" style="cursor: pointer;">
                                Project <span id="sort-project" class="sort-icon"></span>
                            </div>
                            <div class="table-cell sortable" onclick="sortTasks('date')" style="cursor: pointer;">
                                Due Date <span id="sort-date" class="sort-icon"></span>
                            </div>
                            <div class="table-cell">Timeline</div>
                            <div class="table-cell">Actions</div>
                        </div>
                        <div id="tableBody"></div>
                        <div class="add-row" onclick="openModal()">
                            <span>+</span>
                            <span>Add new task</span>
                        </div>
                    </div>
                </div>

                <!-- Team Page -->
                <div id="teamPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Team Members</h1>
                        <p class="board-subtitle">Collaborate with your amazing team</p>
                        <div class="board-actions">
                            <button class="btn btn-primary" onclick="openMemberModal()">
                                <span>+</span>
                                <span>Add Member</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📊</span>
                                <span>Team Report</span>
                            </button>
                        </div>
                    </div>

                    <div class="team-grid">
                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #667eea, #764ba2);">SL</div>
                            <div class="team-name">Sarah Lee</div>
                            <div class="team-role">Project Manager</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">12</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">8</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #f093fb, #f5576c);">MC</div>
                            <div class="team-name">Mike Chen</div>
                            <div class="team-role">Lead Developer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">15</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">10</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">ER</div>
                            <div class="team-name">Emily Rose</div>
                            <div class="team-role">Marketing Lead</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">9</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">7</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">AK</div>
                            <div class="team-name">Alex Kim</div>
                            <div class="team-role">Database Admin</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">11</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">6</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #fa709a, #fee140);">JP</div>
                            <div class="team-name">Jordan Park</div>
                            <div class="team-role">UI/UX Designer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">10</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">8</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>

                        <div class="team-card">
                            <div class="team-avatar-large" style="background: linear-gradient(135deg, #ffecd2, #fcb69f);">TW</div>
                            <div class="team-name">Taylor Wong</div>
                            <div class="team-role">Backend Developer</div>
                            <div class="team-stats">
                                <div class="team-stat">
                                    <div class="team-stat-value">13</div>
                                    <div class="team-stat-label">Tasks</div>
                                </div>
                                <div class="team-stat">
                                    <div class="team-stat-value">9</div>
                                    <div class="team-stat-label">Done</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reportsPage" class="page-view">
                    <div class="board-header">
                        <h1 class="board-title">Reports & Analytics</h1>
                        <p class="board-subtitle">Insights into your team's performance</p>
                        <div class="board-actions">
                            <button class="btn btn-secondary">
                                <span>📊</span>
                                <span>Export Report</span>
                            </button>
                            <button class="btn btn-secondary">
                                <span>📅</span>
                                <span>Date Range</span>
                            </button>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Key Metrics</h3>
                        <div class="dashboard-grid">
                            <div class="stat-card">
                                <div class="stat-value">87%</div>
                                <div class="stat-label">Completion Rate</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">156</div>
                                <div class="stat-label">Tasks Completed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">3.2</div>
                                <div class="stat-label">Avg. Days/Task</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="color: #e44258;">4</div>
                                <div class="stat-label">Overdue Tasks</div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">Team Performance</h3>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Sarah Lee - Project Manager</span>
                                <span class="progress-percentage">92%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 92%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Mike Chen - Lead Developer</span>
                                <span class="progress-percentage">85%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 85%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Emily Rose - Marketing Lead</span>
                                <span class="progress-percentage">95%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 95%; background: #00c875;"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-header">
                                <span class="progress-name">Alex Kim - Database Admin</span>
                                <span class="progress-percentage">68%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: 68%; background: #fdab3d;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Initialize Data Button -->
        <button class="init-data-btn" id="initDataBtn" onclick="initializeAllSampleData()">
            <span id="initBtnIcon">📦</span>
            <span id="initBtnText">Initialize Sample Data</span>
        </button>
    </div>

    <!-- Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <!-- Modal Spinner Overlay -->
            <div class="modal-spinner-overlay" id="modalSpinner">
                <div class="modal-spinner"></div>
            </div>

            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Create New Task</h2>
            </div>
            <form id="taskForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-input" id="itemName" placeholder="Enter task name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="itemStatus">
                            <option value="blank">Not Started</option>
                            <option value="working">Working on it</option>
                            <option value="stuck">Stuck</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="itemPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign To <span style="color: #e44258;">*</span></label>
                        <select class="form-select" id="itemPerson" required>
                            <option value="" disabled selected>Select team member...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project</label>
                        <select class="form-select" id="itemProject">
                            <option value="">No Project</option>
                            <option value="Website Redesign">Website Redesign</option>
                            <option value="Mobile App Development">Mobile App Development</option>
                            <option value="Marketing Campaign Q4">Marketing Campaign Q4</option>
                            <option value="Database Infrastructure">Database Infrastructure</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="itemStartDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="itemStartDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="itemDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="itemDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Timeline</label>
                        <input type="text" class="form-input" id="itemTimeline" placeholder="e.g., 2 weeks" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Team Member Modal -->
    <div class="modal" id="memberModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="memberModalTitle">Add Team Member</h2>
            </div>
            <form id="memberForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="memberName" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="memberEmail" placeholder="email@company.com" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <input type="text" class="form-input" id="memberRole" placeholder="e.g., Project Manager" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select class="form-select" id="memberDepartment" required>
                            <option value="">Select department...</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Development">Development</option>
                            <option value="Design">Design</option>
                            <option value="Quality">Quality</option>
                            <option value="Security">Security</option>
                            <option value="Operations">Operations</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Avatar (2 letters)</label>
                        <input type="text" class="form-input" id="memberAvatar" placeholder="e.g., SL" maxlength="2" pattern="[A-Za-z]{2}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="memberStatus" required>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Skills (comma separated)</label>
                        <input type="text" class="form-input" id="memberSkills" placeholder="e.g., javascript, react, node.js">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projectModalTitle">Create New Project</h2>
            </div>
            <form id="projectForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-input" id="projectName" placeholder="Enter project name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="projectDescription" placeholder="Project description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="projectStatus">
                            <option value="planned">Planned</option>
                            <option value="in-progress" selected>In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on-hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SDLC Phase</label>
                        <select class="form-select" id="projectSDLC">
                            <option value="Requirement">Requirement</option>
                            <option value="Design">Design</option>
                            <option value="Development" selected>Development</option>
                            <option value="Smoke Test">Smoke Test</option>
                            <option value="SIT">SIT</option>
                            <option value="UAT">UAT</option>
                            <option value="Implement">Implemented</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-select" id="projectPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="projectStartDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="projectStartDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <div class="date-input-wrapper">
                            <div class="date-display placeholder" id="projectEndDate-display">dd/mm/yyyy</div>
                            <span class="calendar-icon">📅</span>
                            <input type="date" class="form-input" id="projectEndDate" required onchange="updateDateDisplay(this)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Progress (%)</label>
                        <input type="number" class="form-input" id="projectProgress" min="0" max="100" value="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Budget (฿)</label>
                        <input type="number" class="form-input" id="projectBudget" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team Members <span style="color: #e44258;">*</span></label>
                        <select class="form-select" id="projectTeamMembers" multiple size="5" required>
                            <option value="" disabled>Loading team members...</option>
                        </select>
                        <small style="color: #676879; font-size: 12px; margin-top: 4px; display: block;">Hold Ctrl/Cmd to select multiple members (at least one required)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-input" id="projectTags" placeholder="e.g., frontend, urgent">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="projectSubmitBtn">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Change Password</h2>
            </div>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="modal-body">
                    <div id="passwordError" class="password-error-message"></div>
                    <div id="passwordSuccess" class="password-success-message"></div>

                    <div class="form-group">
                        <label class="form-label">Team Member</label>
                        <input type="text" id="passwordMemberName" class="form-input readonly-input" readonly>
                        <input type="hidden" id="passwordMemberId">
                        <input type="hidden" id="passwordMemberHasPassword">
                    </div>

                    <div class="form-group" id="currentPasswordGroup">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                        <small style="color: #676879; font-size: 12px; margin-top: 4px; display: block;">Required to change your existing password</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-input" placeholder="Enter new password (min 4 characters)" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Re-confirm New Password</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Re-enter new password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA2My_zhJEfE_wfQ9wpu4W7o_cLKOI9PLQ",
            authDomain: "project-status-f7de8.firebaseapp.com",
            projectId: "project-status-f7de8",
            storageBucket: "project-status-f7de8.firebasestorage.app",
            messagingSenderId: "809576699201",
            appId: "1:809576699201:web:554f6cbf54200d08b6fdc0",
            measurementId: "G-61Z0HS88LR"
        };

        // Session timeout configuration (1 hour = 3600000 milliseconds)
        const SESSION_TIMEOUT = 60 * 60 * 1000; // 1 hour in milliseconds

        // Check authentication and session timeout
        function checkSession() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');

            if (!loggedInUser) {
                window.location.href = 'login.html';
                return false;
            }

            try {
                const currentUser = JSON.parse(loggedInUser);
                const now = Date.now();
                const lastActivity = currentUser.lastActivity || now;
                const timeSinceActivity = now - lastActivity;

                // Check if session has expired (no activity for 1 hour)
                if (timeSinceActivity > SESSION_TIMEOUT) {
                    console.log('Session expired due to inactivity');
                    sessionStorage.removeItem('loggedInUser');
                    alert('Your session has expired due to inactivity. Please login again.');
                    window.location.href = 'login.html';
                    return false;
                }

                return true;
            } catch (error) {
                console.error("Error checking session:", error);
                sessionStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
                return false;
            }
        }

        // Update last activity time
        function updateActivity() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                try {
                    const currentUser = JSON.parse(loggedInUser);
                    currentUser.lastActivity = Date.now();
                    sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                } catch (error) {
                    console.error("Error updating activity:", error);
                }
            }
        }

        // Check session on page load
        if (!checkSession()) {
            // Will redirect to login if session is invalid
        }

        // Parse user data and display in header
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        let currentUser = null;
        try {
            currentUser = JSON.parse(loggedInUser);
            // Update user display in header
            const userNameEl = document.getElementById('currentUserName');
            const userAvatarEl = document.getElementById('currentUserAvatar');
            if (userNameEl && currentUser.name) {
                userNameEl.textContent = currentUser.name;
            }
            if (userAvatarEl && currentUser.name) {
                const initials = currentUser.name.split(' ').map(n => n[0]).join('');
                userAvatarEl.textContent = initials;
            }
        } catch (error) {
            console.error("Error parsing user data:", error);
        }

        // Track user activity - update timestamp on any interaction
        const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
        });

        // Check session every minute
        setInterval(() => {
            checkSession();
        }, 60000); // Check every 60 seconds

        // Logout function
        function logout() {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        }

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("✅ Firebase initialized successfully!");
        } catch (error) {
            console.error("❌ Firebase initialization error:", error);
        }

        // ========================================
        // DATE CONVERSION HELPER FUNCTIONS
        // ========================================

        // Update date display to show dd/mm/yyyy format
        function updateDateDisplay(inputElement) {
            if (!inputElement || !inputElement.value) return;

            const displayId = inputElement.id + '-display';
            const displayElement = document.getElementById(displayId);

            if (displayElement) {
                // Convert yyyy-mm-dd to dd/mm/yyyy for display
                const [year, month, day] = inputElement.value.split('-');
                displayElement.textContent = `${day}/${month}/${year}`;
                displayElement.classList.remove('placeholder');
            }
        }

        // Convert any date format to yyyy/mm/dd for display
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';

            // Handle slash format (dd/mm/yyyy or yyyy/mm/dd)
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length !== 3) return dateString;

                // Check if it's already yyyy/mm/dd (year is 4 digits and in first position)
                if (parts[0].length === 4) {
                    return dateString; // Already yyyy/mm/dd
                }

                // Convert from dd/mm/yyyy to yyyy/mm/dd
                const [day, month, year] = parts;
                return `${year}/${month.padStart(2, '0')}/${day.padStart(2, '0')}`;
            }

            // Handle dash format (yyyy-mm-dd)
            if (dateString.includes('-')) {
                const [year, month, day] = dateString.split('-');
                return `${year}/${month}/${day}`;
            }

            return dateString;
        }

        // Set date input value (input uses yyyy-mm-dd format from HTML5 date picker)
        function setDateInputValue(inputElement, dateString) {
            if (!inputElement || !dateString) return;

            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                // Check if yyyy/mm/dd format
                if (parts[0].length === 4) {
                    // Convert yyyy/mm/dd to yyyy-mm-dd for date input
                    const [year, month, day] = parts;
                    inputElement.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                } else {
                    // Convert dd/mm/yyyy to yyyy-mm-dd
                    const [day, month, year] = parts;
                    inputElement.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
            } else if (dateString.includes('-')) {
                // Already yyyy-mm-dd
                inputElement.value = dateString;
            } else {
                inputElement.value = dateString;
            }

            // Update the display element
            updateDateDisplay(inputElement);
        }

        // Get date from input (yyyy-mm-dd from date picker) and convert to yyyy/mm/dd for storage
        function getDateInputValue(inputElement) {
            if (!inputElement || !inputElement.value) return '';

            const value = inputElement.value.trim();
            if (!value) return '';

            // Date picker returns yyyy-mm-dd, convert to yyyy/mm/dd for storage
            if (value.includes('-')) {
                const [year, month, day] = value.split('-');
                return `${year}/${month}/${day}`;
            }

            return value;
        }

        // ========================================
        // LOADING SPINNER FUNCTIONS
        // ========================================
        function showSpinner(text = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const spinnerText = document.getElementById('spinnerText');
            if (overlay) {
                if (spinnerText) spinnerText.textContent = text;
                overlay.classList.add('active');
            }
        }

        function hideSpinner() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // Modal spinner functions
        function showModalSpinner() {
            const modalSpinner = document.getElementById('modalSpinner');
            if (modalSpinner) {
                modalSpinner.classList.add('active');
            }
        }

        function hideModalSpinner() {
            const modalSpinner = document.getElementById('modalSpinner');
            if (modalSpinner) {
                modalSpinner.classList.remove('active');
            }
        }

        // ========================================
        // PASSWORD CHANGE FUNCTIONS
        // ========================================

        // Base64 encode function
        function encodePassword(password) {
            return btoa(password);
        }

        // Base64 decode function
        function decodePassword(encodedPassword) {
            try {
                return atob(encodedPassword);
            } catch (e) {
                return encodedPassword; // Return as-is if not base64
            }
        }

        // Open password change modal
        async function openChangePasswordModal(memberId, memberName) {
            const modal = document.getElementById('changePasswordModal');
            document.getElementById('passwordMemberId').value = memberId;
            document.getElementById('passwordMemberName').value = memberName;
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';

            // Hide messages using class
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            // Check if member has a password
            try {
                const memberDoc = await db.collection('team_members').doc(memberId).get();
                const memberData = memberDoc.data();
                const hasPassword = memberData && memberData.password && memberData.password !== '';

                document.getElementById('passwordMemberHasPassword').value = hasPassword ? 'true' : 'false';

                // Show/hide current password field based on whether they have a password
                const currentPasswordGroup = document.getElementById('currentPasswordGroup');
                if (hasPassword) {
                    currentPasswordGroup.style.display = 'block';
                } else {
                    currentPasswordGroup.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking password:', error);
                // Default to showing the field
                document.getElementById('currentPasswordGroup').style.display = 'block';
            }

            modal.classList.add('active');
        }

        // Close password change modal
        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.remove('active');
        }

        // Change password
        async function changePassword(event) {
            if (event) event.preventDefault();
            const memberId = document.getElementById('passwordMemberId').value;
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');
            const btn = document.getElementById('changePasswordBtn');

            // Hide messages using classes
            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');

            // Disable button
            btn.disabled = true;
            btn.textContent = 'Changing...';

            try {
                // Get member document first to check if password exists
                const memberDoc = await db.collection('team_members').doc(memberId).get();

                if (!memberDoc.exists) {
                    errorDiv.textContent = 'Team member not found';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                const memberData = memberDoc.data();
                const hasPassword = memberData.password && memberData.password !== '';

                // If member has a password, current password is required
                if (hasPassword) {
                    if (!currentPassword) {
                        errorDiv.textContent = 'Current password is required';
                        errorDiv.classList.add('show');
                        btn.disabled = false;
                        btn.textContent = 'Change Password';
                        return;
                    }

                    let storedPassword = memberData.password;
                    // Decode if it's base64
                    storedPassword = decodePassword(storedPassword);

                    // Verify current password
                    if (currentPassword !== storedPassword) {
                        errorDiv.textContent = 'Current password is incorrect';
                        errorDiv.classList.add('show');
                        btn.disabled = false;
                        btn.textContent = 'Change Password';
                        return;
                    }
                }

                // Validate new password
                if (!newPassword || !confirmPassword) {
                    errorDiv.textContent = 'New password and confirmation are required';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'New password and confirmation do not match';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                if (newPassword.length < 4) {
                    errorDiv.textContent = 'Password must be at least 4 characters long';
                    errorDiv.classList.add('show');
                    btn.disabled = false;
                    btn.textContent = 'Change Password';
                    return;
                }

                // Encode new password with base64
                const encodedNewPassword = encodePassword(newPassword);

                // Update password in Firestore
                await db.collection('team_members').doc(memberId).update({
                    password: encodedNewPassword,
                    passwordUpdatedAt: new Date().toISOString()
                });

                // Success
                successDiv.textContent = 'Password changed successfully!';
                successDiv.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Change Password';

                // Clear form
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                // Close modal after 2 seconds
                setTimeout(() => {
                    closeChangePasswordModal();
                }, 2000);

            } catch (error) {
                console.error('Error changing password:', error);
                errorDiv.textContent = 'Failed to change password: ' + error.message;
                errorDiv.classList.add('show');
                btn.disabled = false;
                btn.textContent = 'Change Password';
            }
        }

        // ========================================
        // FIRESTORE FUNCTIONS
        // ========================================

        // Render team members in the UI
        function renderTeamMembers(members) {
            const teamGrid = document.querySelector('.team-grid');
            if (!teamGrid) return;

            const gradients = [
                'linear-gradient(135deg, #667eea, #764ba2)',
                'linear-gradient(135deg, #f093fb, #f5576c)',
                'linear-gradient(135deg, #4facfe, #00f2fe)',
                'linear-gradient(135deg, #43e97b, #38f9d7)',
                'linear-gradient(135deg, #fa709a, #fee140)',
                'linear-gradient(135deg, #ffecd2, #fcb69f)',
                'linear-gradient(135deg, #a1c4fd, #c2e9fb)',
                'linear-gradient(135deg, #d299c2, #fef9d7)'
            ];

            // Filter out inactive members
            const activeMembers = members.filter(member => {
                const status = member.status || 'Active';
                return status.toLowerCase() !== 'inactive';
            });

            teamGrid.innerHTML = activeMembers.map((member, index) => `
                <div class="team-card" data-member-id="${member.id}">
                    <button class="team-edit-btn" data-action="edit-member" data-member-index="${index}" title="Edit member">
                        ✏️
                    </button>
                    <div class="team-avatar-large" style="background: ${gradients[index % gradients.length]};">
                        ${member.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div class="team-name">${member.name}</div>
                    <div class="team-role">${member.role}</div>
                    <div class="team-status ${member.status === 'Active' ? 'active' : 'inactive'}">
                        ${member.status || 'Active'}
                    </div>
                    <div class="team-stats">
                        <div class="team-stat clickable-stat" data-action="filter-remaining" data-member-id="${member.id}" data-member-name="${member.name}">
                            <div class="team-stat-value">${member.remainingCount || 0}</div>
                            <div class="team-stat-label">Remain</div>
                        </div>
                        <div class="team-stat">
                            <div class="team-stat-value">${member.doneCount || 0}</div>
                            <div class="team-stat-label">Done</div>
                        </div>
                        <div class="team-stat">
                            <div class="team-stat-value">${member.inProgressProjects ? member.inProgressProjects.length : 0}</div>
                            <div class="team-stat-label">Project</div>
                        </div>
                    </div>
                    <button class="change-password-btn" onclick="openChangePasswordModal('${member.id}', '${member.name}')" title="Change Password">
                        🔐 Change Password
                    </button>
                </div>
            `).join('');

            // Add event listeners to edit buttons
            document.querySelectorAll('[data-action="edit-member"]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-member-index'));
                    editMember(activeMembers[index], index);
                });
            });

            // Add event listeners to "Remain" stat
            document.querySelectorAll('[data-action="filter-remaining"]').forEach(stat => {
                stat.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const memberId = this.getAttribute('data-member-id');
                    const memberName = this.getAttribute('data-member-name');
                    filterRemainingTasksByMember(memberId, memberName);
                });
            });
        }

        // Store current members for editing
        let currentTeamMembers = [];

        // Load team members with real task counts
        async function loadTeamMembersWithStats() {
            if (!db) return;

            showSpinner('Loading team members...');

            try {
                const membersSnapshot = await db.collection('team_members').get();
                const tasksSnapshot = await db.collection('tasks').get();
                const projectsSnapshot = await db.collection('projects').get();

                const teamMembers = [];

                for (const memberDoc of membersSnapshot.docs) {
                    const memberData = memberDoc.data();
                    const memberId = memberDoc.id;

                    // Count tasks for this member by ID
                    let totalTasks = 0;
                    let doneTasks = 0;

                    tasksSnapshot.forEach(taskDoc => {
                        const task = taskDoc.data();
                        // Check both assignedTo (ID) and person (name) for backwards compatibility
                        if (task.assignedTo === memberId || task.person === memberData.name) {
                            totalTasks++;
                            if (task.status === 'done') {
                                doneTasks++;
                            }
                        }
                    });

                    // Find in-progress projects this member is part of
                    const inProgressProjects = [];
                    projectsSnapshot.forEach(projectDoc => {
                        const project = projectDoc.data();
                        // Check if member is in teamMemberIds or teamMembers (name-based)
                        const isMemberInProject =
                            (project.teamMemberIds && project.teamMemberIds.includes(memberId)) ||
                            (project.teamMembers && project.teamMembers.includes(memberData.name));

                        // Only include in-progress projects
                        if (isMemberInProject && project.status === 'in-progress') {
                            inProgressProjects.push({
                                id: projectDoc.id,
                                name: project.name,
                                progress: project.progress || 0
                            });
                        }
                    });

                    teamMembers.push({
                        id: memberDoc.id,
                        ...memberData,
                        tasksCount: totalTasks,
                        doneCount: doneTasks,
                        remainingCount: totalTasks - doneTasks,  // Calculate remaining tasks
                        inProgressProjects: inProgressProjects  // Add in-progress projects
                    });
                }

                currentTeamMembers = teamMembers;
                renderTeamMembers(teamMembers);
                console.log(`✅ Loaded ${teamMembers.length} team members with real task counts and projects`);

            } catch (error) {
                console.error("❌ Error loading team members:", error);
            } finally {
                hideSpinner();
            }
        }

        // Load active team members for dropdown
        async function loadActiveTeamMembers() {
            if (!db) {
                console.error("❌ Firebase not initialized");
                return [];
            }

            try {
                // First, try to get all team members (more reliable)
                const snapshot = await db.collection('team_members').get();

                console.log(`📊 Found ${snapshot.size} total team members in database`);

                const activeMembers = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`👤 Member: ${data.name}, active: ${data.active}, status: ${data.status}`);

                    // Include member if:
                    // 1. active field is explicitly true, OR
                    // 2. status field is 'Active', OR
                    // 3. neither field exists (assume active by default)
                    const isActive = data.active === true ||
                                   data.status === 'Active' ||
                                   (data.active === undefined && data.status === undefined);

                    if (isActive && data.name) {
                        activeMembers.push({
                            id: doc.id,
                            name: data.name
                        });
                    }
                });

                // Sort alphabetically by name
                activeMembers.sort((a, b) => a.name.localeCompare(b.name));

                console.log(`✅ Loaded ${activeMembers.length} active team members for dropdown`);
                return activeMembers;

            } catch (error) {
                console.error("❌ Error loading team members:", error);
                return [];
            }
        }

        // Get member name by ID
        async function getMemberNameById(memberId) {
            if (!db || !memberId) return 'Unknown';
            
            try {
                const doc = await db.collection('team_members').doc(memberId).get();
                if (doc.exists) {
                    return doc.data().name;
                }
                return 'Unknown';
            } catch (error) {
                console.error("❌ Error getting member name:", error);
                return 'Unknown';
            }
        }

        // Populate assign to dropdown
        async function populateAssignToDropdown() {
            console.log('🔄 populateAssignToDropdown() called');

            const personSelect = document.getElementById('itemPerson');
            if (!personSelect) {
                console.error('❌ itemPerson select element not found!');
                return;
            }

            console.log('✅ Found itemPerson select element');

            // Show loading state
            personSelect.innerHTML = '<option value="" disabled selected>Loading active members...</option>';
            console.log('⏳ Loading state set, calling loadActiveTeamMembers()...');

            // Get active members with IDs
            const activeMembers = await loadActiveTeamMembers();
            console.log('📦 Received activeMembers array:', activeMembers);

            if (activeMembers.length === 0) {
                personSelect.innerHTML = '<option value="" disabled selected>No team members found</option>';
                console.warn("⚠️ No active team members found in database");

                // Provide helpful guidance
                const shouldInit = confirm(
                    '⚠️ No team members found!\n\n' +
                    'You need to add team members before creating tasks.\n\n' +
                    'Options:\n' +
                    '1. Click "OK" to initialize sample data (includes sample team members)\n' +
                    '2. Click "Cancel" to manually add team members via the Team page\n\n' +
                    'Initialize sample data now?'
                );

                if (shouldInit) {
                    // Close the task modal
                    closeModal();
                    // Initialize sample data
                    await initializeAllSampleData();
                } else {
                    // Close task modal and navigate to team page
                    closeModal();
                    navigateTo('team');
                }
                return;
            }

            // Clear current options and add placeholder
            personSelect.innerHTML = '<option value="" disabled selected>Select team member...</option>';

            // Add active members with ID as value
            activeMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;  // Store member ID
                option.textContent = member.name;  // Show member name
                option.setAttribute('data-member-name', member.name);
                personSelect.appendChild(option);
            });

            console.log(`✅ Populated dropdown with ${activeMembers.length} active members`);
        }

        // Populate project dropdown for task form
        async function populateTaskProjectDropdown() {
            console.log('🔄 populateTaskProjectDropdown() called');
            const projectSelect = document.getElementById('itemProject');

            if (!projectSelect) {
                console.error('❌ itemProject select element not found!');
                return;
            }

            // Show loading state
            projectSelect.innerHTML = '<option value="">Loading projects...</option>';

            if (!db) {
                console.error('❌ Firebase not initialized');
                projectSelect.innerHTML = '<option value="">No Project</option>';
                return;
            }

            try {
                const snapshot = await db.collection('projects').get();
                console.log(`📦 Found ${snapshot.size} projects in database`);

                // Clear and add default option
                projectSelect.innerHTML = '<option value="">No Project</option>';

                if (snapshot.empty) {
                    console.warn('⚠️ No projects found in database');
                    return;
                }

                // Add projects to dropdown
                let addedCount = 0;
                snapshot.forEach(doc => {
                    const project = doc.data();
                    if (project.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;  // Store project ID
                        option.textContent = project.name;  // Show project name
                        option.setAttribute('data-project-name', project.name);
                        projectSelect.appendChild(option);
                        addedCount++;
                        console.log(`📁 Added project: ${project.name}`);
                    }
                });

                console.log(`✅ Populated project dropdown with ${addedCount} projects`);

            } catch (error) {
                console.error('❌ Error loading projects for dropdown:', error);
                projectSelect.innerHTML = '<option value="">No Project</option>';
            }
        }

        // Get project name by ID
        async function getProjectNameById(projectId) {
            if (!db || !projectId) return '';

            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    return doc.data().name;
                }
                return '';
            } catch (error) {
                console.error('❌ Error getting project name:', error);
                return '';
            }
        }

        // Initialize ALL sample data (tasks, team members, workspaces, projects)
        async function initializeAllSampleData() {
            if (!db) {
                alert("❌ Firebase is not connected. Please check your configuration.");
                return;
            }

            const btn = document.getElementById('initDataBtn');
            const btnIcon = document.getElementById('initBtnIcon');
            const btnText = document.getElementById('initBtnText');
            
            // Show loading state
            btn.classList.add('loading');
            btnIcon.textContent = '⏳';
            btnText.textContent = 'Initializing...';

            try {
                // Check if data already exists
                const tasksSnapshot = await db.collection('tasks').limit(1).get();
                const membersSnapshot = await db.collection('team_members').limit(1).get();
                const workspacesSnapshot = await db.collection('workspaces').limit(1).get();
                const projectsSnapshot = await db.collection('projects').limit(1).get();

                let addedCount = 0;

                // ========== TASKS ==========
                if (tasksSnapshot.empty) {
                    console.log("📦 Adding sample tasks...");
                    const sampleTasks = [
                        { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', project: 'Website Redesign', date: '2025-11-15', timeline: '3 weeks', workspace: 'Marketing', category: 'Design', tags: ['design', 'frontend', 'urgent'] },
                        { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', project: 'Mobile App Development', date: '2025-12-01', timeline: '6 weeks', workspace: 'Development', category: 'Development', tags: ['mobile', 'ios', 'android'] },
                        { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', project: 'Marketing Campaign Q4', date: '2025-10-20', timeline: '2 weeks', workspace: 'Marketing', category: 'Marketing', tags: ['campaign', 'social-media'] },
                        { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', project: 'Database Infrastructure', date: '2025-11-30', timeline: '4 weeks', workspace: 'Development', category: 'Backend', tags: ['database', 'backend', 'critical'] },
                        { name: 'Customer Portal', status: 'working', priority: 'medium', person: 'Jordan Park', project: 'Website Redesign', date: '2025-11-25', timeline: '5 weeks', workspace: 'Development', category: 'Frontend', tags: ['portal', 'customer', 'dashboard'] },
                        { name: 'API Integration', status: 'blank', priority: 'low', person: 'Taylor Wong', project: 'Mobile App Development', date: '2025-12-15', timeline: '3 weeks', workspace: 'Development', category: 'Backend', tags: ['api', 'integration'] },
                        { name: 'User Testing', status: 'working', priority: 'medium', person: 'Chris Davis', project: 'Website Redesign', date: '2025-11-10', timeline: '1 week', workspace: 'Design', category: 'QA', tags: ['testing', 'ux', 'feedback'] },
                        { name: 'Security Audit', status: 'done', priority: 'high', person: 'Morgan Lee', project: 'Database Infrastructure', date: '2025-10-15', timeline: '2 weeks', workspace: 'Development', category: 'Security', tags: ['security', 'audit', 'compliance'] }
                    ];

                    for (const task of sampleTasks) {
                        await db.collection('tasks').add({
                            ...task,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleTasks.length} tasks`);
                }

                // ========== TEAM MEMBERS ==========
                if (membersSnapshot.empty) {
                    console.log("📦 Adding team members...");
                    const sampleMembers = [
                        { name: 'Sarah Lee', email: 'sarah.lee@company.com', role: 'Project Manager', department: 'Marketing', avatar: 'SL', status: 'Active', active: true, skills: ['management', 'planning', 'coordination'] },
                        { name: 'Mike Chen', email: 'mike.chen@company.com', role: 'Lead Developer', department: 'Development', avatar: 'MC', status: 'Active', active: true, skills: ['javascript', 'react', 'node.js'] },
                        { name: 'Emily Rose', email: 'emily.rose@company.com', role: 'Marketing Lead', department: 'Marketing', avatar: 'ER', status: 'Active', active: true, skills: ['marketing', 'analytics', 'content'] },
                        { name: 'Alex Kim', email: 'alex.kim@company.com', role: 'Database Administrator', department: 'Development', avatar: 'AK', status: 'Active', active: true, skills: ['sql', 'postgresql', 'mongodb'] },
                        { name: 'Jordan Park', email: 'jordan.park@company.com', role: 'UI/UX Designer', department: 'Design', avatar: 'JP', status: 'Active', active: true, skills: ['figma', 'sketch', 'prototyping'] },
                        { name: 'Taylor Wong', email: 'taylor.wong@company.com', role: 'Backend Developer', department: 'Development', avatar: 'TW', status: 'Active', active: true, skills: ['python', 'django', 'api'] },
                        { name: 'Chris Davis', email: 'chris.davis@company.com', role: 'QA Engineer', department: 'Quality', avatar: 'CD', status: 'Active', active: true, skills: ['testing', 'automation', 'selenium'] },
                        { name: 'Morgan Lee', email: 'morgan.lee@company.com', role: 'Security Analyst', department: 'Security', avatar: 'ML', status: 'Inactive', active: false, skills: ['security', 'penetration-testing', 'compliance'] }
                    ];

                    for (const member of sampleMembers) {
                        await db.collection('team_members').add({
                            ...member,
                            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleMembers.length} team members`);
                }

                // ========== WORKSPACES ==========
                if (workspacesSnapshot.empty) {
                    console.log("📦 Adding workspaces...");
                    const sampleWorkspaces = [
                        { name: 'Marketing', icon: '🎯', color: '#667eea', description: 'Marketing team workspace', memberCount: 3, taskCount: 5, active: true },
                        { name: 'Development', icon: '💻', color: '#764ba2', description: 'Development team workspace', memberCount: 5, taskCount: 8, active: true },
                        { name: 'Design', icon: '🎨', color: '#f093fb', description: 'Design team workspace', memberCount: 2, taskCount: 4, active: true },
                        { name: 'Mobile', icon: '📱', color: '#4facfe', description: 'Mobile app development workspace', memberCount: 4, taskCount: 6, active: true }
                    ];

                    for (const workspace of sampleWorkspaces) {
                        await db.collection('workspaces').add({
                            ...workspace,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleWorkspaces.length} workspaces`);
                }

                // ========== PROJECTS ==========
                if (projectsSnapshot.empty) {
                    console.log("📦 Adding projects...");
                    const sampleProjects = [
                        { name: 'Website Redesign', description: 'Complete redesign of company website', status: 'in-progress', priority: 'high', workspace: 'Marketing', startDate: '2025-10-01', endDate: '2025-11-30', progress: 75, budget: 50000, teamMembers: ['Sarah Lee', 'Jordan Park'], tags: ['website', 'design', 'frontend'] },
                        { name: 'Mobile App Development', description: 'iOS and Android app development', status: 'in-progress', priority: 'high', workspace: 'Development', startDate: '2025-09-15', endDate: '2025-12-31', progress: 60, budget: 120000, teamMembers: ['Mike Chen', 'Taylor Wong'], tags: ['mobile', 'app', 'ios', 'android'] },
                        { name: 'Marketing Campaign Q4', description: 'Q4 2025 marketing campaign', status: 'completed', priority: 'medium', workspace: 'Marketing', startDate: '2025-09-01', endDate: '2025-10-20', progress: 100, budget: 30000, teamMembers: ['Emily Rose'], tags: ['campaign', 'marketing', 'q4'] },
                        { name: 'Database Infrastructure', description: 'Database migration and optimization', status: 'in-progress', priority: 'high', workspace: 'Development', startDate: '2025-10-15', endDate: '2025-12-15', progress: 30, budget: 80000, teamMembers: ['Alex Kim', 'Taylor Wong'], tags: ['database', 'infrastructure', 'migration'] }
                    ];

                    for (const project of sampleProjects) {
                        await db.collection('projects').add({
                            ...project,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                    console.log(`✅ Added ${sampleProjects.length} projects`);
                }

                // Success feedback
                if (addedCount > 0) {
                    btnIcon.textContent = '✅';
                    btnText.textContent = `Added ${addedCount} items!`;
                    btn.classList.remove('loading');
                    btn.classList.add('success');
                    
                    // Reload data
                    await loadTasksFromFirebase();
                    
                    alert(`✅ Successfully initialized!\n\n📊 Added ${addedCount} items to Firebase:\n- Tasks\n- Team Members\n- Workspaces\n- Projects\n\nCheck Firebase Console to see all your data!`);
                    
                    // Hide button after 3 seconds
                    setTimeout(() => {
                        btn.style.display = 'none';
                    }, 3000);
                } else {
                    btnIcon.textContent = 'ℹ️';
                    btnText.textContent = 'Data Already Exists';
                    btn.classList.remove('loading');
                    
                    alert('ℹ️ Sample data already exists in Firebase.\n\nAll collections are populated. Check Firebase Console to view your data.');
                    
                    setTimeout(() => {
                        btnIcon.textContent = '📦';
                        btnText.textContent = 'Initialize Sample Data';
                    }, 3000);
                }

            } catch (error) {
                console.error("❌ Error initializing data:", error);
                btnIcon.textContent = '❌';
                btnText.textContent = 'Error!';
                btn.classList.remove('loading');
                
                alert(`❌ Error initializing data:\n\n${error.message}\n\nCheck console for details.`);
                
                setTimeout(() => {
                    btnIcon.textContent = '📦';
                    btnText.textContent = 'Initialize Sample Data';
                    btn.classList.remove('success');
                }, 3000);
            }
        }

        // Initialize sample data in Firebase (run once) - LEGACY FUNCTION
        async function initializeSampleData() {
            if (!db) return;

            const sampleTasks = [
                { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', date: '2025-11-15', timeline: '3 weeks', workspace: 'Marketing' },
                { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', date: '2025-12-01', timeline: '6 weeks', workspace: 'Development' },
                { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', date: '2025-10-20', timeline: '2 weeks', workspace: 'Marketing' },
                { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', date: '2025-11-30', timeline: '4 weeks', workspace: 'Development' }
            ];

            try {
                // Check if tasks already exist
                const snapshot = await db.collection('tasks').limit(1).get();
                
                if (snapshot.empty) {
                    console.log("📦 Initializing sample data...");
                    
                    for (const task of sampleTasks) {
                        await db.collection('tasks').add({
                            ...task,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    console.log("✅ Sample data initialized!");
                } else {
                    console.log("ℹ️ Data already exists in Firebase");
                }
            } catch (error) {
                console.error("❌ Error initializing data:", error);
            }
        }

        // Prevent concurrent loading
        let isLoadingTasks = false;

        // Load all tasks from Firestore
        async function loadTasksFromFirebase() {
            if (!db) {
                console.warn("Firebase not initialized, using local data");
                return;
            }

            // Prevent concurrent loading
            if (isLoadingTasks) {
                console.log("⏭️ Task loading already in progress, skipping...");
                return;
            }

            isLoadingTasks = true;
            showSpinner('Loading tasks...');
            console.log("📥 Loading tasks from Firebase...");

            try {
                // Fetch all data in parallel for better performance
                const [tasksSnapshot, membersSnapshot, projectsSnapshot] = await Promise.all([
                    db.collection('tasks').orderBy('createdAt', 'desc').get(),
                    db.collection('team_members').get(),
                    db.collection('projects').get()
                ]);

                // Create lookup maps for fast access
                const membersMap = {};
                membersSnapshot.forEach(doc => {
                    membersMap[doc.id] = doc.data().name;
                });

                const projectsMap = {};
                projectsSnapshot.forEach(doc => {
                    projectsMap[doc.id] = doc.data().name;
                });

                // Clear tasks array to prevent duplicates
                tasks = [];

                // Process tasks with cached data (no more individual Firebase calls!)
                tasksSnapshot.forEach(doc => {
                    const taskData = doc.data();

                    // Get member name from map (much faster!)
                    let personName = taskData.person;
                    if (taskData.assignedTo && membersMap[taskData.assignedTo]) {
                        personName = membersMap[taskData.assignedTo];
                    }

                    // Get project name from map (much faster!)
                    let projectName = taskData.project || '';
                    if (taskData.projectId && projectsMap[taskData.projectId]) {
                        projectName = projectsMap[taskData.projectId];
                    }

                    tasks.push({
                        id: doc.id,
                        ...taskData,
                        personName: personName,      // Store display name
                        project: projectName         // Store real-time project name
                    });
                });

                // Check if any filters are active and re-apply them
                // Reset allTasks when loading fresh data
                allTasks = [];

                const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '');

                if (hasActiveFilters || currentProjectFilter) {
                    console.log(`🔄 Re-applying active filters`);
                    applyTaskFilters();
                } else if (isMyTasksActive) {
                    console.log(`🔄 Re-applying My Tasks filter`);
                    toggleMyTasks();
                    toggleMyTasks(); // Toggle twice to refresh with new data
                } else {
                    renderTasks();
                }

                updateDashboardStats();
                console.log(`✅ Loaded ${tasks.length} tasks from Firebase (optimized batch loading)`);
            } catch (error) {
                console.error("❌ Error loading tasks:", error);
            } finally {
                isLoadingTasks = false;
                hideSpinner();
            }
        }

        // Add task to Firestore
        async function addTaskToFirebase(task) {
            if (!db) return;

            try {
                const docRef = await db.collection('tasks').add({
                    ...task,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log("✅ Task added with ID:", docRef.id);
                return docRef.id;
            } catch (error) {
                console.error("❌ Error adding task:", error);
            }
        }

        // Update task in Firestore
        async function updateTaskInFirebase(taskId, taskData) {
            if (!db) return;

            try {
                await db.collection('tasks').doc(taskId).update({
                    ...taskData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log("✅ Task updated:", taskId);
            } catch (error) {
                console.error("❌ Error updating task:", error);
            }
        }

        // Delete task from Firestore
        async function deleteTaskFromFirebase(taskId) {
            if (!db) return;

            try {
                await db.collection('tasks').doc(taskId).delete();
                console.log("✅ Task deleted:", taskId);
            } catch (error) {
                console.error("❌ Error deleting task:", error);
            }
        }

        // Real-time listener for tasks
        let realtimeListenerUnsubscribe = null;

        function setupRealtimeListener() {
            if (!db) return;

            // Prevent setting up multiple listeners
            if (realtimeListenerUnsubscribe) {
                console.log("⏭️ Real-time listener already set up, skipping...");
                return;
            }

            console.log("📡 Setting up real-time listener...");
            realtimeListenerUnsubscribe = db.collection('tasks').onSnapshot(async (snapshot) => {
                // Skip if we're in the middle of a manual operation
                if (isManualOperation) {
                    console.log("⏭️ Skipping real-time update (manual operation in progress)");
                    return;
                }

                const changes = snapshot.docChanges();
                if (changes.length > 0) {
                    console.log("📡 Real-time update detected, reloading tasks...");
                    await loadTasksFromFirebase();

                    // Reload team members if on team page
                    const teamPage = document.getElementById('teamPage');
                    if (teamPage && teamPage.classList.contains('active')) {
                        await loadTeamMembersWithStats();
                    }
                }
            });
        }

        // ========================================
        // APPLICATION CODE
        // ========================================

        let tasks = [
            { name: 'Website Redesign', status: 'working', priority: 'high', person: 'Sarah Lee', date: '2025-11-15', timeline: '3 weeks' },
            { name: 'Mobile App Development', status: 'working', priority: 'high', person: 'Mike Chen', date: '2025-12-01', timeline: '6 weeks' },
            { name: 'Marketing Campaign', status: 'done', priority: 'medium', person: 'Emily Rose', date: '2025-10-20', timeline: '2 weeks' },
            { name: 'Database Migration', status: 'stuck', priority: 'high', person: 'Alex Kim', date: '2025-11-30', timeline: '4 weeks' },
            { name: 'Customer Portal', status: 'working', priority: 'medium', person: 'Jordan Park', date: '2025-11-25', timeline: '5 weeks' },
            { name: 'API Integration', status: 'blank', priority: 'low', person: 'Taylor Wong', date: '2025-12-15', timeline: '3 weeks' },
            { name: 'User Testing', status: 'working', priority: 'medium', person: 'Chris Davis', date: '2025-11-10', timeline: '1 week' },
            { name: 'Security Audit', status: 'done', priority: 'high', person: 'Morgan Lee', date: '2025-10-15', timeline: '2 weeks' }
        ];

        let projects = [
            {
                name: 'Website Redesign',
                description: 'Complete overhaul of company website with modern design',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-10-01',
                endDate: '2025-12-31',
                progress: 75,
                budget: 50000,
                teamMembers: ['Sarah Lee', 'Mike Chen'],
                tags: ['design', 'frontend', 'urgent']
            },
            {
                name: 'Mobile App Development',
                description: 'Build native mobile app for iOS and Android',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-09-15',
                endDate: '2025-12-15',
                progress: 60,
                budget: 120000,
                teamMembers: ['Mike Chen', 'Taylor Wong'],
                tags: ['mobile', 'development']
            },
            {
                name: 'Marketing Campaign Q4',
                description: 'Q4 marketing initiatives and social media campaigns',
                status: 'completed',
                priority: 'medium',
                startDate: '2025-10-01',
                endDate: '2025-10-31',
                progress: 100,
                budget: 30000,
                teamMembers: ['Emily Rose'],
                tags: ['marketing', 'social-media']
            },
            {
                name: 'Database Infrastructure',
                description: 'Database migration and optimization project',
                status: 'in-progress',
                priority: 'high',
                startDate: '2025-10-15',
                endDate: '2025-12-15',
                progress: 30,
                budget: 80000,
                teamMembers: ['Alex Kim', 'Taylor Wong'],
                tags: ['database', 'infrastructure', 'backend']
            }
        ];

        let editingIndex = -1;
        let editingProjectIndex = -1;
        let isManualOperation = false;  // Flag to prevent listener conflicts

        function toggleSection(sectionName) {
            const section = event.currentTarget.closest('.sidebar-section');
            const arrow = document.getElementById(sectionName + 'Arrow');
            
            section.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                arrow.textContent = '▶';
            } else {
                arrow.textContent = '▼';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('collapseIcon');
            sidebar.classList.toggle('collapsed');
            icon.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
        }

        function switchPage(pageName, skipFilterClear = false) {
            const pages = ['dashboard', 'projectslist', 'tasks', 'team', 'reports'];
            pages.forEach(p => {
                const page = document.getElementById(p + 'Page');
                if (page) page.classList.remove('active');
            });

            const targetPage = document.getElementById(pageName + 'Page');
            if (targetPage) targetPage.classList.add('active');

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            // Reload data when switching to specific pages
            if (pageName === 'tasks' && db) {
                // Clear filter only if not coming from viewProjectTasks
                if (!skipFilterClear) {
                    // Hide filter panel and clear all filters when navigating directly to tasks
                    const panel = document.getElementById('taskFilterPanel');
                    if (panel) {
                        panel.style.display = 'none';
                    }
                    clearAllTaskFilters();
                }
                loadTasksFromFirebase();
            } else if (pageName === 'team' && db) {
                loadTeamMembersWithStats();
            } else if (pageName === 'dashboard') {
                updateDashboardStats();
            } else if (pageName === 'projectslist') {
                if (db) {
                    loadProjectsFromFirebase();
                } else {
                    renderProjects();
                }
            }
        }

        function updateDashboardStats() {
            console.log('📊 Updating dashboard with real-time data...');

            // Update task statistics
            const totalTasks = tasks.length;
            const workingTasks = tasks.filter(t => t.status === 'working').length;
            const doneTasks = tasks.filter(t => t.status === 'done').length;
            const stuckTasks = tasks.filter(t => t.status === 'stuck').length;

            document.getElementById('totalItems').textContent = totalTasks;
            document.getElementById('workingItems').textContent = workingTasks;
            document.getElementById('doneItems').textContent = doneTasks;
            document.getElementById('stuckItems').textContent = stuckTasks;

            console.log(`✅ Task stats: ${totalTasks} total, ${workingTasks} in progress, ${doneTasks} done, ${stuckTasks} stuck`);

            // Update project progress
            renderProjectProgress();

            // Update recent activity
            renderRecentActivity();
        }

        // Render project progress on dashboard
        function renderProjectProgress() {
            const progressList = document.getElementById('projectProgressList');
            if (!progressList) return;

            if (projects.length === 0) {
                progressList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No projects found</div>';
                return;
            }

            // Sort by progress (incomplete first, then by priority)
            const sortedProjects = [...projects]
                .filter(p => p.name && p.progress !== undefined)
                .sort((a, b) => {
                    // Show incomplete projects first
                    if (a.progress < 100 && b.progress >= 100) return -1;
                    if (a.progress >= 100 && b.progress < 100) return 1;
                    // Then by progress percentage
                    return b.progress - a.progress;
                })
                .slice(0, 6); // Show top 6 projects

            progressList.innerHTML = sortedProjects.map(project => {
                const progress = project.progress || 0;
                let barColor = '#0073ea'; // Default blue

                if (progress === 100) {
                    barColor = '#00c875'; // Green for complete
                } else if (progress < 30) {
                    barColor = '#e44258'; // Red for low progress
                } else if (progress < 60) {
                    barColor = '#fdab3d'; // Orange for medium
                }

                return `
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-name">${project.name}</span>
                            <span class="progress-percentage">${progress}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progress}%; background: ${barColor}"></div>
                        </div>
                    </div>
                `;
            }).join('');

            console.log(`✅ Rendered ${sortedProjects.length} projects on dashboard`);
        }

        // Render recent activity on dashboard
        function renderRecentActivity() {
            const activityList = document.getElementById('recentActivityList');
            if (!activityList) return;

            // Get recent tasks (sorted by updatedAt or createdAt)
            const recentTasks = [...tasks]
                .filter(t => t.name && t.personName)
                .sort((a, b) => {
                    const aTime = a.updatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                    const bTime = b.updatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                    return bTime - aTime;
                })
                .slice(0, 5); // Show 5 most recent

            if (recentTasks.length === 0) {
                activityList.innerHTML = '<li style="text-align: center; padding: 20px; color: #999;">No recent activity</li>';
                return;
            }

            activityList.innerHTML = recentTasks.map(task => {
                let icon = '📝';
                let action = 'updated';

                if (task.status === 'done') {
                    icon = '✅';
                    action = 'completed';
                } else if (task.status === 'stuck') {
                    icon = '🚨';
                    action = 'marked as stuck';
                } else if (task.status === 'working') {
                    icon = '⚙️';
                    action = 'is working on';
                }

                // Calculate time ago
                const timestamp = task.updatedAt?.toMillis?.() || task.createdAt?.toMillis?.() || Date.now();
                const timeAgo = getTimeAgo(timestamp);

                const projectText = task.project ? ` in ${task.project}` : '';

                return `
                    <li class="activity-item">
                        <div class="activity-icon">${icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${task.personName}</strong> ${action} <strong>${task.name}</strong>${projectText}
                            </div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </li>
                `;
            }).join('');

            console.log(`✅ Rendered ${recentTasks.length} recent activities`);
        }

        // Helper function to calculate time ago
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return days === 1 ? '1 day ago' : `${days} days ago`;
            if (hours > 0) return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
            if (minutes > 0) return minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
            return 'Just now';
        }

        function getStatusText(status) {
            const statusMap = {
                'working': 'Working on it',
                'done': 'Done',
                'stuck': 'Stuck',
                'blank': 'Not Started'
            };
            return statusMap[status] || status;
        }

        // Helper function to format name as "FirstName LastInitial."
        function formatNameWithInitial(fullName) {
            if (!fullName || fullName === 'Unknown') return fullName;

            const nameParts = fullName.trim().split(' ');
            if (nameParts.length === 1) {
                // Only first name, return as is
                return nameParts[0];
            }

            // Get first name and first letter of last name
            const firstName = nameParts[0];
            const lastNameInitial = nameParts[nameParts.length - 1][0];
            return `${firstName} ${lastNameInitial}.`;
        }

        function renderTasks() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = tasks.map((task, index) => {
                const fullName = task.personName || task.person || 'Unknown';
                const displayName = formatNameWithInitial(fullName);
                const avatarText = fullName.split(' ').map(n => n[0]).join('');

                return `
                <div class="table-row" data-index="${index}">
                    <div class="table-cell" data-label="#">
                        <span class="row-number">${index + 1}</span>
                    </div>
                    <div class="table-cell" data-label="Task">
                        <span class="task-name">${task.name}</span>
                    </div>
                    <div class="table-cell" data-label="Status">
                        <div class="status-badge-wrapper">
                            <div class="status-badge status-${task.status}" onclick="toggleStatusPopup(event, ${index})">
                                ${getStatusText(task.status)}
                            </div>
                            <div class="status-popup" id="status-popup-${index}">
                                <div class="status-popup-option blank" onclick="changeTaskStatus(${index}, 'blank')">
                                    Not Started
                                </div>
                                <div class="status-popup-option working" onclick="changeTaskStatus(${index}, 'working')">
                                    Working on it
                                </div>
                                <div class="status-popup-option stuck" onclick="changeTaskStatus(${index}, 'stuck')">
                                    Stuck
                                </div>
                                <div class="status-popup-option done" onclick="changeTaskStatus(${index}, 'done')">
                                    Done
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Priority">
                        <div class="priority">
                            <span class="priority-dot priority-${task.priority}"></span>
                            <span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Assigned To">
                        <div class="person-cell">
                            <div class="person-avatar">${avatarText}</div>
                            <span>${displayName}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Project">
                        ${task.project ? `<span class="project-badge" title="${task.project}">${task.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                    </div>
                    <div class="table-cell" data-label="Date">
                        <span class="date-cell">${formatDateForDisplay(task.date)}</span>
                    </div>
                    <div class="table-cell" data-label="Timeline">
                        <span class="date-cell">${task.timeline}</span>
                    </div>
                    <div class="table-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-action="edit" data-index="${index}" title="Edit task">
                                ✏️
                            </button>
                            <button class="action-btn clone-btn" data-action="clone" data-index="${index}" title="Clone task">
                                📋
                            </button>
                            <button class="action-btn delete-btn" data-action="delete" data-index="${index}" title="Delete task">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Add event listeners to action buttons
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (action === 'edit') {
                        editTask(index);
                    } else if (action === 'clone') {
                        cloneTask(index);
                    } else if (action === 'delete') {
                        deleteTask(index);
                    }
                });
            });
        }

        // ========================================
        // MY TASKS FILTER FUNCTIONALITY
        // ========================================
        let isMyTasksActive = false;
        let allTasks = []; // Store original tasks

        async function toggleMyTasks() {
            const myTasksBtn = document.getElementById('myTasksBtn');
            isMyTasksActive = !isMyTasksActive;

            if (isMyTasksActive) {
                // Activate My Tasks filter
                myTasksBtn.classList.add('active');

                // Get current logged-in user
                const loggedInUserData = sessionStorage.getItem('loggedInUser');
                if (!loggedInUserData) {
                    console.error('No logged in user found');
                    isMyTasksActive = false;
                    myTasksBtn.classList.remove('active');
                    return;
                }

                const currentUser = JSON.parse(loggedInUserData);
                const currentUserId = currentUser.id;

                console.log(`Activating My Tasks filter for user ID: ${currentUserId}`);

                // Ensure filter dropdowns are populated
                await populateFilterDropdowns();

                // Set the assignedTo filter to current user
                taskFilters.assignedTo = currentUserId;

                // Update the filter dropdown to show current user
                const assignedToSelect = document.getElementById('filterAssignedTo');
                if (assignedToSelect) {
                    assignedToSelect.value = currentUserId;
                }

                // Apply the filters using the existing filter system
                applyTaskFilters();

                // Update active filters display to show the filter tag
                updateActiveFiltersDisplay();
            } else {
                // Deactivate My Tasks filter
                myTasksBtn.classList.remove('active');

                console.log(`Deactivating My Tasks filter`);

                // Remove the assignedTo filter
                taskFilters.assignedTo = '';

                // Update the filter dropdown
                const assignedToSelect = document.getElementById('filterAssignedTo');
                if (assignedToSelect) {
                    assignedToSelect.value = '';
                }

                // Apply the filters (which will now show all tasks if no other filters are active)
                applyTaskFilters();

                // Update active filters display to remove the filter tag
                updateActiveFiltersDisplay();
            }

            updateTaskStats();
        }

        // ========================================
        // TASK SORTING FUNCTIONALITY
        // ========================================
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        function sortTasks(column) {
            // Toggle direction if clicking same column, otherwise default to ascending
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Clear all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon';
            });

            // Set active sort icon
            const sortIcon = document.getElementById(`sort-${column}`);
            if (sortIcon) {
                sortIcon.className = `sort-icon ${currentSortDirection}`;
            }

            // Sort the tasks array
            tasks.sort((a, b) => {
                let valueA, valueB;

                switch (column) {
                    case 'name':
                        valueA = (a.name || '').toLowerCase();
                        valueB = (b.name || '').toLowerCase();
                        break;

                    case 'status':
                        // Custom order: blank, working, stuck, done
                        const statusOrder = { 'blank': 0, 'working': 1, 'stuck': 2, 'done': 3 };
                        valueA = statusOrder[a.status] ?? 999;
                        valueB = statusOrder[b.status] ?? 999;
                        break;

                    case 'priority':
                        // Custom order: high, medium, low
                        const priorityOrder = { 'high': 0, 'medium': 1, 'low': 2 };
                        valueA = priorityOrder[a.priority] ?? 999;
                        valueB = priorityOrder[b.priority] ?? 999;
                        break;

                    case 'person':
                        valueA = (a.personName || a.person || '').toLowerCase();
                        valueB = (b.personName || b.person || '').toLowerCase();
                        break;

                    case 'project':
                        valueA = (a.project || '').toLowerCase();
                        valueB = (b.project || '').toLowerCase();
                        break;

                    case 'date':
                        // Convert dd/mm/yyyy to comparable format
                        valueA = convertDateForSort(a.date);
                        valueB = convertDateForSort(b.date);
                        break;

                    default:
                        return 0;
                }

                // Compare values
                if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Check if any filters are active
            const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '');

            // Re-render the sorted tasks with filters if active
            if (hasActiveFilters) {
                applyTaskFilters();
            } else {
                renderTasks();
            }
        }

        // Helper function to convert date for sorting
        function convertDateForSort(dateString) {
            if (!dateString) return '';

            // Handle yyyy/mm/dd format (display format)
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length !== 3) return dateString;

                // Check if it's yyyy/mm/dd (year is 4 digits and in first position)
                if (parts[0].length === 4) {
                    // Already yyyy/mm/dd, just remove slashes for sorting
                    return parts.join('');
                }

                // It's dd/mm/yyyy, convert for sorting
                const [day, month, year] = parts;
                return `${year}${month.padStart(2, '0')}${day.padStart(2, '0')}`;
            }

            // Handle yyyy-mm-dd format
            if (dateString.includes('-')) {
                return dateString.replace(/-/g, '');
            }

            return dateString;
        }

        async function deleteTask(index) {
            const task = tasks[index];

            // Show confirmation dialog with task name
            if (!confirm(`Are you sure you want to delete the task "${task.name}"?\n\nThis action cannot be undone.`)) {
                return; // User cancelled
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            try {
                // Delete from Firebase if task has an ID
                if (task.id && db) {
                    await deleteTaskFromFirebase(task.id);
                    console.log("✅ Task deleted from Firebase:", task.id);
                }

                // Reload tasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();

                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);

            } catch (error) {
                console.error("❌ Error deleting task:", error);
                alert('❌ Error deleting task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        }

        function editTask(index) {
            editingIndex = index;
            const task = tasks[index];

            // Update modal title
            document.getElementById('modalTitle').textContent = 'Edit Task';

            // Open modal first
            document.getElementById('taskModal').classList.add('active');

            // Show modal spinner
            showModalSpinner();

            // Populate both dropdowns first, then fill in task data
            Promise.all([
                populateAssignToDropdown(),
                populateTaskProjectDropdown()
            ]).then(() => {
                // Populate form with task data
                document.getElementById('itemName').value = task.name;
                document.getElementById('itemStatus').value = task.status;
                document.getElementById('itemPriority').value = task.priority;

                // Set the assignedTo (member ID) in dropdown
                if (task.assignedTo) {
                    document.getElementById('itemPerson').value = task.assignedTo;
                } else if (task.person) {
                    // Fallback for old data - try to find by name
                    const personSelect = document.getElementById('itemPerson');
                    const options = personSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].getAttribute('data-member-name') === task.person) {
                            personSelect.value = options[i].value;
                            break;
                        }
                    }
                }

                // Set the project (project ID) in dropdown
                if (task.projectId) {
                    // New format: uses project ID
                    document.getElementById('itemProject').value = task.projectId;
                } else if (task.project) {
                    // Old format: try to find by name
                    const projectSelect = document.getElementById('itemProject');
                    const options = projectSelect.options;
                    for (let i = 0; i < options.length; i++) {
                        if (options[i].getAttribute('data-project-name') === task.project) {
                            projectSelect.value = options[i].value;
                            break;
                        }
                    }
                }

                // Set dates using helper function (converts dd/mm/yyyy to yyyy-mm-dd for input)
                setDateInputValue(document.getElementById('itemStartDate'), task.startDate);
                setDateInputValue(document.getElementById('itemDate'), task.date);
                document.getElementById('itemTimeline').value = task.timeline;

                // Hide modal spinner after data is loaded
                hideModalSpinner();
            }).catch(error => {
                console.error('Error loading task data:', error);
                hideModalSpinner();
            });

            // Change button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Update Task';
        }

        // ========================================
        // STATUS POPUP FUNCTIONALITY
        // ========================================
        let activeStatusPopup = null;

        function toggleStatusPopup(event, index) {
            event.stopPropagation();

            const popupId = `status-popup-${index}`;
            const popup = document.getElementById(popupId);

            if (!popup) return;

            // Close any other open popup
            if (activeStatusPopup && activeStatusPopup !== popup) {
                activeStatusPopup.classList.remove('active');
            }

            // Toggle current popup
            popup.classList.toggle('active');
            activeStatusPopup = popup.classList.contains('active') ? popup : null;
        }

        async function changeTaskStatus(index, newStatus) {
            const task = tasks[index];

            if (!task || !task.id) {
                console.error('Task not found or missing ID');
                return;
            }

            // Close popup
            if (activeStatusPopup) {
                activeStatusPopup.classList.remove('active');
                activeStatusPopup = null;
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            try {
                // Update in Firebase
                await db.collection('tasks').doc(task.id).update({
                    status: newStatus
                });

                console.log(`✅ Task status updated to ${newStatus}`);

                // Update local array
                task.status = newStatus;

                // Re-render tasks (will apply filters if active)
                const hasActiveFilters = taskFilters && Object.values(taskFilters).some(v => v !== '');
                if (hasActiveFilters) {
                    applyTaskFilters();
                } else {
                    renderTasks();
                }

                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                }, 500);

            } catch (error) {
                console.error('❌ Error updating task status:', error);
                alert('Error updating task status: ' + error.message);
                isManualOperation = false;
            }
        }

        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            if (activeStatusPopup && !event.target.closest('.status-badge-wrapper')) {
                activeStatusPopup.classList.remove('active');
                activeStatusPopup = null;
            }
        });

        async function cloneTask(index) {
            const task = tasks[index];

            // Show confirmation dialog
            if (!confirm(`Are you sure you want to duplicate the task "${task.name}"?`)) {
                return; // User cancelled
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            // Create a copy of the task with a new name
            const clonedTask = {
                name: task.name + ' (Copy)',
                status: task.status,
                priority: task.priority,
                assignedTo: task.assignedTo,
                person: task.person,
                personName: task.personName,
                project: task.project || '',
                projectId: task.projectId,
                date: task.date,
                startDate: task.startDate,
                timeline: task.timeline,
                createdAt: new Date()
            };

            try {
                // Add cloned task to Firebase
                if (db) {
                    await addTaskToFirebase(clonedTask);
                    console.log("✅ Task cloned successfully");
                }

                // Reload tasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();

                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);

            } catch (error) {
                console.error("❌ Error cloning task:", error);
                alert('❌ Error cloning task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        }

        function openModal() {
            console.log('🚪 openModal() called');
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Create New Task';
            document.getElementById('taskForm').reset();

            // Populate dropdowns
            console.log('📞 Calling populateAssignToDropdown()...');
            populateAssignToDropdown();

            console.log('📞 Calling populateTaskProjectDropdown()...');
            populateTaskProjectDropdown();

            document.getElementById('taskModal').classList.add('active');
            console.log('✅ Modal opened');

            // Reset button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Create Task';
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskForm').reset();
            editingIndex = -1;
            
            // Reset button text
            const submitBtn = document.querySelector('#taskForm button[type="submit"]');
            submitBtn.textContent = 'Create Task';
        }

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate that a team member is selected
            const assignedToId = document.getElementById('itemPerson').value;
            if (!assignedToId || assignedToId.trim() === '') {
                alert('⚠️ Please select a team member to assign this task to.');
                document.getElementById('itemPerson').focus();
                return;
            }

            // Set flag to prevent real-time listener interference
            isManualOperation = true;

            const personSelect = document.getElementById('itemPerson');
            const selectedOption = personSelect.options[personSelect.selectedIndex];
            const personName = selectedOption.getAttribute('data-member-name') || selectedOption.textContent;

            // Get project ID and name
            const projectSelect = document.getElementById('itemProject');
            const projectId = projectSelect.value;
            const projectOption = projectSelect.options[projectSelect.selectedIndex];
            const projectName = projectOption.getAttribute('data-project-name') || projectOption.textContent || '';

            const newTask = {
                name: document.getElementById('itemName').value,
                status: document.getElementById('itemStatus').value,
                priority: document.getElementById('itemPriority').value,
                assignedTo: assignedToId,  // Store member ID
                person: personName,  // Store name for backwards compatibility
                projectId: projectId,  // Store project ID
                project: projectName,  // Store project name for backwards compatibility and display
                startDate: getDateInputValue(document.getElementById('itemStartDate')),  // Convert to dd/mm/yyyy
                date: getDateInputValue(document.getElementById('itemDate')),  // Convert to dd/mm/yyyy
                timeline: document.getElementById('itemTimeline').value
            };

            try {
                if (editingIndex >= 0) {
                    const task = tasks[editingIndex];
                    
                    // Update in Firebase if task has an ID
                    if (task.id && db) {
                        await updateTaskInFirebase(task.id, newTask);
                        console.log("✅ Task updated in Firebase:", task.id);
                    }
                } else {
                    // Add to Firebase
                    if (db) {
                        const taskId = await addTaskToFirebase(newTask);
                        console.log("✅ Task added to Firebase:", taskId);
                    }
                }

                closeModal();
                
                // Reload tasks from Firebase to prevent duplicates
                await loadTasksFromFirebase();
                
                // Re-enable real-time listener after a short delay
                setTimeout(() => {
                    isManualOperation = false;
                    console.log("✅ Real-time listener re-enabled");
                }, 1000);
                
            } catch (error) {
                console.error("❌ Error saving task:", error);
                alert('❌ Error saving task: ' + error.message);
                isManualOperation = false;  // Reset flag on error
            }
        });

        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ========================================
        // TEAM MEMBER MODAL FUNCTIONS
        // ========================================
        
        let editingMemberId = null;

        function openMemberModal() {
            editingMemberId = null;
            document.getElementById('memberModalTitle').textContent = 'Add Team Member';
            document.getElementById('memberModal').classList.add('active');
            document.getElementById('memberForm').reset();
            
            // Set default status
            document.getElementById('memberStatus').value = 'Active';
            
            // Reset button text
            const submitBtn = document.querySelector('#memberForm button[type="submit"]');
            submitBtn.textContent = 'Add Member';
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('active');
            document.getElementById('memberForm').reset();
            editingMemberId = null;
        }

        function editMember(member, index) {
            editingMemberId = member.id;
            
            // Update modal title
            document.getElementById('memberModalTitle').textContent = 'Edit Team Member';
            
            // Populate form with member data
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberEmail').value = member.email;
            document.getElementById('memberRole').value = member.role;
            document.getElementById('memberDepartment').value = member.department;
            document.getElementById('memberAvatar').value = member.avatar;
            document.getElementById('memberStatus').value = member.status || 'Active';
            document.getElementById('memberSkills').value = member.skills ? member.skills.join(', ') : '';
            
            // Change button text
            const submitBtn = document.querySelector('#memberForm button[type="submit"]');
            submitBtn.textContent = 'Update Member';
            
            // Open modal
            document.getElementById('memberModal').classList.add('active');
        }

        // Handle member form submission
        document.getElementById('memberForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const skillsInput = document.getElementById('memberSkills').value;
            const skillsArray = skillsInput ? skillsInput.split(',').map(s => s.trim()).filter(s => s) : [];
            
            const memberData = {
                name: document.getElementById('memberName').value,
                email: document.getElementById('memberEmail').value,
                role: document.getElementById('memberRole').value,
                department: document.getElementById('memberDepartment').value,
                avatar: document.getElementById('memberAvatar').value.toUpperCase(),
                status: document.getElementById('memberStatus').value,
                active: document.getElementById('memberStatus').value === 'Active',
                skills: skillsArray
            };

            try {
                if (editingMemberId) {
                    // Get old member data to check if name changed
                    const oldMemberDoc = await db.collection('team_members').doc(editingMemberId).get();
                    const oldMemberData = oldMemberDoc.data();
                    const nameChanged = oldMemberData.name !== memberData.name;
                    
                    // Update existing member
                    if (db) {
                        await db.collection('team_members').doc(editingMemberId).update({
                            ...memberData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("✅ Member updated:", editingMemberId);
                    }
                    
                    // If name changed, update all tasks assigned to this member
                    if (nameChanged && db) {
                        console.log(`📝 Name changed from "${oldMemberData.name}" to "${memberData.name}", updating tasks...`);
                        
                        const tasksSnapshot = await db.collection('tasks')
                            .where('assignedTo', '==', editingMemberId)
                            .get();
                        
                        const batch = db.batch();
                        let updateCount = 0;
                        
                        tasksSnapshot.forEach(doc => {
                            batch.update(doc.ref, {
                                person: memberData.name,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            updateCount++;
                        });
                        
                        if (updateCount > 0) {
                            await batch.commit();
                            console.log(`✅ Updated ${updateCount} tasks with new member name`);
                        }
                    }
                } else {
                    // Add new member
                    if (db) {
                        await db.collection('team_members').add({
                            ...memberData,
                            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("✅ Member added");
                    }
                }

                // Reload team members
                await loadTeamMembersWithStats();
                
                // Reload assign to dropdown if task modal is open
                if (document.getElementById('taskModal').classList.contains('active')) {
                    await populateAssignToDropdown();
                }
                
                closeMemberModal();
                
                alert(editingMemberId ? '✅ Team member updated successfully!' : '✅ Team member added successfully!');
                
            } catch (error) {
                console.error("❌ Error saving member:", error);
                alert('❌ Error saving team member: ' + error.message);
            }
        });

        document.getElementById('memberModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMemberModal();
            }
        });

        // ========================================
        // PROJECT CRUD FUNCTIONS
        // ========================================

        function renderProjects() {
            const projectsGrid = document.getElementById('projectsGrid');
            if (!projectsGrid) return;

            projectsGrid.innerHTML = projects.map((project, index) => `
                <div class="project-card">
                    <div class="project-card-header">
                        <div>
                            <div class="project-card-title">${project.name}</div>
                            <div style="display: flex; gap: 8px; align-items: center; margin-top: 8px;">
                                <span class="project-status-badge ${project.status}">${formatStatus(project.status)}</span>
                                ${project.sdlc ? `<span class="project-status-badge" style="background: #0073ea; color: white;"> ${project.sdlc}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="project-card-description">${project.description}</div>

                    <div class="project-progress">
                        <div class="project-progress-label">
                            <span>Progress</span>
                            <span>${project.progress}%</span>
                        </div>
                        <div class="project-progress-bar">
                            <div class="project-progress-fill" style="width: ${project.progress}%"></div>
                        </div>
                    </div>

                    <div class="project-card-meta">
                        <div class="project-meta-item">
                            <span class="project-meta-icon">📅</span>
                            <span>${formatDateForDisplay(project.startDate)} - ${formatDateForDisplay(project.endDate)}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">💰</span>
                            <span>฿${project.budget.toLocaleString()}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">👥</span>
                            <span>${project.teamMembers && project.teamMembers.length > 0 ? project.teamMembers.length + ' members' : 'No members'}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="project-meta-icon">⚡</span>
                            <span>${formatPriority(project.priority)}</span>
                        </div>
                    </div>

                    ${project.teamMembers && project.teamMembers.length > 0 ? `
                        <div class="project-team-members" style="margin-top: 12px; padding: 12px; background: #f6f7fb; border-radius: 8px;">
                            <div style="font-size: 12px; font-weight: 700; color: #676879; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Team Members</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${project.teamMembers.map(member => `
                                    <span style="background: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; color: #323338; border: 1px solid #e6e9ef;">${formatNameWithInitial(member)}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${project.tags && project.tags.length > 0 ? `
                        <div class="project-tags">
                            ${project.tags.map(tag => `<span class="project-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}

                    <div class="project-card-actions">
                        <button class="project-action-btn" onclick="viewProjectTasks('${project.id}', '${project.name}')">
                            📋 Tasks
                        </button>
                        <button class="project-action-btn" onclick="editProject(${index})">
                            ✏️ Edit
                        </button>
                        <button class="project-action-btn delete" onclick="deleteProject(${index})">
                            🗑️ Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function formatStatus(status) {
            return status.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function formatPriority(priority) {
            return priority.charAt(0).toUpperCase() + priority.slice(1);
        }

        // ========================================
        // PROJECT FIREBASE FUNCTIONS
        // ========================================

        // Add project to Firebase
        async function addProjectToFirebase(projectData) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return null;
            }

            try {
                const docRef = await db.collection('projects').add({
                    ...projectData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('✅ Project added to Firebase with ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('❌ Error adding project to Firebase:', error);
                throw error;
            }
        }

        // Update project in Firebase
        async function updateProjectInFirebase(projectId, projectData) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            try {
                await db.collection('projects').doc(projectId).update({
                    ...projectData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('✅ Project updated in Firebase:', projectId);
            } catch (error) {
                console.error('❌ Error updating project in Firebase:', error);
                throw error;
            }
        }

        // Delete project from Firebase
        async function deleteProjectFromFirebase(projectId) {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            try {
                await db.collection('projects').doc(projectId).delete();
                console.log('✅ Project deleted from Firebase:', projectId);
            } catch (error) {
                console.error('❌ Error deleting project from Firebase:', error);
                throw error;
            }
        }

        // Load projects from Firebase
        async function loadProjectsFromFirebase() {
            if (!db) {
                console.error('❌ Firebase not initialized');
                return;
            }

            showSpinner('Loading projects...');

            try {
                const snapshot = await db.collection('projects')
                    .orderBy('createdAt', 'desc')
                    .get();

                projects = [];
                snapshot.forEach(doc => {
                    projects.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log(`✅ Loaded ${projects.length} projects from Firebase`);
                renderProjects();
            } catch (error) {
                console.error('❌ Error loading projects from Firebase:', error);
                // If orderBy fails (no index), try without ordering
                try {
                    const snapshot = await db.collection('projects').get();
                    projects = [];
                    snapshot.forEach(doc => {
                        projects.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    console.log(`✅ Loaded ${projects.length} projects from Firebase (fallback)`);
                    renderProjects();
                } catch (fallbackError) {
                    console.error('❌ Fallback also failed:', fallbackError);
                }
            } finally {
                hideSpinner();
            }
        }

        // Populate team members dropdown for project form
        async function populateProjectTeamMembersDropdown() {
            console.log('🔄 populateProjectTeamMembersDropdown() called');
            const selectElement = document.getElementById('projectTeamMembers');

            if (!db) {
                console.error('❌ Firebase not initialized');
                selectElement.innerHTML = '<option value="">Firebase not connected</option>';
                return;
            }

            try {
                // FIXED: Changed from 'teamMembers' to 'team_members' to match the actual collection name
                console.log('📊 Loading from team_members collection...');
                const membersSnapshot = await db.collection('team_members').get();

                console.log(`📦 Found ${membersSnapshot.size} team members`);

                if (membersSnapshot.empty) {
                    console.warn('⚠️ No team members found in database');
                    selectElement.innerHTML = '<option value="">No team members found</option>';

                    const shouldInit = confirm(
                        '⚠️ No team members found!\n\n' +
                        'You need to add team members before creating projects.\n\n' +
                        'Options:\n' +
                        '1. Click "OK" to initialize sample data\n' +
                        '2. Click "Cancel" to add team members manually\n\n' +
                        'Initialize sample data now?'
                    );

                    if (shouldInit) {
                        closeProjectModal();
                        await initializeAllSampleData();
                    } else {
                        closeProjectModal();
                        navigateTo('team');
                    }
                    return;
                }

                selectElement.innerHTML = '';
                let loadedCount = 0;
                membersSnapshot.forEach(doc => {
                    const member = doc.data();

                    // Only show active members
                    const isActive = member.active === true ||
                                   member.status === 'Active' ||
                                   (member.active === undefined && member.status === undefined);

                    if (isActive && member.name) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.setAttribute('data-member-name', member.name);
                        option.textContent = `${member.name} - ${member.role || 'Team Member'}`;
                        selectElement.appendChild(option);
                        loadedCount++;
                        console.log(`👤 Added: ${member.name} (${member.role || 'N/A'})`);
                    }
                });

                console.log(`✅ Populated project dropdown with ${loadedCount} active team members`);

                if (loadedCount === 0) {
                    selectElement.innerHTML = '<option value="">No active team members</option>';
                    console.warn('⚠️ All team members are inactive');
                }

            } catch (error) {
                console.error('❌ Error loading team members:', error);
                selectElement.innerHTML = '<option value="">Error loading members</option>';
            }
        }

        function openProjectModal() {
            console.log('🚪 openProjectModal() called');
            editingProjectIndex = -1;
            document.getElementById('projectModalTitle').textContent = 'Create New Project';
            document.getElementById('projectSubmitBtn').textContent = 'Create Project';
            document.getElementById('projectForm').reset();

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('projectStartDate').value = today;

            // Populate team members dropdown
            console.log('📞 Calling populateProjectTeamMembersDropdown()...');
            populateProjectTeamMembersDropdown();

            document.getElementById('projectModal').classList.add('active');
            console.log('✅ Project modal opened');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('active');
            document.getElementById('projectForm').reset();
            editingProjectIndex = -1;
        }

        function editProject(index) {
            editingProjectIndex = index;
            const project = projects[index];

            // Update modal title and button
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectSubmitBtn').textContent = 'Update Project';

            // Populate form with project data
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDescription').value = project.description;
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectPriority').value = project.priority;
            document.getElementById('projectSDLC').value = project.sdlc || 'Development';

            // Set dates using helper function (converts dd/mm/yyyy to yyyy-mm-dd for input)
            setDateInputValue(document.getElementById('projectStartDate'), project.startDate);
            setDateInputValue(document.getElementById('projectEndDate'), project.endDate);
            document.getElementById('projectProgress').value = project.progress;
            document.getElementById('projectBudget').value = project.budget;
            document.getElementById('projectTags').value = project.tags ? project.tags.join(', ') : '';

            // Populate team members dropdown and select the correct members
            populateProjectTeamMembersDropdown().then(() => {
                const teamMembersSelect = document.getElementById('projectTeamMembers');

                // If project has teamMemberIds, use those. Otherwise try to match by name
                if (project.teamMemberIds && project.teamMemberIds.length > 0) {
                    // Select by IDs
                    Array.from(teamMembersSelect.options).forEach(option => {
                        if (project.teamMemberIds.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                } else if (project.teamMembers && project.teamMembers.length > 0) {
                    // Fallback: try to match by name for old data
                    Array.from(teamMembersSelect.options).forEach(option => {
                        const memberName = option.getAttribute('data-member-name');
                        if (project.teamMembers.includes(memberName)) {
                            option.selected = true;
                        }
                    });
                }
            });

            // Open modal
            document.getElementById('projectModal').classList.add('active');
        }

        async function deleteProject(index) {
            const project = projects[index];

            if (confirm(`Are you sure you want to delete "${project.name}"?`)) {
                try {
                    // Delete from Firebase if project has an ID
                    if (project.id && db) {
                        await deleteProjectFromFirebase(project.id);
                        console.log('✅ Project deleted from Firebase:', project.id);
                        alert('✅ Project deleted successfully!');

                        // Reload projects from Firebase
                        await loadProjectsFromFirebase();
                    } else {
                        // Fallback to local deletion if no ID
                        projects.splice(index, 1);
                        renderProjects();
                        alert('✅ Project deleted successfully (locally)!');
                    }
                } catch (error) {
                    console.error('❌ Error deleting project:', error);
                    alert('❌ Error deleting project: ' + error.message);
                }
            }
        }

        // Global variable to store current project filter
        let currentProjectFilter = null;

        // View tasks for a specific project
        function viewProjectTasks(projectId, projectName) {
            console.log(`📋 Viewing tasks for project: ${projectName} (ID: ${projectId})`);

            // Switch to tasks page (skip filter clearing)
            switchPage('tasks', true);

            // Open filter panel and set project filter
            const panel = document.getElementById('taskFilterPanel');
            panel.style.display = 'block';

            // Populate dropdowns first
            populateFilterDropdowns().then(() => {
                // Set the project filter
                document.getElementById('filterProject').value = projectId;
                taskFilters.project = projectId;

                // Apply filters
                applyTaskFilters();
            });

            // Store for backwards compatibility
            currentProjectFilter = { id: projectId, name: projectName };
        }

        // Clear project filter (legacy function - now redirects to clearAllTaskFilters)
        function clearProjectFilter() {
            console.log('🔄 Clearing project filter');
            clearAllTaskFilters();
        }

        // Filter remaining tasks by team member (all non-done tasks)
        function filterRemainingTasksByMember(memberId, memberName) {
            // Switch to tasks page without clearing filters
            switchPage('tasks', true);

            // Wait for page to load and tasks to be fetched from Firebase
            setTimeout(async () => {
                console.log(`🔍 Starting filter for member: ${memberName} (${memberId})`);
                console.log(`📋 Total tasks available: ${tasks.length}`);

                // Open filter panel and populate dropdowns
                const filterPanel = document.getElementById('taskFilterPanel');
                if (filterPanel) {
                    // Make sure it's visible
                    filterPanel.style.display = 'block';

                    // Populate filter dropdowns first
                    await populateFilterDropdowns();
                    console.log(`✅ Dropdowns populated`);
                }

                // Set filter values - filter by assigned member
                const assignedToSelect = document.getElementById('filterAssignedTo');
                if (assignedToSelect) {
                    assignedToSelect.value = memberId;
                    console.log(`✅ Set assignedTo dropdown to: ${memberId}`);
                    console.log(`📋 Dropdown options count: ${assignedToSelect.options.length}`);
                }

                // Check status checkboxes for all non-done statuses (blank, working, stuck)
                const statusCheckboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
                console.log(`📦 Found ${statusCheckboxes.length} status checkboxes`);

                statusCheckboxes.forEach(checkbox => {
                    // Check all except "done"
                    if (checkbox.value !== 'done') {
                        checkbox.checked = true;
                        console.log(`✅ Checked checkbox: ${checkbox.value}`);
                    } else {
                        checkbox.checked = false;
                        console.log(`❌ Unchecked checkbox: ${checkbox.value}`);
                    }
                });

                // Clear other filters
                document.getElementById('filterPriority').value = '';
                document.getElementById('filterProject').value = '';

                // Update task filters object with the non-done statuses
                taskFilters.assignedTo = memberId;
                taskFilters.status = ['blank', 'working', 'stuck'];
                taskFilters.priority = '';
                taskFilters.project = '';

                console.log(`🎯 Filter object:`, taskFilters);

                // Update status filter display to show the selected statuses
                updateStatusFilterDisplay();

                // Manually filter tasks with proper logic
                let filteredTasks = tasks.filter(task => {
                    // Check if task is assigned to this member (by ID or name for backward compatibility)
                    const isMember = task.assignedTo === memberId || task.person === memberName;

                    // Check if task status is in the selected statuses (not done)
                    const isNotDone = taskFilters.status.includes(task.status);

                    const matches = isMember && isNotDone;

                    if (isMember) {
                        console.log(`  Task "${task.name}": isMember=true, status=${task.status}, isNotDone=${isNotDone}`);
                    }

                    return matches;
                });

                console.log(`📊 Filtered ${filteredTasks.length} remaining tasks (excluding done) for member: ${memberName}`);

                // Render filtered tasks
                renderFilteredTasks(filteredTasks);

                // Update active filters display
                updateActiveFiltersDisplay();
            }, 500);
        }

        // Filter tasks by project ID
        function filterTasksByProject(projectId) {
            const tableBody = document.getElementById('tableBody');
            const filteredTasks = tasks.filter(task => task.projectId === projectId);

            console.log(`📊 Found ${filteredTasks.length} tasks for project ID: ${projectId}`);

            if (filteredTasks.length === 0) {
                tableBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #676879;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                        <div style="font-size: 16px; font-weight: 600;">No tasks found for this project</div>
                        <div style="font-size: 14px; margin-top: 8px;">Create a new task and assign it to this project</div>
                    </div>
                `;
                return;
            }

            // Render filtered tasks
            tableBody.innerHTML = filteredTasks.map((task, displayIndex) => {
                const index = tasks.indexOf(task); // Get original index
                const fullName = task.personName || task.person || 'Unknown';
                const displayName = formatNameWithInitial(fullName);
                const avatarText = fullName.split(' ').map(n => n[0]).join('');

                return `
                <div class="table-row" data-index="${index}">
                    <div class="table-cell" data-label="#">
                        <span class="row-number">${displayIndex + 1}</span>
                    </div>
                    <div class="table-cell" data-label="Task">
                        <span class="task-name">${task.name}</span>
                    </div>
                    <div class="table-cell" data-label="Status">
                        <div class="status-badge status-${task.status}">
                            ${getStatusText(task.status)}
                        </div>
                    </div>
                    <div class="table-cell" data-label="Priority">
                        <div class="priority">
                            <span class="priority-dot priority-${task.priority}"></span>
                            <span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Assigned To">
                        <div class="person-cell">
                            <div class="person-avatar">${avatarText}</div>
                            <span>${displayName}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Project">
                        ${task.project ? `<span class="project-badge" title="${task.project}">${task.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                    </div>
                    <div class="table-cell" data-label="Date">
                        <span class="date-cell">${task.date}</span>
                    </div>
                    <div class="table-cell" data-label="Timeline">
                        <span class="date-cell">${task.timeline}</span>
                    </div>
                    <div class="table-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-action="edit" data-index="${index}" title="Edit task">
                                ✏️
                            </button>
                            <button class="action-btn clone-btn" data-action="clone" data-index="${index}" title="Clone task">
                                📋
                            </button>
                            <button class="action-btn delete-btn" data-action="delete" data-index="${index}" title="Delete task">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Re-attach event listeners
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (action === 'edit') {
                        editTask(index);
                    } else if (action === 'clone') {
                        cloneTask(index);
                    } else if (action === 'delete') {
                        deleteTask(index);
                    }
                });
            });
        }

        // ========================================
        // TASK FILTER FUNCTIONS
        // ========================================
        let taskFilters = {
            status: [],  // Changed to array for multiple selections
            priority: '',
            assignedTo: '',
            project: ''
        };

        // ========================================
        // MULTI-SELECT STATUS DROPDOWN FUNCTIONS
        // ========================================

        // Toggle status dropdown
        function toggleStatusDropdown() {
            const display = document.getElementById('statusFilterDisplay');
            const options = document.getElementById('statusFilterOptions');

            display.classList.toggle('open');
            options.classList.toggle('open');
        }

        // Close status dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('statusFilterDropdown');
            const display = document.getElementById('statusFilterDisplay');
            const options = document.getElementById('statusFilterOptions');

            if (dropdown && !dropdown.contains(event.target)) {
                display.classList.remove('open');
                options.classList.remove('open');
            }
        });

        // Update status filter when checkboxes change
        function updateStatusFilter() {
            const checkboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
            const selectedStatuses = [];

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedStatuses.push(checkbox.value);
                }
            });

            // Update taskFilters object
            taskFilters.status = selectedStatuses;

            // Update display text
            updateStatusFilterDisplay();

            // Apply filters immediately
            applyTaskFilters();
        }

        // Update the display text based on selected statuses
        function updateStatusFilterDisplay() {
            const displayText = document.getElementById('statusFilterText');
            const selectedStatuses = taskFilters.status;

            if (selectedStatuses.length === 0) {
                displayText.textContent = 'All Status';
            } else if (selectedStatuses.length === 1) {
                // Show single status name
                const statusNames = {
                    'blank': 'Not Started',
                    'working': 'Working on it',
                    'stuck': 'Stuck',
                    'done': 'Done'
                };
                displayText.textContent = statusNames[selectedStatuses[0]];
            } else if (selectedStatuses.length === 4) {
                displayText.textContent = 'All Status';
            } else {
                displayText.textContent = `${selectedStatuses.length} statuses selected`;
            }
        }

        // Toggle filter panel visibility
        function toggleFilterPanel() {
            const panel = document.getElementById('taskFilterPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';

                // Restore all filter values from taskFilters object
                document.getElementById('filterStatus').value = taskFilters.status || '';
                document.getElementById('filterPriority').value = taskFilters.priority || '';

                // Populate dynamic dropdowns (they will restore their values internally)
                populateFilterDropdowns();
            } else {
                panel.style.display = 'none';
            }
        }

        // Populate filter dropdowns with data
        async function populateFilterDropdowns() {
            // Save current values before repopulating
            const savedAssignedTo = taskFilters.assignedTo;
            const savedProject = taskFilters.project;

            // Populate Assigned To dropdown
            const assignedToSelect = document.getElementById('filterAssignedTo');
            const uniqueMembers = [...new Set(tasks.map(t => t.assignedTo).filter(Boolean))];

            // Get member names
            const memberOptions = await Promise.all(
                uniqueMembers.map(async (memberId) => {
                    const memberName = await getMemberNameById(memberId);
                    return { id: memberId, name: memberName };
                })
            );

            assignedToSelect.innerHTML = '<option value="">All Members</option>' +
                memberOptions.map(m => `<option value="${m.id}">${m.name}</option>`).join('');

            // Restore saved value
            if (savedAssignedTo) {
                assignedToSelect.value = savedAssignedTo;
            }

            // Populate Project dropdown
            const projectSelect = document.getElementById('filterProject');
            const uniqueProjects = [...new Set(tasks.map(t => t.projectId).filter(Boolean))];

            const projectOptions = await Promise.all(
                uniqueProjects.map(async (projectId) => {
                    const projectName = await getProjectNameById(projectId);
                    return { id: projectId, name: projectName };
                })
            );

            projectSelect.innerHTML = '<option value="">All Projects</option>' +
                projectOptions.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            // Restore saved value
            if (savedProject) {
                projectSelect.value = savedProject;
            }
        }

        // Apply task filters
        function applyTaskFilters() {
            // Get filter values (status is already in taskFilters.status as array)
            taskFilters.priority = document.getElementById('filterPriority').value;
            taskFilters.assignedTo = document.getElementById('filterAssignedTo').value;
            taskFilters.project = document.getElementById('filterProject').value;

            // Check if any filter is active
            const hasActiveFilters = taskFilters.status.length > 0 ||
                                      taskFilters.priority !== '' ||
                                      taskFilters.assignedTo !== '' ||
                                      taskFilters.project !== '';

            // Filter tasks
            let filteredTasks = tasks;

            // Filter by multiple statuses (OR logic)
            if (taskFilters.status && taskFilters.status.length > 0) {
                filteredTasks = filteredTasks.filter(t => taskFilters.status.includes(t.status));
            }

            if (taskFilters.priority) {
                filteredTasks = filteredTasks.filter(t => t.priority === taskFilters.priority);
            }

            if (taskFilters.assignedTo) {
                filteredTasks = filteredTasks.filter(t => {
                    // Check both assignedTo (ID) and person (name) for backward compatibility
                    return t.assignedTo === taskFilters.assignedTo ||
                           (t.person && document.getElementById('filterAssignedTo').selectedOptions[0] &&
                            t.person === document.getElementById('filterAssignedTo').selectedOptions[0].text);
                });
            }

            if (taskFilters.project) {
                filteredTasks = filteredTasks.filter(t => t.projectId === taskFilters.project);
            }

            // Render filtered tasks
            renderFilteredTasks(filteredTasks);

            // Update active filters display
            updateActiveFiltersDisplay();
        }

        // Render filtered tasks
        function renderFilteredTasks(filteredTasks) {
            const tableBody = document.getElementById('tableBody');

            if (filteredTasks.length === 0) {
                tableBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #676879;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                        <div style="font-size: 16px; font-weight: 600;">No tasks match your filters</div>
                        <div style="font-size: 14px; margin-top: 8px;">Try adjusting your filter criteria</div>
                    </div>
                `;
                return;
            }

            tableBody.innerHTML = filteredTasks.map((task, displayIndex) => {
                const index = tasks.indexOf(task);
                const fullName = task.personName || task.person || 'Unknown';
                const displayName = formatNameWithInitial(fullName);
                const avatarText = fullName.split(' ').map(n => n[0]).join('');

                return `
                <div class="table-row" data-index="${index}">
                    <div class="table-cell" data-label="#">
                        <span class="row-number">${displayIndex + 1}</span>
                    </div>
                    <div class="table-cell" data-label="Task">
                        <span class="task-name">${task.name}</span>
                    </div>
                    <div class="table-cell" data-label="Status">
                        <div class="status-badge-wrapper">
                            <div class="status-badge status-${task.status}" onclick="toggleStatusPopup(event, ${index})">
                                ${getStatusText(task.status)}
                            </div>
                            <div class="status-popup" id="status-popup-${index}">
                                <div class="status-popup-option blank" onclick="changeTaskStatus(${index}, 'blank')">
                                    Not Started
                                </div>
                                <div class="status-popup-option working" onclick="changeTaskStatus(${index}, 'working')">
                                    Working on it
                                </div>
                                <div class="status-popup-option stuck" onclick="changeTaskStatus(${index}, 'stuck')">
                                    Stuck
                                </div>
                                <div class="status-popup-option done" onclick="changeTaskStatus(${index}, 'done')">
                                    Done
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Priority">
                        <div class="priority">
                            <span class="priority-dot priority-${task.priority}"></span>
                            <span>${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Assigned To">
                        <div class="person-cell">
                            <div class="person-avatar">${avatarText}</div>
                            <span>${displayName}</span>
                        </div>
                    </div>
                    <div class="table-cell" data-label="Project">
                        ${task.project ? `<span class="project-badge" title="${task.project}">${task.project}</span>` : '<span style="color: #c5c7d0;">—</span>'}
                    </div>
                    <div class="table-cell" data-label="Date">
                        <span class="date-cell">${task.date}</span>
                    </div>
                    <div class="table-cell" data-label="Timeline">
                        <span class="date-cell">${task.timeline}</span>
                    </div>
                    <div class="table-cell" data-label="Actions">
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" data-action="edit" data-index="${index}" title="Edit task">
                                ✏️
                            </button>
                            <button class="action-btn clone-btn" data-action="clone" data-index="${index}" title="Clone task">
                                📋
                            </button>
                            <button class="action-btn delete-btn" data-action="delete" data-index="${index}" title="Delete task">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Re-attach event listeners
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const action = this.getAttribute('data-action');
                    const index = parseInt(this.getAttribute('data-index'));

                    if (action === 'edit') {
                        editTask(index);
                    } else if (action === 'clone') {
                        cloneTask(index);
                    } else if (action === 'delete') {
                        deleteTask(index);
                    }
                });
            });

            console.log(`✅ Filtered to ${filteredTasks.length} tasks`);
        }

        // Update active filters display
        function updateActiveFiltersDisplay() {
            const activeFiltersDisplay = document.getElementById('activeFiltersDisplay');
            const activeFilterTags = document.getElementById('activeFilterTags');

            const activeFilters = [];

            // Handle multiple status selections
            if (taskFilters.status && taskFilters.status.length > 0) {
                const statusNames = {
                    'blank': 'Not Started',
                    'working': 'Working on it',
                    'stuck': 'Stuck',
                    'done': 'Done'
                };
                const statusValues = taskFilters.status.map(s => statusNames[s] || s).join(', ');
                activeFilters.push({ type: 'status', label: 'Status', value: statusValues });
            }
            if (taskFilters.priority) {
                activeFilters.push({ type: 'priority', label: 'Priority', value: taskFilters.priority.charAt(0).toUpperCase() + taskFilters.priority.slice(1) });
            }
            if (taskFilters.assignedTo) {
                const memberName = document.getElementById('filterAssignedTo').selectedOptions[0].text;
                activeFilters.push({ type: 'assignedTo', label: 'Member', value: memberName });
            }
            if (taskFilters.project) {
                const projectName = document.getElementById('filterProject').selectedOptions[0].text;
                activeFilters.push({ type: 'project', label: 'Project', value: projectName });
            }

            if (activeFilters.length > 0) {
                activeFiltersDisplay.style.display = 'block';
                activeFilterTags.innerHTML = activeFilters.map(filter => `
                    <div style="background: #e6f2ff; padding: 6px 12px; border-radius: 20px; font-size: 13px; color: #0073ea; display: flex; align-items: center; gap: 6px;">
                        <strong>${filter.label}:</strong> ${filter.value}
                        <button onclick="removeFilter('${filter.type}')" style="background: none; border: none; color: #0073ea; cursor: pointer; font-size: 16px; line-height: 1; padding: 0;">×</button>
                    </div>
                `).join('');
            } else {
                activeFiltersDisplay.style.display = 'none';
            }
        }

        // Remove individual filter
        function removeFilter(filterType) {
            if (filterType === 'status') {
                // Uncheck all status checkboxes
                const checkboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = false);
                taskFilters.status = [];
                updateStatusFilterDisplay();
            } else {
                document.getElementById('filter' + filterType.charAt(0).toUpperCase() + filterType.slice(1)).value = '';
            }
            applyTaskFilters();
        }

        // Clear all task filters
        function clearAllTaskFilters() {
            // Clear status checkboxes
            const statusCheckboxes = document.querySelectorAll('#statusFilterOptions input[type="checkbox"]');
            statusCheckboxes.forEach(checkbox => checkbox.checked = false);

            document.getElementById('filterPriority').value = '';
            document.getElementById('filterAssignedTo').value = '';
            document.getElementById('filterProject').value = '';

            taskFilters = {
                status: [],  // Changed to empty array
                priority: '',
                assignedTo: '',
                project: ''
            };

            // Update status filter display
            updateStatusFilterDisplay();

            // Clear project filter variable
            currentProjectFilter = null;

            renderTasks();
            updateActiveFiltersDisplay();

            console.log('✅ All task filters cleared');
        }

        // Handle project form submission
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get selected team member IDs and names
            const teamMembersSelect = document.getElementById('projectTeamMembers');
            const selectedOptions = Array.from(teamMembersSelect.selectedOptions);

            const teamMemberIds = selectedOptions.map(opt => opt.value).filter(v => v);
            const teamMemberNames = selectedOptions.map(opt => opt.getAttribute('data-member-name')).filter(n => n);

            // Validate that at least one team member is selected
            if (teamMemberIds.length === 0) {
                alert('⚠️ Please select at least one team member for this project.');
                teamMembersSelect.focus();
                return;
            }

            const tagsInput = document.getElementById('projectTags').value;
            const tagsArray = tagsInput ? tagsInput.split(',').map(s => s.trim()).filter(s => s) : [];

            const projectData = {
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                status: document.getElementById('projectStatus').value,
                priority: document.getElementById('projectPriority').value,
                sdlc: document.getElementById('projectSDLC').value,
                startDate: getDateInputValue(document.getElementById('projectStartDate')),  // Convert to dd/mm/yyyy
                endDate: getDateInputValue(document.getElementById('projectEndDate')),  // Convert to dd/mm/yyyy
                progress: parseInt(document.getElementById('projectProgress').value),
                budget: parseInt(document.getElementById('projectBudget').value) || 0,
                teamMemberIds: teamMemberIds,  // Store IDs
                teamMembers: teamMemberNames,   // Store names for backwards compatibility and display
                tags: tagsArray
            };

            try {
                if (editingProjectIndex >= 0) {
                    // Update existing project
                    const project = projects[editingProjectIndex];

                    // Update in Firebase if project has an ID
                    if (project.id && db) {
                        await updateProjectInFirebase(project.id, projectData);
                        console.log('✅ Project updated in Firebase:', project.id);
                        alert('✅ Project updated successfully!');
                    } else {
                        // Fallback to local storage if no ID
                        projects[editingProjectIndex] = projectData;
                        alert('✅ Project updated successfully (locally)!');
                    }
                } else {
                    // Add new project to Firebase
                    if (db) {
                        const projectId = await addProjectToFirebase(projectData);
                        console.log('✅ Project added to Firebase with ID:', projectId);
                        alert('✅ Project created successfully!');
                    } else {
                        // Fallback to local storage if Firebase not available
                        projects.push(projectData);
                        alert('✅ Project created successfully (locally)!');
                    }
                }

                closeProjectModal();

                // Reload projects from Firebase
                if (db) {
                    await loadProjectsFromFirebase();
                } else {
                    renderProjects();
                }

            } catch (error) {
                console.error('❌ Error saving project:', error);
                alert('❌ Error saving project: ' + error.message);
            }
        });

        // Close modal when clicking outside
        document.getElementById('projectModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProjectModal();
            }
        });

        // Initialize app
        window.addEventListener('load', async () => {
            // Load from Firebase
            if (db) {
                await loadTasksFromFirebase();
                await loadTeamMembersWithStats();
                await loadProjectsFromFirebase();
                setupRealtimeListener();
            } else {
                renderTasks();
                renderProjects();
                updateDashboardStats();
            }
        });
    </script>

    <!-- Loading Spinner Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text" id="spinnerText">Loading...</div>
        </div>
    </div>
</body>
</html>